<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Dynamic Title & Meta Tags (populated by JavaScript) -->
    <title>Loading... - Eyes of Azrael</title>
    <meta name="description" content="Explore mythology entity details">
    <meta property="og:title" content="Entity - Eyes of Azrael">
    <meta property="og:description" content="Explore world mythology">
    <meta property="og:type" content="article">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_large_image">

    <!-- JSON-LD Structured Data (populated by JavaScript) -->
    <script type="application/ld+json" id="entity-schema">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Loading...",
        "description": "Loading entity details..."
    }
    </script>

    <!-- Base Theme System -->
    <link rel="stylesheet" href="/themes/theme-base.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/themes/corpus-links.css">
    <link rel="stylesheet" href="/themes/smart-links.css">
    <link rel="stylesheet" href="/css/firebase-themes.css">

    <!-- Entity Display Styles -->
    <link rel="stylesheet" href="/css/entity-detail.css">

    <!-- Theme Scripts -->
    <script defer src="/themes/theme-picker.js"></script>
    <script defer src="/themes/theme-animations.js"></script>
    <script defer src="/themes/smart-links.js"></script>

    <!-- Firebase Auth System -->
    <link rel="stylesheet" href="/css/user-auth.css">
    <script src="/js/firebase-auth.js"></script>
    <script src="/js/auth-guard.js"></script>
    <script src="/js/components/google-signin-button.js"></script>

    <style>
        /* Loading State */
        .entity-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            position: sticky;
            top: 60px;
            left: 0;
            width: 100%;
            z-index: 999;
            background: rgba(var(--color-surface-rgb), 0.9);
            backdrop-filter: blur(12px);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            border-bottom: 1px solid rgba(var(--color-primary-rgb), 0.15);
        }

        .breadcrumb a {
            color: var(--color-primary);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .breadcrumb a:hover {
            color: var(--color-secondary);
            text-decoration: underline;
        }

        /* Entity Container */
        #entity-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        /* Error State */
        .entity-error {
            max-width: 600px;
            margin: 4rem auto;
            padding: var(--spacing-xl);
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .entity-error h2 {
            color: #ef4444;
            margin-top: 0;
        }

        /* Related Entities Sidebar */
        .related-sidebar {
            position: fixed;
            right: 0;
            top: 120px;
            width: 300px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            padding: var(--spacing-lg);
            background: rgba(var(--color-surface-rgb), 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(var(--color-primary-rgb), 0.2);
        }

        @media (max-width: 1400px) {
            .related-sidebar {
                display: none;
            }
        }

        /* Recently Viewed Component */
        .recently-viewed {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: rgba(var(--color-surface-rgb), 0.6);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
        }

        .recently-viewed h3 {
            color: var(--color-primary);
            margin-top: 0;
        }

        .recently-viewed-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .recently-viewed-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(var(--color-surface-rgb), 0.4);
            border-radius: var(--radius-sm);
            text-decoration: none;
            color: var(--color-text-primary);
            transition: all var(--transition-fast);
        }

        .recently-viewed-item:hover {
            background: rgba(var(--color-primary-rgb), 0.2);
            transform: translateX(4px);
        }

        .recently-viewed-icon {
            font-size: 1.5rem;
        }

        .recently-viewed-info {
            flex: 1;
        }

        .recently-viewed-name {
            font-weight: 600;
            display: block;
        }

        .recently-viewed-type {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <!-- Theme Picker Container -->
    <div id="theme-picker-container"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <h1 id="page-title">Eyes of Azrael</h1>
            <div id="user-auth-nav"></div>
        </div>
    </header>

    <!-- Breadcrumb Navigation (dynamically populated) -->
    <nav class="breadcrumb" id="breadcrumb-nav" aria-label="Breadcrumb">
        <a href="/index.html">Home</a>
    </nav>

    <main>
        <!-- Entity Container (dynamically populated) -->
        <div id="entity-container" class="entity-loading">
            <div class="loading-spinner"></div>
            <p>Loading entity details...</p>
        </div>

        <!-- Related Entities Sidebar -->
        <aside class="related-sidebar" id="related-sidebar" style="display: none;">
            <h3>Related Entities</h3>
            <div id="related-entities-list"></div>
        </aside>

        <!-- Recently Viewed Component -->
        <section class="recently-viewed" id="recently-viewed" style="display: none;">
            <h3>Recently Viewed</h3>
            <div class="recently-viewed-list" id="recently-viewed-list"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p>
            <strong>Eyes of Azrael</strong> - Exploring World Mythology<br>
            <a href="/mythos/index.html">Browse Mythologies</a> |
            <a href="/index.html">Main Site</a>
        </p>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="/firebase-config.js"></script>

    <!-- Entity Display & Loader -->
    <script src="/js/entity-display.js"></script>
    <script src="/js/entity-loader.js"></script>

    <!-- Navigation System -->
    <script src="/js/navigation.js"></script>

    <!-- Initialize Entity Detail Page -->
    <script>
        // Wait for Firebase and DOM to be ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize auth UI
            if (window.GoogleSignInButton) {
                const authNav = document.getElementById('user-auth-nav');
                if (authNav) {
                    window.GoogleSignInButton.injectIntoElement(authNav, {
                        showUserInfo: true,
                        showAvatar: true,
                        compact: true
                    });
                }
            }

            // Wait for Firebase to initialize
            await new Promise(resolve => {
                if (window.firebaseApp && window.firebaseDb) {
                    resolve();
                } else {
                    setTimeout(resolve, 1000);
                }
            });

            // Load entity from URL
            await loadEntityFromURL();
        });

        /**
         * Load and display entity based on URL
         * Supports multiple URL patterns:
         * - /entity-detail.html?type=deity&id=zeus
         * - /greek/deities/zeus.html (redirect to entity-detail.html)
         */
        async function loadEntityFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            const id = urlParams.get('id');
            const mythology = urlParams.get('mythology');

            if (!type || !id) {
                showError('Invalid URL', 'Missing entity type or ID in URL parameters.');
                return;
            }

            try {
                // Load entity from Firestore
                const collection = EntityLoader.getCollectionName(type);
                const doc = await firebase.firestore()
                    .collection(collection)
                    .doc(id)
                    .get();

                if (!doc.exists) {
                    showError('Entity Not Found', `The ${type} "${id}" could not be found in the database.`);
                    return;
                }

                const entity = { id: doc.id, ...doc.data() };

                // Update page metadata
                updatePageMetadata(entity);

                // Update breadcrumb
                updateBreadcrumb(entity);

                // Render entity
                const container = document.getElementById('entity-container');
                container.className = 'entity-detail-page';
                EntityDisplay.renderDetail(entity, container);

                // Load related entities
                await loadRelatedEntities(entity);

                // Track view in recently viewed
                addToRecentlyViewed(entity);

                // Show recently viewed
                displayRecentlyViewed();

                // Track analytics
                if (window.gtag) {
                    gtag('event', 'view_entity', {
                        entity_type: type,
                        entity_id: id,
                        mythology: entity.mythology
                    });
                }

            } catch (error) {
                console.error('Error loading entity:', error);
                showError('Error Loading Entity', error.message);
            }
        }

        /**
         * Update page title, meta tags, and structured data
         */
        function updatePageMetadata(entity) {
            const name = entity.name || entity.title;
            const description = entity.description || entity.shortDescription || '';
            const type = entity.type || 'entity';
            const mythology = entity.mythology || '';

            // Update title
            document.title = `${name} - ${mythology} ${type} - Eyes of Azrael`;
            document.getElementById('page-title').textContent = name;

            // Update meta tags
            const metaTags = {
                'description': description.substring(0, 160),
                'og:title': `${name} - ${mythology} Mythology`,
                'og:description': description.substring(0, 200),
                'twitter:title': `${name} - ${mythology} Mythology`
            };

            Object.entries(metaTags).forEach(([name, content]) => {
                let meta = document.querySelector(`meta[name="${name}"], meta[property="${name}"]`);
                if (!meta) {
                    meta = document.createElement('meta');
                    if (name.startsWith('og:') || name.startsWith('twitter:')) {
                        meta.setAttribute('property', name);
                    } else {
                        meta.setAttribute('name', name);
                    }
                    document.head.appendChild(meta);
                }
                meta.setAttribute('content', content);
            });

            // Update JSON-LD structured data
            const schema = {
                "@context": "https://schema.org",
                "@type": "Article",
                "headline": name,
                "description": description,
                "author": {
                    "@type": "Organization",
                    "name": "Eyes of Azrael"
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "Eyes of Azrael"
                },
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": window.location.href
                }
            };

            if (entity.visual?.icon) {
                schema.image = entity.visual.icon;
            }

            document.getElementById('entity-schema').textContent = JSON.stringify(schema, null, 2);
        }

        /**
         * Update breadcrumb navigation
         */
        function updateBreadcrumb(entity) {
            const breadcrumb = document.getElementById('breadcrumb-nav');
            const mythology = entity.mythology || '';
            const type = entity.type || 'entity';
            const name = entity.name || entity.title;

            breadcrumb.innerHTML = `
                <a href="/index.html">Home</a> →
                <a href="/mythos/index.html">Mythologies</a> →
                <a href="/mythos/${mythology}/index.html">${capitalize(mythology)}</a> →
                <a href="/templates/entity-grid.html?type=${type}&mythology=${mythology}">${capitalize(type)}s</a> →
                <span aria-current="page">${name}</span>
            `;
        }

        /**
         * Load and display related entities
         */
        async function loadRelatedEntities(entity) {
            if (!entity.relatedEntities && !entity.crossReferences) {
                return;
            }

            const sidebar = document.getElementById('related-sidebar');
            const list = document.getElementById('related-entities-list');

            const crossRefs = await EntityLoader.loadCrossReferences(entity);

            if (Object.keys(crossRefs).length === 0) {
                return;
            }

            let html = '';
            Object.entries(crossRefs).forEach(([type, entities]) => {
                if (entities && entities.length > 0) {
                    html += `<h4>${capitalize(type)}</h4>`;
                    entities.forEach(relatedEntity => {
                        const card = EntityDisplay.renderCard(relatedEntity);
                        html += card.outerHTML;
                    });
                }
            });

            list.innerHTML = html;
            sidebar.style.display = 'block';
        }

        /**
         * Add entity to recently viewed (localStorage)
         */
        function addToRecentlyViewed(entity) {
            const recent = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');

            // Remove if already exists
            const filtered = recent.filter(item => item.id !== entity.id);

            // Add to beginning
            filtered.unshift({
                id: entity.id,
                type: entity.type,
                name: entity.name || entity.title,
                mythology: entity.mythology,
                icon: EntityDisplay.getEntityIcon(entity),
                timestamp: Date.now()
            });

            // Keep only last 10
            const limited = filtered.slice(0, 10);

            localStorage.setItem('recentlyViewed', JSON.stringify(limited));
        }

        /**
         * Display recently viewed entities
         */
        function displayRecentlyViewed() {
            const recent = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');

            if (recent.length <= 1) {
                return; // Don't show if only current entity
            }

            const section = document.getElementById('recently-viewed');
            const list = document.getElementById('recently-viewed-list');

            const html = recent.slice(1, 6).map(item => `
                <a href="/templates/entity-detail.html?type=${item.type}&id=${item.id}" class="recently-viewed-item">
                    <span class="recently-viewed-icon">${item.icon}</span>
                    <div class="recently-viewed-info">
                        <span class="recently-viewed-name">${item.name}</span>
                        <span class="recently-viewed-type">${capitalize(item.mythology)} ${capitalize(item.type)}</span>
                    </div>
                </a>
            `).join('');

            list.innerHTML = html;
            section.style.display = 'block';
        }

        /**
         * Show error state
         */
        function showError(title, message) {
            const container = document.getElementById('entity-container');
            container.className = 'entity-error';
            container.innerHTML = `
                <h2>${title}</h2>
                <p>${message}</p>
                <a href="/mythos/index.html" class="btn btn-primary">Browse Mythologies</a>
            `;
        }

        /**
         * Capitalize string
         */
        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>

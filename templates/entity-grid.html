<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Entities - Eyes of Azrael</title>

    <!-- Base Theme System -->
    <link rel="stylesheet" href="/themes/theme-base.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/css/firebase-themes.css">

    <!-- Theme Scripts -->
    <script defer src="/themes/theme-picker.js"></script>
    <script defer src="/themes/theme-animations.js"></script>

    <!-- Firebase Auth System -->
    <link rel="stylesheet" href="/css/user-auth.css">
    <script src="/js/firebase-auth.js"></script>
    <script src="/js/auth-guard.js"></script>
    <script src="/js/components/google-signin-button.js"></script>

    <style>
        /* Grid Layout Styles */
        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .grid-title {
            color: var(--color-primary);
            margin: 0;
        }

        .grid-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        /* Filter Sidebar */
        .grid-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-lg);
        }

        .filter-sidebar {
            position: sticky;
            top: 80px;
            height: fit-content;
            background: rgba(var(--color-surface-rgb), 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }

        .filter-section {
            margin-bottom: var(--spacing-lg);
        }

        .filter-section h3 {
            color: var(--color-primary);
            font-size: var(--font-size-md);
            margin-top: 0;
            margin-bottom: var(--spacing-sm);
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-option:hover {
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-sm);
        }

        .filter-option input[type="checkbox"],
        .filter-option input[type="radio"] {
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            flex: 1;
        }

        .filter-count {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            padding-left: 3rem;
            background: rgba(var(--color-surface-rgb), 0.8);
            border: 2px solid rgba(var(--color-primary-rgb), 0.3);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--font-size-md);
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--color-text-secondary);
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .sort-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .sort-select {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(var(--color-surface-rgb), 0.8);
            border: 2px solid rgba(var(--color-primary-rgb), 0.3);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        /* Grid Container */
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        /* Stats Bar */
        .grid-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: rgba(var(--color-primary-rgb), 0.05);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .stats-count {
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
        }

        .pagination-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(var(--color-surface-rgb), 0.8);
            border: 2px solid rgba(var(--color-primary-rgb), 0.3);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(var(--color-primary-rgb), 0.2);
            border-color: var(--color-primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Add New Button */
        .btn-add-new {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-add-new:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            gap: var(--spacing-md);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }

            .filter-sidebar {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .entities-grid {
                grid-template-columns: 1fr;
            }

            .grid-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Breadcrumb */
        .breadcrumb {
            position: sticky;
            top: 60px;
            left: 0;
            width: 100%;
            z-index: 999;
            background: rgba(var(--color-surface-rgb), 0.9);
            backdrop-filter: blur(12px);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            border-bottom: 1px solid rgba(var(--color-primary-rgb), 0.15);
        }

        .breadcrumb a {
            color: var(--color-primary);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .breadcrumb a:hover {
            color: var(--color-secondary);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Theme Picker Container -->
    <div id="theme-picker-container"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <h1>Eyes of Azrael</h1>
            <div id="user-auth-nav"></div>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb" id="breadcrumb-nav" aria-label="Breadcrumb">
        <a href="/index.html">Home</a>
    </nav>

    <main style="max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl);">
        <!-- Grid Header -->
        <div class="grid-header">
            <h1 class="grid-title" id="page-title">Loading...</h1>
            <div class="grid-actions">
                <button class="btn-add-new" id="add-new-btn" style="display: none;">
                    + Add New
                </button>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid-layout">
            <!-- Filter Sidebar -->
            <aside class="filter-sidebar">
                <!-- Search -->
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        class="search-input"
                        id="search-input"
                        placeholder="Search entities..."
                        autocomplete="off"
                    >
                </div>

                <!-- Mythology Filter -->
                <div class="filter-section" id="mythology-filter">
                    <h3>Mythology</h3>
                    <div id="mythology-options"></div>
                </div>

                <!-- Type Filter -->
                <div class="filter-section" id="type-filter" style="display: none;">
                    <h3>Entity Type</h3>
                    <div id="type-options"></div>
                </div>

                <!-- Tags Filter -->
                <div class="filter-section" id="tags-filter">
                    <h3>Tags</h3>
                    <div id="tags-options"></div>
                </div>

                <!-- Clear Filters -->
                <button class="btn btn-secondary" id="clear-filters" style="width: 100%;">
                    Clear All Filters
                </button>
            </aside>

            <!-- Main Grid Content -->
            <div class="grid-content">
                <!-- Sort Controls -->
                <div class="sort-controls">
                    <span class="sort-label">Sort by:</span>
                    <select class="sort-select" id="sort-select">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="date-desc">Recently Added</option>
                        <option value="date-asc">Oldest First</option>
                        <option value="popularity">Most Popular</option>
                    </select>
                </div>

                <!-- Stats Bar -->
                <div class="grid-stats">
                    <span class="stats-count" id="stats-count">Loading...</span>
                    <span id="filter-status"></span>
                </div>

                <!-- Entities Grid -->
                <div class="entities-grid" id="entities-grid">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Loading entities...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>
            <strong>Eyes of Azrael</strong> - Exploring World Mythology<br>
            <a href="/mythos/index.html">Browse Mythologies</a> |
            <a href="/index.html">Main Site</a>
        </p>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="/firebase-config.js"></script>

    <!-- Entity Display & Loader -->
    <script src="/js/entity-display.js"></script>
    <script src="/js/entity-loader.js"></script>

    <!-- Initialize Entity Grid -->
    <script>
        // State management
        const state = {
            type: null,
            mythology: null,
            filters: {
                mythologies: [],
                tags: [],
                search: ''
            },
            sort: 'name-asc',
            page: 1,
            pageSize: 24,
            allEntities: [],
            filteredEntities: []
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize auth UI
            if (window.GoogleSignInButton) {
                const authNav = document.getElementById('user-auth-nav');
                if (authNav) {
                    window.GoogleSignInButton.injectIntoElement(authNav, {
                        showUserInfo: true,
                        showAvatar: true,
                        compact: true
                    });
                }
            }

            // Wait for Firebase
            await new Promise(resolve => {
                if (window.firebaseApp && window.firebaseDb) {
                    resolve();
                } else {
                    setTimeout(resolve, 1000);
                }
            });

            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            state.type = urlParams.get('type');
            state.mythology = urlParams.get('mythology');

            // Update UI
            updatePageTitle();
            updateBreadcrumb();

            // Setup event listeners
            setupEventListeners();

            // Load entities
            await loadEntities();

            // Check if user can add new entities
            checkAddNewPermission();
        });

        /**
         * Update page title
         */
        function updatePageTitle() {
            let title = 'Browse';
            if (state.mythology) {
                title += ` ${capitalize(state.mythology)}`;
            }
            if (state.type) {
                title += ` ${capitalize(state.type)}s`;
            } else {
                title += ' Entities';
            }
            document.getElementById('page-title').textContent = title;
            document.title = `${title} - Eyes of Azrael`;
        }

        /**
         * Update breadcrumb
         */
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb-nav');
            let html = '<a href="/index.html">Home</a> ‚Üí <a href="/mythos/index.html">Mythologies</a>';

            if (state.mythology) {
                html += ` ‚Üí <a href="/mythos/${state.mythology}/index.html">${capitalize(state.mythology)}</a>`;
            }

            if (state.type) {
                html += ` ‚Üí <span aria-current="page">${capitalize(state.type)}s</span>`;
            } else {
                html += ` ‚Üí <span aria-current="page">All Entities</span>`;
            }

            breadcrumb.innerHTML = html;
        }

        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                state.filters.search = e.target.value.toLowerCase();
                applyFiltersAndRender();
            });

            // Sort
            document.getElementById('sort-select').addEventListener('change', (e) => {
                state.sort = e.target.value;
                applyFiltersAndRender();
            });

            // Clear filters
            document.getElementById('clear-filters').addEventListener('click', () => {
                state.filters = { mythologies: [], tags: [], search: '' };
                document.getElementById('search-input').value = '';
                document.querySelectorAll('.filter-option input').forEach(input => {
                    input.checked = false;
                });
                applyFiltersAndRender();
            });

            // Add new button
            document.getElementById('add-new-btn').addEventListener('click', () => {
                const url = state.type ?
                    `/submit.html?type=${state.type}` :
                    '/submit.html';
                window.location.href = url;
            });
        }

        /**
         * Load entities from Firestore
         */
        async function loadEntities() {
            try {
                const collection = state.type ?
                    EntityLoader.getCollectionName(state.type) :
                    'deities'; // Default collection

                let query = firebase.firestore().collection(collection);

                // Filter by mythology if specified
                if (state.mythology) {
                    query = query.where('mythology', '==', state.mythology);
                }

                const snapshot = await query.get();

                state.allEntities = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Build filter options
                buildFilterOptions();

                // Apply filters and render
                applyFiltersAndRender();

            } catch (error) {
                console.error('Error loading entities:', error);
                showError('Failed to load entities: ' + error.message);
            }
        }

        /**
         * Build filter options from loaded entities
         */
        function buildFilterOptions() {
            // Collect all unique mythologies and tags
            const mythologies = new Set();
            const tags = new Set();

            state.allEntities.forEach(entity => {
                if (entity.mythology) mythologies.add(entity.mythology);
                if (entity.mythologies && Array.isArray(entity.mythologies)) {
                    entity.mythologies.forEach(m => mythologies.add(m));
                }
                if (entity.tags && Array.isArray(entity.tags)) {
                    entity.tags.forEach(t => tags.add(t));
                }
            });

            // Render mythology filter options
            const mythologyOptions = document.getElementById('mythology-options');
            mythologyOptions.innerHTML = Array.from(mythologies).sort().map(myth => `
                <div class="filter-option">
                    <input type="checkbox" id="myth-${myth}" value="${myth}"
                           onchange="toggleMythologyFilter('${myth}')">
                    <label for="myth-${myth}">${capitalize(myth)}</label>
                </div>
            `).join('');

            // Render tags filter options
            const tagsOptions = document.getElementById('tags-options');
            if (tags.size > 0) {
                tagsOptions.innerHTML = Array.from(tags).sort().map(tag => `
                    <div class="filter-option">
                        <input type="checkbox" id="tag-${tag}" value="${tag}"
                               onchange="toggleTagFilter('${tag}')">
                        <label for="tag-${tag}">${capitalize(tag)}</label>
                    </div>
                `).join('');
            } else {
                document.getElementById('tags-filter').style.display = 'none';
            }
        }

        /**
         * Toggle mythology filter
         */
        window.toggleMythologyFilter = function(mythology) {
            if (state.filters.mythologies.includes(mythology)) {
                state.filters.mythologies = state.filters.mythologies.filter(m => m !== mythology);
            } else {
                state.filters.mythologies.push(mythology);
            }
            applyFiltersAndRender();
        };

        /**
         * Toggle tag filter
         */
        window.toggleTagFilter = function(tag) {
            if (state.filters.tags.includes(tag)) {
                state.filters.tags = state.filters.tags.filter(t => t !== tag);
            } else {
                state.filters.tags.push(tag);
            }
            applyFiltersAndRender();
        };

        /**
         * Apply filters, sort, and render
         */
        function applyFiltersAndRender() {
            // Filter entities
            state.filteredEntities = state.allEntities.filter(entity => {
                // Mythology filter
                if (state.filters.mythologies.length > 0) {
                    const entityMythologies = entity.mythologies || [entity.mythology];
                    if (!entityMythologies.some(m => state.filters.mythologies.includes(m))) {
                        return false;
                    }
                }

                // Tags filter
                if (state.filters.tags.length > 0) {
                    if (!entity.tags || !entity.tags.some(t => state.filters.tags.includes(t))) {
                        return false;
                    }
                }

                // Search filter
                if (state.filters.search) {
                    const searchFields = [
                        entity.name,
                        entity.title,
                        entity.description,
                        entity.shortDescription
                    ].filter(Boolean).join(' ').toLowerCase();

                    if (!searchFields.includes(state.filters.search)) {
                        return false;
                    }
                }

                return true;
            });

            // Sort entities
            sortEntities();

            // Update stats
            updateStats();

            // Render grid
            renderGrid();

            // Render pagination
            renderPagination();
        }

        /**
         * Sort entities
         */
        function sortEntities() {
            const [field, direction] = state.sort.split('-');

            state.filteredEntities.sort((a, b) => {
                let aVal, bVal;

                if (field === 'name') {
                    aVal = (a.name || a.title || '').toLowerCase();
                    bVal = (b.name || b.title || '').toLowerCase();
                } else if (field === 'date') {
                    aVal = a.createdAt?.seconds || 0;
                    bVal = b.createdAt?.seconds || 0;
                } else if (field === 'popularity') {
                    aVal = a.views || 0;
                    bVal = b.views || 0;
                }

                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        /**
         * Update stats
         */
        function updateStats() {
            const statsCount = document.getElementById('stats-count');
            const filterStatus = document.getElementById('filter-status');

            statsCount.textContent = `Showing ${state.filteredEntities.length} of ${state.allEntities.length} entities`;

            const activeFilters = [
                ...state.filters.mythologies.map(m => capitalize(m)),
                ...state.filters.tags.map(t => capitalize(t))
            ];

            if (activeFilters.length > 0 || state.filters.search) {
                filterStatus.textContent = `Filters: ${activeFilters.join(', ')}${state.filters.search ? ' (Search: ' + state.filters.search + ')' : ''}`;
            } else {
                filterStatus.textContent = '';
            }
        }

        /**
         * Render grid
         */
        function renderGrid() {
            const grid = document.getElementById('entities-grid');

            if (state.filteredEntities.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h2>No entities found</h2>
                        <p>Try adjusting your filters or search query.</p>
                    </div>
                `;
                return;
            }

            // Paginate
            const start = (state.page - 1) * state.pageSize;
            const end = start + state.pageSize;
            const pageEntities = state.filteredEntities.slice(start, end);

            // Render cards
            grid.innerHTML = '';
            pageEntities.forEach(entity => {
                const card = EntityDisplay.renderCard(entity);
                grid.appendChild(card);
            });
        }

        /**
         * Render pagination
         */
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(state.filteredEntities.length / state.pageSize);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button class="pagination-btn" ${state.page === 1 ? 'disabled' : ''} onclick="goToPage(${state.page - 1})">
                    ‚Üê Previous
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= state.page - 2 && i <= state.page + 2)) {
                    html += `
                        <button class="pagination-btn ${i === state.page ? 'active' : ''}" onclick="goToPage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === state.page - 3 || i === state.page + 3) {
                    html += `<span>...</span>`;
                }
            }

            html += `
                <button class="pagination-btn" ${state.page === totalPages ? 'disabled' : ''} onclick="goToPage(${state.page + 1})">
                    Next ‚Üí
                </button>
            `;

            pagination.innerHTML = html;
        }

        /**
         * Go to page
         */
        window.goToPage = function(page) {
            state.page = page;
            renderGrid();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /**
         * Check if user can add new entities
         */
        async function checkAddNewPermission() {
            const user = firebase.auth().currentUser;
            if (user) {
                document.getElementById('add-new-btn').style.display = 'block';
            }
        }

        /**
         * Show error
         */
        function showError(message) {
            document.getElementById('entities-grid').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <h2>Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        /**
         * Capitalize string
         */
        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>

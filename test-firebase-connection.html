<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test - Eyes of Azrael</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #0a0015 100%);
            color: white;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .test-section {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .test-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .test-status.success {
            background: #22c55e;
            border-color: #22c55e;
            animation: none;
        }

        .test-status.error {
            background: #ef4444;
            border-color: #ef4444;
            animation: none;
        }

        .test-status.warning {
            background: #f59e0b;
            border-color: #f59e0b;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .test-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .test-details {
            padding-left: 2.5rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        .test-output {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(147, 51, 234, 0.2);
            color: white;
            border: 2px solid rgba(147, 51, 234, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(147, 51, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .summary {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            margin-top: 2rem;
        }

        .summary h2 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .summary.success {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }

        .summary.error {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Connection Test</h1>

        <!-- Test 1: Firebase SDK -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-sdk"></div>
                <div class="test-title">Firebase SDK Loaded</div>
            </div>
            <div class="test-details" id="details-sdk">Testing...</div>
        </div>

        <!-- Test 2: Firebase Config -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-config"></div>
                <div class="test-title">Firebase Configuration</div>
            </div>
            <div class="test-details" id="details-config">Testing...</div>
        </div>

        <!-- Test 3: Firebase Auth -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-auth"></div>
                <div class="test-title">Authentication Service</div>
            </div>
            <div class="test-details" id="details-auth">Testing...</div>
        </div>

        <!-- Test 4: Firestore -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-firestore"></div>
                <div class="test-title">Firestore Database</div>
            </div>
            <div class="test-details" id="details-firestore">Testing...</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="signin-btn" disabled>
                Sign In with Google
            </button>
            <button class="btn btn-secondary" id="retest-btn" onclick="location.reload()">
                Run Tests Again
            </button>
        </div>

        <!-- Summary -->
        <div class="summary" id="summary" style="display: none;">
            <h2 id="summary-title">Test Results</h2>
            <p id="summary-text"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let testsCompleted = 0;
        let testsPassed = 0;
        const totalTests = 4;

        function updateStatus(testId, status, message, details = null) {
            const statusEl = document.getElementById(`status-${testId}`);
            const detailsEl = document.getElementById(`details-${testId}`);

            statusEl.className = `test-status ${status}`;
            detailsEl.innerHTML = message;

            if (details) {
                detailsEl.innerHTML += `<div class="test-output">${details}</div>`;
            }

            testsCompleted++;
            if (status === 'success') testsPassed++;

            if (testsCompleted === totalTests) {
                showSummary();
            }
        }

        function showSummary() {
            const summaryEl = document.getElementById('summary');
            const titleEl = document.getElementById('summary-title');
            const textEl = document.getElementById('summary-text');

            summaryEl.style.display = 'block';

            if (testsPassed === totalTests) {
                summaryEl.className = 'summary success';
                titleEl.textContent = '‚úÖ All Tests Passed!';
                textEl.innerHTML = `
                    Firebase is fully configured and ready to use.<br>
                    You can now sign in and start using the user theories system.
                `;
                document.getElementById('signin-btn').disabled = false;
            } else {
                summaryEl.className = 'summary error';
                titleEl.textContent = '‚ö†Ô∏è Some Tests Failed';
                textEl.innerHTML = `
                    ${testsPassed} of ${totalTests} tests passed.<br>
                    Please check the details above and follow the instructions.
                `;
            }
        }

        // Test 1: Firebase SDK
        setTimeout(() => {
            if (typeof firebase !== 'undefined') {
                updateStatus('sdk', 'success',
                    'Firebase SDK loaded successfully',
                    `Version: ${firebase.SDK_VERSION || '10.7.1'}`
                );
            } else {
                updateStatus('sdk', 'error',
                    'Firebase SDK not loaded',
                    'Check that Firebase CDN scripts are loading correctly'
                );
            }
        }, 500);

        // Test 2: Firebase Config
        setTimeout(() => {
            try {
                const app = firebase.app();
                const config = app.options;

                if (config.projectId === 'eyesofazrael') {
                    updateStatus('config', 'success',
                        'Firebase configured correctly',
                        `Project ID: ${config.projectId}<br>Auth Domain: ${config.authDomain}`
                    );
                } else {
                    updateStatus('config', 'warning',
                        'Firebase initialized but with different project',
                        `Project ID: ${config.projectId}`
                    );
                }
            } catch (error) {
                updateStatus('config', 'error',
                    'Firebase configuration error',
                    error.message
                );
            }
        }, 1000);

        // Test 3: Firebase Auth
        setTimeout(() => {
            try {
                const auth = firebase.auth();

                if (auth) {
                    // Check if Google provider is enabled by trying to get redirect result
                    auth.getRedirectResult().then(() => {
                        updateStatus('auth', 'success',
                            'Authentication service is ready',
                            'Google OAuth can be tested with Sign In button below'
                        );
                    }).catch((error) => {
                        if (error.code === 'auth/operation-not-allowed') {
                            updateStatus('auth', 'error',
                                'Google Authentication is not enabled',
                                `Error: ${error.message}<br><br>
                                <strong>Fix:</strong> Go to Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Enable Google`
                            );
                        } else {
                            updateStatus('auth', 'warning',
                                'Authentication service initialized',
                                `Note: ${error.message}`
                            );
                        }
                    });
                } else {
                    updateStatus('auth', 'error',
                        'Firebase Authentication not initialized',
                        'Check firebase-config.js'
                    );
                }
            } catch (error) {
                updateStatus('auth', 'error',
                    'Firebase Authentication error',
                    error.message
                );
            }
        }, 1500);

        // Test 4: Firestore
        setTimeout(() => {
            try {
                const db = firebase.firestore();

                if (db) {
                    // Try to read from Firestore (this will fail gracefully if not set up)
                    db.collection('_test_').limit(1).get()
                        .then(() => {
                            updateStatus('firestore', 'success',
                                'Firestore database is accessible',
                                'Database is ready to store user theories'
                            );
                        })
                        .catch((error) => {
                            if (error.code === 'permission-denied') {
                                updateStatus('firestore', 'success',
                                    'Firestore database exists and security rules are active',
                                    'Permission denied is expected (rules are working)'
                                );
                            } else if (error.code === 'failed-precondition') {
                                updateStatus('firestore', 'error',
                                    'Firestore database not created',
                                    `${error.message}<br><br>
                                    <strong>Fix:</strong> Go to Firebase Console ‚Üí Firestore Database ‚Üí Create Database`
                                );
                            } else {
                                updateStatus('firestore', 'warning',
                                    'Firestore initialized but may have issues',
                                    `Error: ${error.message}`
                                );
                            }
                        });
                } else {
                    updateStatus('firestore', 'error',
                        'Firestore not initialized',
                        'Check firebase-config.js'
                    );
                }
            } catch (error) {
                updateStatus('firestore', 'error',
                    'Firestore error',
                    error.message
                );
            }
        }, 2000);

        // Sign in button
        document.getElementById('signin-btn').addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);

                alert(`‚úÖ Successfully signed in as ${result.user.displayName}!\n\nYou can now use the user theories system.`);

                // Create a test user profile
                const db = firebase.firestore();
                await db.collection('users').doc(result.user.uid).set({
                    username: result.user.displayName,
                    email: result.user.email,
                    avatar: result.user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('‚úÖ User profile created in Firestore!\n\nYou can now go to Submit Theory page.');

            } catch (error) {
                alert(`‚ùå Sign in failed:\n\n${error.message}`);
            }
        });
    </script>
</body>
</html>

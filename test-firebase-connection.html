<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test - Eyes of Azrael</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #0a0015 100%);
            color: white;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .test-section {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .test-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .test-status.success {
            background: #22c55e;
            border-color: #22c55e;
            animation: none;
        }

        .test-status.error {
            background: #ef4444;
            border-color: #ef4444;
            animation: none;
        }

        .test-status.warning {
            background: #f59e0b;
            border-color: #f59e0b;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .test-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .test-details {
            padding-left: 2.5rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        .test-output {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(147, 51, 234, 0.2);
            color: white;
            border: 2px solid rgba(147, 51, 234, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(147, 51, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .summary {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            margin-top: 2rem;
        }

        .summary h2 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .summary.success {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }

        .summary.error {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.1);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .info-box strong {
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Connection Test</h1>

        <!-- Test 1: Firebase SDK -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-sdk"></div>
                <div class="test-title">1. Firebase SDK Loaded</div>
            </div>
            <div class="test-details" id="details-sdk">Testing...</div>
        </div>

        <!-- Test 2: Firebase Config -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-config"></div>
                <div class="test-title">2. Firebase Configuration</div>
            </div>
            <div class="test-details" id="details-config">Testing...</div>
        </div>

        <!-- Test 3: Firebase Init -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-init"></div>
                <div class="test-title">3. Firebase Initialization</div>
            </div>
            <div class="test-details" id="details-init">Testing...</div>
        </div>

        <!-- Test 4: Firebase Auth -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-auth"></div>
                <div class="test-title">4. Authentication Service</div>
            </div>
            <div class="test-details" id="details-auth">Testing...</div>
        </div>

        <!-- Test 5: Firestore -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-firestore"></div>
                <div class="test-title">5. Firestore Database</div>
            </div>
            <div class="test-details" id="details-firestore">Testing...</div>
        </div>

        <!-- Test 6: Firestore Query -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-status" id="status-query"></div>
                <div class="test-title">6. Firestore Query Test</div>
            </div>
            <div class="test-details" id="details-query">Testing...</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="signin-btn" disabled>
                Test Google Sign-In
            </button>
            <button class="btn btn-secondary" id="retest-btn" onclick="location.reload()">
                Run Tests Again
            </button>
        </div>

        <!-- Summary -->
        <div class="summary" id="summary" style="display: none;">
            <h2 id="summary-title">Test Results</h2>
            <p id="summary-text"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config (THIS IS THE KEY FILE TO TEST) -->
    <script src="firebase-config.js"></script>

    <script>
        let testsCompleted = 0;
        let testsPassed = 0;
        const totalTests = 6;

        function updateStatus(testId, status, message, details = null) {
            const statusEl = document.getElementById(`status-${testId}`);
            const detailsEl = document.getElementById(`details-${testId}`);

            statusEl.className = `test-status ${status}`;
            detailsEl.innerHTML = message;

            if (details) {
                detailsEl.innerHTML += `<div class="test-output">${details}</div>`;
            }

            testsCompleted++;
            if (status === 'success') testsPassed++;

            if (testsCompleted === totalTests) {
                showSummary();
            }
        }

        function showSummary() {
            const summaryEl = document.getElementById('summary');
            const titleEl = document.getElementById('summary-title');
            const textEl = document.getElementById('summary-text');

            summaryEl.style.display = 'block';

            if (testsPassed === totalTests) {
                summaryEl.className = 'summary success';
                titleEl.textContent = '‚úÖ All Tests Passed!';
                textEl.innerHTML = `
                    Firebase is fully configured and ready to use.<br>
                    You can now sign in and start using the user theories system.
                `;
                document.getElementById('signin-btn').disabled = false;
            } else {
                summaryEl.className = 'summary error';
                titleEl.textContent = '‚ö†Ô∏è Some Tests Failed';
                textEl.innerHTML = `
                    ${testsPassed} of ${totalTests} tests passed.<br>
                    Please check the details above and follow the instructions.
                `;
            }
        }

        // Test 1: Firebase SDK
        setTimeout(() => {
            if (typeof firebase !== 'undefined') {
                updateStatus('sdk', 'success',
                    'Firebase SDK loaded successfully',
                    `Version: ${firebase.SDK_VERSION || '10.7.1'}\nLoaded from CDN: gstatic.com/firebasejs/10.7.1`
                );
            } else {
                updateStatus('sdk', 'error',
                    'Firebase SDK not loaded',
                    `<strong>Problem:</strong> Firebase global object is undefined\n\n<strong>Fix:</strong>\n1. Check internet connection\n2. Verify CDN scripts are loading (check browser DevTools Network tab)\n3. Make sure no ad blocker is blocking Firebase CDN`
                );
            }
        }, 500);

        // Test 2: Firebase Config File
        setTimeout(() => {
            try {
                // Check if firebaseConfig exists (loaded from firebase-config.js)
                if (typeof firebaseConfig !== 'undefined') {
                    const hasRequiredFields = firebaseConfig.apiKey &&
                                             firebaseConfig.projectId &&
                                             firebaseConfig.authDomain;

                    if (hasRequiredFields) {
                        updateStatus('config', 'success',
                            'firebase-config.js loaded successfully',
                            `Project ID: ${firebaseConfig.projectId}\nAuth Domain: ${firebaseConfig.authDomain}\nConfig valid: Yes`
                        );
                    } else {
                        updateStatus('config', 'error',
                            'firebase-config.js loaded but incomplete',
                            `<strong>Problem:</strong> Configuration is missing required fields\n\n<strong>Fix:</strong>\nCheck firebase-config.js has apiKey, projectId, and authDomain`
                        );
                    }
                } else {
                    updateStatus('config', 'error',
                        'firebase-config.js not loaded',
                        `<strong>Problem:</strong> firebaseConfig object is undefined\n\n<strong>Possible causes:</strong>\n1. firebase-config.js file doesn't exist\n2. File has JavaScript errors\n3. File path is incorrect\n\n<strong>Fix:</strong>\n1. Check that firebase-config.js exists in project root\n2. Check browser console for JavaScript errors\n3. Verify the file exports firebaseConfig variable`
                    );
                }
            } catch (error) {
                updateStatus('config', 'error',
                    'Error checking Firebase config',
                    error.message
                );
            }
        }, 1000);

        // Test 3: Firebase Initialization
        setTimeout(() => {
            try {
                // Check if Firebase has been initialized
                if (firebase.apps && firebase.apps.length > 0) {
                    const app = firebase.app();
                    const config = app.options;

                    updateStatus('init', 'success',
                        'Firebase app initialized successfully',
                        `App name: ${app.name}\nProject: ${config.projectId}\nInitialized: Yes`
                    );
                } else {
                    updateStatus('init', 'error',
                        'Firebase app not initialized',
                        `<strong>Problem:</strong> firebase.initializeApp() was not called\n\n<strong>Fix:</strong>\nAdd to firebase-config.js:\n\nif (firebase.apps.length === 0) {\n  firebase.initializeApp(firebaseConfig);\n}`
                    );
                }
            } catch (error) {
                updateStatus('init', 'error',
                    'Firebase initialization error',
                    error.message
                );
            }
        }, 1500);

        // Test 4: Firebase Auth
        setTimeout(() => {
            try {
                const auth = firebase.auth();

                if (auth) {
                    // Check if Google provider is enabled
                    auth.getRedirectResult().then(() => {
                        updateStatus('auth', 'success',
                            'Authentication service is ready',
                            `Auth ready: Yes\nCurrent user: ${auth.currentUser ? auth.currentUser.email : 'Not signed in'}\nGoogle Sign-In can be tested with button below`
                        );
                    }).catch((error) => {
                        if (error.code === 'auth/operation-not-allowed') {
                            updateStatus('auth', 'error',
                                'Google Authentication is not enabled',
                                `<strong>Problem:</strong> ${error.message}\n\n<strong>Fix:</strong>\n1. Go to Firebase Console ‚Üí Authentication\n2. Click "Sign-in method" tab\n3. Enable "Google" provider\n4. Save changes`
                            );
                        } else {
                            updateStatus('auth', 'warning',
                                'Authentication service initialized',
                                `Note: ${error.message}`
                            );
                        }
                    });
                } else {
                    updateStatus('auth', 'error',
                        'Firebase Authentication not initialized',
                        `<strong>Problem:</strong> firebase.auth() returned null/undefined\n\n<strong>Fix:</strong>\nVerify firebase-auth-compat.js is loaded and Firebase is initialized`
                    );
                }
            } catch (error) {
                updateStatus('auth', 'error',
                    'Firebase Authentication error',
                    error.message
                );
            }
        }, 2000);

        // Test 5: Firestore
        setTimeout(() => {
            try {
                const db = firebase.firestore();

                if (db) {
                    // Try to read from Firestore
                    db.collection('_test_').limit(1).get()
                        .then(() => {
                            updateStatus('firestore', 'success',
                                'Firestore database is accessible',
                                'Database connection: Success\nDatabase is ready to store user theories'
                            );
                        })
                        .catch((error) => {
                            if (error.code === 'permission-denied') {
                                updateStatus('firestore', 'success',
                                    'Firestore database exists (security rules active)',
                                    'Database exists: Yes\nSecurity rules: Active (permission-denied is expected)\nThis is GOOD - means rules are protecting your data'
                                );
                            } else if (error.code === 'failed-precondition') {
                                updateStatus('firestore', 'error',
                                    'Firestore database not created',
                                    `<strong>Problem:</strong> ${error.message}\n\n<strong>Fix:</strong>\n1. Go to Firebase Console ‚Üí Firestore Database\n2. Click "Create database"\n3. Choose "Start in production mode"\n4. Select a location\n5. Deploy security rules`
                                );
                            } else {
                                updateStatus('firestore', 'warning',
                                    'Firestore initialized but may have issues',
                                    `Error: ${error.message}`
                                );
                            }
                        });
                } else {
                    updateStatus('firestore', 'error',
                        'Firestore not initialized',
                        `<strong>Problem:</strong> firebase.firestore() returned null/undefined\n\n<strong>Fix:</strong>\nVerify firebase-firestore-compat.js is loaded and Firebase is initialized`
                    );
                }
            } catch (error) {
                updateStatus('firestore', 'error',
                    'Firestore error',
                    error.message
                );
            }
        }, 2500);

        // Test 6: Firestore Query (test actual data reading)
        setTimeout(() => {
            try {
                const db = firebase.firestore();

                // Try to query the mythologies collection
                db.collection('mythologies').limit(3).get()
                    .then((snapshot) => {
                        if (snapshot.empty) {
                            updateStatus('query', 'warning',
                                'Firestore query works but "mythologies" collection is empty',
                                `Query succeeded: Yes\nDocuments found: 0\n\nThis is OK if you haven't uploaded data yet.\n\nTo upload data, run:\nnode scripts/upload-to-firebase.js`
                            );
                        } else {
                            const docs = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                docs.push(`${doc.id}: ${data.name || data.title || 'unnamed'}`);
                            });

                            updateStatus('query', 'success',
                                `Firestore query successful - found ${snapshot.size} documents`,
                                `Collection: mythologies\nDocuments found: ${snapshot.size}\n\nSample documents:\n${docs.join('\n')}`
                            );
                        }
                    })
                    .catch((error) => {
                        if (error.code === 'permission-denied') {
                            updateStatus('query', 'warning',
                                'Query blocked by security rules (may be normal)',
                                `Permission denied for public read\n\nThis may be intentional if:\n- Rules require authentication for reads\n- You're testing from localhost without proper CORS setup\n\nTo test with auth, sign in using the button below`
                            );
                        } else {
                            updateStatus('query', 'error',
                                'Firestore query failed',
                                `<strong>Error:</strong> ${error.message}\n\nCode: ${error.code || 'unknown'}`
                            );
                        }
                    });
            } catch (error) {
                updateStatus('query', 'error',
                    'Firestore query error',
                    error.message
                );
            }
        }, 3000);

        // Sign in button
        document.getElementById('signin-btn').addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);

                alert(`‚úÖ Successfully signed in as ${result.user.displayName}!\n\nYou can now use the user theories system.`);

                // Create a test user profile
                const db = firebase.firestore();
                await db.collection('users').doc(result.user.uid).set({
                    username: result.user.displayName,
                    email: result.user.email,
                    avatar: result.user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert('‚úÖ User profile created in Firestore!\n\nFirebase is fully working!\n\nYou can now:\n1. Go to Submit Theory page\n2. Create theories\n3. View your dashboard');

            } catch (error) {
                alert(`‚ùå Sign in failed:\n\n${error.message}\n\nCommon issues:\n- Pop-up blocked by browser\n- Google Sign-In not enabled in Firebase Console\n- Invalid OAuth configuration`);
            }
        });
    </script>
</body>
</html>

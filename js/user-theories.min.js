class UserTheories{constructor(){this.useFirestore=!1,this.theories=this.loadTheories(),this.listeners=new Map,this.init()}async init(){window.addEventListener("userLogin",()=>this.onUserLogin()),window.addEventListener("userLogout",()=>this.onUserLogout()),await this.initFirebase()}async initFirebase(){try{"undefined"!=typeof firebase&&window.firebaseDB&&(await window.firebaseDB.init(),this.useFirestore=!0,await this.migrateFromLocalStorage())}catch(e){this.useFirestore=!1}}async migrateFromLocalStorage(){const e="userTheories_migrated";localStorage.getItem(e)||0!==this.loadTheories().length||localStorage.setItem(e,"true")}loadTheories(){const e=localStorage.getItem("userTheories");return e?JSON.parse(e):[]}saveTheories(){localStorage.setItem("userTheories",JSON.stringify(this.theories))}generateId(){return`theory_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async submitTheory(e){if(!window.userAuth||!window.userAuth.isLoggedIn())return{success:!1,error:"You must be logged in to submit theories"};if(!e.title||e.title.trim().length<5)return{success:!1,error:"Title must be at least 5 characters"};const t=e.richContent&&e.richContent.panels&&e.richContent.panels.length>0,s=e.content&&e.content.trim().length>=50;if(!t&&!s)return{success:!1,error:"Theory must have content panels or at least 50 characters of text"};if(!e.category&&!e.topic)return{success:!1,error:"Please select a category or topic"};if(this.useFirestore)try{const t=await window.firebaseDB.createTheory(e);return{success:!0,theory:t.theory,theoryId:t.theoryId,message:"Theory submitted successfully!"}}catch(e){return{success:!1,error:e.message||"Failed to submit theory"}}const r=window.userAuth.getCurrentUser(),o={id:this.generateId(),title:e.title.trim(),summary:e.summary?e.summary.trim():"",richContent:e.richContent||null,content:e.content?e.content.trim():"",topic:e.topic||null,topicName:e.topicName||null,topicIcon:e.topicIcon||null,subtopic:e.subtopic||null,subtopicName:e.subtopicName||null,category:e.category||e.topic||"general",sources:e.sources?e.sources.trim():"",relatedMythologies:e.relatedMythologies||[],relatedPage:e.relatedPage||null,author:r.username,authorAvatar:r.avatar,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),votes:0,voters:[],comments:[],status:"published",views:0,tags:e.tags||[]};return this.theories.push(o),this.saveTheories(),this.addTheoryToUser(r.username,o.id),{success:!0,theory:o,message:"Theory submitted successfully!"}}async updateTheory(e,t){if(!window.userAuth||!window.userAuth.isLoggedIn())return{success:!1,error:"You must be logged in to edit theories"};if(this.useFirestore)try{return await window.firebaseDB.updateTheory(e,t),{success:!0,message:"Theory updated successfully!"}}catch(e){return{success:!1,error:e.message||"Failed to update theory"}}const s=window.userAuth.getCurrentUser(),r=this.theories.find(t=>t.id===e);return r?r.author!==s.username?{success:!1,error:"You can only edit your own theories"}:(t.title&&(r.title=t.title.trim()),void 0!==t.summary&&(r.summary=t.summary.trim()),t.content&&(r.content=t.content.trim()),t.richContent&&(r.richContent=t.richContent),t.category&&(r.category=t.category),t.topic&&(r.topic=t.topic),t.topicName&&(r.topicName=t.topicName),t.topicIcon&&(r.topicIcon=t.topicIcon),t.subtopic&&(r.subtopic=t.subtopic),t.subtopicName&&(r.subtopicName=t.subtopicName),void 0!==t.sources&&(r.sources=t.sources.trim()),t.relatedMythologies&&(r.relatedMythologies=t.relatedMythologies),t.tags&&(r.tags=t.tags),t.status&&(r.status=t.status),r.updatedAt=(new Date).toISOString(),this.saveTheories(),{success:!0,theory:r,message:"Theory updated successfully!"}):{success:!1,error:"Theory not found"}}async deleteTheory(e){if(!window.userAuth||!window.userAuth.isLoggedIn())return{success:!1,error:"You must be logged in to delete theories"};if(this.useFirestore)try{return await window.firebaseDB.deleteTheory(e),{success:!0,message:"Theory deleted successfully!"}}catch(e){return{success:!1,error:e.message||"Failed to delete theory"}}const t=window.userAuth.getCurrentUser(),s=this.theories.findIndex(t=>t.id===e);return-1===s?{success:!1,error:"Theory not found"}:this.theories[s].author!==t.username?{success:!1,error:"You can only delete your own theories"}:(this.theories.splice(s,1),this.saveTheories(),{success:!0,message:"Theory deleted successfully!"})}async getTheory(e){if(this.useFirestore)try{return await window.firebaseDB.getTheory(e)}catch(e){return null}return this.theories.find(t=>t.id===e)}async getAllTheories(e={}){if(this.useFirestore)try{return e.search?(await window.firebaseDB.searchTheories(e.search,e)).theories:(await window.firebaseDB.getTheories(e)).theories}catch(e){}let t=[...this.theories];if(t=e.status?t.filter(t=>t.status===e.status):t.filter(e=>"published"===e.status),e.topic&&(t=t.filter(t=>t.topic===e.topic)),e.subtopic&&(t=t.filter(t=>t.subtopic===e.subtopic)),e.category&&(t=t.filter(t=>t.category===e.category)),e.author&&(t=t.filter(t=>t.author===e.author)),e.mythology&&(t=t.filter(t=>t.relatedMythologies.some(t=>t.toLowerCase()===e.mythology.toLowerCase()))),e.relatedPage&&(t=t.filter(t=>t.relatedPage===e.relatedPage)),e.search){const s=e.search.toLowerCase();t=t.filter(e=>{const t=e.title.toLowerCase().includes(s),r=e.content?.toLowerCase().includes(s),o=e.richContent?.panels?.some(e=>e.title?.toLowerCase().includes(s)||e.content?.toLowerCase().includes(s));return t||r||o})}switch(e.sortBy||"newest"){case"newest":t.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt));break;case"oldest":t.sort((e,t)=>new Date(e.createdAt)-new Date(t.createdAt));break;case"popular":t.sort((e,t)=>t.votes-e.votes);break;case"views":t.sort((e,t)=>t.views-e.views)}return t}async voteTheory(e,t=1){if(!window.userAuth||!window.userAuth.isLoggedIn())return{success:!1,error:"You must be logged in to vote"};if(this.useFirestore)try{return await window.firebaseDB.voteTheory(e,t),{success:!0}}catch(e){return{success:!1,error:e.message||"Failed to vote"}}const s=window.userAuth.getCurrentUser(),r=this.theories.find(t=>t.id===e);if(!r)return{success:!1,error:"Theory not found"};const o=r.voters.findIndex(e=>e.username===s.username);if(-1!==o){const e=r.voters[o];e.direction===t?(r.votes-=t,r.voters.splice(o,1)):(r.votes-=e.direction,r.votes+=t,e.direction=t)}else r.votes+=t,r.voters.push({username:s.username,direction:t,votedAt:(new Date).toISOString()});return this.saveTheories(),{success:!0,votes:r.votes}}async addComment(e,t){if(!window.userAuth||!window.userAuth.isLoggedIn())return{success:!1,error:"You must be logged in to comment"};if(this.useFirestore)try{return{success:!0,comment:(await window.firebaseDB.addComment(e,t)).comment,message:"Comment added!"}}catch(e){return{success:!1,error:e.message||"Failed to add comment"}}const s=window.userAuth.getCurrentUser(),r=this.theories.find(t=>t.id===e);if(!r)return{success:!1,error:"Theory not found"};if(!t||t.trim().length<3)return{success:!1,error:"Comment must be at least 3 characters"};const o={id:this.generateId(),author:s.username,authorAvatar:s.avatar,content:t.trim(),createdAt:(new Date).toISOString(),votes:0};return r.comments.push(o),this.saveTheories(),{success:!0,comment:o,message:"Comment added!"}}async incrementViews(e){if(this.useFirestore)try{return void await window.firebaseDB.incrementViews(e)}catch(e){}const t=this.theories.find(t=>t.id===e);t&&(t.views=(t.views||0)+1,this.saveTheories())}addTheoryToUser(e,t){const s=JSON.parse(localStorage.getItem("users")||"{}");s[e]&&(s[e].theories||(s[e].theories=[]),s[e].theories.push(t),localStorage.setItem("users",JSON.stringify(s)))}getUserTheories(e){return this.getAllTheories({author:e,status:null})}async getComments(e){if(this.useFirestore)try{return await window.firebaseDB.getComments(e)}catch(e){return[]}const t=this.theories.find(t=>t.id===e);return t?t.comments:[]}listenToTheory(e,t){return this.useFirestore&&window.firebaseDB?window.firebaseDB.listenToTheory(e,t):()=>{}}listenToComments(e,t){return this.useFirestore&&window.firebaseDB?window.firebaseDB.listenToComments(e,t):()=>{}}stopListening(e){this.useFirestore&&window.firebaseDB&&window.firebaseDB.stopListening(e)}onUserLogin(){this.refreshTheoryDisplays()}onUserLogout(){this.refreshTheoryDisplays()}refreshTheoryDisplays(){window.dispatchEvent(new CustomEvent("theoriesUpdated"))}getCategoryIcon(e){return{pattern:"ğŸ”—",archaeological:"ğŸ›ï¸",textual:"ğŸ“–",alternative:"ğŸ§¬",geographic:"ğŸ—ºï¸",timeline:"â³",physics:"âš›ï¸",general:"ğŸ’¡"}[e]||"ğŸ’­"}getCategoryName(e){return{pattern:"Pattern Connections",archaeological:"Archaeological Correlations",textual:"Textual Analysis",alternative:"Alternative Interpretations",geographic:"Geographic Correlations",timeline:"Timeline Analysis",physics:"Physics Integration",general:"General Theory"}[e]||e}formatDate(e){const t=new Date(e),s=new Date-t,r=Math.floor(s/6e4),o=Math.floor(s/36e5),i=Math.floor(s/864e5);return r<1?"just now":r<60?`${r} minute${r>1?"s":""} ago`:o<24?`${o} hour${o>1?"s":""} ago`:i<7?`${i} day${i>1?"s":""} ago`:t.toLocaleDateString()}}window.userTheories=new UserTheories,"undefined"!=typeof module&&module.exports&&(module.exports=UserTheories);
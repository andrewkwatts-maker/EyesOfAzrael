class AdvancedSearchSystem{constructor(){this.db=null,this.initialized=!1,this.searchIndex=new Map,this.searchCache=new Map,this.searchHistory=[],this.searchAnalytics={queries:[],popularSearches:{},noResultsQueries:[],popularEntities:{}},this.config={fuzzyThreshold:.7,maxResults:100,minQueryLength:2,cacheTimeout:3e5,highlightTag:"mark",debounceDelay:300},this.loadAnalytics()}async init(){if(!this.initialized)try{if("undefined"==typeof firebase||!firebase.firestore)throw new Error("Firebase not initialized");this.db=firebase.firestore(),await this.buildSearchIndex(),this.initialized=!0}catch(e){throw e}}async buildSearchIndex(){try{(await this.db.collection("content").where("status","==","published").limit(1e3).get()).docs.forEach(e=>{const t=e.data();this.indexContent(t)})}catch(e){}}indexContent(e){const t=this.buildSearchableText(e),s=this.tokenize(t);this.searchIndex.set(e.id,{id:e.id,title:e.title,subtitle:e.subtitle||"",summary:e.summary,contentType:e.contentType,mythology:e.mythology,mythologyName:e.mythologyName,section:e.section,icon:e.icon,imageUrl:e.imageUrl,tags:e.tags||[],attributes:e.attributes||{},searchableText:t,tokens:s,createdAt:e.createdAt,views:e.views||0,votes:e.votes||0})}buildSearchableText(e){const t=[e.title,e.subtitle,e.summary,e.mythology,e.mythologyName,e.section,e.contentType];return e.tags&&Array.isArray(e.tags)&&t.push(...e.tags),e.attributes&&(e.attributes.domains&&t.push(...e.attributes.domains),e.attributes.titles&&t.push(...e.attributes.titles),e.attributes.symbols&&t.push(...e.attributes.symbols)),e.richContent&&e.richContent.panels&&e.richContent.panels.forEach(e=>{e.title&&t.push(e.title),e.content&&t.push(e.content)}),t.filter(Boolean).join(" ").toLowerCase()}tokenize(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>1)}async search(e,t={}){if(this.initialized||await this.init(),!e||e.trim().length<this.config.minQueryLength)return{results:[],totalResults:0,searchTime:0};const s=performance.now(),r=this.parseQuery(e),a=this.getCacheKey(e,t);if(this.searchCache.has(a)){const e=this.searchCache.get(a);if(Date.now()-e.timestamp<this.config.cacheTimeout)return e.results}let i=this.performSearch(r,t);i=this.applyFilters(i,t.filters||{}),i=this.sortResults(i,t.sortBy||"relevance");const o=i.length;i=i.slice(0,t.limit||this.config.maxResults),i=i.map(e=>this.highlightMatches(e,r));const n=performance.now()-s,c={results:i,totalResults:o,searchTime:Math.round(n),query:r,filters:t.filters||{}};return this.searchCache.set(a,{results:c,timestamp:Date.now()}),this.trackSearch(e,o),c}parseQuery(e){const t={original:e,terms:[],exactPhrases:[],wildcards:[],fieldSpecific:{},operators:{and:[],or:[],not:[]}},s=/"([^"]+)"/g;let r;for(;null!==(r=s.exec(e));)t.exactPhrases.push(r[1].toLowerCase()),e=e.replace(r[0],"");const a=/(\w+):(\w+)/g;for(;null!==(r=a.exec(e));){const s=r[1].toLowerCase(),a=r[2].toLowerCase();t.fieldSpecific[s]||(t.fieldSpecific[s]=[]),t.fieldSpecific[s].push(a),e=e.replace(r[0],"")}const i=/NOT\s+(\w+)/gi;for(;null!==(r=i.exec(e));)t.operators.not.push(r[1].toLowerCase()),e=e.replace(r[0],"");const o=/(\w+)\*/g;for(;null!==(r=o.exec(e));)t.wildcards.push(r[1].toLowerCase()),e=e.replace(r[0],"");const n=e.trim().split(/\s+/).filter(e=>e.length>0);return n.forEach((e,s)=>{"OR"===e.toUpperCase()?(s>0&&t.operators.or.push(n[s-1].toLowerCase()),s<n.length-1&&t.operators.or.push(n[s+1].toLowerCase())):"AND"===e.toUpperCase()?(s>0&&t.operators.and.push(n[s-1].toLowerCase()),s<n.length-1&&t.operators.and.push(n[s+1].toLowerCase())):"OR"!==e.toUpperCase()&&"AND"!==e.toUpperCase()&&"NOT"!==e.toUpperCase()&&t.terms.push(e.toLowerCase())}),0===t.operators.and.length&&0===t.operators.or.length&&(t.operators.and=t.terms),t}performSearch(e,t){const s=[];return this.searchIndex.forEach((t,r)=>{let a=0,i=[];if(e.exactPhrases.forEach(e=>{t.searchableText.includes(e)&&(a+=10,i.push({type:"exact",term:e}))}),Object.entries(e.fieldSpecific).forEach(([e,s])=>{s.forEach(s=>{t[e]&&t[e].toLowerCase()===s&&(a+=8,i.push({type:"field",field:e,value:s}))})}),e.wildcards.forEach(e=>{t.tokens.forEach(t=>{t.startsWith(e)&&(a+=5,i.push({type:"wildcard",term:e,matched:t}))})}),e.operators.and.length>0){let s=0;if(e.operators.and.forEach(e=>{const r=this.matchTerm(e,t);r>0&&(s++,a+=r,i.push({type:"and",term:e,score:r}))}),s<e.operators.and.length)return}if(e.operators.or.length>0){let s=!1;if(e.operators.or.forEach(e=>{const r=this.matchTerm(e,t);r>0&&(s=!0,a+=r,i.push({type:"or",term:e,score:r}))}),!s)return}let o=!1;e.operators.not.forEach(e=>{t.searchableText.includes(e)&&(o=!0)}),o||(0===e.operators.and.length&&0===e.operators.or.length&&e.terms.length>0&&e.terms.forEach(e=>{const s=this.matchTerm(e,t);a+=s,s>0&&i.push({type:"regular",term:e,score:s})}),a>0&&i.length>0&&s.push({...t,searchScore:a,matches:i}))}),s}matchTerm(e,t){let s=0;return t.title.toLowerCase().includes(e)&&(s+=10),t.subtitle.toLowerCase().includes(e)&&(s+=8),t.summary.toLowerCase().includes(e)&&(s+=5),t.tokens.includes(e)&&(s+=3),0===s&&t.tokens.forEach(t=>{const r=this.calculateSimilarity(e,t);r>=this.config.fuzzyThreshold&&(s+=2*r)}),s}calculateSimilarity(e,t){const s=e.length>t.length?e:t,r=e.length>t.length?t:e;if(0===s.length)return 1;const a=this.levenshteinDistance(s,r);return(s.length-a)/s.length}levenshteinDistance(e,t){const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let r=1;r<=t.length;r++)for(let a=1;a<=e.length;a++)t.charAt(r-1)===e.charAt(a-1)?s[r][a]=s[r-1][a-1]:s[r][a]=Math.min(s[r-1][a-1]+1,s[r][a-1]+1,s[r-1][a]+1);return s[t.length][e.length]}applyFilters(e,t){let s=e;return t.mythologies&&t.mythologies.length>0&&(s=s.filter(e=>t.mythologies.includes(e.mythology))),t.contentTypes&&t.contentTypes.length>0&&(s=s.filter(e=>t.contentTypes.includes(e.contentType))),t.domains&&t.domains.length>0&&(s=s.filter(e=>!(!e.attributes||!e.attributes.domains)&&t.domains.some(t=>e.attributes.domains.includes(t)))),t.tags&&t.tags.length>0&&(s=s.filter(e=>!!e.tags&&t.tags.some(t=>e.tags.includes(t)))),s}sortResults(e,t){switch(t){case"relevance":return e.sort((e,t)=>t.searchScore-e.searchScore);case"name":case"alphabetical":return e.sort((e,t)=>e.title.localeCompare(t.title));case"date":case"newest":return e.sort((e,t)=>{const s=e.createdAt?new Date(e.createdAt):new Date(0);return(t.createdAt?new Date(t.createdAt):new Date(0))-s});case"popular":case"votes":return e.sort((e,t)=>t.votes-e.votes);case"views":return e.sort((e,t)=>t.views-e.views);default:return e}}highlightMatches(e,t){const s=[...t.terms,...t.exactPhrases,...t.operators.and,...t.operators.or];return e.highlightedTitle=this.highlightText(e.title,s),e.highlightedSubtitle=this.highlightText(e.subtitle,s),e.highlightedSummary=this.highlightText(e.summary,s),e}highlightText(e,t){if(!e)return"";let s=e;return t.forEach(e=>{const t=new RegExp(`(${this.escapeRegex(e)})`,"gi");s=s.replace(t,`<${this.config.highlightTag}>$1</${this.config.highlightTag}>`)}),s}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async getAutocompleteSuggestions(e,t=10){if(!e||e.length<2)return[];const s=new Set,r=e.toLowerCase();return this.searchIndex.forEach(e=>{e.title.toLowerCase().includes(r)&&s.add(e.title)}),this.searchHistory.forEach(e=>{e.toLowerCase().includes(r)&&s.add(e)}),Array.from(s).slice(0,t)}getSpellingSuggestions(e){const t=[];return this.tokenize(e).forEach(e=>{let s=null,r=0;this.searchIndex.forEach(t=>{t.tokens.forEach(t=>{const a=this.calculateSimilarity(e,t);a>r&&a<1&&a>=this.config.fuzzyThreshold&&(r=a,s=t)})}),s&&r>=.75&&t.push({original:e,suggestion:s,confidence:r})}),t}getRelatedSearches(e,t=5){const s=new Set;return this.performSearch(this.parseQuery(e),{}).slice(0,10).forEach(e=>{e.tags.forEach(e=>s.add(e)),e.mythology&&s.add(e.mythologyName),e.contentType&&s.add(e.contentType)}),Array.from(s).slice(0,t)}getPopularSearches(e=10){return Object.entries(this.searchAnalytics.popularSearches).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({query:e,count:t}))}trackSearch(e,t){this.searchAnalytics.queries.push({query:e,resultCount:t,timestamp:new Date}),this.searchAnalytics.popularSearches[e]||(this.searchAnalytics.popularSearches[e]=0),this.searchAnalytics.popularSearches[e]++,0===t&&this.searchAnalytics.noResultsQueries.push({query:e,timestamp:new Date}),this.searchHistory.includes(e)||(this.searchHistory.unshift(e),this.searchHistory=this.searchHistory.slice(0,50)),this.saveAnalytics()}trackEntityView(e,t){this.searchAnalytics.popularEntities[e]||(this.searchAnalytics.popularEntities[e]={title:t,views:0}),this.searchAnalytics.popularEntities[e].views++,this.saveAnalytics()}getSearchTrends(e=7){const t=new Date;t.setDate(t.getDate()-e);const s=this.searchAnalytics.queries.filter(e=>new Date(e.timestamp)>=t),r={};return s.forEach(e=>{r[e.query]||(r[e.query]={count:0,avgResults:0}),r[e.query].count++,r[e.query].avgResults=(r[e.query].avgResults+e.resultCount)/2}),Object.entries(r).sort((e,t)=>t[1].count-e[1].count).slice(0,10).map(([e,t])=>({query:e,...t}))}getPopularEntities(e=10){return Object.entries(this.searchAnalytics.popularEntities).sort((e,t)=>t[1].views-e[1].views).slice(0,e).map(([e,t])=>({id:e,...t}))}getCacheKey(e,t){return`${e}_${JSON.stringify(t)}`}saveAnalytics(){try{localStorage.setItem("searchAnalytics",JSON.stringify(this.searchAnalytics)),localStorage.setItem("searchHistory",JSON.stringify(this.searchHistory))}catch(e){}}loadAnalytics(){try{const e=localStorage.getItem("searchAnalytics");e&&(this.searchAnalytics=JSON.parse(e));const t=localStorage.getItem("searchHistory");t&&(this.searchHistory=JSON.parse(t))}catch(e){}}clearCache(){this.searchCache.clear()}async getAvailableFacets(){const e={mythologies:new Set,contentTypes:new Set,domains:new Set,tags:new Set};return this.searchIndex.forEach(t=>{e.mythologies.add(t.mythology),e.contentTypes.add(t.contentType),t.attributes&&t.attributes.domains&&t.attributes.domains.forEach(t=>e.domains.add(t)),t.tags&&t.tags.forEach(t=>e.tags.add(t))}),{mythologies:Array.from(e.mythologies).sort(),contentTypes:Array.from(e.contentTypes).sort(),domains:Array.from(e.domains).sort(),tags:Array.from(e.tags).sort()}}async refreshIndex(){this.searchIndex.clear(),await this.buildSearchIndex()}}window.advancedSearchSystem=new AdvancedSearchSystem,"undefined"!=typeof module&&module.exports&&(module.exports=AdvancedSearchSystem);
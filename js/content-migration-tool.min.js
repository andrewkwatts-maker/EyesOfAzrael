class ContentExtractor{constructor(){this.parser=new DOMParser}extractMetadataFromPath(t){const e=t.split("/").filter(t=>t&&"."!==t);let s="",r="",i="";const n=e.findIndex(t=>"mythos"===t);n>=0&&n+1<e.length&&(s=e[n+1]),n>=0&&n+2<e.length&&(r=e[n+2]);const o=e[e.length-1];return o&&o.endsWith(".html")&&(i=o.replace(".html","")),{mythology:s,section:r,filename:i,contentType:this.inferContentType(r),filePath:t}}inferContentType(t){return{deities:"deity",heroes:"hero",creatures:"creature",places:"place",cosmology:"cosmology",concepts:"concept",rituals:"ritual",magic:"magic",herbs:"herb",symbols:"symbol",texts:"text",archetypes:"archetype",lineage:"lineage",events:"event",teachings:"concept",theology:"concept"}[t]||"concept"}extractContent(t,e){const s=this.parser.parseFromString(t,"text/html");return{title:this.extractTitle(s),subtitle:this.extractSubtitle(s),icon:this.extractIcon(s),summary:this.extractSummary(s),attributes:this.extractAttributes(s,e.contentType),richContent:this.extractRichContent(s),sources:this.extractSources(s),relatedContent:this.extractRelatedContent(s),...e}}extractTitle(t){let e=t.querySelector("header h1")?.textContent?.trim();if(e||(e=t.querySelector(".deity-header h2, .hero-header h2, .hero-section h2")?.textContent?.trim()),e||(e=t.querySelector("main h1, main h2")?.textContent?.trim()),!e){const s=t.querySelector("title")?.textContent?.trim();if(s){const t=s.split("-").map(t=>t.trim());e=t[t.length-1]}}return e&&(e=e.replace(/[âš¡ðŸ›ï¸ðŸ‘‘ðŸ”±ðŸ¦‰ðŸ’€ðŸŒŠðŸ”¥ðŸŒ™â˜€ï¸âš”ï¸ðŸ¦…ðŸðŸ’ªðŸ¹ðŸŒ¿]/g,"").trim()),e||"Untitled"}extractSubtitle(t){let e=t.querySelector(".subtitle")?.textContent?.trim();if(!e){const s=t.querySelector('.deity-header p[style*="1.5rem"], .hero-header p[style*="1.5rem"]');s&&(e=s.textContent.trim())}return e||""}extractIcon(t){let e=t.querySelector(".deity-icon, .hero-icon, .hero-icon-display")?.textContent?.trim();if(!e){const s=t.querySelector("header h1")?.textContent;if(s){const t=s.match(/[âš¡ðŸ›ï¸ðŸ‘‘ðŸ”±ðŸ¦‰ðŸ’€ðŸŒŠðŸ”¥ðŸŒ™â˜€ï¸âš”ï¸ðŸ¦…ðŸðŸ’ªðŸ¹ðŸŒ¿ðŸ²ðŸ¦ðŸ¦‹ðŸŒ¸ðŸ—¡ï¸âš–ï¸ðŸ“šðŸŽ­ðŸŽ¨ðŸŽµ]/);t&&(e=t[0])}}return e||""}extractSummary(t){let e=t.querySelector(".deity-header > p:not(.subtitle), .hero-header > p:not(.subtitle), .hero-description")?.textContent?.trim();if(e||(e=t.querySelector("main section:first-of-type > p:first-of-type")?.textContent?.trim()),e&&e.length>500){const t=e.match(/[^.!?]+[.!?]+/g)||[];e=t.slice(0,2).join(" ").trim()}return e||""}extractDeityAttributes(t){const e={titles:[],domains:[],symbols:[],sacredAnimals:[],sacredPlants:[],colors:[],consorts:[],children:[],parents:[],siblings:[]};t.querySelectorAll(".attribute-card").forEach(t=>{const s=t.querySelector(".attribute-label")?.textContent?.toLowerCase().trim(),r=t.querySelector(".attribute-value")?.textContent?.trim();s&&r&&(s.includes("title")?e.titles=this.splitAttributeValue(r):s.includes("domain")?e.domains=this.splitAttributeValue(r):s.includes("symbol")?e.symbols=this.splitAttributeValue(r):s.includes("sacred")&&s.includes("animal")?e.sacredAnimals=this.splitAttributeValue(r):s.includes("sacred")&&s.includes("plant")?e.sacredPlants=this.splitAttributeValue(r):s.includes("color")&&(e.colors=this.splitAttributeValue(r)))});const s=this.findSectionByHeading(t,"relationships","family");return s&&s.querySelectorAll("ul li").forEach(t=>{const s=t.textContent;s.toLowerCase().includes("parent")?e.parents=this.extractNames(s):s.toLowerCase().includes("consort")?e.consorts=this.extractNames(s):s.toLowerCase().includes("children")?e.children=this.extractNames(s):s.toLowerCase().includes("sibling")&&(e.siblings=this.extractNames(s))}),e}extractHeroAttributes(t){const e={epithet:"",parentage:[],notableDeeds:[],weapons:[],companions:[],fateOrDeath:""};t.querySelectorAll(".attribute-card").forEach(t=>{const s=t.querySelector(".attribute-label")?.textContent?.toLowerCase().trim(),r=t.querySelector(".attribute-value")?.textContent?.trim();s&&r&&(s.includes("title")||s.includes("epithet")?e.epithet=r:(s.includes("weapon")||s.includes("item"))&&(e.weapons=this.splitAttributeValue(r)))});const s=this.findSectionByHeading(t,"relationships","family");s&&s.querySelectorAll("ul li").forEach(t=>{const s=t.textContent;s.toLowerCase().includes("parent")&&(e.parentage=this.extractNames(s))});const r=this.findSectionByHeading(t,"mythology","stories","labors","deeds");return r&&r.querySelectorAll("ul li, .labor-card").forEach(t=>{const s=t.querySelector(".labor-title")?.textContent?.trim()||t.textContent.split(":")[0]?.trim();s&&s.length>5&&e.notableDeeds.push(s)}),e}extractCreatureAttributes(t){const e={species:"",appearance:"",abilities:[],weaknesses:[],habitat:"",origin:"",slainBy:""};t.querySelectorAll(".glass-card").forEach(t=>{const s=t.querySelector("h3")?.textContent?.toLowerCase().trim(),r=t.textContent.trim();s?.includes("feature")||s?.includes("description")?e.appearance=r.substring(0,500):(s?.includes("origin")||s?.includes("curse"))&&(e.origin=r.substring(0,500)),t.querySelectorAll("ul li").forEach(t=>{const s=t.textContent.trim();if(s.includes(":")){const t=s.split(":")[0].trim();t.length>0&&e.abilities.push(t)}})});const s=this.findSectionByHeading(t,"quest","perseus","heracles","hero");if(s){const t=s.textContent.match(/([A-Z][a-z]+)\s+(slew|killed|defeated|beheaded)/i);t&&(e.slainBy=t[1])}return e}extractAttributes(t,e){switch(e){case"deity":return this.extractDeityAttributes(t);case"hero":return this.extractHeroAttributes(t);case"creature":return this.extractCreatureAttributes(t);default:return{}}}extractRichContent(t){const e=[];return t.querySelectorAll("main > section:not(.deity-header):not(.hero-header):not(.hero-section):not(.interlink-panel)").forEach(t=>{const s=t.querySelector("h2, h3")?.textContent?.trim();if(!s)return;if(s.toLowerCase().includes("attribute"))return;const r=t.innerHTML;e.push({type:"text",title:s,content:this.cleanHtmlForPanel(r),style:"default"})}),{panels:e}}cleanHtmlForPanel(t){let e=t.replace(/\s+class="[^"]*"/g,"");return e=e.replace(/\s+style="[^"]*"/g,""),e=e.replace(/<(h[1-6]|p|ul|ol|li|strong|em|a)([^>]*)>/gi,"<$1>"),e.length>1e4&&(e=e.substring(0,1e4)+"..."),e}extractSources(t){const e=t.querySelector(".citation, .sources");return e?e.textContent.replace("Sources:","").trim():""}extractRelatedContent(t){const e=[];return t.querySelectorAll(".see-also-link").forEach(t=>{const s=t.textContent.trim().replace(/^[âš¡ðŸ‘‘ðŸ”±ðŸ¦‰ðŸ’€ðŸŒŠðŸ”¥ðŸŒ™â˜€ï¸âš”ï¸ðŸ¦…ðŸðŸ’ªðŸ¹ðŸŒ¿ðŸ²ðŸ¦ðŸ¦‹ðŸŒ¸ðŸ—¡ï¸âš–ï¸ðŸ“šðŸŽ­ðŸŽ¨ðŸŽµ]\s*/,"");s&&s.length>0&&e.push(s)}),e}findSectionByHeading(t,...e){const s=t.querySelectorAll("section");for(const t of s){const s=t.querySelector("h2, h3")?.textContent?.toLowerCase().trim();if(s&&e.some(t=>s.includes(t)))return t}return null}splitAttributeValue(t){return t.split(/[,;]/).map(t=>t.trim()).filter(t=>t.length>0&&!t.toLowerCase().includes("(disputed)")).map(t=>t.replace(/\([^)]*\)/g,"").trim())}extractNames(t){const e=t.indexOf(":");return e>0&&(t=t.substring(e+1)),t.split(/,|\sand\s/).map(t=>t.trim()).map(t=>t.replace(/\([^)]*\)/g,"").trim()).filter(t=>t.length>0&&t.length<50)}}class ContentMigrationTool{constructor(){this.extractor=new ContentExtractor,this.extractedContent=[],this.failedExtractions=[],this.stats={totalFiles:0,successful:0,failed:0,byType:{},byMythology:{}}}async processFile(t,e){try{const s=this.extractor.extractMetadataFromPath(t);if("index"===s.filename||"corpus-search"===s.filename)return null;const r=this.extractor.extractContent(e,s);if(!r.title||"Untitled"===r.title)throw new Error("Could not extract title");return this.stats.successful++,this.stats.byType[r.contentType]=(this.stats.byType[r.contentType]||0)+1,this.stats.byMythology[r.mythology]=(this.stats.byMythology[r.mythology]||0)+1,r}catch(e){return this.stats.failed++,this.failedExtractions.push({filePath:t,error:e.message}),null}}async processFiles(t){this.stats.totalFiles=t.length,this.extractedContent=[],this.failedExtractions=[];for(const e of t){const t=await this.processFile(e.path,e.html);t&&this.extractedContent.push(t)}return{extracted:this.extractedContent,failed:this.failedExtractions,stats:this.stats}}validateExtracted(){const t={valid:[],warnings:[],errors:[]};for(const e of this.extractedContent){const s=[];e.title||s.push("Missing title"),(!e.summary||e.summary.length<10)&&s.push("Summary too short or missing"),e.mythology||s.push("Missing mythology"),e.contentType||s.push("Missing content type"),"deity"!==e.contentType||e.attributes.domains&&0!==e.attributes.domains.length||s.push("Deity missing domains"),s.length>0?t.warnings.push({title:e.title,filePath:e.filePath,issues:s}):t.valid.push(e.title)}return t}generatePreviewReport(){return{timestamp:(new Date).toISOString(),stats:this.stats,sample:this.extractedContent.slice(0,5),failed:this.failedExtractions}}async uploadToFirestore(t={}){if(!window.firebaseContentDB)throw new Error("FirebaseContentDB not available");return await window.firebaseContentDB.batchCreateContent(this.extractedContent,{isDefault:!0,...t})}generateMigrationReport(t){return{timestamp:(new Date).toISOString(),extraction:{total:this.stats.totalFiles,successful:this.stats.successful,failed:this.stats.failed,byType:this.stats.byType,byMythology:this.stats.byMythology},upload:{successful:t.successful.length,failed:t.failed.length,items:t.successful},failures:{extraction:this.failedExtractions,upload:t.failed}}}reset(){this.extractedContent=[],this.failedExtractions=[],this.stats={totalFiles:0,successful:0,failed:0,byType:{},byMythology:{}}}}window.contentMigrationTool=new ContentMigrationTool,"undefined"!=typeof module&&module.exports&&(module.exports={ContentExtractor:ContentExtractor,ContentMigrationTool:ContentMigrationTool});
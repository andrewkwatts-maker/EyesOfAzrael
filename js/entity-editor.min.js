class EntityEditor{constructor(e,t={}){if(this.container=document.getElementById(e),!this.container)throw new Error(`Container with id "${e}" not found`);this.options={mode:t.mode||"create",entityType:t.entityType||null,entityId:t.entityId||null,onSave:t.onSave||null,onError:t.onError||null,autoSave:!1!==t.autoSave,autoSaveInterval:t.autoSaveInterval||3e4,...t},this.currentEntity=null,this.currentType=this.options.entityType,this.formData={},this.isDirty=!1,this.autoSaveTimer=null,this.crossReferenceCache={},this.validationErrors={},this.init()}async init(){try{await waitForFirebase(),"edit"===this.options.mode&&this.options.entityId&&await this.loadEntity(this.options.entityId,this.options.entityType),this.render(),this.options.autoSave&&this.setupAutoSave(),this.setupKeyboardShortcuts()}catch(e){this.showError("Failed to initialize editor: "+e.message)}}async loadEntity(e,t){try{const n=EntityLoader.getCollectionName(t),i=await db.collection(n).doc(e).get();if(!i.exists)throw new Error(`Entity ${e} not found in ${n}`);this.currentEntity={id:i.id,...i.data()},this.currentType=t,this.formData={...this.currentEntity},this.isDirty=!1}catch(e){throw e}}render(){this.container.innerHTML="",this.container.className="entity-editor-container";const e=this.renderHeader();if(this.container.appendChild(e),"create"===this.options.mode){const e=this.renderTypeSelector();this.container.appendChild(e)}if(this.currentType){const e=this.renderForm();this.container.appendChild(e);const t=this.renderPreviewPanel();this.container.appendChild(t);const n=this.renderFooter();this.container.appendChild(n)}this.attachEventListeners()}renderHeader(){const e=document.createElement("div");return e.className="editor-header",e.innerHTML=`\n            <div class="editor-header-content">\n                <h1 class="editor-title">\n                    ${"edit"===this.options.mode?"Edit":"Create"}\n                    ${this.currentType?EntityDisplay.getTypeLabel(this.currentType):"Entity"}\n                </h1>\n                ${this.currentEntity?`<p class="editor-subtitle">Editing: ${this.currentEntity.name||this.currentEntity.id}</p>`:""}\n            </div>\n            <div class="editor-header-actions">\n                <button class="btn-help" data-action="show-help">\n                    ‚ùì Help\n                </button>\n                ${this.isDirty?'<span class="unsaved-indicator">‚óè Unsaved changes</span>':""}\n            </div>\n        `,e}renderTypeSelector(){const e=document.createElement("div");e.className="editor-section type-selector-section";const t=[{value:"deity",label:"Deity",icon:"‚ö°",description:"Gods, goddesses, and divine beings"},{value:"hero",label:"Hero",icon:"üó°Ô∏è",description:"Legendary heroes and protagonists"},{value:"creature",label:"Creature",icon:"üêâ",description:"Mythical beasts and monsters"},{value:"item",label:"Artifact",icon:"‚öîÔ∏è",description:"Magical items and artifacts"},{value:"place",label:"Place",icon:"üèõÔ∏è",description:"Sacred sites and locations"},{value:"concept",label:"Concept",icon:"üí≠",description:"Abstract concepts and ideas"},{value:"magic",label:"Magic System",icon:"üîÆ",description:"Magical practices and systems"},{value:"theory",label:"Theory",icon:"üî¨",description:"Comparative mythology theories"},{value:"mythology",label:"Mythology",icon:"üìú",description:"Complete mythological systems"}];return t.map(e=>`\n            <option value="${e.value}" data-icon="${e.icon}">\n                ${e.icon} ${e.label} - ${e.description}\n            </option>\n        `).join(""),e.innerHTML=`\n            <h2>Select Entity Type</h2>\n            <div class="type-selector-grid">\n                ${t.map(e=>`\n                    <div class="type-option" data-type="${e.value}">\n                        <div class="type-icon">${e.icon}</div>\n                        <div class="type-label">${e.label}</div>\n                        <div class="type-description">${e.description}</div>\n                    </div>\n                `).join("")}\n            </div>\n        `,e}renderForm(){const e=document.createElement("form");return e.className="entity-editor-form",e.id="entityEditorForm",e.appendChild(this.renderCommonFields()),e.appendChild(this.renderTypeSpecificFields()),e.appendChild(this.renderMetadataFields()),e.appendChild(this.renderCrossReferencesSection()),e.appendChild(this.renderSourcesSection()),e}renderCommonFields(){const e=document.createElement("div");return e.className="editor-section common-fields",e.innerHTML=`\n            <h2>Basic Information</h2>\n\n            <div class="form-group required">\n                <label for="entity-name">Name</label>\n                <input\n                    type="text"\n                    id="entity-name"\n                    name="name"\n                    required\n                    maxlength="100"\n                    placeholder="Entity name in English"\n                    value="${this.formData.name||""}"\n                >\n                <span class="field-hint">Primary display name (required)</span>\n            </div>\n\n            <div class="form-group">\n                <label for="entity-icon">Icon</label>\n                <input\n                    type="text"\n                    id="entity-icon"\n                    name="icon"\n                    maxlength="10"\n                    placeholder="üìú (emoji or unicode character)"\n                    value="${this.formData.icon||""}"\n                >\n                <span class="field-hint">Single emoji or unicode character for visual identification</span>\n            </div>\n\n            <div class="form-group required">\n                <label for="entity-mythologies">Mythologies</label>\n                <div class="tag-input-container" id="mythologies-tags">\n                    ${this.renderTagInput("mythologies",this.formData.mythologies||[],this.getMythologySuggestions())}\n                </div>\n                <span class="field-hint">Which mythologies does this entity appear in? (at least one required)</span>\n            </div>\n\n            <div class="form-group">\n                <label for="entity-short-description">Short Description</label>\n                <textarea\n                    id="entity-short-description"\n                    name="shortDescription"\n                    maxlength="200"\n                    rows="2"\n                    placeholder="One-sentence summary (max 200 characters)"\n                >${this.formData.shortDescription||""}</textarea>\n                <span class="char-counter">\n                    <span class="current">${(this.formData.shortDescription||"").length}</span> / 200\n                </span>\n            </div>\n\n            <div class="form-group">\n                <label for="entity-long-description">\n                    Full Description\n                    <button type="button" class="btn-preview-toggle" data-field="longDescription">\n                        üëÅÔ∏è Toggle Preview\n                    </button>\n                </label>\n                <div class="markdown-editor">\n                    <textarea\n                        id="entity-long-description"\n                        name="longDescription"\n                        rows="10"\n                        placeholder="Detailed description (Markdown supported)"\n                    >${this.formData.longDescription||""}</textarea>\n                    <div class="markdown-preview" id="preview-longDescription" style="display: none;">\n                        ${this.renderMarkdown(this.formData.longDescription||"")}\n                    </div>\n                </div>\n                <span class="field-hint">Full description with rich formatting (Markdown supported: **bold**, *italic*, lists, etc.)</span>\n            </div>\n\n            <div class="form-group">\n                <label for="entity-tags">Tags</label>\n                <div class="tag-input-container" id="tags-input">\n                    ${this.renderTagInput("tags",this.formData.tags||[])}\n                </div>\n                <span class="field-hint">Searchable tags for discovery (press Enter to add)</span>\n            </div>\n        `,e}renderTypeSpecificFields(){const e=document.createElement("div");switch(e.className="editor-section type-specific-fields",this.currentType){case"deity":e.appendChild(this.renderDeityFields());break;case"hero":e.appendChild(this.renderHeroFields());break;case"creature":e.appendChild(this.renderCreatureFields());break;case"item":e.appendChild(this.renderItemFields());break;case"place":e.appendChild(this.renderPlaceFields());break;case"concept":e.appendChild(this.renderConceptFields());break;case"magic":e.appendChild(this.renderMagicFields());break;case"theory":e.appendChild(this.renderTheoryFields());break;case"mythology":e.appendChild(this.renderMythologyFields())}return e}renderDeityFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Deity-Specific Information</h2>\n\n            <div class="form-group">\n                <label for="deity-domains">Domains</label>\n                <div class="tag-input-container" id="domains-tags">\n                    ${this.renderTagInput("domains",this.formData.domains||[],["war","wisdom","love","death","nature","fertility","sky","sea","underworld","sun","moon","fire","water","earth","air"])}\n                </div>\n                <span class="field-hint">Areas of divine influence (e.g., war, wisdom, love)</span>\n            </div>\n\n            <div class="form-group">\n                <label for="deity-symbols">Symbols</label>\n                <div class="tag-input-container" id="symbols-tags">\n                    ${this.renderTagInput("symbols",this.formData.symbols||[],["eagle","lightning bolt","trident","sword","crown","scepter","owl","dove","serpent"])}\n                </div>\n                <span class="field-hint">Sacred symbols and emblems</span>\n            </div>\n\n            <div class="form-group">\n                <label for="deity-epithets">Epithets & Titles</label>\n                <div class="dynamic-list" id="epithets-list">\n                    ${this.renderDynamicList("epithets",this.formData.epithets||[],"Add epithet or title")}\n                </div>\n                <span class="field-hint">Alternative names, titles, and epithets</span>\n            </div>\n\n            <div class="form-group">\n                <label for="deity-relationships">Relationships</label>\n                <div class="relationships-editor" id="relationships-editor">\n                    ${this.renderRelationshipsEditor(this.formData.relationships||{})}\n                </div>\n                <span class="field-hint">Family relationships and divine connections</span>\n            </div>\n        `,e}renderHeroFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Hero-Specific Information</h2>\n\n            <div class="form-group">\n                <label>Parentage</label>\n                <div class="parentage-editor">\n                    <div class="form-group">\n                        <label for="hero-father">Father</label>\n                        <input type="text" id="hero-father" name="parentage.father"\n                            value="${this.formData.parentage?.father||""}"\n                            placeholder="Father's name (or 'unknown')">\n                    </div>\n                    <div class="form-group">\n                        <label for="hero-mother">Mother</label>\n                        <input type="text" id="hero-mother" name="parentage.mother"\n                            value="${this.formData.parentage?.mother||""}"\n                            placeholder="Mother's name (or 'unknown')">\n                    </div>\n                    <div class="form-group">\n                        <label class="checkbox-label">\n                            <input type="checkbox" id="hero-divine" name="parentage.divine"\n                                ${this.formData.parentage?.divine?"checked":""}>\n                            <span>Divine Heritage</span>\n                        </label>\n                    </div>\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="hero-quests">Legendary Quests</label>\n                <div class="dynamic-list" id="quests-list">\n                    ${this.renderDynamicList("quests",this.formData.quests||[],"Add quest or accomplishment")}\n                </div>\n                <span class="field-hint">Major quests and accomplishments</span>\n            </div>\n\n            <div class="form-group">\n                <label for="hero-abilities">Abilities</label>\n                <div class="tag-input-container" id="abilities-tags">\n                    ${this.renderTagInput("abilities",this.formData.abilities||[],["superhuman strength","invulnerability","divine favor","combat mastery","archery","swordsmanship"])}\n                </div>\n                <span class="field-hint">Special abilities and powers</span>\n            </div>\n\n            <div class="form-group">\n                <label for="hero-weapons">Weapons & Equipment</label>\n                <div class="cross-reference-picker" id="weapons-picker">\n                    ${this.renderCrossReferencePicker("weapons","item",this.formData.weapons||[])}\n                </div>\n                <span class="field-hint">Associated artifacts and weapons</span>\n            </div>\n        `,e}renderCreatureFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Creature-Specific Information</h2>\n\n            <div class="form-group">\n                <label for="creature-physical">Physical Description</label>\n                <textarea id="creature-physical" name="physicalDescription" rows="5"\n                    placeholder="Detailed physical appearance">${this.formData.physicalDescription||""}</textarea>\n            </div>\n\n            <div class="form-group">\n                <label for="creature-abilities">Abilities & Powers</label>\n                <div class="tag-input-container" id="creature-abilities-tags">\n                    ${this.renderTagInput("abilities",this.formData.abilities||[],["flight","fire breath","regeneration","shape-shifting","petrification"])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="creature-weaknesses">Weaknesses</label>\n                <div class="tag-input-container" id="weaknesses-tags">\n                    ${this.renderTagInput("weaknesses",this.formData.weaknesses||[],["silver","iron","sunlight","holy water","decapitation"])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="creature-slain-by">Defeated By</label>\n                <div class="cross-reference-picker" id="slain-by-picker">\n                    ${this.renderCrossReferencePicker("slainBy","hero",this.formData.slainBy||[])}\n                </div>\n                <span class="field-hint">Heroes who defeated this creature</span>\n            </div>\n        `,e}renderItemFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Artifact-Specific Information</h2>\n\n            <div class="form-group">\n                <label for="item-powers">Powers & Abilities</label>\n                <div class="dynamic-list" id="powers-list">\n                    ${this.renderDynamicList("powers",this.formData.powers||[],"Add power or ability")}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="item-materials">Materials</label>\n                <div class="tag-input-container" id="materials-tags">\n                    ${this.renderTagInput("materials",this.formData.materials||[],["gold","silver","bronze","iron","adamantine","celestial metal"])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="item-created-by">Created By</label>\n                <div class="cross-reference-picker" id="created-by-picker">\n                    ${this.renderCrossReferencePicker("createdBy","deity",this.formData.createdBy||[])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="item-wielders">Notable Wielders</label>\n                <div class="cross-reference-picker" id="wielders-picker">\n                    ${this.renderCrossReferencePicker("wielders","deity,hero",this.formData.wielders||[])}\n                </div>\n            </div>\n        `,e}renderPlaceFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Place-Specific Information</h2>\n\n            <div class="form-group">\n                <label for="place-location">Coordinates (if known)</label>\n                <div class="coordinates-input">\n                    <input type="number" step="0.0001" min="-90" max="90"\n                        id="place-latitude" name="geographical.primaryLocation.coordinates.latitude"\n                        placeholder="Latitude" value="${this.formData.geographical?.primaryLocation?.coordinates?.latitude||""}">\n                    <input type="number" step="0.0001" min="-180" max="180"\n                        id="place-longitude" name="geographical.primaryLocation.coordinates.longitude"\n                        placeholder="Longitude" value="${this.formData.geographical?.primaryLocation?.coordinates?.longitude||""}">\n                </div>\n                <span class="field-hint">Geographical coordinates for real-world locations</span>\n            </div>\n\n            <div class="form-group">\n                <label for="place-inhabitants">Inhabitants</label>\n                <div class="cross-reference-picker" id="inhabitants-picker">\n                    ${this.renderCrossReferencePicker("inhabitants","deity,creature,hero",this.formData.inhabitants||[])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="place-events">Major Events</label>\n                <div class="dynamic-list" id="events-list">\n                    ${this.renderDynamicList("events",this.formData.events||[],"Add significant event")}\n                </div>\n            </div>\n        `,e}renderConceptFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Concept-Specific Information</h2>\n\n            <div class="form-group">\n                <label for="concept-opposites">Opposing Concepts</label>\n                <div class="cross-reference-picker" id="opposites-picker">\n                    ${this.renderCrossReferencePicker("opposites","concept",this.formData.opposites||[])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="concept-personifications">Personified As</label>\n                <div class="cross-reference-picker" id="personifications-picker">\n                    ${this.renderCrossReferencePicker("personifications","deity",this.formData.personifications||[])}\n                </div>\n                <span class="field-hint">Deities who personify this concept</span>\n            </div>\n        `,e}renderMagicFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Magic System Information</h2>\n\n            <div class="form-group">\n                <label for="magic-techniques">Techniques & Methods</label>\n                <div class="dynamic-list" id="techniques-list">\n                    ${this.renderDynamicList("techniques",this.formData.techniques||[],"Add technique or method")}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="magic-tools">Tools & Materials</label>\n                <div class="tag-input-container" id="tools-tags">\n                    ${this.renderTagInput("tools",this.formData.tools||[],["wand","staff","crystal","herbs","candles","runes","sigils"])}\n                </div>\n            </div>\n\n            <div class="form-group">\n                <label for="magic-warnings">Safety Warnings</label>\n                <div class="dynamic-list" id="warnings-list">\n                    ${this.renderDynamicList("safetyWarnings",this.formData.safetyWarnings||[],"Add safety warning")}\n                </div>\n                <span class="field-hint">Important cautions for practitioners</span>\n            </div>\n        `,e}renderTheoryFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Theory Information</h2>\n\n            <div class="form-group">\n                <label for="theory-warning">Intellectual Honesty Warning</label>\n                <textarea id="theory-warning" name="intellectualHonestyWarning" rows="3"\n                    placeholder="Statement about the speculative nature of this theory">${this.formData.intellectualHonestyWarning||""}</textarea>\n                <span class="field-hint">Required disclaimer about evidence and speculation</span>\n            </div>\n\n            <div class="form-group">\n                <label for="theory-confidence">Confidence Score (0-100)</label>\n                <input type="range" id="theory-confidence" name="confidence"\n                    min="0" max="100" value="${this.formData.confidence||50}">\n                <output id="confidence-value">${this.formData.confidence||50}%</output>\n            </div>\n\n            <div class="form-group">\n                <label for="theory-alternatives">Alternative Explanations</label>\n                <div class="dynamic-list" id="alternatives-list">\n                    ${this.renderDynamicList("alternativeExplanations",this.formData.alternativeExplanations||[],"Add alternative explanation")}\n                </div>\n            </div>\n        `,e}renderMythologyFields(){const e=document.createElement("div");return e.innerHTML=`\n            <h2>Mythology System Information</h2>\n\n            <div class="form-group">\n                <label for="mythology-creation">Creation Myth</label>\n                <textarea id="mythology-creation" name="creationMyth" rows="8"\n                    placeholder="How this mythology explains the origin of the world">${this.formData.creationMyth||""}</textarea>\n            </div>\n\n            <div class="form-group">\n                <label for="mythology-cosmology">Cosmology</label>\n                <textarea id="mythology-cosmology" name="cosmology" rows="8"\n                    placeholder="Structure of the universe in this mythology">${this.formData.cosmology||""}</textarea>\n            </div>\n\n            <div class="form-group">\n                <label for="mythology-major-deities">Major Deities</label>\n                <div class="cross-reference-picker" id="major-deities-picker">\n                    ${this.renderCrossReferencePicker("majorDeities","deity",this.formData.majorDeities||[])}\n                </div>\n            </div>\n        `,e}renderMetadataFields(){const e=document.createElement("div");return e.className="editor-section metadata-fields collapsible collapsed",e.innerHTML=`\n            <h2 class="collapsible-header">\n                <button type="button" class="collapse-toggle">‚ñ∂</button>\n                Advanced Metadata (Optional)\n            </h2>\n            <div class="collapsible-content">\n                ${this.renderLinguisticFields()}\n                ${this.renderGeographicalFields()}\n                ${this.renderTemporalFields()}\n            </div>\n        `,e}renderLinguisticFields(){return`\n            <div class="metadata-subsection">\n                <h3>Linguistic Information</h3>\n\n                <div class="form-group">\n                    <label for="ling-original-name">Original Name</label>\n                    <input type="text" id="ling-original-name" name="linguistic.originalName"\n                        value="${this.formData.linguistic?.originalName||""}"\n                        placeholder="Name in original script (e.g., ŒñŒµœçœÇ, ◊ô◊î◊ï◊î)">\n                </div>\n\n                <div class="form-group">\n                    <label for="ling-pronunciation">Pronunciation (IPA)</label>\n                    <input type="text" id="ling-pronunciation" name="linguistic.pronunciation"\n                        value="${this.formData.linguistic?.pronunciation||""}"\n                        placeholder="/zju:s/">\n                </div>\n\n                <div class="form-group">\n                    <label for="ling-etymology">Etymology</label>\n                    <textarea id="ling-etymology" name="linguistic.etymology.meaning" rows="3"\n                        placeholder="Word origin and meaning">${this.formData.linguistic?.etymology?.meaning||""}</textarea>\n                </div>\n            </div>\n        `}renderGeographicalFields(){return`\n            <div class="metadata-subsection">\n                <h3>Geographical Information</h3>\n\n                <div class="form-group">\n                    <label for="geo-region">Region</label>\n                    <input type="text" id="geo-region" name="geographical.region"\n                        value="${this.formData.geographical?.region||""}"\n                        placeholder="e.g., Mediterranean, Scandinavia">\n                </div>\n\n                <div class="form-group">\n                    <label for="geo-cultural-area">Cultural Area</label>\n                    <input type="text" id="geo-cultural-area" name="geographical.culturalArea"\n                        value="${this.formData.geographical?.culturalArea||""}"\n                        placeholder="e.g., Hellenistic World, Viking Age Scandinavia">\n                </div>\n            </div>\n        `}renderTemporalFields(){return`\n            <div class="metadata-subsection">\n                <h3>Historical Information</h3>\n\n                <div class="form-group">\n                    <label for="temp-period">Historical Period</label>\n                    <input type="text" id="temp-period" name="temporal.historicalPeriod"\n                        value="${this.formData.temporal?.historicalPeriod||""}"\n                        placeholder="e.g., Bronze Age, Classical Period">\n                </div>\n\n                <div class="form-group">\n                    <label for="temp-first-attestation">First Attestation</label>\n                    <input type="text" id="temp-first-attestation" name="temporal.firstAttestation.date"\n                        value="${this.formData.temporal?.firstAttestation?.date||""}"\n                        placeholder="e.g., c. 750 BCE">\n                </div>\n            </div>\n        `}renderCrossReferencesSection(){const e=document.createElement("div");return e.className="editor-section cross-references-section collapsible collapsed",e.innerHTML=`\n            <h2 class="collapsible-header">\n                <button type="button" class="collapse-toggle">‚ñ∂</button>\n                Cross-References\n            </h2>\n            <div class="collapsible-content">\n                <p class="section-description">Link this entity to related deities, heroes, creatures, items, places, and concepts.</p>\n\n                <div class="form-group">\n                    <label>Related Deities</label>\n                    <div class="cross-reference-picker" id="related-deities-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.deities","deity",this.formData.relatedEntities?.deities||[])}\n                    </div>\n                </div>\n\n                <div class="form-group">\n                    <label>Related Heroes</label>\n                    <div class="cross-reference-picker" id="related-heroes-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.heroes","hero",this.formData.relatedEntities?.heroes||[])}\n                    </div>\n                </div>\n\n                <div class="form-group">\n                    <label>Related Creatures</label>\n                    <div class="cross-reference-picker" id="related-creatures-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.creatures","creature",this.formData.relatedEntities?.creatures||[])}\n                    </div>\n                </div>\n\n                <div class="form-group">\n                    <label>Related Items</label>\n                    <div class="cross-reference-picker" id="related-items-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.items","item",this.formData.relatedEntities?.items||[])}\n                    </div>\n                </div>\n\n                <div class="form-group">\n                    <label>Related Places</label>\n                    <div class="cross-reference-picker" id="related-places-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.places","place",this.formData.relatedEntities?.places||[])}\n                    </div>\n                </div>\n\n                <div class="form-group">\n                    <label>Related Concepts</label>\n                    <div class="cross-reference-picker" id="related-concepts-picker">\n                        ${this.renderCrossReferencePicker("relatedEntities.concepts","concept",this.formData.relatedEntities?.concepts||[])}\n                    </div>\n                </div>\n            </div>\n        `,e}renderSourcesSection(){const e=document.createElement("div");e.className="editor-section sources-section collapsible collapsed";const t=this.formData.sources||[];return e.innerHTML=`\n            <h2 class="collapsible-header">\n                <button type="button" class="collapse-toggle">‚ñ∂</button>\n                Sources & Citations\n            </h2>\n            <div class="collapsible-content">\n                <p class="section-description">Add academic sources, primary texts, and references.</p>\n\n                <div id="sources-list">\n                    ${t.map((e,t)=>this.renderSourceItem(e,t)).join("")}\n                </div>\n\n                <button type="button" class="btn-add-source" data-action="add-source">\n                    ‚ûï Add Source\n                </button>\n            </div>\n        `,e}renderSourceItem(e={},t=0){return`\n            <div class="source-item" data-index="${t}">\n                <div class="source-item-header">\n                    <span class="source-number">#${t+1}</span>\n                    <button type="button" class="btn-remove-source" data-index="${t}">‚úï</button>\n                </div>\n                <div class="form-group">\n                    <label>Title</label>\n                    <input type="text" name="sources[${t}].title" value="${e.title||""}" placeholder="Source title">\n                </div>\n                <div class="form-group">\n                    <label>Author</label>\n                    <input type="text" name="sources[${t}].author" value="${e.author||""}" placeholder="Author name">\n                </div>\n                <div class="form-group">\n                    <label>Type</label>\n                    <select name="sources[${t}].type">\n                        <option value="primary" ${"primary"===e.type?"selected":""}>Primary Source</option>\n                        <option value="secondary" ${"secondary"===e.type?"selected":""}>Secondary Source</option>\n                        <option value="archaeological" ${"archaeological"===e.type?"selected":""}>Archaeological</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label>URL (optional)</label>\n                    <input type="url" name="sources[${t}].url" value="${e.url||""}" placeholder="https://...">\n                </div>\n            </div>\n        `}renderPreviewPanel(){const e=document.createElement("div");return e.className="preview-panel collapsed",e.id="preview-panel",e.innerHTML=`\n            <div class="preview-header">\n                <h3>Live Preview</h3>\n                <button type="button" class="btn-toggle-preview" data-action="toggle-preview">\n                    üëÅÔ∏è Toggle\n                </button>\n            </div>\n            <div class="preview-content">\n                <div id="entity-preview">\n                    ${this.renderEntityPreview()}\n                </div>\n            </div>\n        `,e}renderEntityPreview(){if(!this.formData.name)return'<p class="preview-empty">Fill in entity details to see preview...</p>';const e={...this.formData,type:this.currentType};return EntityDisplay.renderCard(e).outerHTML}renderFooter(){const e=document.createElement("div");e.className="editor-footer";const t=FirebaseService.isAuthenticated();return e.innerHTML=`\n            <div class="footer-actions">\n                <button type="button" class="btn-cancel" data-action="cancel">\n                    Cancel\n                </button>\n\n                ${t?`\n                    <button type="button" class="btn-save-draft" data-action="save-draft">\n                        üíæ Save Draft\n                    </button>\n                    <button type="button" class="btn-submit" data-action="submit">\n                        ‚úÖ ${"edit"===this.options.mode?"Update":"Submit for Review"}\n                    </button>\n                `:'\n                    <div class="login-required">\n                        <span class="warning-icon">‚ö†Ô∏è</span>\n                        <span>Please <a href="#" data-action="sign-in">sign in</a> to save entities</span>\n                    </div>\n                '}\n            </div>\n\n            <div class="footer-info">\n                <span class="auto-save-status" id="auto-save-status">\n                    ${this.options.autoSave?"Auto-save enabled":"Auto-save disabled"}\n                </span>\n            </div>\n        `,e}renderTagInput(e,t=[],n=[]){const i=t.map(t=>`\n            <span class="tag">\n                ${this.escapeHtml(t)}\n                <button type="button" class="tag-remove" data-field="${e}" data-value="${this.escapeHtml(t)}">√ó</button>\n            </span>\n        `).join(""),a=n.length>0?`\n            <datalist id="${e}-suggestions">\n                ${n.map(e=>`<option value="${e}">`).join("")}\n            </datalist>\n        `:"";return`\n            <div class="tag-input-wrapper">\n                <div class="tags-display">${i}</div>\n                <input\n                    type="text"\n                    class="tag-input"\n                    data-field="${e}"\n                    list="${e}-suggestions"\n                    placeholder="Type and press Enter..."\n                >\n                ${a}\n            </div>\n        `}renderDynamicList(e,t=[],n="Add item"){const i=t.map((t,i)=>`\n            <div class="dynamic-list-item" data-index="${i}">\n                <input type="text" name="${e}[${i}]" value="${this.escapeHtml(t)}" placeholder="${n}">\n                <button type="button" class="btn-remove-item" data-field="${e}" data-index="${i}">√ó</button>\n            </div>\n        `).join("");return`\n            <div class="dynamic-list-wrapper" data-field="${e}">\n                ${i}\n                <button type="button" class="btn-add-item" data-field="${e}">\n                    ‚ûï ${n}\n                </button>\n            </div>\n        `}renderCrossReferencePicker(e,t,n=[]){const i=t.split(",");return`\n            <div class="cross-ref-picker-wrapper" data-field="${e}" data-types="${t}">\n                <div class="selected-refs">\n                    ${n.map(t=>`\n                        <div class="ref-tag" data-id="${t}">\n                            <span class="ref-name">${t}</span>\n                            <button type="button" class="ref-remove" data-field="${e}" data-id="${t}">√ó</button>\n                        </div>\n                    `).join("")}\n                </div>\n                <div class="ref-search-box">\n                    <input\n                        type="text"\n                        class="ref-search-input"\n                        data-field="${e}"\n                        placeholder="Search ${i.join("/")}..."\n                    >\n                    <div class="ref-search-results" id="ref-results-${e}"></div>\n                </div>\n            </div>\n        `}renderRelationshipsEditor(e={}){return`\n            <div class="relationships-editor-wrapper">\n                ${["father","mother","spouse","children","siblings"].map(t=>`\n                    <div class="relationship-row">\n                        <label>${this.capitalize(t)}</label>\n                        <input type="text" name="relationships.${t}"\n                            value="${e[t]||""}"\n                            placeholder="Entity ID or name">\n                    </div>\n                `).join("")}\n            </div>\n        `}attachEventListeners(){this.container.querySelectorAll(".type-option").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.type;this.selectType(t)})}),this.container.querySelectorAll("input, textarea, select").forEach(e=>{e.addEventListener("input",()=>{this.isDirty=!0,this.updateFormData()})}),this.container.querySelectorAll("textarea[maxlength]").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.parentElement.querySelector(".char-counter .current");t&&(t.textContent=e.target.value.length)})}),this.container.querySelectorAll(".btn-preview-toggle").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.field;this.toggleMarkdownPreview(t)})}),this.container.querySelectorAll(".tag-input").forEach(e=>{e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.addTag(e.target))})}),this.container.querySelectorAll(".tag-remove").forEach(e=>{e.addEventListener("click",e=>{this.removeTag(e.currentTarget)})}),this.container.querySelectorAll(".btn-add-item").forEach(e=>{e.addEventListener("click",e=>{this.addListItem(e.currentTarget.dataset.field)})}),this.container.querySelectorAll(".btn-remove-item").forEach(e=>{e.addEventListener("click",e=>{this.removeListItem(e.currentTarget)})}),this.container.querySelectorAll(".ref-search-input").forEach(e=>{e.addEventListener("input",e=>{this.searchCrossReferences(e.target)})}),this.container.querySelectorAll(".collapse-toggle").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.closest(".collapsible");t.classList.toggle("collapsed"),e.currentTarget.textContent=t.classList.contains("collapsed")?"‚ñ∂":"‚ñº"})}),this.container.querySelector('[data-action="add-source"]')?.addEventListener("click",()=>{this.addSource()}),this.container.querySelectorAll(".btn-remove-source").forEach(e=>{e.addEventListener("click",e=>{this.removeSource(e.currentTarget.dataset.index)})}),this.container.querySelector('[data-action="cancel"]')?.addEventListener("click",()=>{this.cancel()}),this.container.querySelector('[data-action="save-draft"]')?.addEventListener("click",()=>{this.saveDraft()}),this.container.querySelector('[data-action="submit"]')?.addEventListener("click",()=>{this.submit()}),this.container.querySelector('[data-action="toggle-preview"]')?.addEventListener("click",()=>{this.togglePreview()}),this.container.querySelector('[data-action="show-help"]')?.addEventListener("click",()=>{this.showHelp()});const e=this.container.querySelector("#theory-confidence");e&&e.addEventListener("input",e=>{const t=this.container.querySelector("#confidence-value");t&&(t.textContent=e.target.value+"%")})}selectType(e){this.currentType=e,this.formData.type=e,this.isDirty=!0,this.render()}updateFormData(){const e=this.container.querySelector("#entityEditorForm");if(!e)return;const t=new FormData(e);for(const[e,n]of t.entries())this.setNestedValue(this.formData,e,n);this.container.querySelector(".preview-panel").classList.contains("collapsed")||this.updatePreview()}setNestedValue(e,t,n){const i=t.split(".");let a=e;for(let e=0;e<i.length-1;e++){const t=i[e];a[t]||(a[t]={}),a=a[t]}a[i[i.length-1]]=n}toggleMarkdownPreview(e){const t=this.container.querySelector(`#entity-${e}`),n=this.container.querySelector(`#preview-${e}`);t&&n&&("none"===n.style.display?(n.innerHTML=this.renderMarkdown(t.value),n.style.display="block",t.style.display="none"):(n.style.display="none",t.style.display="block"))}addTag(e){const t=e.value.trim();if(!t)return;const n=e.dataset.field;this.formData[n]||(this.formData[n]=[]),this.formData[n].includes(t)||(this.formData[n].push(t),this.isDirty=!0,e.closest(".tag-input-container").innerHTML=this.renderTagInput(n,this.formData[n]),this.attachEventListeners()),e.value=""}removeTag(e){const t=e.dataset.field,n=e.dataset.value;this.formData[t]&&(this.formData[t]=this.formData[t].filter(e=>e!==n),this.isDirty=!0,e.closest(".tag-input-container").innerHTML=this.renderTagInput(t,this.formData[t]),this.attachEventListeners())}addListItem(e){this.formData[e]||(this.formData[e]=[]),this.formData[e].push(""),this.isDirty=!0;const t=this.container.querySelector(`[data-field="${e}"]`);if(t&&t.classList.contains("dynamic-list-wrapper")){const n=t.querySelector(".btn-add-item").textContent.replace("‚ûï ","");t.innerHTML=this.renderDynamicList(e,this.formData[e],n),this.attachEventListeners()}}removeListItem(e){const t=e.dataset.field,n=parseInt(e.dataset.index);if(this.formData[t]){this.formData[t].splice(n,1),this.isDirty=!0;const e=this.container.querySelector(`[data-field="${t}"]`);if(e){const n=e.querySelector(".btn-add-item").textContent.replace("‚ûï ","");e.innerHTML=this.renderDynamicList(t,this.formData[t],n),this.attachEventListeners()}}}async searchCrossReferences(e){const t=e.value.trim().toLowerCase(),n=e.dataset.field,i=e.closest(".cross-ref-picker-wrapper").dataset.types.split(",");if(t.length<2){const e=this.container.querySelector(`#ref-results-${n}`);return void(e&&(e.innerHTML=""))}try{const a=(await EntityLoader.search(t,{collections:i.map(e=>EntityLoader.getCollectionName(e))})).slice(0,10).map(e=>`\n                <div class="ref-result-item" data-id="${e.id}" data-name="${e.name}">\n                    ${EntityDisplay.getEntityIcon({type:e.type})} ${e.name}\n                    <span class="ref-type">${e.type}</span>\n                </div>\n            `).join(""),r=this.container.querySelector(`#ref-results-${n}`);r&&(r.innerHTML=a,r.querySelectorAll(".ref-result-item").forEach(t=>{t.addEventListener("click",()=>{this.addCrossReference(n,t.dataset.id,t.dataset.name),e.value="",r.innerHTML=""})}))}catch(e){}}addCrossReference(e,t,n){const i=e.split(".");let a=this.formData;for(let e=0;e<i.length-1;e++)a[i[e]]||(a[i[e]]={}),a=a[i[e]];const r=i[i.length-1];if(a[r]||(a[r]=[]),!a[r].includes(t)){a[r].push(t),this.isDirty=!0;const n=this.container.querySelector(`[data-field="${e}"]`);if(n){const t=n.dataset.types;n.innerHTML=this.renderCrossReferencePicker(e,t,a[r]),this.attachEventListeners()}}}addSource(){this.formData.sources||(this.formData.sources=[]),this.formData.sources.push({title:"",author:"",type:"secondary",url:""}),this.isDirty=!0;const e=this.container.querySelector("#sources-list");e&&(e.innerHTML=this.formData.sources.map((e,t)=>this.renderSourceItem(e,t)).join(""),this.attachEventListeners())}removeSource(e){if(this.formData.sources){this.formData.sources.splice(parseInt(e),1),this.isDirty=!0;const t=this.container.querySelector("#sources-list");t&&(t.innerHTML=this.formData.sources.map((e,t)=>this.renderSourceItem(e,t)).join(""),this.attachEventListeners())}}togglePreview(){const e=this.container.querySelector(".preview-panel");e&&(e.classList.toggle("collapsed"),e.classList.contains("collapsed")||this.updatePreview())}updatePreview(){const e=this.container.querySelector("#entity-preview");e&&(e.innerHTML=this.renderEntityPreview())}validate(){return this.validationErrors={},this.formData.name||(this.validationErrors.name="Name is required"),this.formData.mythologies&&0!==this.formData.mythologies.length||(this.validationErrors.mythologies="At least one mythology is required"),"theory"!==this.currentType||this.formData.intellectualHonestyWarning||(this.validationErrors.intellectualHonestyWarning="Intellectual honesty warning is required for theories"),0===Object.keys(this.validationErrors).length}showValidationErrors(){this.container.querySelectorAll(".field-error").forEach(e=>e.remove()),Object.entries(this.validationErrors).forEach(([e,t])=>{const n=this.container.querySelector(`[name="${e}"]`);if(n){const e=document.createElement("span");e.className="field-error",e.textContent=t,n.parentElement.appendChild(e),n.classList.add("error")}})}async saveDraft(){try{if(!FirebaseService.isAuthenticated())return void this.showError("Please sign in to save drafts");this.updateFormData();const e={...this.formData,type:this.currentType,status:"draft",authorId:FirebaseService.getUserId(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};e.createdAt||(e.createdAt=firebase.firestore.FieldValue.serverTimestamp());const t=EntityLoader.getCollectionName(this.currentType);if(this.currentEntity&&this.currentEntity.id)await db.collection(t).doc(this.currentEntity.id).update(e),this.showSuccess("Draft saved successfully");else{const n=await db.collection(t).add(e);this.currentEntity={id:n.id,...e},this.showSuccess("Draft created successfully")}this.isDirty=!1,this.options.onSave&&this.options.onSave(this.currentEntity)}catch(e){this.showError("Failed to save draft: "+e.message),this.options.onError&&this.options.onError(e)}}async submit(){try{if(!FirebaseService.isAuthenticated())return void this.showError("Please sign in to submit entities");if(this.updateFormData(),!this.validate())return this.showValidationErrors(),void this.showError("Please fix validation errors before submitting");const e={...this.formData,type:this.currentType,status:"edit"===this.options.mode?"published":"pending_review",authorId:FirebaseService.getUserId(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};e.createdAt||(e.createdAt=firebase.firestore.FieldValue.serverTimestamp()),e.id||(e.id=this.generateEntityId(e.name));const t=EntityLoader.getCollectionName(this.currentType);this.currentEntity&&this.currentEntity.id?(await db.collection(t).doc(this.currentEntity.id).set(e,{merge:!0}),this.showSuccess("Entity updated successfully")):(await db.collection(t).doc(e.id).set(e),this.showSuccess("Entity submitted for review")),this.isDirty=!1,this.options.onSave&&this.options.onSave(e),setTimeout(()=>{window.location.href=`/view.html?type=${this.currentType}&id=${e.id}`},1500)}catch(e){this.showError("Failed to submit entity: "+e.message),this.options.onError&&this.options.onError(e)}}cancel(){this.isDirty&&!confirm("You have unsaved changes. Are you sure you want to cancel?")||(this.currentEntity&&this.currentEntity.id?window.location.href=`/view.html?type=${this.currentType}&id=${this.currentEntity.id}`:window.location.href="/index.html")}showHelp(){window.open("/ENTITY_EDITOR_GUIDE.md","_blank")}setupAutoSave(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.autoSaveTimer=setInterval(()=>{this.isDirty&&FirebaseService.isAuthenticated()&&(this.saveDraft(),this.updateAutoSaveStatus("Auto-saved at "+(new Date).toLocaleTimeString()))},this.options.autoSaveInterval)}updateAutoSaveStatus(e){const t=this.container.querySelector("#auto-save-status");t&&(t.textContent=e)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),this.saveDraft()),(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),this.submit()),"Escape"===e.key&&this.cancel()})}generateEntityId(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}getMythologySuggestions(){return["greek","roman","norse","egyptian","celtic","hindu","buddhist","christian","jewish","islamic","japanese","chinese","sumerian","babylonian","aztec","mayan","yoruba","native_american","persian","tarot","apocryphal"]}renderMarkdown(e){return e?e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>"):""}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}capitalize(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}showError(e){this.showNotification(e,"error")}showSuccess(e){this.showNotification(e,"success")}showNotification(e,t="info"){const n=document.createElement("div");n.className=`editor-notification ${t}`,n.innerHTML=`\n            <span class="notification-icon">\n                ${"error"===t?"‚ö†Ô∏è":"success"===t?"‚úÖ":"‚ÑπÔ∏è"}\n            </span>\n            <span class="notification-message">${e}</span>\n            <button class="notification-close">√ó</button>\n        `,n.querySelector(".notification-close").addEventListener("click",()=>{n.remove()}),document.body.appendChild(n),setTimeout(()=>{n.classList.add("show")},100),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},5e3)}}"undefined"!=typeof module&&module.exports&&(module.exports=EntityEditor);
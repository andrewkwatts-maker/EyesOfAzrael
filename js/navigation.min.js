import{ENTITY_ICONS,getEntityIcon}from"./constants/entity-types.js";class NavigationSystem{constructor(){this.mythologies=[],this.recentlyViewed=this.loadRecentlyViewed(),this.initialized=!1}async init(){if(!this.initialized)try{await this.loadMythologies(),this.initialized=!0}catch(e){}}async loadMythologies(){try{const e=await firebase.firestore().collection("mythologies").orderBy("name","asc").get();this.mythologies=e.docs.map(e=>({id:e.id,...e.data()}))}catch(e){this.mythologies=this.getFallbackMythologies()}}getFallbackMythologies(){return[{id:"greek",name:"Greek",icon:"‚ö°"},{id:"norse",name:"Norse",icon:"‚öîÔ∏è"},{id:"egyptian",name:"Egyptian",icon:"ìÇÄ"},{id:"hindu",name:"Hindu",icon:"üïâÔ∏è"},{id:"buddhist",name:"Buddhist",icon:"‚ò∏Ô∏è"},{id:"chinese",name:"Chinese",icon:"‚òØÔ∏è"},{id:"japanese",name:"Japanese",icon:"‚õ©Ô∏è"},{id:"celtic",name:"Celtic",icon:"‚òòÔ∏è"},{id:"aztec",name:"Aztec",icon:"ü¶Ö"},{id:"mayan",name:"Mayan",icon:"üêÜ"},{id:"christian",name:"Christian",icon:"‚úùÔ∏è"},{id:"islamic",name:"Islamic",icon:"‚ò™Ô∏è"},{id:"jewish",name:"Jewish",icon:"‚ú°Ô∏è"},{id:"roman",name:"Roman",icon:"üèõÔ∏è"},{id:"sumerian",name:"Sumerian",icon:"íÄ≠"},{id:"babylonian",name:"Babylonian",icon:"ü¶Å"}]}renderMythologyMenu(e,t={}){const n=document.getElementById(e);if(!n)return;const{maxItems:i=12,showIcons:a=!0,layout:o="grid",currentMythology:l=null}=t,s=this.mythologies.slice(0,i);"grid"===o?n.innerHTML=`\n                <div class="mythology-menu-grid">\n                    ${s.map(e=>`\n                        <a href="/mythos/${e.id}/index.html"\n                           class="mythology-menu-item ${e.id===l?"active":""}"\n                           data-mythology="${e.id}">\n                            ${a?`<span class="mythology-icon">${e.icon||"üåç"}</span>`:""}\n                            <span class="mythology-name">${e.name}</span>\n                        </a>\n                    `).join("")}\n                </div>\n            `:"list"===o?n.innerHTML=`\n                <ul class="mythology-menu-list">\n                    ${s.map(e=>`\n                        <li>\n                            <a href="/mythos/${e.id}/index.html"\n                               class="${e.id===l?"active":""}"\n                               data-mythology="${e.id}">\n                                ${a?`${e.icon||"üåç"} `:""}${e.name}\n                            </a>\n                        </li>\n                    `).join("")}\n                </ul>\n            `:"dropdown"===o&&(n.innerHTML=`\n                <select class="mythology-dropdown" onchange="window.location.href = this.value">\n                    <option value="">Select Mythology...</option>\n                    ${s.map(e=>`\n                        <option value="/mythos/${e.id}/index.html"\n                                ${e.id===l?"selected":""}>\n                            ${a?`${e.icon||"üåç"} `:""}${e.name}\n                        </option>\n                    `).join("")}\n                </select>\n            `)}generateBreadcrumb(e){const{mythology:t,entityType:n,entityName:i,customPath:a}=e,o=[{label:"Home",url:"/index.html"}];return a?o.push(...a):(t&&o.push({label:"Mythologies",url:"/mythos/index.html"},{label:this.capitalize(t),url:`/mythos/${t}/index.html`}),n&&o.push({label:this.capitalize(n)+"s",url:`/templates/entity-grid.html?type=${n}&mythology=${t}`}),i&&o.push({label:i,url:null})),this.renderBreadcrumb(o)}renderBreadcrumb(e){return e.map((t,n)=>n===e.length-1?`<span aria-current="page">${t.label}</span>`:`<a href="${t.url}">${t.label}</a>`).join(" ‚Üí ")}injectBreadcrumb(e,t){const n=document.getElementById(e);n&&(n.innerHTML=this.generateBreadcrumb(t))}trackEntityView(e){const t={id:e.id,type:e.type,name:e.name||e.title,mythology:e.mythology,icon:this.getEntityIcon(e),timestamp:Date.now()};this.recentlyViewed=this.recentlyViewed.filter(t=>t.id!==e.id),this.recentlyViewed.unshift(t),this.recentlyViewed=this.recentlyViewed.slice(0,10),this.saveRecentlyViewed()}getRecentlyViewed(e=5){return this.recentlyViewed.slice(0,e)}renderRecentlyViewed(e,t={}){const n=document.getElementById(e);if(!n)return;const{limit:i=5,showIcons:a=!0,excludeCurrentId:o=null}=t;let l=this.getRecentlyViewed(i+1);o&&(l=l.filter(e=>e.id!==o)),l=l.slice(0,i),0!==l.length?(n.innerHTML=`\n            <h3>Recently Viewed</h3>\n            <div class="recently-viewed-list">\n                ${l.map(e=>`\n                    <a href="/templates/entity-detail.html?type=${e.type}&id=${e.id}"\n                       class="recently-viewed-item">\n                        ${a?`<span class="recently-viewed-icon">${e.icon}</span>`:""}\n                        <div class="recently-viewed-info">\n                            <span class="recently-viewed-name">${e.name}</span>\n                            <span class="recently-viewed-type">${this.capitalize(e.mythology)} ${this.capitalize(e.type)}</span>\n                        </div>\n                    </a>\n                `).join("")}\n            </div>\n        `,n.style.display="block"):n.style.display="none"}clearRecentlyViewed(){this.recentlyViewed=[],this.saveRecentlyViewed()}loadRecentlyViewed(){try{const e=localStorage.getItem("recentlyViewed");return e?JSON.parse(e):[]}catch(e){return[]}}saveRecentlyViewed(){try{localStorage.setItem("recentlyViewed",JSON.stringify(this.recentlyViewed))}catch(e){}}getEntityIcon(e){return getEntityIcon(e)}capitalize(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}async renderRelatedEntities(e,t){const n=document.getElementById(t);if(n)if(e.relatedEntities||e.crossReferences){n.innerHTML="<p>Loading related entities...</p>",n.style.display="block";try{const t=await EntityLoader.loadCrossReferences(e);if(0===Object.keys(t).length)return void(n.style.display="none");let i="<h3>Related Entities</h3>";Object.entries(t).forEach(([e,t])=>{t&&t.length>0&&(i+=`<h4>${this.capitalize(e)}</h4>`,i+='<div class="related-entities-list">',t.forEach(e=>{i+=`\n                            <a href="/templates/entity-detail.html?type=${e.type}&id=${e.id}"\n                               class="related-entity-item">\n                                <span class="related-entity-icon">${this.getEntityIcon(e)}</span>\n                                <span class="related-entity-name">${e.name||e.title}</span>\n                            </a>\n                        `}),i+="</div>")}),n.innerHTML=i}catch(e){n.innerHTML="<p>Error loading related entities</p>"}}else n.style.display="none"}autoPopulateNavigation(){const e=window.location.pathname,t=new URLSearchParams(window.location.search),n={mythology:t.get("mythology")||this.extractMythologyFromPath(e),entityType:t.get("type"),entityId:t.get("id")};document.getElementById("breadcrumb-nav")&&this.injectBreadcrumb("breadcrumb-nav",n),document.getElementById("mythology-menu")&&this.renderMythologyMenu("mythology-menu",{currentMythology:n.mythology}),document.getElementById("recently-viewed")&&this.renderRecentlyViewed("recently-viewed",{excludeCurrentId:n.entityId}),this.setupHeaderFiltersIntegration()}setupHeaderFiltersIntegration(){const e=setInterval(()=>{window.headerFilters&&window.headerFilters.initialized&&(clearInterval(e),window.headerFilters.onFilterChange(e=>{this.handleFilterChange(e)}))},100);setTimeout(()=>clearInterval(e),1e4)}handleFilterChange(e){const t=document.getElementById("mythology-menu");t&&e.mythologies.length>0&&t.querySelectorAll("[data-mythology]").forEach(t=>{const n=t.dataset.mythology;e.mythologies.includes(n)?t.classList.add("filtered-active"):t.classList.remove("filtered-active")}),window.EntityLoader}extractMythologyFromPath(e){const t=e.match(/\/mythos\/([^\/]+)/);return t?t[1]:null}}async function initNavigation(){const e=()=>new Promise(t=>{window.firebaseApp&&window.firebaseDb?t():setTimeout(()=>e().then(t),100)});await e(),window.navigationSystem=new NavigationSystem,await window.navigationSystem.init(),window.navigationSystem.autoPopulateNavigation()}window.NavigationSystem=NavigationSystem,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initNavigation):initNavigation(),"undefined"!=typeof module&&module.exports&&(module.exports=NavigationSystem);
class UniversalAssetRenderer{constructor(e){this.db=e,this.cache=new Map}async render(e,s,n,t={}){if("string"==typeof e&&(e=await this.loadAsset(e)),e)switch(e.rendering&&e.rendering.modes&&!e.rendering.modes[s]&&(s=e.rendering.defaultMode||"panelCard"),s){case"hyperlink":n.innerHTML=this.renderHyperlink(e,t),this.attachHyperlinkListeners(n,e);break;case"expandableRow":n.innerHTML=this.renderExpandableRow(e,t),this.attachExpandableRowListeners(n,e);break;case"panelCard":n.innerHTML=this.renderPanelCard(e,t),this.attachPanelCardListeners(n,e);break;case"subsection":n.innerHTML=await this.renderSubsection(e,t),this.attachSubsectionListeners(n,e);break;case"fullPage":n.innerHTML=await this.renderFullPage(e,t),this.attachFullPageListeners(n,e);break;default:n.innerHTML=this.renderPanelCard(e,t)}else n.innerHTML='<p class="error">Asset not found</p>'}async loadAsset(e){if(this.cache.has(e))return this.cache.get(e);try{const s=["deities","mythologies","items","places","theories","archetypes","submissions"];for(const n of s){const s=await this.db.collection(n).doc(e).get();if(s.exists){const n={id:s.id,...s.data()};return this.cache.set(e,n),n}}return null}catch(e){return null}}renderHyperlink(e,s={}){const n=e.rendering?.hyperlink||{},t=!1!==n.showIcon,a=n.dropdownOptions&&n.dropdownOptions.length>0,i=t?e.icon||"ðŸ“„":"",r=e.name||e.title||"Untitled",d=this.getAssetRoute(e);return`\n            <span class="asset-hyperlink" data-asset-id="${e.id}" data-asset-type="${e.type}">\n                <a href="${d}" class="asset-link">\n                    ${i?`<span class="asset-icon">${i}</span>`:""}\n                    <span class="asset-name">${r}</span>\n                </a>\n                ${a?`\n                    <button class="asset-dropdown-trigger" aria-label="More options">â–¼</button>\n                    <div class="asset-dropdown-menu hidden">\n                        ${this.renderDropdownOptions(e,n.dropdownOptions)}\n                    </div>\n                `:""}\n            </span>\n        `}renderDropdownOptions(e,s){return s.map(s=>{const n=s.route?s.route.replace("{type}",e.type).replace("{id}",e.id):"#";return`\n                <button class="dropdown-option" data-action="${s.action}" data-route="${n}">\n                    ${s.icon} ${s.label}\n                </button>\n            `}).join("")}attachHyperlinkListeners(e,s){const n=e.querySelector(".asset-dropdown-trigger"),t=e.querySelector(".asset-dropdown-menu");n&&t&&(n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),t.classList.toggle("hidden")}),document.addEventListener("click",()=>{t.classList.add("hidden")}),t.querySelectorAll(".dropdown-option").forEach(e=>{e.addEventListener("click",n=>{n.preventDefault();const a=e.dataset.action,i=e.dataset.route;this.handleDropdownAction(a,i,s),t.classList.add("hidden")})}))}handleDropdownAction(e,s,n){switch(e){case"navigate":window.location.hash=s;break;case"expand":this.showQuickView(n);break;case"showReferences":this.showReferences(n);break;case"corpusSearch":this.openCorpusSearch(n)}}renderExpandableRow(e,s={}){const n=e.rendering?.expandableRow||{},t=!1!==n.showPreview,a=(n.previewFields,e.icon||"ðŸ“„"),i=e.name||e.title||"Untitled",r=e.description||"";return`\n            <div class="asset-expandable-row" data-asset-id="${e.id}" data-asset-type="${e.type}">\n                <div class="row-header">\n                    <button class="expand-toggle" aria-label="Expand">â–¶</button>\n                    ${a?`<span class="row-icon">${a}</span>`:""}\n                    <span class="row-name">${i}</span>\n                    ${t&&r?`<span class="row-preview">${r}</span>`:""}\n                </div>\n                <div class="row-content collapsed">\n                    ${this.renderRowContent(e,n.expandedFields)}\n                </div>\n            </div>\n        `}renderRowContent(e,s=[]){let n="";return s.includes("summary")&&e.summary&&(n+=`<div class="field-summary">${e.summary}</div>`),s.includes("attributes")&&e.attributes&&(n+=`<div class="field-attributes">${this.renderAttributes(e.attributes)}</div>`),s.includes("relationships")&&e.relationships&&(n+=`<div class="field-relationships">${this.renderRelationships(e.relationships)}</div>`),s.includes("metadata")&&e.metadata&&(n+=`<div class="field-metadata">${this.renderMetadata(e.metadata)}</div>`),n||"<p>No additional details available</p>"}attachExpandableRowListeners(e,s){const n=e.querySelector(".expand-toggle"),t=e.querySelector(".row-content");n&&t&&n.addEventListener("click",()=>{t.classList.contains("collapsed")?(t.classList.remove("collapsed"),t.classList.add("expanded"),n.textContent="â–¼",n.setAttribute("aria-label","Collapse")):(t.classList.remove("expanded"),t.classList.add("collapsed"),n.textContent="â–¶",n.setAttribute("aria-label","Expand"))})}renderPanelCard(e,s={}){const n=e.rendering?.panelCard||{},t=n.size||"medium",a=n.layout||"standard",i=n.showFields||["icon","name","description"],r=e.icon||"ðŸ“„",d=e.name||e.title||"Untitled",l=e.description||"",o=e.thumbnail||e.image,c=this.getAssetRoute(e),p=n.badge||e.metadata?.status;return`\n            <a href="${c}"\n               class="panel-card panel-card-${t} panel-card-${a}"\n               data-asset-id="${e.id}"\n               data-asset-type="${e.type}">\n                ${o?`\n                    <div class="card-image">\n                        <img src="${o}" alt="${d}" loading="lazy">\n                    </div>\n                `:""}\n                ${i.includes("icon")&&r?`\n                    <div class="card-icon">${r}</div>\n                `:""}\n                ${i.includes("name")?`\n                    <h3 class="card-title">${d}</h3>\n                `:""}\n                ${i.includes("description")&&l?`\n                    <p class="card-description">${l}</p>\n                `:""}\n                ${p?`\n                    <span class="card-badge">${p}</span>\n                `:""}\n                ${e.metadata?.tags?`\n                    <div class="card-tags">\n                        ${e.metadata.tags.slice(0,3).map(e=>`<span class="tag">${e}</span>`).join("")}\n                    </div>\n                `:""}\n            </a>\n        `}attachPanelCardListeners(e,s){const n=e.querySelector(".panel-card");n&&n.addEventListener("click",e=>{})}async renderSubsection(e,s={}){const n=e.rendering?.subsection||{},t=!1!==n.collapsible,a=n.defaultState||"expanded",i=!1!==n.showChildCount,r=e.icon||"ðŸ“„",d=e.name||e.title||"Untitled",l=await this.loadChildren(e),o=l.length;return`\n            <div class="subsection-panel" data-asset-id="${e.id}" data-asset-type="${e.type}">\n                <div class="subsection-header">\n                    ${t?'<button class="collapse-toggle" aria-label="Toggle">â–¼</button>':""}\n                    <h3 class="subsection-title">\n                        ${r?`<span class="subsection-icon">${r}</span>`:""}\n                        ${d}\n                    </h3>\n                    ${i&&o>0?`\n                        <span class="child-count">(${o})</span>\n                    `:""}\n                </div>\n                <div class="subsection-content ${"collapsed"===a?"collapsed":"expanded"}">\n                    ${e.summary||e.description||""}\n                    ${l.length>0?`\n                        <div class="subsection-children">\n                            ${this.renderChildren(l,n.childrenLayout)}\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `}async loadChildren(e){if(!e.relationships||!e.relationships.childIds)return[];const s=e.relationships.childIds.map(e=>this.loadAsset(e));return(await Promise.all(s)).filter(e=>null!==e)}renderChildren(e,s="grid"){return"grid"===s?`\n                <div class="children-grid">\n                    ${e.map(e=>this.renderPanelCard(e,{size:"small"})).join("")}\n                </div>\n            `:"list"===s?`\n                <ul class="children-list">\n                    ${e.map(e=>`\n                        <li>${this.renderHyperlink(e)}</li>\n                    `).join("")}\n                </ul>\n            `:""}attachSubsectionListeners(e,s){const n=e.querySelector(".collapse-toggle"),t=e.querySelector(".subsection-content");n&&t&&n.addEventListener("click",()=>{t.classList.contains("collapsed")?(t.classList.remove("collapsed"),t.classList.add("expanded"),n.textContent="â–¼"):(t.classList.remove("expanded"),t.classList.add("collapsed"),n.textContent="â–¶")})}async renderFullPage(e,s={}){const n=e.rendering?.fullPage||{},t=n.sections||["header","description","attributes","relationships"],a=n.sidebar||{enabled:!1},i=e.icon||"ðŸ“„",r=e.name||e.title||"Untitled",d=e.subtitle||"";return`\n            <div class="asset-page" data-asset-id="${e.id}" data-asset-type="${e.type}">\n                ${t.includes("header")?`\n                    <header class="page-header">\n                        <div class="header-icon">${i}</div>\n                        <h1 class="page-title">${r}</h1>\n                        ${d?`<p class="page-subtitle">${d}</p>`:""}\n                    </header>\n                `:""}\n\n                <div class="page-layout ${a.enabled?"with-sidebar":""}">\n                    ${a.enabled?`\n                        <aside class="page-sidebar sidebar-${a.position||"right"}">\n                            ${await this.renderSidebar(e,a)}\n                        </aside>\n                    `:""}\n\n                    <main class="page-content">\n                        ${await this.renderPageSections(e,t)}\n                    </main>\n                </div>\n            </div>\n        `}async renderPageSections(e,s){let n="";for(const t of s)switch(t){case"description":(e.description||e.summary||e.content)&&(n+=`\n                            <section class="section-description">\n                                <h2>Description</h2>\n                                ${e.content||e.summary||e.description}\n                            </section>\n                        `);break;case"attributes":e.attributes&&(n+=`\n                            <section class="section-attributes">\n                                <h2>Attributes</h2>\n                                ${this.renderAttributes(e.attributes)}\n                            </section>\n                        `);break;case"relationships":e.relationships&&(n+=`\n                            <section class="section-relationships">\n                                <h2>Relationships</h2>\n                                ${await this.renderRelationships(e.relationships)}\n                            </section>\n                        `);break;case"references":e.relationships?.references&&(n+=`\n                            <section class="section-references">\n                                <h2>References</h2>\n                                ${this.renderReferences(e.relationships.references)}\n                            </section>\n                        `);break;case"related":e.relationships?.relatedIds&&(n+=`\n                            <section class="section-related">\n                                <h2>Related</h2>\n                                <div class="related-grid">\n                                    ${(await this.loadRelatedAssets(e.relationships.relatedIds)).map(e=>this.renderPanelCard(e,{size:"small"})).join("")}\n                                </div>\n                            </section>\n                        `)}return n}async renderSidebar(e,s){const n=s.content||["toc","related"];let t="";return n.includes("toc")&&(t+='<div class="sidebar-toc"><h3>Contents</h3>\x3c!-- TOC --\x3e</div>'),n.includes("related")&&e.relationships?.relatedIds&&(t+=`\n                <div class="sidebar-related">\n                    <h3>Related</h3>\n                    ${(await this.loadRelatedAssets(e.relationships.relatedIds.slice(0,3))).map(e=>this.renderHyperlink(e)).join("<br>")}\n                </div>\n            `),t}attachFullPageListeners(e,s){}getAssetRoute(e){const s=e.type||"asset",n=e.id;return{deity:`#/mythology/${e.relationships?.mythology}/deities/${n}`,mythology:`#/mythology/${n}`,item:`#/item/${n}`,place:`#/place/${n}`,theory:`#/theory/${n}`,archetype:`#/archetype/${n}`,submission:`#/submission/${n}`}[s]||`#/${s}/${n}`}renderAttributes(e){return`\n            <dl class="attributes-list">\n                ${Object.entries(e).map(([e,s])=>`\n                    <dt>${this.formatKey(e)}</dt>\n                    <dd>${Array.isArray(s)?s.join(", "):s}</dd>\n                `).join("")}\n            </dl>\n        `}async renderRelationships(e){let s='<dl class="relationships-list">';if(e.parentId){const n=await this.loadAsset(e.parentId);s+=`<dt>Parent</dt><dd>${n?this.renderHyperlink(n):e.parentId}</dd>`}return e.relatedIds&&e.relatedIds.length>0&&(s+=`<dt>Related</dt><dd>${(await this.loadRelatedAssets(e.relatedIds)).map(e=>this.renderHyperlink(e)).join(", ")}</dd>`),s+="</dl>",s}renderReferences(e){return`\n            <ul class="references-list">\n                ${e.map(e=>`\n                    <li>\n                        <a href="${e.url||"#"}" target="_blank" rel="noopener">\n                            ${e.label||e.title||"Reference"}\n                        </a>\n                    </li>\n                `).join("")}\n            </ul>\n        `}renderMetadata(e){return`\n            <dl class="metadata-list">\n                ${e.category?`<dt>Category</dt><dd>${e.category}</dd>`:""}\n                ${e.tags?`<dt>Tags</dt><dd>${e.tags.join(", ")}</dd>`:""}\n                ${e.status?`<dt>Status</dt><dd>${e.status}</dd>`:""}\n            </dl>\n        `}async loadRelatedAssets(e){const s=e.map(e=>this.loadAsset(e));return(await Promise.all(s)).filter(e=>null!==e)}formatKey(e){return e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())}showQuickView(e){"undefined"!=typeof EntityQuickViewModal&&this.db?new EntityQuickViewModal(this.db).open(e.id,e.type||"assets",e.relationships?.mythology||"unknown"):window.location.hash=this.getAssetRoute(e)}showReferences(e){e.relationships?.references&&e.relationships.references.length>0&&(window.location.hash=this.getAssetRoute(e)+"#references")}openCorpusSearch(e){const s=e.name||e.title||"";window.location.hash=`#/search?q=${encodeURIComponent(s)}`}clearCache(){this.cache.clear()}}window.UniversalAssetRenderer=UniversalAssetRenderer;
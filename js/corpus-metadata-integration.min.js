class CorpusMetadataIntegration{constructor(t,e={}){this.corpusSearch=t,this.nameIndex=null,this.crossCulturalMap=null,this.initialized=!1,this.options={autoExpandNames:!0,includeCrossCultural:!0,maxAlternateTerms:5,annotateResults:!0,...e}}async init(t={}){const{nameIndexInstance:e=null,entities:a=null,crossCulturalMapPath:s="/data/cross-cultural-mapping.json",loadCrossCulturalMap:n=!0}=t;try{if(e)this.nameIndex=e;else if(this.nameIndex=new AlternateNameIndex,a)this.nameIndex.loadFromArray(a);else try{await this.nameIndex.loadFromDirectory("/data/entities")}catch(t){}if(n)try{const t=await fetch(s);t.ok&&(this.crossCulturalMap=await t.json())}catch(t){}return this.initialized=!0,!0}catch(t){throw t}}async searchWithMetadata(t,e={}){const{caseSensitive:a=!1,maxResults:s=100,contextWords:n=10,expandNames:i=this.options.autoExpandNames,includeCrossCultural:r=this.options.includeCrossCultural,annotate:o=this.options.annotateResults,...l}=e;let u=[t];if(i&&this.nameIndex&&this.nameIndex.initialized&&(u=this.nameIndex.expandSearchTerms(t,{includePartialMatches:!1,maxAlternates:this.options.maxAlternateTerms})),r&&this.crossCulturalMap){const e=this._getCrossCulturalEquivalents(t);u.push(...e)}u=[...new Set(u)];const c=await this.corpusSearch.search(t,{caseSensitive:a,maxResults:s,contextWords:n,terms:u,matchAll:!1,...l});return o&&this.nameIndex&&this.nameIndex.initialized?this._annotateResults(c,t,u):c}async search(t,e={}){return await this.corpusSearch.search(t,e)}_getCrossCulturalEquivalents(t){if(!this.crossCulturalMap)return[];const e=t.toLowerCase().trim(),a=[];if(this.crossCulturalMap.deityEquivalents)for(const t of this.crossCulturalMap.deityEquivalents)if(t.names.map(t=>t.toLowerCase()).includes(e))for(const s of t.names)s.toLowerCase()!==e&&a.push(s);if(this.crossCulturalMap.conceptEquivalents)for(const t of this.crossCulturalMap.conceptEquivalents)if(t.names.map(t=>t.toLowerCase()).includes(e))for(const s of t.names)s.toLowerCase()!==e&&a.push(s);return a}_annotateResults(t,e,a){return t.map(t=>{const s={originalSearchTerm:e,expandedTerms:a,matchedViaAlternate:t.matched_term!==e,entityMetadata:null,crossCulturalEquivalents:[]},n=this.nameIndex.findEntitiesByName(t.matched_term,{exactMatch:!0,limit:1});if(n.length>0){const t=n[0];s.entityMetadata={id:t.id,type:t.type,primaryName:t.primaryName,mythology:t.mythology,mythologies:t.mythologies,matchedVariants:t.matchedVariants},s.crossCulturalEquivalents=this._getCrossCulturalEquivalents(t.primaryName)}return{...t,metadata:{...t.metadata,entityAnnotation:s}}})}getAlternateSuggestions(t,e={}){const{limit:a=5,includeCrossCultural:s=!0}=e,n=[];if(this.nameIndex&&this.nameIndex.initialized){const e=this.nameIndex.findEntitiesByName(t,{exactMatch:!1,limit:3});for(const a of e){const e=this.nameIndex.getAlternateNames(a.id);for(const s of e)s.toLowerCase()!==t.toLowerCase()&&n.push({term:s,type:"alternate",entity:a.primaryName,mythology:a.mythology})}}if(s&&this.crossCulturalMap){const e=this._getCrossCulturalEquivalents(t);for(const a of e)n.push({term:a,type:"cross-cultural",entity:t})}return n.filter((t,e,a)=>a.findIndex(e=>e.term.toLowerCase()===t.term.toLowerCase())===e).slice(0,a)}getEntityByName(t){if(!this.nameIndex||!this.nameIndex.initialized)return null;const e=this.nameIndex.findEntitiesByName(t,{exactMatch:!0,limit:1});return e.length>0?e[0]:null}isMetadataAvailable(){return this.initialized&&this.nameIndex&&this.nameIndex.initialized&&this.nameIndex.getStats().totalEntities>0}getStats(){const t={initialized:this.initialized,metadataAvailable:this.isMetadataAvailable(),crossCulturalMapLoaded:null!==this.crossCulturalMap};return this.nameIndex&&(t.nameIndex=this.nameIndex.getStats()),this.crossCulturalMap&&(t.crossCulturalGroups={deities:this.crossCulturalMap.deityEquivalents?.length||0,concepts:this.crossCulturalMap.conceptEquivalents?.length||0}),t}setAutoExpand(t){this.options.autoExpandNames=t}setCrossCultural(t){this.options.includeCrossCultural=t}setAnnotation(t){this.options.annotateResults=t}}"undefined"!=typeof module&&module.exports&&(module.exports=CorpusMetadataIntegration);
class AlternateNameIndex{constructor(){this.nameToEntities=new Map,this.entityById=new Map,this.indexedCount=0,this.initialized=!1}async loadFromDirectory(t="/data/entities",e={}){const{entityTypes:i=["deity","creature","hero","place","item","concept","magic"],progressCallback:n=null,errorCallback:a=null}=e,s={totalEntities:0,totalNames:0,errors:[],byType:{}};try{for(const e of i){const i=`${t}/${e}`,o=await this._loadEntityType(i,e,{progressCallback:n,errorCallback:a});s.totalEntities+=o.count,s.totalNames+=o.namesIndexed,s.byType[e]=o}return this.initialized=!0,this.indexedCount=s.totalEntities,s}catch(t){throw t}}async _loadEntityType(t,e,i){const n={count:0,namesIndexed:0,files:[]};try{const a=`${t}/manifest.json`;let s=[];try{const t=await fetch(a);t.ok&&(s=(await t.json()).files||[])}catch(t){return n}for(const a of s)try{const s=`${t}/${a}`,o=await fetch(s);if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=await o.json();this.indexEntity(r),n.count++,n.namesIndexed+=this._countIndexedNames(r),n.files.push(a),i.progressCallback&&i.progressCallback({entityType:e,filename:a,count:n.count})}catch(t){i.errorCallback&&i.errorCallback({entityType:e,filename:a,error:t})}}catch(t){}return n}loadFromArray(t){const e={totalEntities:0,totalNames:0,byType:{}};for(const i of t){this.indexEntity(i),e.totalEntities++,e.totalNames+=this._countIndexedNames(i);const t=i.type||"unknown";e.byType[t]=(e.byType[t]||0)+1}return this.initialized=!0,this.indexedCount=e.totalEntities,e}indexEntity(t){if(!t.id||!t.name)return;const e={id:t.id,type:t.type,primaryName:t.name,mythology:t.primaryMythology||t.mythologies?.[0],mythologies:t.mythologies||[]};if(this.entityById.set(t.id,e),this._indexName(t.name,e,"primary"),t.mythologyContexts&&Array.isArray(t.mythologyContexts))for(const i of t.mythologyContexts)if(i.names&&Array.isArray(i.names))for(const t of i.names)this._indexName(t,e,"mythology-context",{mythology:i.mythology,context:i.usage});if(t.linguistic){const i=t.linguistic;if(i.originalName&&this._indexName(i.originalName,e,"original"),i.transliteration&&i.transliteration!==t.name&&this._indexName(i.transliteration,e,"transliteration"),i.alternativeNames&&Array.isArray(i.alternativeNames))for(const t of i.alternativeNames)this._indexName(t.name,e,"alternative",{language:t.language,context:t.context,meaning:t.meaning});if(i.cognates&&Array.isArray(i.cognates))for(const t of i.cognates)this._indexName(t.term,e,"cognate",{language:t.language})}if(t.tags&&Array.isArray(t.tags))for(const i of t.tags)this._indexName(i,e,"tag")}_indexName(t,e,i="unknown",n={}){if(!t||"string"!=typeof t)return;const a=this._normalizeName(t);this.nameToEntities.has(a)||this.nameToEntities.set(a,[]);const s=this.nameToEntities.get(a),o=s.find(t=>t.entity.id===e.id);o?o.variants.push({name:t,type:i,...n}):s.push({entity:e,variants:[{name:t,type:i,...n}]})}_normalizeName(t){return t.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}_countIndexedNames(t){let e=1;if(t.mythologyContexts)for(const i of t.mythologyContexts)e+=(i.names||[]).length;if(t.linguistic){const i=t.linguistic;i.originalName&&e++,i.transliteration&&e++,e+=(i.alternativeNames||[]).length,e+=(i.cognates||[]).length}return e+=(t.tags||[]).length,e}findEntitiesByName(t,e={}){const{exactMatch:i=!1,mythology:n=null,entityType:a=null,limit:s=10}=e,o=this._normalizeName(t),r=[];if(i){const t=this.nameToEntities.get(o);t&&r.push(...t)}else for(const[t,e]of this.nameToEntities.entries())t.includes(o)&&r.push(...e);let l=r;return n&&(l=l.filter(t=>t.entity.mythologies.includes(n))),a&&(l=l.filter(t=>t.entity.type===a)),s&&l.length>s&&(l=l.slice(0,s)),l.map(t=>({id:t.entity.id,type:t.entity.type,primaryName:t.entity.primaryName,mythology:t.entity.mythology,mythologies:t.entity.mythologies,matchedVariants:t.variants,relevance:this._calculateRelevance(t,o)})).sort((t,e)=>e.relevance-t.relevance)}_calculateRelevance(t,e){let i=0;for(const n of t.variants){const t=this._normalizeName(n.name);t===e?i+="primary"===n.type?100:80:t.startsWith(e)?i+="primary"===n.type?60:40:t.includes(e)&&(i+="primary"===n.type?30:20),"primary"===n.type&&(i+=10)}return i}getAlternateNames(t){if(!this.entityById.get(t))return[];const e=new Set;for(const[i,n]of this.nameToEntities.entries())for(const i of n)if(i.entity.id===t)for(const t of i.variants)e.add(t.name);return Array.from(e)}expandSearchTerms(t,e={}){const{includePartialMatches:i=!1,mythology:n=null,maxAlternates:a=5}=e,s=new Set([t]),o=this.findEntitiesByName(t,{exactMatch:!i,mythology:n,limit:3});for(const t of o){const e=this.getAlternateNames(t.id);for(const t of e)if(s.add(t),s.size>=a+1)break;if(s.size>=a+1)break}return Array.from(s)}getStats(){return{initialized:this.initialized,totalEntities:this.entityById.size,totalNameVariants:this.nameToEntities.size,indexedCount:this.indexedCount,averageNamesPerEntity:this.entityById.size>0?(this.nameToEntities.size/this.entityById.size).toFixed(2):0}}clear(){this.nameToEntities.clear(),this.entityById.clear(),this.indexedCount=0,this.initialized=!1}}"undefined"!=typeof module&&module.exports&&(module.exports=AlternateNameIndex);
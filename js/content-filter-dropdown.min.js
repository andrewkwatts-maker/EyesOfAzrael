class ContentFilterDropdown{constructor(){this.db="undefined"!=typeof firebase&&firebase.firestore?firebase.firestore():null,this.auth="undefined"!=typeof firebase&&firebase.auth?firebase.auth():null,this.activeDropdown=null,this.init()}init(){document.addEventListener("click",e=>{this.activeDropdown&&!e.target.closest(".content-filter-dropdown")&&this.closeDropdown(this.activeDropdown)}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.activeDropdown&&this.closeDropdown(this.activeDropdown)}),window.addEventListener("contentFilterChanged",()=>{this.updateAllDropdowns()})}addDropdown(e,t){if(!t||!window.contentFilter)return;const n=this.auth?.currentUser?.uid,s=!t.userId||!0===t.official,o=t.userId&&t.userId===n;if(s||o)return void this.addContentBadge(e,t,s,o);const i=e.querySelector(".content-filter-dropdown");i&&i.remove();const a=this.createDropdown(t);e.style.position="relative",e.insertAdjacentElement("afterbegin",a),this.addContentBadge(e,t,!1,!1)}createDropdown(e){const t=document.createElement("div");t.className="content-filter-dropdown",t.setAttribute("role","menu");const n=document.createElement("button");n.className="filter-dropdown-trigger",n.setAttribute("aria-label","Content filter options"),n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false"),n.innerHTML='<span class="filter-dropdown-icon">â‹®</span>';const s=document.createElement("div");return s.className="filter-dropdown-menu",s.setAttribute("role","menu"),s.innerHTML=this.getMenuHTML(e),t.appendChild(n),t.appendChild(s),n.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),this.toggleDropdown(t)}),this.attachMenuListeners(s,e),t}getMenuHTML(e){const t=e.userId,n=e.userName||e.userDisplayName||"this user",s=e.type||"entity",o=e.userTopic||e.topic,i=(e.userSubtopic||e.subtopic,t&&window.contentFilter.isUserHidden(t)),a=o&&window.contentFilter.isTopicHidden(o);let r=[];return r.push('\n            <div class="filter-menu-header">\n                <span class="filter-menu-title">Filter Options</span>\n            </div>\n        '),t&&r.push(`\n                <button class="filter-menu-item"\n                        data-action="block-user"\n                        data-user-id="${this.escapeAttr(t)}"\n                        data-user-name="${this.escapeAttr(n)}"\n                        role="menuitem">\n                    <span class="filter-menu-icon">${i?"ğŸ‘ï¸":"ğŸš«"}</span>\n                    <span class="filter-menu-text">${i?"Unblock":"Block"} ${this.escapeHtml(n)}</span>\n                </button>\n            `),o&&r.push(`\n                <button class="filter-menu-item"\n                        data-action="block-topic"\n                        data-topic="${this.escapeAttr(o)}"\n                        role="menuitem">\n                    <span class="filter-menu-icon">${a?"ğŸ‘ï¸":"ğŸ·ï¸"}</span>\n                    <span class="filter-menu-text">${a?"Unblock":"Block"} topic: ${this.escapeHtml(o)}</span>\n                </button>\n            `),r.push(`\n            <button class="filter-menu-item"\n                    data-action="block-category"\n                    data-category="${this.escapeAttr(s)}"\n                    role="menuitem">\n                <span class="filter-menu-icon">ğŸ“</span>\n                <span class="filter-menu-text">Block all user ${this.escapeHtml(s)}s</span>\n            </button>\n        `),r.push('<div class="filter-menu-divider"></div>'),r.push(`\n            <button class="filter-menu-item"\n                    data-action="hide-submission"\n                    data-entity-id="${this.escapeAttr(e.id||"")}"\n                    role="menuitem">\n                <span class="filter-menu-icon">ğŸ‘ï¸â€ğŸ—¨ï¸</span>\n                <span class="filter-menu-text">Hide this submission</span>\n            </button>\n        `),r.push(`\n            <button class="filter-menu-item filter-menu-item-danger"\n                    data-action="report-content"\n                    data-entity-id="${this.escapeAttr(e.id||"")}"\n                    role="menuitem">\n                <span class="filter-menu-icon">âš ï¸</span>\n                <span class="filter-menu-text">Report content</span>\n            </button>\n        `),r.join("")}attachMenuListeners(e,t){e.querySelectorAll(".filter-menu-item").forEach(n=>{n.addEventListener("click",async s=>{s.stopPropagation(),s.preventDefault();const o=n.dataset.action,i=e.closest(".content-filter-dropdown");await this.handleAction(o,n.dataset,t),i&&this.closeDropdown(i)}),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())})})}async handleAction(e,t,n){switch(e){case"block-user":await this.blockUser(t.userId,t.userName,n);break;case"block-topic":await this.blockTopic(t.topic,n);break;case"block-category":await this.blockCategory(t.category,n);break;case"hide-submission":await this.hideSubmission(t.entityId,n);break;case"report-content":await this.reportContent(t.entityId,n)}}async blockUser(e,t,n){e&&window.contentFilter&&(window.contentFilter.isUserHidden(e)?(window.contentFilter.unhideUser(e),this.showToast(`Content from ${t} will now be shown`,"success")):(window.contentFilter.hideUser(e),this.showToast(`Content from ${t} will now be hidden`,"info"),this.hideEntityElement(n)))}async blockTopic(e,t){e&&window.contentFilter&&(window.contentFilter.isTopicHidden(e)?(window.contentFilter.unhideTopic(e),this.showToast(`Topic "${e}" will now be shown`,"success")):(window.contentFilter.hideTopic(e),this.showToast(`Topic "${e}" will now be hidden`,"info"),this.hideEntityElement(t)))}async blockCategory(e,t){const n=this.getBlockedCategories();n.includes(e)||(n.push(e),localStorage.setItem("blockedCategories",JSON.stringify(n)),this.showToast(`All user-submitted ${e}s will now be hidden`,"info"),this.hideEntityElement(t),window.dispatchEvent(new CustomEvent("categoryBlocked",{detail:{category:e}})))}getBlockedCategories(){try{const e=localStorage.getItem("blockedCategories");return e?JSON.parse(e):[]}catch(e){return[]}}async hideSubmission(e,t){if(!e)return;const n=this.getHiddenSubmissions();n.includes(e)||(n.push(e),localStorage.setItem("hiddenSubmissions",JSON.stringify(n)),this.showToast("This submission has been hidden","info"),this.hideEntityElement(t))}getHiddenSubmissions(){try{const e=localStorage.getItem("hiddenSubmissions");return e?JSON.parse(e):[]}catch(e){return[]}}async reportContent(e,t){if(this.db&&this.auth?.currentUser){if(confirm("Are you sure you want to report this content?\n\nReports are reviewed by moderators. False reports may result in account restrictions."))try{await this.db.collection("contentReports").add({entityId:e,entityType:t.type||"unknown",reportedBy:this.auth.currentUser.uid,reportedByEmail:this.auth.currentUser.email,reportedAt:firebase.firestore.FieldValue.serverTimestamp(),status:"pending",entity:{id:t.id,type:t.type,name:t.name||t.title,userId:t.userId,userName:t.userName||t.userDisplayName}}),this.showToast("Content has been reported. Thank you.","success"),this.hideSubmission(e,t)}catch(e){this.showToast("Failed to report content. Please try again.","error")}}else this.showToast("You must be signed in to report content","error")}hideEntityElement(e){e&&e.id&&document.querySelectorAll(`[data-entity-id="${e.id}"]`).forEach(e=>{e.style.display="none",e.classList.add("filtered-hidden"),e.style.transition="opacity 0.3s ease",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300)})}toggleDropdown(e){const t=e.querySelector(".filter-dropdown-menu"),n=e.querySelector(".filter-dropdown-trigger");if(!t||!n)return;const s=t.classList.contains("show");this.activeDropdown&&this.activeDropdown!==e&&this.closeDropdown(this.activeDropdown),s?this.closeDropdown(e):this.openDropdown(e)}openDropdown(e){const t=e.querySelector(".filter-dropdown-menu"),n=e.querySelector(".filter-dropdown-trigger");if(!t||!n)return;t.classList.add("show"),n.setAttribute("aria-expanded","true"),this.activeDropdown=e;const s=t.querySelector(".filter-menu-item");s&&setTimeout(()=>s.focus(),100)}closeDropdown(e){if(!e)return;const t=e.querySelector(".filter-dropdown-menu"),n=e.querySelector(".filter-dropdown-trigger");t&&n&&(t.classList.remove("show"),n.setAttribute("aria-expanded","false"),this.activeDropdown===e&&(this.activeDropdown=null))}updateAllDropdowns(){document.querySelectorAll(".content-filter-dropdown").forEach(e=>{const t=e.closest("[data-entity-id]")?.dataset.entityId;if(t){const t=e.querySelector(".filter-dropdown-menu");t&&!t.classList.contains("show")&&t.remove()}})}addContentBadge(e,t,n,s){const o=e.querySelector(".content-badge");o&&o.remove();const i=document.createElement("div");if(i.className="content-badge",n)i.classList.add("content-badge-official"),i.innerHTML='\n                <span class="content-badge-icon">âœ“</span>\n                <span class="content-badge-text">Official Content</span>\n            ';else if(s)i.classList.add("content-badge-own"),i.innerHTML='\n                <span class="content-badge-icon">ğŸ‘¤</span>\n                <span class="content-badge-text">Your Contribution</span>\n            ';else{i.classList.add("content-badge-community");const e=t.userName||t.userDisplayName||"Community",n=t.createdAt?this.formatDate(t.createdAt):"",s=t.approvalStatus||"pending";i.innerHTML=`\n                <div class="content-badge-header">\n                    <span class="content-badge-icon">ğŸ‘¥</span>\n                    <span class="content-badge-text">Community Contribution</span>\n                </div>\n                <div class="content-badge-meta">\n                    <span class="content-badge-author">By: ${this.escapeHtml(e)}</span>\n                    ${n?`<span class="content-badge-date">${n}</span>`:""}\n                    <span class="content-badge-status content-badge-status-${s}">${this.formatApprovalStatus(s)}</span>\n                </div>\n            `}const a=e.querySelector(".entity-header-content")||e.querySelector(".entity-name")||e;a&&a.insertAdjacentElement("afterbegin",i)}formatApprovalStatus(e){return{pending:"â³ Pending Review",approved:"âœ… Approved",rejected:"âŒ Rejected",flagged:"âš ï¸ Flagged"}[e]||e}formatDate(e){if(!e)return"";let t;t=e.toDate?e.toDate():e instanceof Date?e:new Date(e);const n=new Date-t,s=Math.floor(n/864e5);return 0===s?"Today":1===s?"Yesterday":s<7?`${s} days ago`:s<30?`${Math.floor(s/7)} weeks ago`:t.toLocaleDateString()}showToast(e,t="info"){let n=document.querySelector(".toast-container");n||(n=document.createElement("div"),n.className="toast-container",document.body.appendChild(n));const s=document.createElement("div");s.className=`toast toast-${t}`;const o={success:"âœ“",info:"â„¹",warning:"âš ",error:"âœ•"}[t]||"â„¹";s.innerHTML=`\n            <span class="toast-icon">${o}</span>\n            <span class="toast-message">${this.escapeHtml(e)}</span>\n        `,n.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}escapeAttr(e){return e?String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}}window.contentFilterDropdown=new ContentFilterDropdown;
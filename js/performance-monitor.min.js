class PerformanceMonitor{constructor(){this.metrics={navigation:{},firebase:[],scripts:[],resources:[],interactions:[],custom:[]},this.startTime=performance.now(),this.observers=[],this.alerts=[],this.isRecording=!0,this.thresholds={pageLoad:3e3,firebaseQuery:1e3,authTime:2e3,scriptLoad:1500,timeToInteractive:5e3,firstContentfulPaint:2e3},this.init()}init(){"complete"===document.readyState?this.captureNavigationTiming():window.addEventListener("load",()=>this.captureNavigationTiming()),this.setupPerformanceObservers(),this.setupFirebaseInterceptor(),this.trackTimeToInteractive(),this.setupCustomMetrics()}captureNavigationTiming(){if(!performance.timing)return;const e=performance.timing,t=performance.navigation;this.metrics.navigation={dnsLookup:e.domainLookupEnd-e.domainLookupStart,tcpConnection:e.connectEnd-e.connectStart,serverResponse:e.responseEnd-e.requestStart,domProcessing:e.domComplete-e.domLoading,domInteractive:e.domInteractive-e.navigationStart,domContentLoaded:e.domContentLoadedEventEnd-e.navigationStart,pageLoad:e.loadEventEnd-e.navigationStart,ttfb:e.responseStart-e.navigationStart,navigationType:["navigate","reload","back_forward","prerender"][t.type]||"unknown",redirectCount:t.redirectCount},this.metrics.navigation.pageLoad>this.thresholds.pageLoad&&this.addAlert("warning",`Page load time exceeded threshold: ${this.metrics.navigation.pageLoad}ms > ${this.thresholds.pageLoad}ms`)}setupPerformanceObservers(){if(window.PerformanceObserver)try{const e=new PerformanceObserver(e=>{for(const t of e.getEntries())this.recordResourceTiming(t)});e.observe({entryTypes:["resource"]}),this.observers.push(e);const t=new PerformanceObserver(e=>{for(const t of e.getEntries())this.recordPaintTiming(t)});t.observe({entryTypes:["paint"]}),this.observers.push(t);const r=new PerformanceObserver(e=>{for(const t of e.getEntries())this.recordCustomTiming(t)});r.observe({entryTypes:["measure"]}),this.observers.push(r)}catch(e){}}recordResourceTiming(e){const t={name:e.name,type:e.initiatorType,duration:e.duration,size:e.transferSize||0,startTime:e.startTime,responseTime:e.responseEnd-e.requestStart,cached:0===e.transferSize&&e.decodedBodySize>0};this.metrics.resources.push(t),"script"===e.initiatorType&&t.duration>this.thresholds.scriptLoad&&this.addAlert("warning",`Slow script load: ${e.name} took ${Math.round(t.duration)}ms`)}recordPaintTiming(e){this.metrics.navigation[e.name]=e.startTime,"first-contentful-paint"===e.name&&e.startTime>this.thresholds.firstContentfulPaint&&this.addAlert("warning",`First Contentful Paint exceeded threshold: ${Math.round(e.startTime)}ms`)}recordCustomTiming(e){this.metrics.custom.push({name:e.name,duration:e.duration,startTime:e.startTime})}setupFirebaseInterceptor(){const e=setInterval(()=>{window.firebase&&window.db&&(clearInterval(e),this.wrapFirebaseMethods())},100);setTimeout(()=>clearInterval(e),1e4)}wrapFirebaseMethods(){const e=window.db;if(!e)return;const t=e.collection.bind(e);e.collection=e=>{const r=t(e);return this.wrapCollectionRef(r,e)}}wrapCollectionRef(e,t){const r=e.get.bind(e);e.get=async(...e)=>{const s=performance.now(),i=`${t}_${Date.now()}`;try{const o=await r(...e),n=performance.now()-s;return this.recordFirebaseQuery({collection:t,operation:"get",duration:n,success:!0,resultCount:o.size||o.docs?.length||0,queryId:i}),o}catch(e){const r=performance.now()-s;throw this.recordFirebaseQuery({collection:t,operation:"get",duration:r,success:!1,error:e.message,queryId:i}),e}};const s=e.doc.bind(e);return e.doc=e=>{const r=s(e);return this.wrapDocRef(r,`${t}/${e}`)},e}wrapDocRef(e,t){const r=e.get.bind(e);return e.get=async(...e)=>{const s=performance.now(),i=`${t}_${Date.now()}`;try{const o=await r(...e),n=performance.now()-s;return this.recordFirebaseQuery({collection:t,operation:"get",duration:n,success:!0,exists:o.exists,queryId:i}),o}catch(e){const r=performance.now()-s;throw this.recordFirebaseQuery({collection:t,operation:"get",duration:r,success:!1,error:e.message,queryId:i}),e}},e}recordFirebaseQuery(e){this.metrics.firebase.push({...e,timestamp:Date.now()}),e.duration>this.thresholds.firebaseQuery&&this.addAlert("warning",`Slow Firebase query: ${e.collection} took ${Math.round(e.duration)}ms`)}trackTimeToInteractive(){let e=0;if(window.PerformanceObserver)try{const t=new PerformanceObserver(t=>{e=performance.now()});t.observe({entryTypes:["longtask"]}),this.observers.push(t)}catch(e){}window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.now()-this.startTime;this.metrics.navigation.timeToInteractive=e,e>this.thresholds.timeToInteractive&&this.addAlert("warning",`Time to Interactive exceeded threshold: ${Math.round(e)}ms`)},100)})}setupCustomMetrics(){window.addEventListener("firebaseAuthStateChanged",e=>{const t=performance.now()-this.startTime;this.recordInteraction({name:"auth_state_change",duration:t,user:e.detail.user?"signed_in":"signed_out"}),e.detail.user&&t>this.thresholds.authTime&&this.addAlert("warning",`Authentication took longer than expected: ${Math.round(t)}ms`)})}mark(e){this.isRecording&&performance.mark(e)}measure(e,t,r){if(this.isRecording)try{return performance.measure(e,t,r),performance.getEntriesByName(e,"measure")[0].duration}catch(e){return 0}}recordInteraction(e){this.metrics.interactions.push({...e,timestamp:Date.now()})}async timeOperation(e,t){const r=performance.now();this.mark(`${e}_start`);try{const s=await t(),i=performance.now()-r;return this.mark(`${e}_end`),this.measure(e,`${e}_start`,`${e}_end`),this.metrics.custom.push({name:e,duration:i,success:!0,timestamp:Date.now()}),s}catch(t){const s=performance.now()-r;throw this.metrics.custom.push({name:e,duration:s,success:!1,error:t.message,timestamp:Date.now()}),t}}addAlert(e,t){const r={level:e,message:t,timestamp:Date.now()};this.alerts.push(r),window.dispatchEvent(new CustomEvent("performanceAlert",{detail:r}))}getMetrics(){return{...this.metrics,alerts:this.alerts,timestamp:Date.now()}}getSummary(){return{pageLoad:this.metrics.navigation.pageLoad||0,firstContentfulPaint:this.metrics.navigation["first-contentful-paint"]||0,timeToInteractive:this.metrics.navigation.timeToInteractive||0,firebaseQueries:this.metrics.firebase.length,avgFirebaseQueryTime:this.getAverageFirebaseQueryTime(),slowFirebaseQueries:this.getSlowFirebaseQueries(),totalResources:this.metrics.resources.length,totalSize:this.getTotalResourceSize(),alerts:this.alerts.length}}getAverageFirebaseQueryTime(){return 0===this.metrics.firebase.length?0:this.metrics.firebase.reduce((e,t)=>e+t.duration,0)/this.metrics.firebase.length}getSlowFirebaseQueries(){return this.metrics.firebase.filter(e=>e.duration>this.thresholds.firebaseQuery)}getTotalResourceSize(){return this.metrics.resources.reduce((e,t)=>e+t.size,0)}getScriptsByLoadTime(){return this.metrics.resources.filter(e=>"script"===e.type).sort((e,t)=>t.duration-e.duration)}exportMetrics(){return JSON.stringify(this.getMetrics(),null,2)}exportReport(){return{summary:this.getSummary(),slowQueries:this.getSlowFirebaseQueries(),slowScripts:this.getScriptsByLoadTime().slice(0,10),alerts:this.alerts,timestamp:(new Date).toISOString()}}clear(){this.metrics={navigation:{},firebase:[],scripts:[],resources:[],interactions:[],custom:[]},this.alerts=[]}stop(){this.isRecording=!1,this.observers.forEach(e=>e.disconnect()),this.observers=[]}}window.PerformanceMonitor=PerformanceMonitor,window.performanceMonitor=new PerformanceMonitor,"undefined"!=typeof module&&module.exports&&(module.exports=PerformanceMonitor);
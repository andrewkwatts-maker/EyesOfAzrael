class FirebaseDB{constructor(){this.db=null,this.unsubscribers=new Map,this.cache=new Map,this.initialized=!1}async init(){if(!this.initialized)try{if(!firebase||!firebase.firestore)throw new Error("Firebase not initialized. Make sure firebase-init.js is loaded first.");this.db=firebase.firestore();try{await this.db.enablePersistence({synchronizeTabs:!0})}catch(t){"failed-precondition"===t.code||t.code}this.initialized=!0}catch(t){throw t}}generateTheoryId(){return`theory_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async createTheory(t){await this.init();const e=firebase.auth().currentUser;if(!e)throw new Error("User must be authenticated to create theories");const s=this.generateTheoryId(),i=firebase.firestore.FieldValue.serverTimestamp(),r={id:s,title:t.title.trim(),summary:t.summary?.trim()||"",content:t.content?.trim()||"",richContent:t.richContent||null,topic:t.topic||null,topicName:t.topicName||null,topicIcon:t.topicIcon||null,subtopic:t.subtopic||null,subtopicName:t.subtopicName||null,category:t.category||t.topic||"general",sources:t.sources?.trim()||"",relatedMythologies:t.relatedMythologies||[],relatedPage:t.relatedPage||null,tags:t.tags||[],authorId:e.uid,authorName:e.displayName||e.email,authorAvatar:e.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.displayName||e.email)}&background=9333ea&color=fff`,votes:0,views:0,status:"published",createdAt:i,updatedAt:i};try{return await this.db.collection("theories").doc(s).set(r),r.createdAt=new Date,r.updatedAt=new Date,this.cache.set(s,r),{success:!0,theoryId:s,theory:r}}catch(t){throw t}}async updateTheory(t,e){await this.init();const s=firebase.auth().currentUser;if(!s)throw new Error("User must be authenticated to update theories");try{const i=this.db.collection("theories").doc(t),r=await i.get();if(!r.exists)throw new Error("Theory not found");if(r.data().authorId!==s.uid)throw new Error("You can only edit your own theories");const o={updatedAt:firebase.firestore.FieldValue.serverTimestamp()};return["title","summary","content","richContent","topic","topicName","topicIcon","subtopic","subtopicName","category","sources","relatedMythologies","relatedPage","tags","status"].forEach(t=>{void 0!==e[t]&&(o[t]=e[t])}),await i.update(o),this.cache.has(t)&&this.cache.set(t,{...this.cache.get(t),...o,updatedAt:new Date}),{success:!0,theoryId:t}}catch(t){throw t}}async deleteTheory(t){await this.init();const e=firebase.auth().currentUser;if(!e)throw new Error("User must be authenticated to delete theories");try{const s=this.db.collection("theories").doc(t),i=await s.get();if(!i.exists)throw new Error("Theory not found");if(i.data().authorId!==e.uid)throw new Error("You can only delete your own theories");return await s.update({status:"deleted",updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),this.cache.delete(t),{success:!0}}catch(t){throw t}}async getTheory(t,e=!0){if(await this.init(),e&&this.cache.has(t))return this.cache.get(t);try{const e=await this.db.collection("theories").doc(t).get();if(!e.exists)return null;const s=this.convertTimestamps(e.data());return this.cache.set(t,s),s}catch(t){throw t}}async getTheories(t={}){await this.init();try{let e=this.db.collection("theories");switch(e=t.status?e.where("status","==",t.status):e.where("status","==","published"),t.topic&&(e=e.where("topic","==",t.topic)),t.subtopic&&(e=e.where("subtopic","==",t.subtopic)),t.authorId&&(e=e.where("authorId","==",t.authorId)),t.author&&(e=e.where("authorName","==",t.author)),t.sortBy||"newest"){case"newest":e=e.orderBy("createdAt","desc");break;case"oldest":e=e.orderBy("createdAt","asc");break;case"popular":e=e.orderBy("votes","desc");break;case"views":e=e.orderBy("views","desc")}const s=t.limit||20;e=e.limit(s),t.startAfter&&(e=e.startAfter(t.startAfter));const i=await e.get(),r=i.docs.map(t=>this.convertTimestamps(t.data()));return r.forEach(t=>{this.cache.set(t.id,t)}),{theories:r,lastDoc:i.docs[i.docs.length-1],hasMore:i.docs.length===s}}catch(t){throw t}}async searchTheories(t,e={}){await this.init();const s=await this.getTheories({...e,limit:100}),i=t.toLowerCase();return{theories:s.theories.filter(t=>{const e=t.title.toLowerCase().includes(i),s=t.content?.toLowerCase().includes(i),r=t.summary?.toLowerCase().includes(i),o=t.richContent?.panels?.some(t=>t.title?.toLowerCase().includes(i)||t.content?.toLowerCase().includes(i));return e||s||r||o}),hasMore:!1}}async voteTheory(t,e=1){await this.init();const s=firebase.auth().currentUser;if(!s)throw new Error("User must be authenticated to vote");try{const i=this.db.collection("theories").doc(t).collection("votes").doc(s.uid),r=this.db.collection("theories").doc(t);if(await this.db.runTransaction(async t=>{const o=await t.get(i),a=await t.get(r);if(!a.exists)throw new Error("Theory not found");let c=a.data().votes||0;if(o.exists){const s=o.data();s.direction===e?(t.delete(i),c-=e):(t.update(i,{direction:e,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),c=c-s.direction+e)}else t.set(i,{direction:e,userId:s.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),c+=e;t.update(r,{votes:c})}),this.cache.has(t)){const e=await this.getTheory(t,!1);this.cache.set(t,e)}return{success:!0}}catch(t){throw t}}async addComment(t,e){await this.init();const s=firebase.auth().currentUser;if(!s)throw new Error("User must be authenticated to comment");if(!e||e.trim().length<3)throw new Error("Comment must be at least 3 characters");try{const i=`comment_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r=this.db.collection("theories").doc(t).collection("comments").doc(i),o={id:i,content:e.trim(),authorId:s.uid,authorName:s.displayName||s.email,authorAvatar:s.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.displayName||s.email)}&background=9333ea&color=fff`,createdAt:firebase.firestore.FieldValue.serverTimestamp()};return await r.set(o),{success:!0,commentId:i,comment:{...o,createdAt:new Date}}}catch(t){throw t}}async getComments(t){await this.init();try{return(await this.db.collection("theories").doc(t).collection("comments").orderBy("createdAt","desc").get()).docs.map(t=>this.convertTimestamps(t.data()))}catch(t){throw t}}async getUserVote(t){await this.init();const e=firebase.auth().currentUser;if(!e)return null;try{const s=await this.db.collection("theories").doc(t).collection("votes").doc(e.uid).get();return s.exists?this.convertTimestamps(s.data()):null}catch(t){return null}}async incrementViews(t){await this.init();try{if(await this.db.collection("theories").doc(t).update({views:firebase.firestore.FieldValue.increment(1)}),this.cache.has(t)){const e=this.cache.get(t);e.views=(e.views||0)+1,this.cache.set(t,e)}}catch(t){}}listenToTheory(t,e){if(!this.initialized)return()=>{};const s=this.db.collection("theories").doc(t).onSnapshot(s=>{if(s.exists){const i=this.convertTimestamps(s.data());this.cache.set(t,i),e(i)}else e(null)},t=>{e(null,t)});return this.unsubscribers.set(`theory_${t}`,s),s}listenToComments(t,e){if(!this.initialized)return()=>{};const s=this.db.collection("theories").doc(t).collection("comments").orderBy("createdAt","desc").onSnapshot(t=>{const s=t.docs.map(t=>this.convertTimestamps(t.data()));e(s)},t=>{e([],t)});return this.unsubscribers.set(`comments_${t}`,s),s}listenToVotes(t,e){if(!this.initialized)return()=>{};const s=this.db.collection("theories").doc(t).collection("votes").onSnapshot(t=>{const s=t.docs.map(t=>this.convertTimestamps(t.data()));e(s)},t=>{e([],t)});return this.unsubscribers.set(`votes_${t}`,s),s}stopListening(t){[`theory_${t}`,`comments_${t}`,`votes_${t}`].forEach(t=>{this.unsubscribers.has(t)&&(this.unsubscribers.get(t)(),this.unsubscribers.delete(t))})}stopAllListeners(){this.unsubscribers.forEach(t=>t()),this.unsubscribers.clear()}convertTimestamps(t){const e={...t};return t.createdAt&&t.createdAt.toDate&&(e.createdAt=t.createdAt.toDate()),t.updatedAt&&t.updatedAt.toDate&&(e.updatedAt=t.updatedAt.toDate()),e}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,theories:Array.from(this.cache.keys())}}}window.firebaseDB=new FirebaseDB,"undefined"!=typeof module&&module.exports&&(module.exports=FirebaseDB);
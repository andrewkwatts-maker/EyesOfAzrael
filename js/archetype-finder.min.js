class ArchetypeFinder{constructor(){this.db=firebase.firestore(),this.comparisonEngine=new MythologyComparisons,this.cache=new Map,this.extendedArchetypes={"divine-messenger":{name:"Divine Messenger",description:"Herald and intermediary between gods and mortals",keywords:["messenger","herald","communication","travel","guide","psychopomp"],examples:{greek:"hermes",norse:"heimdall",hindu:"narada",roman:"mercury"}},"craftsman-god":{name:"Divine Craftsman",description:"God of craftsmanship, forging, and creation",keywords:["forge","craftsman","smith","creation","builder","artisan"],examples:{greek:"hephaestus",norse:"wayland",roman:"vulcan",egyptian:"ptah"}},"harvest-deity":{name:"Harvest Deity",description:"God or goddess of agriculture and harvest",keywords:["harvest","agriculture","grain","crops","seasons","abundance"],examples:{greek:"demeter",roman:"ceres",norse:"freyr",aztec:"centeotl"}},"storm-god":{name:"Storm God",description:"Deity of storms, thunder, and weather",keywords:["storm","thunder","rain","weather","tempest","lightning"],examples:{norse:"thor",greek:"zeus",hindu:"indra",mayan:"chaac"}},"sea-deity":{name:"Sea Deity",description:"Ruler of oceans, seas, and waters",keywords:["sea","ocean","water","waves","maritime","naval"],examples:{greek:"poseidon",roman:"neptune",norse:"njord",hindu:"varuna"}},"lunar-deity":{name:"Moon Deity",description:"God or goddess of the moon and night",keywords:["moon","lunar","night","phases","celestial","nocturnal"],examples:{greek:"selene",roman:"luna",norse:"mani",egyptian:"khonsu"}},"dawn-deity":{name:"Dawn Deity",description:"Goddess of dawn and morning",keywords:["dawn","morning","sunrise","aurora","daybreak"],examples:{greek:"eos",roman:"aurora",hindu:"ushas",norse:"eostre"}},"hunting-deity":{name:"Hunting Deity",description:"God or goddess of the hunt and wilderness",keywords:["hunt","hunting","wilderness","forest","animals","archer"],examples:{greek:"artemis",roman:"diana",celtic:"cernunnos",hindu:"rudra"}},"justice-deity":{name:"Justice Deity",description:"God or goddess of justice, law, and order",keywords:["justice","law","order","balance","truth","judgment"],examples:{greek:"themis",egyptian:"maat",roman:"justitia",norse:"forseti"}},"wine-deity":{name:"Wine & Ecstasy Deity",description:"God of wine, revelry, and altered states",keywords:["wine","ecstasy","revelry","intoxication","celebration","madness"],examples:{greek:"dionysus",roman:"bacchus",egyptian:"hathor"}},"healer-deity":{name:"Healing Deity",description:"God or goddess of medicine and healing",keywords:["healing","medicine","health","cure","physician","restoration"],examples:{greek:"asclepius",egyptian:"sekhmet",celtic:"dian-cecht",hindu:"dhanvantari"}},"fire-deity":{name:"Fire Deity",description:"God or goddess of fire and flame",keywords:["fire","flame","heat","combustion","hearth","volcano"],examples:{roman:"vesta",hindu:"agni",hawaiian:"pele",aztec:"xiuhtecuhtli"}}}}async findByArchetype(e,t={}){const s=`archetype:${e}:${JSON.stringify(t)}`;if(this.cache.has(s))return this.cache.get(s);const n=this.getArchetypeDefinition(e);if(!n)throw new Error(`Unknown archetype: ${e}`);const r=[],i=t.collections||["deities","heroes","creatures"],o=t.minScore||3;for(const s of i)try{(await this.db.collection(s).limit(t.limit||100).get()).docs.forEach(t=>{const i={id:t.id,collection:s,...t.data()},a=this.calculateArchetypeMatch(i,n);a>=o&&r.push({...i,archetypeScore:a,archetypeId:e,archetypeName:n.name,matchedKeywords:this.getMatchedKeywords(i,n)})})}catch(e){}r.sort((e,t)=>t.archetypeScore-e.archetypeScore);let a=r;return t.mythology&&(a=r.filter(e=>e.mythology===t.mythology)),this.cache.set(s,a),a}async identifyArchetypes(e){const t=await this.comparisonEngine.fetchEntity(e);if(!t)throw new Error("Entity not found");const s=[],n={...this.comparisonEngine.archetypes,...this.extendedArchetypes};for(const[e,r]of Object.entries(n)){const n=this.calculateArchetypeMatch(t,r);n>=3&&s.push({id:e,name:r.name,description:r.description,score:n,matchedKeywords:this.getMatchedKeywords(t,r),confidence:this.calculateConfidence(n)})}return s.sort((e,t)=>t.score-e.score)}calculateArchetypeMatch(e,t){this.buildEntitySearchText(e);const s=t.keywords||t.attributes||[];let n=0;return s.forEach(t=>{const s=new RegExp(`\\b${t.toLowerCase()}\\b`,"i");e.name&&s.test(e.name.toLowerCase())&&(n+=3),e.title&&s.test(e.title.toLowerCase())&&(n+=2),e.domains&&e.domains.some(e=>s.test(e.toLowerCase()))&&(n+=2),e.attributes&&e.attributes.some(e=>s.test(e.toLowerCase()))&&(n+=1.5),e.description&&s.test(e.description.toLowerCase())&&(n+=1),e.symbols&&e.symbols.some(e=>s.test(e.toLowerCase()))&&(n+=1)}),t.examples&&Object.values(t.examples).map(e=>e.toLowerCase()).includes(e.id.toLowerCase())&&(n+=5),Math.round(10*n)/10}buildEntitySearchText(e){return[e.name,e.title,e.description,...e.domains||[],...e.attributes||[],...e.symbols||[],...e.aliases||[]].filter(Boolean).join(" ").toLowerCase()}getMatchedKeywords(e,t){const s=this.buildEntitySearchText(e);return(t.keywords||t.attributes||[]).filter(e=>new RegExp(`\\b${e.toLowerCase()}\\b`,"i").test(s))}calculateConfidence(e){return e>=10?"very-high":e>=7?"high":e>=5?"medium":e>=3?"low":"very-low"}getArchetypeDefinition(e){return this.comparisonEngine.archetypes[e]||this.extendedArchetypes[e]||null}getAllArchetypes(){return{...this.comparisonEngine.archetypes,...this.extendedArchetypes}}findRelatedArchetypes(e){const t=this.getArchetypeDefinition(e);if(!t)return[];const s=this.getAllArchetypes(),n=[];for(const[r,i]of Object.entries(s)){if(r===e)continue;const s=this.findSharedKeywords(t,i);s.length>0&&n.push({id:r,name:i.name,sharedKeywords:s,similarity:s.length})}return n.sort((e,t)=>t.similarity-e.similarity)}findSharedKeywords(e,t){const s=e.keywords||e.attributes||[],n=t.keywords||t.attributes||[];return s.filter(e=>n.includes(e))}async mapArchetypeNetwork(){const e=this.getAllArchetypes(),t={nodes:[],edges:[]};for(const[s,n]of Object.entries(e)){const e=await this.countEntitiesForArchetype(s);t.nodes.push({id:s,name:n.name,description:n.description,entityCount:e,keywords:n.keywords||n.attributes||[]})}const s=Object.keys(e);for(let n=0;n<s.length;n++)for(let r=n+1;r<s.length;r++){const i=s[n],o=s[r],a=e[i],c=e[o],h=this.findSharedKeywords(a,c);h.length>0&&t.edges.push({source:i,target:o,weight:h.length,sharedKeywords:h})}return t}async countEntitiesForArchetype(e){try{return(await this.findByArchetype(e,{limit:100})).length}catch(e){return 0}}async findArchetypesByMythology(e){const t=this.getAllArchetypes(),s=[];for(const[n,r]of Object.entries(t))if(r.examples&&r.examples[e]){const t=await this.findByArchetype(n,{mythology:e,limit:20});s.push({id:n,name:r.name,description:r.description,entityCount:t.length,topEntities:t.slice(0,5),example:r.examples[e]})}return s.sort((e,t)=>t.entityCount-e.entityCount)}async findUniversalArchetypes(e=3){const t=this.getAllArchetypes(),s=[];for(const[n,r]of Object.entries(t))if(r.examples&&Object.keys(r.examples).length>=e){const e=await this.findByArchetype(n,{limit:50}),t=[...new Set(e.map(e=>e.mythology))];s.push({id:n,name:r.name,description:r.description,mythologyCount:t.length,mythologies:t,entityCount:e.length,examples:r.examples})}return s.sort((e,t)=>t.mythologyCount-e.mythologyCount)}async discoverNewArchetypes(e={}){const t=e.collections||["deities","heroes"],s=[];for(const n of t)try{(await this.db.collection(n).limit(e.limit||200).get()).docs.forEach(e=>{s.push({id:e.id,collection:n,...e.data()})})}catch(e){}return this.analyzeEntityPatterns(s)}analyzeEntityPatterns(e){const t={},s={};e.forEach(e=>{(e.domains||[]).forEach(s=>{t[s]||(t[s]=[]),t[s].push(e)}),(e.attributes||[]).forEach(t=>{s[t]||(s[t]=[]),s[t].push(e)})});const n=[];for(const[e,s]of Object.entries(t))if(s.length>=3){const t=[...new Set(s.map(e=>e.mythology))];t.length>=2&&n.push({type:"domain-based",name:`${e} Deity Pattern`,domain:e,entityCount:s.length,mythologies:t,examples:s.slice(0,5).map(e=>({id:e.id,name:e.name}))})}return n.sort((e,t)=>t.entityCount-e.entityCount)}async compareArchetypeDistributions(e){const t={};for(const s of e){const e=await this.findArchetypesByMythology(s);t[s]=e}return{mythologies:e,distributions:t,analysis:this.analyzeDistributions(t)}}analyzeDistributions(e){const t={sharedArchetypes:[],uniqueArchetypes:{},dominantArchetypes:{}},s=Object.keys(e),n=new Set;return s.forEach(t=>{e[t].forEach(e=>n.add(e.id))}),n.forEach(n=>{const r=s.filter(t=>e[t].some(e=>e.id===n));if(r.length===s.length)t.sharedArchetypes.push(n);else if(1===r.length){const e=r[0];t.uniqueArchetypes[e]||(t.uniqueArchetypes[e]=[]),t.uniqueArchetypes[e].push(n)}}),s.forEach(s=>{e[s].length>0&&(t.dominantArchetypes[s]=e[s][0])}),t}clearCache(){this.cache.clear()}}"undefined"!=typeof module&&module.exports&&(module.exports=ArchetypeFinder);
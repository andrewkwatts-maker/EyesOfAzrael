class VersionTracker{constructor(t=null,e={}){this.db=t?firebase.firestore(t):null,this.options={collection:e.collection||"system",document:e.document||"version",autoIncrement:!1!==e.autoIncrement,checkInterval:e.checkInterval||3e5,enableLogging:e.enableLogging||!1,onVersionChange:e.onVersionChange||null},this.currentVersion=null,this.lastCheck=null,this.checkTimer=null,this.listeners=[]}initFirestore(t){this.db=firebase.firestore(t),this.log("Firestore initialized")}async initialize(){if(!this.db)throw new Error("Firestore not initialized. Call initFirestore() first.");try{return this.currentVersion=await this.getCurrentVersion(),this.log(`Initialized with version: ${this.currentVersion}`),this.startVersionChecking(),this.currentVersion}catch(t){throw this.log("Error initializing version tracker:",t),t}}async getCurrentVersion(){try{const t=this.db.collection(this.options.collection).doc(this.options.document),e=await t.get();if(e.exists){const t=e.data();return this.lastCheck=Date.now(),t.version||1}return await this.initializeVersionDocument(),1}catch(t){throw this.log("Error getting current version:",t),t}}async initializeVersionDocument(){try{const t=this.db.collection(this.options.collection).doc(this.options.document);await t.set({version:1,created:firebase.firestore.FieldValue.serverTimestamp(),lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),updateCount:0,metadata:{description:"System version for cache invalidation",autoIncrement:this.options.autoIncrement}}),this.log("Version document initialized")}catch(t){throw this.log("Error initializing version document:",t),t}}async incrementVersion(t={}){if(!this.db)throw new Error("Firestore not initialized");try{const e=this.db.collection(this.options.collection).doc(this.options.document),i=await this.db.runTransaction(async i=>{const s=await i.get(e);let r=1,n=0;if(s.exists){const t=s.data();r=t.version||1,n=t.updateCount||0}const o=r+1;return i.set(e,{version:o,lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),updateCount:n+1,lastUpdate:{timestamp:firebase.firestore.FieldValue.serverTimestamp(),metadata:t,previousVersion:r},metadata:{description:"System version for cache invalidation",autoIncrement:this.options.autoIncrement}},{merge:!0}),o});return this.currentVersion=i,this.log(`Version incremented to: ${i}`),this.notifyVersionChange(i),i}catch(t){throw this.log("Error incrementing version:",t),t}}async checkForUpdates(){if(!this.db)return!1;try{const t=await this.getCurrentVersion();if(null!==this.currentVersion&&t!==this.currentVersion){this.log(`Version changed: ${this.currentVersion} -> ${t}`);const e=this.currentVersion;return this.currentVersion=t,this.notifyVersionChange(t,e),!0}return!1}catch(t){return this.log("Error checking for updates:",t),!1}}startVersionChecking(){this.checkTimer&&clearInterval(this.checkTimer),this.checkTimer=setInterval(async()=>{await this.checkForUpdates()&&this.options.onVersionChange&&this.options.onVersionChange(this.currentVersion)},this.options.checkInterval),this.log(`Version checking started (interval: ${this.options.checkInterval}ms)`)}stopVersionChecking(){this.checkTimer&&(clearInterval(this.checkTimer),this.checkTimer=null,this.log("Version checking stopped"))}onVersionChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyVersionChange(t,e=null){this.listeners.forEach(i=>{try{i(t,e)}catch(t){this.log("Error in version change listener:",t)}})}async setVersion(t){if(!this.db)throw new Error("Firestore not initialized");try{const e=this.db.collection(this.options.collection).doc(this.options.document);await e.set({version:t,lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),metadata:{description:"System version for cache invalidation",manuallySet:!0,setAt:firebase.firestore.FieldValue.serverTimestamp()}},{merge:!0}),this.currentVersion=t,this.log(`Version manually set to: ${t}`),this.notifyVersionChange(t)}catch(t){throw this.log("Error setting version:",t),t}}async getVersionHistory(t=10){if(!this.db)throw new Error("Firestore not initialized");try{const e=await this.db.collection(this.options.collection).doc(this.options.document).collection("history").orderBy("timestamp","desc").limit(t).get(),i=[];return e.forEach(t=>{i.push({id:t.id,...t.data()})}),i}catch(t){return this.log("Error getting version history:",t),[]}}async logVersionUpdate(t={}){if(this.db)try{await this.db.collection(this.options.collection).doc(this.options.document).collection("history").add({version:this.currentVersion,timestamp:firebase.firestore.FieldValue.serverTimestamp(),metadata:t}),this.log("Version update logged to history")}catch(t){this.log("Error logging version update:",t)}}async getStats(){if(!this.db)throw new Error("Firestore not initialized");try{const t=this.db.collection(this.options.collection).doc(this.options.document),e=await t.get();if(!e.exists)return{version:null,updateCount:0,created:null,lastUpdated:null};const i=e.data();return{version:i.version,updateCount:i.updateCount||0,created:i.created?i.created.toDate().toISOString():null,lastUpdated:i.lastUpdated?i.lastUpdated.toDate().toISOString():null,lastCheck:this.lastCheck?new Date(this.lastCheck).toISOString():null,checkInterval:this.options.checkInterval,autoIncrement:this.options.autoIncrement}}catch(t){throw this.log("Error getting version stats:",t),t}}async reset(){await this.setVersion(1),this.log("Version reset to 1")}log(...t){this.options.enableLogging}destroy(){this.stopVersionChecking(),this.listeners=[],this.log("Version tracker destroyed")}}"undefined"!=typeof module&&module.exports&&(module.exports=VersionTracker);
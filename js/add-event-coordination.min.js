const fs=require("fs"),path=require("path"),filePath=path.join(__dirname,"spa-navigation.js");let content=fs.readFileSync(filePath,"utf8");function wrapRenderWithEvents(e,n,t=[]){const r=new RegExp(`async ${e}\\(([^)]*)\\) {\\s*([\\s\\S]*?)(?=\\n    async |\\n    renderError|\\n    showLoading|$)`,""),o=content.match(r);if(!o)return!1;if(o[0].includes("first-render-complete")||o[0].includes("render-error"))return!1;const a=o[1],s=o[2];let c=`{\n                    route: '${n}',`;t.forEach(e=>{c+=`\n                    ${e}: ${e},`}),c+="\n                    timestamp: Date.now()\n                }";const m=`async ${e}(${a}) {\n        console.log('[SPA] â–¶ï¸  ${e}() called');\n\n        try {\n${s.trimEnd()}\n\n            console.log('[SPA] âœ… ${e}() rendered successfully');\n            console.log('[SPA] ðŸ“¡ Emitting first-render-complete event');\n            document.dispatchEvent(new CustomEvent('first-render-complete', {\n                detail: ${c}\n            }));\n        } catch (error) {\n            console.error('[SPA] âŒ ${e}() render failed:', error);\n            console.log('[SPA] ðŸ“¡ Emitting render-error event');\n            document.dispatchEvent(new CustomEvent('render-error', {\n                detail: ${c.replace("timestamp: Date.now()","error: error.message,\n                    timestamp: Date.now()")}\n            }));\n            throw error;\n        }\n    }`;return content=content.replace(r,m),!0}const methods=[{name:"renderMythology",route:"mythology",params:["mythologyId"]},{name:"renderCategory",route:"category",params:["mythology","category"]},{name:"renderEntity",route:"entity",params:["mythology","categoryType","entityId"]},{name:"renderSearch",route:"search",params:[]},{name:"renderCompare",route:"compare",params:[]},{name:"renderDashboard",route:"dashboard",params:[]},{name:"render404",route:"404",params:[]}];let modified=0;if(methods.forEach(e=>{wrapRenderWithEvents(e.name,e.route,e.params)&&modified++}),content.includes("async renderHome()")&&!content.match(/renderHome[\s\S]{0,100}first-render-complete/)){content=content.replace(/(\s+if \(!mainContent\) {\s+console\.error\('\[SPA\] âŒ CRITICAL: main-content element not found!'\);[\s\S]*?return;\s+})/,e=>e.replace("return;","\n            // Emit error event\n            console.log('[SPA] ðŸ“¡ Emitting render-error event');\n            document.dispatchEvent(new CustomEvent('render-error', {\n                detail: {\n                    route: 'home',\n                    error: 'main-content element not found',\n                    timestamp: Date.now()\n                }\n            }));\n            return;")),content=content.replace(/(await renderer\.renderPage\('home', mainContent\);\s+console\.log\('\[SPA\] âœ… Home page rendered via PageAssetRenderer'\);)\s+return;/,"$1\n\n                        // Emit success event\n                        console.log('[SPA] ðŸ“¡ Emitting first-render-complete event (PageAssetRenderer)');\n                        document.dispatchEvent(new CustomEvent('first-render-complete', {\n                            detail: {\n                                route: 'home',\n                                renderer: 'PageAssetRenderer',\n                                timestamp: Date.now()\n                            }\n                        }));\n                        return;"),content=content.replace(/(await homeView\.render\(mainContent\);\s+console\.log\('\[SPA\] âœ… Home page rendered via HomeView'\);)\s+return;/,"$1\n\n                // Emit success event\n                console.log('[SPA] ðŸ“¡ Emitting first-render-complete event (HomeView)');\n                document.dispatchEvent(new CustomEvent('first-render-complete', {\n                    detail: {\n                        route: 'home',\n                        renderer: 'HomeView',\n                        timestamp: Date.now()\n                    }\n                }));\n                return;");const e=content.match(/async renderHome\(\) \{([\s\S]*?)(?=\n    async )/);e&&!e[1].includes("try {")&&(content=content.replace(/(console\.log\('\[SPA\] Home page rendered'\);)/,"console.log('[SPA] âœ… Home page rendered (inline fallback)');\n\n            // Emit success event\n            console.log('[SPA] ðŸ“¡ Emitting first-render-complete event (inline)');\n            document.dispatchEvent(new CustomEvent('first-render-complete', {\n                detail: {\n                    route: 'home',\n                    renderer: 'inline-fallback',\n                    timestamp: Date.now()\n                }\n            }));")),modified++}fs.writeFileSync(filePath,content,"utf8");
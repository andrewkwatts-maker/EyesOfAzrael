class HeaderFilters{constructor(){this.filterState={contentSource:"both",mythologies:[],entityTypes:[],topics:[]},this.availableOptions={mythologies:[],entityTypes:[{id:"deity",name:"Deities",icon:"‚ö°"},{id:"hero",name:"Heroes",icon:"üó°Ô∏è"},{id:"creature",name:"Creatures",icon:"üêâ"},{id:"item",name:"Items",icon:"‚öîÔ∏è"},{id:"place",name:"Places",icon:"üèõÔ∏è"},{id:"concept",name:"Concepts",icon:"üí≠"},{id:"magic",name:"Magic",icon:"üîÆ"},{id:"theory",name:"Theories",icon:"üî¨"}],topics:[]},this.filterBarVisible=!1,this.initialized=!1,this.listeners=[]}async init(){if(!this.initialized)try{await this.loadAvailableOptions(),this.loadFromPreferences(),this.renderFilterBar(),this.applyURLParameters(),this.setupEventListeners(),this.initialized=!0}catch(t){}}async loadAvailableOptions(){try{const t=await firebase.firestore().collection("mythologies").orderBy("name","asc").get();this.availableOptions.mythologies=t.docs.map(t=>({id:t.id,name:t.data().name,icon:t.data().icon||"üåç"}));const e=await firebase.firestore().collection("tags").orderBy("name","asc").limit(50).get();this.availableOptions.topics=e.docs.map(t=>({id:t.id,name:t.data().name,count:t.data().count||0}))}catch(t){this.availableOptions.mythologies=this.getFallbackMythologies(),this.availableOptions.topics=this.getFallbackTopics()}}renderFilterBar(){let t=document.getElementById("header-filter-bar");if(!t){const e=document.querySelector("header")||document.body;t=document.createElement("div"),t.id="header-filter-bar",e.insertAdjacentElement("afterend",t)}const e=this.getActiveFilterCount(),i=!this.filterBarVisible&&0===e;t.innerHTML=`\n            <div class="filter-bar-container ${i?"collapsed":""}">\n                \x3c!-- Filter Toggle/Status Bar --\x3e\n                <div class="filter-status-bar" id="filter-status-bar">\n                    <div class="filter-status-content">\n                        <button class="filter-toggle-btn" id="filter-toggle-btn">\n                            <span class="filter-icon">üîç</span>\n                            <span class="filter-label">Filters</span>\n                            ${e>0?`<span class="filter-badge">${e}</span>`:""}\n                        </button>\n\n                        ${e>0?`\n                            <div class="active-filters-preview" id="active-filters-preview">\n                                ${this.renderActiveFiltersPills()}\n                            </div>\n                        `:""}\n                    </div>\n\n                    ${e>0?'\n                        <button class="btn-clear-all-filters" id="btn-clear-all-filters">\n                            Clear All\n                        </button>\n                    ':""}\n                </div>\n\n                \x3c!-- Filter Controls (expandable) --\x3e\n                <div class="filter-controls-panel ${this.filterBarVisible?"visible":"hidden"}" id="filter-controls-panel">\n                    <div class="filter-controls-grid">\n                        \x3c!-- Content Source --\x3e\n                        <div class="filter-control">\n                            <label class="filter-label">Content Source</label>\n                            <div class="filter-dropdown" id="content-source-dropdown">\n                                <button class="dropdown-btn" data-dropdown="content-source">\n                                    <span class="dropdown-value">${this.getContentSourceLabel()}</span>\n                                    <span class="dropdown-arrow">‚ñº</span>\n                                </button>\n                                <div class="dropdown-menu" data-dropdown-menu="content-source">\n                                    <label class="dropdown-option">\n                                        <input type="radio" name="content-source" value="both" ${"both"===this.filterState.contentSource?"checked":""}>\n                                        <span>Both Official & Community</span>\n                                    </label>\n                                    <label class="dropdown-option">\n                                        <input type="radio" name="content-source" value="official" ${"official"===this.filterState.contentSource?"checked":""}>\n                                        <span>Official Content Only</span>\n                                    </label>\n                                    <label class="dropdown-option">\n                                        <input type="radio" name="content-source" value="community" ${"community"===this.filterState.contentSource?"checked":""}>\n                                        <span>Community Contributions</span>\n                                    </label>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Mythologies --\x3e\n                        <div class="filter-control">\n                            <label class="filter-label">Mythologies ${this.filterState.mythologies.length>0?`(${this.filterState.mythologies.length} selected)`:""}</label>\n                            <div class="filter-dropdown" id="mythologies-dropdown">\n                                <button class="dropdown-btn" data-dropdown="mythologies">\n                                    <span class="dropdown-value">${this.getMythologiesLabel()}</span>\n                                    <span class="dropdown-arrow">‚ñº</span>\n                                </button>\n                                <div class="dropdown-menu multi-select" data-dropdown-menu="mythologies">\n                                    <div class="dropdown-search">\n                                        <input type="text" placeholder="Search mythologies..." class="dropdown-search-input">\n                                    </div>\n                                    <div class="dropdown-options-list">\n                                        ${this.availableOptions.mythologies.map(t=>`\n                                            <label class="dropdown-option checkbox-option">\n                                                <input type="checkbox" name="mythologies" value="${t.id}"\n                                                    ${this.filterState.mythologies.includes(t.id)?"checked":""}>\n                                                <span>${t.icon} ${t.name}</span>\n                                            </label>\n                                        `).join("")}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Entity Types --\x3e\n                        <div class="filter-control">\n                            <label class="filter-label">Entity Types ${this.filterState.entityTypes.length>0?`(${this.filterState.entityTypes.length} selected)`:""}</label>\n                            <div class="filter-dropdown" id="entity-types-dropdown">\n                                <button class="dropdown-btn" data-dropdown="entity-types">\n                                    <span class="dropdown-value">${this.getEntityTypesLabel()}</span>\n                                    <span class="dropdown-arrow">‚ñº</span>\n                                </button>\n                                <div class="dropdown-menu multi-select" data-dropdown-menu="entity-types">\n                                    ${this.availableOptions.entityTypes.map(t=>`\n                                        <label class="dropdown-option checkbox-option">\n                                            <input type="checkbox" name="entity-types" value="${t.id}"\n                                                ${this.filterState.entityTypes.includes(t.id)?"checked":""}>\n                                            <span>${t.icon} ${t.name}</span>\n                                        </label>\n                                    `).join("")}\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Topics/Tags --\x3e\n                        <div class="filter-control">\n                            <label class="filter-label">Topics/Tags ${this.filterState.topics.length>0?`(${this.filterState.topics.length} selected)`:""}</label>\n                            <div class="filter-dropdown" id="topics-dropdown">\n                                <button class="dropdown-btn" data-dropdown="topics">\n                                    <span class="dropdown-value">${this.getTopicsLabel()}</span>\n                                    <span class="dropdown-arrow">‚ñº</span>\n                                </button>\n                                <div class="dropdown-menu multi-select" data-dropdown-menu="topics">\n                                    <div class="dropdown-search">\n                                        <input type="text" placeholder="Search topics..." class="dropdown-search-input">\n                                    </div>\n                                    <div class="dropdown-options-list">\n                                        ${this.availableOptions.topics.map(t=>`\n                                            <label class="dropdown-option checkbox-option">\n                                                <input type="checkbox" name="topics" value="${t.id}"\n                                                    ${this.filterState.topics.includes(t.id)?"checked":""}>\n                                                <span>${t.name} ${t.count?`(${t.count})`:""}</span>\n                                            </label>\n                                        `).join("")}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Clear All Button --\x3e\n                        <div class="filter-control filter-actions">\n                            <button class="btn-clear-filters" id="btn-clear-filters-panel">\n                                Clear All Filters\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}setupEventListeners(){const t=document.getElementById("filter-toggle-btn");t&&t.addEventListener("click",()=>this.toggleFilterBar()),document.querySelectorAll("#btn-clear-all-filters, #btn-clear-filters-panel").forEach(t=>{t.addEventListener("click",()=>this.clearFilters())}),document.querySelectorAll(".dropdown-btn").forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget.dataset.dropdown;this.toggleDropdown(e)})}),document.querySelectorAll('input[name="content-source"]').forEach(t=>{t.addEventListener("change",t=>{this.updateFilters("contentSource",t.target.value)})}),document.querySelectorAll('input[name="mythologies"]').forEach(t=>{t.addEventListener("change",()=>{const t=Array.from(document.querySelectorAll('input[name="mythologies"]:checked')).map(t=>t.value);this.updateFilters("mythologies",t)})}),document.querySelectorAll('input[name="entity-types"]').forEach(t=>{t.addEventListener("change",()=>{const t=Array.from(document.querySelectorAll('input[name="entity-types"]:checked')).map(t=>t.value);this.updateFilters("entityTypes",t)})}),document.querySelectorAll('input[name="topics"]').forEach(t=>{t.addEventListener("change",()=>{const t=Array.from(document.querySelectorAll('input[name="topics"]:checked')).map(t=>t.value);this.updateFilters("topics",t)})}),document.querySelectorAll(".dropdown-search-input").forEach(t=>{t.addEventListener("input",t=>{this.handleDropdownSearch(t.target)})}),document.addEventListener("click",t=>{t.target.closest(".filter-dropdown")||this.closeAllDropdowns()}),this.setupPillListeners()}setupPillListeners(){document.querySelectorAll(".filter-pill-remove").forEach(t=>{t.addEventListener("click",t=>{t.stopPropagation();const e=t.currentTarget.dataset.filterType,i=t.currentTarget.dataset.filterValue;this.removeFilter(e,i)})})}toggleFilterBar(){this.filterBarVisible=!this.filterBarVisible;const t=document.getElementById("filter-controls-panel"),e=document.querySelector(".filter-bar-container");t&&(t.classList.toggle("visible",this.filterBarVisible),t.classList.toggle("hidden",!this.filterBarVisible)),e&&e.classList.toggle("collapsed",!this.filterBarVisible&&0===this.getActiveFilterCount())}toggleDropdown(t){const e=document.querySelector(`[data-dropdown-menu="${t}"]`);if(!e)return;const i=e.classList.contains("show");this.closeAllDropdowns(),i||e.classList.add("show")}closeAllDropdowns(){document.querySelectorAll(".dropdown-menu").forEach(t=>{t.classList.remove("show")})}handleDropdownSearch(t){const e=t.value.toLowerCase();t.closest(".dropdown-menu").querySelectorAll(".dropdown-option").forEach(t=>{const i=t.textContent.toLowerCase();t.style.display=i.includes(e)?"":"none"})}updateFilters(t,e){this.filterState[t]=e,this.saveToPreferences(),this.updateURLParameters(),this.renderFilterBar(),this.setupEventListeners(),this.notifyFilterChange()}removeFilter(t,e){"contentSource"===t?this.filterState.contentSource="both":Array.isArray(this.filterState[t])&&(this.filterState[t]=this.filterState[t].filter(t=>t!==e)),this.updateFilters(t,this.filterState[t])}clearFilters(){this.filterState={contentSource:"both",mythologies:[],entityTypes:[],topics:[]},this.saveToPreferences(),this.updateURLParameters(),this.renderFilterBar(),this.setupEventListeners(),this.notifyFilterChange()}getActiveFilters(){return{...this.filterState}}getActiveFilterCount(){let t=0;return"both"!==this.filterState.contentSource&&t++,t+=this.filterState.mythologies.length,t+=this.filterState.entityTypes.length,t+=this.filterState.topics.length,t}renderActiveFiltersPills(){const t=[];return"both"!==this.filterState.contentSource&&t.push(`\n                <span class="filter-pill">\n                    ${this.getContentSourceLabel()}\n                    <button class="filter-pill-remove" data-filter-type="contentSource" data-filter-value="${this.filterState.contentSource}">√ó</button>\n                </span>\n            `),this.filterState.mythologies.forEach(e=>{const i=this.availableOptions.mythologies.find(t=>t.id===e);i&&t.push(`\n                    <span class="filter-pill">\n                        ${i.icon} ${i.name}\n                        <button class="filter-pill-remove" data-filter-type="mythologies" data-filter-value="${e}">√ó</button>\n                    </span>\n                `)}),this.filterState.entityTypes.forEach(e=>{const i=this.availableOptions.entityTypes.find(t=>t.id===e);i&&t.push(`\n                    <span class="filter-pill">\n                        ${i.icon} ${i.name}\n                        <button class="filter-pill-remove" data-filter-type="entityTypes" data-filter-value="${e}">√ó</button>\n                    </span>\n                `)}),this.filterState.topics.forEach(e=>{const i=this.availableOptions.topics.find(t=>t.id===e);i&&t.push(`\n                    <span class="filter-pill">\n                        ${i.name}\n                        <button class="filter-pill-remove" data-filter-type="topics" data-filter-value="${e}">√ó</button>\n                    </span>\n                `)}),t.join("")}getContentSourceLabel(){return{both:"Both Sources",official:"Official Only",community:"Community Only"}[this.filterState.contentSource]||"Both Sources"}getMythologiesLabel(){const t=this.filterState.mythologies.length;if(0===t)return"All Mythologies";if(1===t){const t=this.availableOptions.mythologies.find(t=>t.id===this.filterState.mythologies[0]);return t?`${t.icon} ${t.name}`:"1 selected"}return`${t} selected`}getEntityTypesLabel(){const t=this.filterState.entityTypes.length;if(0===t)return"All Types";if(1===t){const t=this.availableOptions.entityTypes.find(t=>t.id===this.filterState.entityTypes[0]);return t?`${t.icon} ${t.name}`:"1 selected"}return`${t} selected`}getTopicsLabel(){const t=this.filterState.topics.length;if(0===t)return"All Topics";if(1===t){const t=this.availableOptions.topics.find(t=>t.id===this.filterState.topics[0]);return t?t.name:"1 selected"}return`${t} selected`}saveToPreferences(){try{localStorage.setItem("headerFilters",JSON.stringify(this.filterState))}catch(t){}}loadFromPreferences(){try{const t=localStorage.getItem("headerFilters");if(t){const e=JSON.parse(t);this.filterState={contentSource:e.contentSource||"both",mythologies:e.mythologies||[],entityTypes:e.entityTypes||[],topics:e.topics||[]}}}catch(t){}}applyURLParameters(){const t=new URLSearchParams(window.location.search);t.has("source")&&(this.filterState.contentSource=t.get("source")),t.has("mythology")&&(this.filterState.mythologies=t.get("mythology").split(",")),t.has("type")&&(this.filterState.entityTypes=t.get("type").split(",")),t.has("topics")&&(this.filterState.topics=t.get("topics").split(","))}updateURLParameters(){const t=new URLSearchParams(window.location.search);"both"!==this.filterState.contentSource?t.set("source",this.filterState.contentSource):t.delete("source"),this.filterState.mythologies.length>0?t.set("mythology",this.filterState.mythologies.join(",")):t.delete("mythology"),this.filterState.entityTypes.length>0?t.set("type",this.filterState.entityTypes.join(",")):t.delete("type"),this.filterState.topics.length>0?t.set("topics",this.filterState.topics.join(",")):t.delete("topics");const e=t.toString()?`${window.location.pathname}?${t.toString()}`:window.location.pathname;window.history.replaceState({},"",e)}onFilterChange(t){this.listeners.push(t)}notifyFilterChange(){this.listeners.forEach(t=>{try{t(this.getActiveFilters())}catch(t){}})}getFallbackMythologies(){return[{id:"greek",name:"Greek",icon:"‚ö°"},{id:"norse",name:"Norse",icon:"‚öîÔ∏è"},{id:"egyptian",name:"Egyptian",icon:"ìÇÄ"},{id:"hindu",name:"Hindu",icon:"üïâÔ∏è"},{id:"buddhist",name:"Buddhist",icon:"‚ò∏Ô∏è"},{id:"chinese",name:"Chinese",icon:"‚òØÔ∏è"},{id:"japanese",name:"Japanese",icon:"‚õ©Ô∏è"},{id:"celtic",name:"Celtic",icon:"‚òòÔ∏è"},{id:"jewish",name:"Jewish",icon:"‚ú°Ô∏è"},{id:"christian",name:"Christian",icon:"‚úùÔ∏è"},{id:"islamic",name:"Islamic",icon:"‚ò™Ô∏è"}]}getFallbackTopics(){return[{id:"creation",name:"Creation",count:0},{id:"death",name:"Death & Afterlife",count:0},{id:"war",name:"War & Combat",count:0},{id:"love",name:"Love & Beauty",count:0},{id:"wisdom",name:"Wisdom & Knowledge",count:0},{id:"nature",name:"Nature & Elements",count:0}]}}async function initHeaderFilters(){const t=()=>new Promise(e=>{window.firebaseApp&&window.firebaseDb?e():setTimeout(()=>t().then(e),100)});await t(),window.headerFilters=new HeaderFilters,await window.headerFilters.init()}window.HeaderFilters=HeaderFilters,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initHeaderFilters):initHeaderFilters(),"undefined"!=typeof module&&module.exports&&(module.exports=HeaderFilters);
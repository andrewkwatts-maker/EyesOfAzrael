import{ENTITY_COLLECTIONS,getCollectionName}from"./constants/entity-types.js";class EntityLoader{static async loadAndRenderGrid(e,t,n={},i={}){const r=document.querySelector(t);if(r){r.innerHTML=this.renderLoadingGrid();try{const t=this.mergeWithHeaderFilters(n);let s=firebase.firestore().collection(e);if(Object.entries(t).forEach(([t,n])=>{s=Array.isArray(n)?s.where(t,"in",n):t.includes(".")?s.where(t,"==",n):t.endsWith("s")&&e!==t?s.where(t,"array-contains",n):s.where(t,"==",n)}),i.orderBy){const[e,t="asc"]=i.orderBy.split(" ");s=s.orderBy(e,t)}else s=s.orderBy("name","asc");i.limit&&(s=s.limit(i.limit));const o=await s.get();let a=o.docs.map(e=>({id:e.id,...e.data()}));if(a=this.applyClientSideFilters(a),0===a.length)return void(r.innerHTML=this.renderEmptyState(e));r.innerHTML="",r.className="entities-grid",a.forEach(e=>{const t=EntityDisplay.renderCard(e);r.appendChild(t)}),this.addGridStatsWithFilters(r,a.length,o.size,e)}catch(e){r.innerHTML=this.renderErrorState(e.message)}}}static mergeWithHeaderFilters(e){if(!window.headerFilters)return e;const t=window.headerFilters.getActiveFilters(),n={...e};return t.mythologies.length>0&&!e.mythology&&(1===t.mythologies.length?n.mythology=t.mythologies[0]:n.mythology=t.mythologies),n}static applyClientSideFilters(e){let t=[...e];if(window.headerFilters){const e=window.headerFilters.getActiveFilters();"both"!==e.contentSource&&(t=t.filter(t=>{const n="official"===t.source||!t.source,i="community"===t.source||t.userSubmitted;return"official"===e.contentSource?n:"community"!==e.contentSource||i})),e.entityTypes.length>0&&(t=t.filter(t=>e.entityTypes.includes(t.type))),e.topics.length>0&&(t=t.filter(t=>{const n=t.tags||t.topics||[];return e.topics.some(e=>n.includes(e))}))}return window.userPreferences&&window.userPreferences.userId&&(t=window.userPreferences.applyFilters(t)),t}static async loadAndRenderDetail(e,t,n){const i=document.querySelector(n);if(i){i.innerHTML=this.renderLoadingDetail();try{const n=this.getCollectionName(t),r=await firebase.firestore().collection(n).doc(e).get();if(!r.exists)return void(i.innerHTML=this.renderNotFound(e,t));const s={id:r.id,...r.data()};EntityDisplay.renderDetail(s,i),document.title=`${s.name||s.title} - Eyes of Azrael`,this.trackView(s)}catch(e){i.innerHTML=this.renderErrorState(e.message)}}}static async loadFromURL(){const e=window.location.pathname,t=new URLSearchParams(window.location.search);if(t.has("type")&&t.has("id")){const e=t.get("type"),n=t.get("id");return void await this.loadAndRenderDetail(n,e,"#entity-container")}const n=e.split("/").filter(e=>e);if(n.length>=3){n[0];const e=n[1].replace(/s$/,""),t=n[2].replace(".html","");await this.loadAndRenderDetail(t,e,"#entity-container")}}static async search(e,t={}){const n=t.collections||["deities","heroes","creatures","items","places","concepts","magic","user_theories","mythologies"],i=[];for(const t of n)try{(await firebase.firestore().collection(t).where("searchTerms","array-contains",e.toLowerCase()).limit(10).get()).forEach(e=>{i.push({id:e.id,collection:t,...e.data()})})}catch(e){}return i}static async loadCrossReferences(e){const t={};if(!e.crossReferences&&!e.relatedEntities)return t;const n=e.crossReferences||e.relatedEntities;for(const[e,i]of Object.entries(n)){if(!i||0===i.length)continue;const n=this.getCollectionName(e.replace(/s$/,""));t[e]=[];for(const r of i.slice(0,5))try{const i=await firebase.firestore().collection(n).doc(r).get();i.exists&&t[e].push({id:i.id,...i.data()})}catch(e){}}return t}static getCollectionName(e){return getCollectionName(e)}static renderLoadingGrid(){return`<div class="entities-grid loading">${Array(12).fill(0).map(()=>'\n            <div class="entity-card skeleton">\n                <div class="skeleton-icon"></div>\n                <div class="skeleton-title"></div>\n                <div class="skeleton-subtitle"></div>\n            </div>\n        ').join("")}</div>`}static renderLoadingDetail(){return'\n            <div class="entity-detail-loading">\n                <div class="skeleton-header"></div>\n                <div class="skeleton-content"></div>\n                <div class="skeleton-content"></div>\n                <div class="skeleton-content"></div>\n            </div>\n        '}static renderEmptyState(e){return`\n            <div class="empty-state">\n                <div class="empty-icon">üîç</div>\n                <h2>No ${e} found</h2>\n                <p>Try adjusting your filters or check back later.</p>\n            </div>\n        `}static renderErrorState(e){return`\n            <div class="error-state">\n                <div class="error-icon">‚ö†Ô∏è</div>\n                <h2>Oops! Something went wrong</h2>\n                <p>${e}</p>\n                <button onclick="location.reload()" class="btn-retry">Try Again</button>\n            </div>\n        `}static renderNotFound(e,t){return`\n            <div class="not-found-state">\n                <div class="not-found-icon">‚ùå</div>\n                <h2>${t} "${e}" not found</h2>\n                <p>This ${t} may have been removed or the link is incorrect.</p>\n                <a href="/${t}s.html" class="btn-back">Browse All ${t}s</a>\n            </div>\n        `}static addGridStats(e,t,n){const i=document.createElement("div");i.className="grid-stats",i.innerHTML=`\n            <p>Showing <strong>${t}</strong> ${n}</p>\n        `,e.parentElement.insertBefore(i,e)}static addGridStatsWithFilters(e,t,n,i){const r=document.createElement("div");r.className="grid-stats filter-results-count";const s=window.headerFilters&&window.headerFilters.getActiveFilterCount()>0;r.innerHTML=s&&t!==n?`\n                <span>Showing <strong>${t}</strong> of <span class="results-total">${n}</span> ${i}</span>\n            `:`\n                <span>Showing <strong>${t}</strong> ${i}</span>\n            `,e.parentElement.insertBefore(r,e)}static trackView(e){window.AnalyticsManager?window.AnalyticsManager.trackEntityView(e):window.gtag&&gtag("event","view_entity",{entity_type:e.type,entity_id:e.id,entity_name:e.name||e.title,mythology:e.mythology})}static async init(){const e=firebase.auth().currentUser;if(e&&window.userPreferences&&!window.userPreferences.userId)try{await window.userPreferences.loadPreferences(e.uid)}catch(e){}document.getElementById("entity-container")&&this.loadFromURL();const t=document.querySelector("[data-entity-grid]");if(t){const e=t.dataset.entityGrid,n=t.dataset.mythology,i=n?{mythology:n}:{};this.loadAndRenderGrid(e,`[data-entity-grid="${e}"]`,i),window.headerFilters&&window.headerFilters.onFilterChange(()=>{this.loadAndRenderGrid(e,`[data-entity-grid="${e}"]`,i)}),window.addEventListener("preferencesApplied",()=>{this.loadAndRenderGrid(e,`[data-entity-grid="${e}"]`,i)})}}static reloadCurrentGrid(){const e=document.querySelector("[data-entity-grid]");if(e){const t=e.dataset.entityGrid,n=e.dataset.mythology,i=n?{mythology:n}:{};this.loadAndRenderGrid(t,`[data-entity-grid="${t}"]`,i)}}}document.addEventListener("DOMContentLoaded",()=>{firebase.auth().onAuthStateChanged(()=>{EntityLoader.init()})}),"undefined"!=typeof module&&module.exports&&(module.exports=EntityLoader);
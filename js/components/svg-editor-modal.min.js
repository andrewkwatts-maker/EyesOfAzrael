class SVGEditorModal{constructor(){this.isOpen=!1,this.currentSvg="",this.currentPrompt="",this.currentMode="code",this.onSaveCallback=null,this.generator=null,this.debounceTimer=null,this.overlay=null,this.authUnsubscribe=null,this.initializeGenerator(),this.setupAuthListener()}setupAuthListener(){"undefined"!=typeof firebase&&firebase.auth&&(this.authUnsubscribe=firebase.auth().onAuthStateChanged(e=>{this.isOpen&&this.refreshAITab()}))}refreshAITab(){if(!this.overlay)return;const e=this.overlay.querySelector('[data-content="ai"]');if(!e)return;const t=e.querySelector(".svg-editor-left");t&&(t.innerHTML=this.getAIGeneratorHTML(),this.attachAITabEventListeners())}initializeGenerator(){window.GeminiSVGGenerator&&(this.generator=new window.GeminiSVGGenerator),window.AIIconGenerator&&(this.iconGenerator=new window.AIIconGenerator)}open(e={}){this.isOpen||(this.currentSvg=e.initialSvg||"",this.currentPrompt=e.initialPrompt||"",this.onSaveCallback=e.onSave||null,this.entityData=e.entityData||null,this.render(),this.attachEventListeners(),this.updatePreview(),this.isOpen=!0,setTimeout(()=>{const e=this.overlay.querySelector(".svg-code-textarea, .svg-prompt-input");e&&e.focus()},100))}destroy(){this.authUnsubscribe&&(this.authUnsubscribe(),this.authUnsubscribe=null)}close(){this.overlay&&(this.overlay.remove(),this.overlay=null),this.isOpen=!1,this.currentSvg="",this.currentPrompt="",this.onSaveCallback=null}render(){this.overlay=document.createElement("div"),this.overlay.className="svg-editor-overlay",this.overlay.innerHTML=this.getModalHTML(),document.body.appendChild(this.overlay)}getModalHTML(){const e=!!this.generator;return`\n            <div class="svg-editor-modal">\n                \x3c!-- Header --\x3e\n                <div class="svg-editor-header">\n                    <h2 class="svg-editor-title">ðŸŽ¨ SVG Editor</h2>\n                    <button class="svg-editor-close" data-action="close" title="Close (Esc)">Ã—</button>\n                </div>\n\n                \x3c!-- Tabs --\x3e\n                <div class="svg-editor-tabs">\n                    <button class="svg-tab active" data-tab="code">Code Editor</button>\n                    <button class="svg-tab ${e?"":"disabled"}" data-tab="ai" ${e?"":'disabled title="Gemini API not available"'}>\n                        AI Generator ${e&&this.generator.isConfigured()?"":"(Sign In Required)"}\n                    </button>\n                    <button class="svg-tab" data-tab="browse">Browse My SVGs</button>\n                </div>\n\n                \x3c!-- Body --\x3e\n                <div class="svg-editor-body">\n                    \x3c!-- Code Editor Tab --\x3e\n                    <div class="svg-tab-content active" data-content="code">\n                        <div class="svg-editor-left">\n                            ${this.getCodeEditorHTML()}\n                        </div>\n                        <div class="svg-editor-right">\n                            ${this.getPreviewHTML()}\n                        </div>\n                    </div>\n\n                    \x3c!-- AI Generator Tab --\x3e\n                    <div class="svg-tab-content" data-content="ai">\n                        <div class="svg-editor-left">\n                            ${this.getAIGeneratorHTML()}\n                        </div>\n                        <div class="svg-editor-right">\n                            ${this.getPreviewHTML()}\n                        </div>\n                    </div>\n\n                    \x3c!-- Browse SVGs Tab --\x3e\n                    <div class="svg-tab-content" data-content="browse">\n                        <div class="svg-browse-container" id="svg-browse-container">\n                            <p class="svg-browse-loading">Loading your SVGs...</p>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Footer --\x3e\n                <div class="svg-editor-footer">\n                    <label class="svg-save-library">\n                        <input type="checkbox" id="svg-save-to-library" />\n                        <span>Save to SVG Library (future feature)</span>\n                    </label>\n                    <div class="svg-footer-actions">\n                        <button class="svg-btn-cancel" data-action="close">Cancel</button>\n                        <button class="svg-btn-insert" data-action="insert">Insert SVG</button>\n                    </div>\n                </div>\n            </div>\n        `}getCodeEditorHTML(){return`\n            <div class="svg-code-editor-section">\n                <label class="svg-code-label">SVG Code</label>\n                <textarea\n                    class="svg-code-textarea"\n                    id="svg-code-input"\n                    placeholder="Paste your SVG code here...&#10;&#10;Example:&#10;<svg viewBox=&quot;0 0 400 400&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;>&#10;  <circle cx=&quot;200&quot; cy=&quot;200&quot; r=&quot;100&quot; fill=&quot;#8b7fff&quot; />&#10;</svg>"\n                    spellcheck="false"\n                >${this.escapeHtml(this.currentSvg)}</textarea>\n                <p class="svg-code-hint">Paste SVG code or write it manually. Preview updates automatically.</p>\n                <p class="svg-keyboard-hint">Tip: Press Ctrl+Enter (Cmd+Enter) to insert</p>\n            </div>\n        `}getAIGeneratorHTML(){if("undefined"==typeof firebase||!firebase.auth||null===firebase.auth().currentUser)return this.getConfigInstructionsHTML();const e=window.GeminiSVGGenerator.getExamplePrompts();return`\n            <div class="svg-ai-generator-section">\n                <div id="svg-ai-messages"></div>\n\n                <div class="svg-form-group">\n                    <label class="svg-form-label">Describe Your SVG</label>\n                    <textarea\n                        class="svg-prompt-input"\n                        id="svg-prompt-input"\n                        placeholder="Example: Zeus hurling a lightning bolt with dramatic clouds and golden accents"\n                    >${this.escapeHtml(this.currentPrompt)}</textarea>\n                    <p class="svg-form-hint">Describe the mythological scene, symbol, or concept you want to visualize</p>\n                    ${this.entityData?'<button type="button" class="svg-generate-from-entity-btn" id="svg-generate-from-entity-btn" style="margin-top: 0.5rem;">\n                        ðŸ¤– Generate Icon from Entity Data\n                    </button>':""}\n                </div>\n\n                <div class="svg-form-group">\n                    <label class="svg-form-label">Style</label>\n                    <select class="svg-select" id="svg-style-select">\n                        <option value="symbolic">Symbolic - Clean, iconic symbols</option>\n                        <option value="detailed">Detailed - Rich, intricate designs</option>\n                        <option value="minimalist">Minimalist - Simple, modern aesthetic</option>\n                        <option value="geometric">Geometric - Sacred geometry patterns</option>\n                    </select>\n                </div>\n\n                <div class="svg-form-group">\n                    <label class="svg-form-label">Color Scheme</label>\n                    <select class="svg-select" id="svg-color-select">\n                        <option value="fire">Fire - Oranges, reds, gold</option>\n                        <option value="divine">Divine - Purple, gold, white</option>\n                        <option value="nature">Nature - Greens, browns, earth tones</option>\n                        <option value="water">Water - Blues, teals, aqua</option>\n                        <option value="monochrome">Monochrome - Purple shades</option>\n                    </select>\n                </div>\n\n                <button class="svg-generate-btn" id="svg-generate-btn" data-action="generate">\n                    <span id="svg-generate-text">âœ¨ Generate SVG</span>\n                    <span id="svg-generate-spinner" class="svg-loading-spinner" style="display: none;"></span>\n                </button>\n\n                <div class="svg-examples">\n                    <div class="svg-examples-title">ðŸ’¡ Example Prompts</div>\n                    <div class="svg-examples-list">\n                        ${e.slice(0,5).map(e=>`\n                            <button class="svg-example-btn" data-action="use-example" data-prompt="${this.escapeHtml(e.text)}" data-style="${e.style}" data-color="${e.colorScheme}">\n                                ${this.escapeHtml(e.text)}\n                            </button>\n                        `).join("")}\n                    </div>\n                </div>\n            </div>\n        `}getConfigInstructionsHTML(){if(!this.generator)return'\n                <div class="svg-message error">\n                    <strong>Error:</strong> GeminiSVGGenerator component not loaded. Please ensure the script is included.\n                </div>\n            ';const e=this.generator.getConfigInstructions();return`\n            <div class="svg-config-instructions">\n                <div class="svg-config-title">${e.title}</div>\n                <p>${e.message}</p>\n                <ul class="svg-config-steps">\n                    ${e.steps.map(e=>`<li>${e}</li>`).join("")}\n                </ul>\n                <p class="svg-form-hint">${e.note}</p>\n                <p class="svg-form-hint" style="margin-top: 1rem;">\n                    You can still use the Code Editor tab to paste SVG code manually without signing in.\n                </p>\n            </div>\n        `}getPreviewHTML(){return'\n            <div class="svg-preview-section">\n                <div class="svg-preview-title">Live Preview</div>\n                <div class="svg-preview-container" id="svg-preview-container">\n                    <p class="svg-preview-empty">Preview will appear here</p>\n                </div>\n            </div>\n        '}attachEventListeners(){this.overlay.querySelectorAll('[data-action="close"]').forEach(e=>{e.addEventListener("click",()=>this.close())}),this.overlay.querySelectorAll(".svg-tab:not(.disabled)").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.tab;this.switchTab(t)})});const e=this.overlay.querySelector("#svg-code-input");e&&(e.addEventListener("input",e=>{this.currentSvg=e.target.value,this.debounceUpdatePreview()}),e.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),this.insertSVG())})),this.attachAITabEventListeners();const t=this.overlay.querySelector('[data-action="insert"]');t&&t.addEventListener("click",()=>this.insertSVG()),this.handleEscKey=e=>{"Escape"===e.key&&this.close()},document.addEventListener("keydown",this.handleEscKey),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.close()})}attachAITabEventListeners(){const e=this.overlay.querySelector("#svg-prompt-input");e&&(e.addEventListener("input",e=>{this.currentPrompt=e.target.value}),e.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),this.generateSVG())}));const t=this.overlay.querySelector("#svg-generate-btn");t&&t.addEventListener("click",()=>this.generateSVG()),this.overlay.querySelectorAll('[data-action="use-example"]').forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.prompt,s=e.target.dataset.style,n=e.target.dataset.color;this.useExample(t,s,n)})});const s=this.overlay.querySelector("#svg-generate-from-entity-btn");s&&!s.dataset.handlerAttached&&(s.dataset.handlerAttached="true",s.addEventListener("click",()=>this.generateFromEntity()))}switchTab(e){this.overlay.querySelectorAll(".svg-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),this.overlay.querySelectorAll(".svg-tab-content").forEach(t=>{t.classList.toggle("active",t.dataset.content===e)}),this.currentMode=e,"browse"===e&&this.loadUserSVGs()}async loadUserSVGs(){const e=document.getElementById("svg-browse-container");if(e)if(firebase&&firebase.auth&&firebase.auth().currentUser)try{const t=firebase.auth().currentUser.uid,s=firebase.firestore().collection("svgGeneration").where("userId","==",t).orderBy("createdAt","desc").limit(50),n=await s.get();if(n.empty)return void(e.innerHTML='\n                    <div class="svg-browse-empty">\n                        <h3>No SVGs Yet</h3>\n                        <p>You haven\'t generated any SVGs yet.</p>\n                        <p>Try the <strong>AI Generator</strong> tab to create your first SVG!</p>\n                    </div>\n                ');const i=n.docs.map(e=>({id:e.id,...e.data()}));this.renderUserSVGs(i,e)}catch(t){e.innerHTML=`\n                <div class="svg-browse-error">\n                    <p>Error loading SVGs: ${this.escapeHtml(t.message)}</p>\n                </div>\n            `}else e.innerHTML='\n                <div class="svg-browse-signin">\n                    <h3>Sign In Required</h3>\n                    <p>Sign in with Google to browse your saved SVGs.</p>\n                </div>\n            '}renderUserSVGs(e,t){t.innerHTML=`\n            <div class="svg-browse-header">\n                <h3>My SVGs (${e.length})</h3>\n                <p>Click an SVG to load it into the editor</p>\n            </div>\n            <div class="svg-browse-grid">\n                ${e.map(e=>`\n                    <div class="svg-browse-item" data-svg-id="${e.id}">\n                        <div class="svg-browse-preview">\n                            ${e.svgCode||'<p class="svg-no-preview">No preview</p>'}\n                        </div>\n                        <div class="svg-browse-info">\n                            <p class="svg-browse-prompt" title="${this.escapeHtml(e.prompt||"No prompt")}">${this.escapeHtml(this.truncate(e.prompt||"Untitled",50))}</p>\n                            <p class="svg-browse-date">${this.formatDate(e.createdAt)}</p>\n                        </div>\n                        <button class="svg-browse-use-btn" data-svg-id="${e.id}" title="Use this SVG">\n                            Use\n                        </button>\n                    </div>\n                `).join("")}\n            </div>\n        `,t.querySelectorAll(".svg-browse-use-btn").forEach(t=>{t.addEventListener("click",t=>{const s=t.target.dataset.svgId,n=e.find(e=>e.id===s);n&&this.loadSVGIntoEditor(n)})}),t.querySelectorAll(".svg-browse-item").forEach(t=>{t.addEventListener("click",s=>{if(s.target.classList.contains("svg-browse-use-btn"))return;const n=t.dataset.svgId,i=e.find(e=>e.id===n);i&&this.loadSVGIntoEditor(i)})})}loadSVGIntoEditor(e){this.currentSvg=e.svgCode||"",this.currentPrompt=e.prompt||"",this.switchTab("code");const t=this.overlay.querySelector("#svg-code-input");t&&(t.value=this.currentSvg),this.updatePreview()}truncate(e,t){return e.length<=t?e:e.substring(0,t-3)+"..."}formatDate(e){if(!e)return"Unknown date";try{return(e.toDate?e.toDate():new Date(e)).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch(e){return"Unknown date"}}debounceUpdatePreview(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.updatePreview()},500)}updatePreview(){this.overlay.querySelectorAll("#svg-preview-container").forEach(e=>{if(!this.currentSvg||""===this.currentSvg.trim())return void(e.innerHTML='<p class="svg-preview-empty">Preview will appear here</p>');if(!this.generator)return void(e.innerHTML=this.currentSvg);const t=this.generator.validateSVG(this.currentSvg);t.valid?e.innerHTML=this.currentSvg:e.innerHTML=`\n                    <p class="svg-preview-empty" style="color: #fca5a5;">\n                        Invalid SVG: ${t.errors.join(", ")}\n                    </p>\n                `})}async generateFromEntity(){if(this.iconGenerator)if(this.entityData){this.setGenerating(!0),this.showMessage("info","Generating icon from entity data...");try{const e=this.iconGenerator.generateWithOptions(this.entityData,{style:"symbolic",size:64,colorScheme:"auto"});if(e.success){this.currentSvg=e.svgCode;const t=this.overlay.querySelector("#svg-code-input");t&&(t.value=this.currentSvg),this.updatePreview(),this.showMessage("success",`Icon generated for ${this.entityData.name}! You can edit the code in the Code Editor tab if needed.`)}else this.showMessage("error",`Generation failed: ${e.error}`)}catch(e){this.showMessage("error",`Unexpected error: ${e.message}`)}finally{this.setGenerating(!1)}}else this.showMessage("error","No entity data provided for icon generation.");else this.showMessage("error","AI Icon Generator not available. Please ensure ai-icon-generator.js is loaded.")}async generateSVG(){if(!this.generator||!this.generator.isConfigured())return void this.showMessage("error","AI generation is not configured. Please check the configuration instructions.");const e=this.currentPrompt.trim();if(!e)return void this.showMessage("error","Please enter a description for your SVG.");const t=this.overlay.querySelector("#svg-style-select")?.value||"symbolic",s=this.overlay.querySelector("#svg-color-select")?.value||"divine";this.setGenerating(!0),this.showMessage("info","Generating SVG with Gemini AI... This may take a few seconds.");try{const n=await this.generator.generateSVG(e,{style:t,colorScheme:s});if(n.success){this.currentSvg=n.svgCode;const e=this.overlay.querySelector("#svg-code-input");e&&(e.value=this.currentSvg),this.updatePreview(),this.showMessage("success","SVG generated successfully! You can edit the code in the Code Editor tab if needed.")}else n.needsAuth?this.showMessage("error","Not signed in. Please sign in with Google to use AI generation."):this.showMessage("error",`Generation failed: ${n.error}`)}catch(e){this.showMessage("error",`Unexpected error: ${e.message}`)}finally{this.setGenerating(!1)}}setGenerating(e){const t=this.overlay.querySelector("#svg-generate-btn"),s=this.overlay.querySelector("#svg-generate-text"),n=this.overlay.querySelector("#svg-generate-spinner");t&&(t.disabled=e),s&&(s.textContent=e?"Generating...":"âœ¨ Generate SVG"),n&&(n.style.display=e?"inline-block":"none")}showMessage(e,t){const s=this.overlay.querySelector("#svg-ai-messages");s&&(s.innerHTML=`\n            <div class="svg-message ${e}">\n                ${t}\n            </div>\n        `,"success"===e&&setTimeout(()=>{s&&(s.innerHTML="")},5e3))}useExample(e,t,s){this.currentPrompt=e;const n=this.overlay.querySelector("#svg-prompt-input"),i=this.overlay.querySelector("#svg-style-select"),r=this.overlay.querySelector("#svg-color-select");n&&(n.value=e),i&&(i.value=t),r&&(r.value=s)}insertSVG(){if(this.currentSvg&&""!==this.currentSvg.trim()){if(this.generator){const e=this.generator.validateSVG(this.currentSvg);if(!e.valid)return void alert(`Cannot insert invalid SVG:\n${e.errors.join("\n")}`)}this.onSaveCallback&&this.onSaveCallback({svgCode:this.currentSvg,prompt:this.currentPrompt,generatedBy:"ai"===this.currentMode?"gemini-ai":"user"}),this.close()}else this.showMessage("error","No SVG to insert. Please generate or paste SVG code first.")}cleanup(){this.handleEscKey&&document.removeEventListener("keydown",this.handleEscKey),this.debounceTimer&&clearTimeout(this.debounceTimer)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.SVGEditorModal||(window.SVGEditorModal=new SVGEditorModal),window.SVGEditorModalClass=SVGEditorModal;
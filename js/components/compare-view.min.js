class CompareView{constructor(e){this.db=e,this.selectedEntities=[],this.maxEntities=6,this.minEntities=2,this.searchResults=[],this.mythologies=["egyptian","greek","norse","celtic","hindu","buddhist","chinese","japanese","aztec","mayan","babylonian","sumerian","persian","roman","christian","islamic","jewish","yoruba","native_american","apocryphal"],this.collections={deities:"Deities",heroes:"Heroes",creatures:"Creatures",cosmology:"Cosmology",rituals:"Rituals",herbs:"Herbs",texts:"Texts",symbols:"Symbols",items:"Items",places:"Places",magic:"Magic",concepts:"Concepts"}}async render(e){await this.parseURLParams(),e.innerHTML=this.getHTML(),await this.init()}async parseURLParams(){const e=new URLSearchParams(window.location.hash.split("?")[1]).get("entities");if(e){const t=e.split(",");for(const e of t.slice(0,this.maxEntities)){const[t,i]=e.split(":");t&&i&&await this.addEntityById(t,i)}}}getHTML(){return`\n            <div class="compare-view">\n                <div class="compare-header">\n                    <h1>Compare Entities</h1>\n                    <div class="compare-actions">\n                        <button id="share-compare" class="btn-secondary" ${this.selectedEntities.length<this.minEntities?"disabled":""}>\n                            üîó Share\n                        </button>\n                        <button id="export-compare" class="btn-secondary" ${this.selectedEntities.length<this.minEntities?"disabled":""}>\n                            üì• Export\n                        </button>\n                        <button id="clear-compare" class="btn-secondary" ${0===this.selectedEntities.length?"disabled":""}>\n                            üóëÔ∏è Clear All\n                        </button>\n                    </div>\n                </div>\n\n                <div class="entity-selector-panel">\n                    <h3>Add Entities to Compare (${this.selectedEntities.length}/${this.maxEntities})</h3>\n\n                    <div class="selector-controls">\n                        <div class="search-input-wrapper">\n                            <input type="text"\n                                   id="entity-search"\n                                   placeholder="Search entities by name..."\n                                   ${this.selectedEntities.length>=this.maxEntities?"disabled":""}>\n                            <span class="search-icon">üîç</span>\n                        </div>\n\n                        <select id="mythology-filter">\n                            <option value="">All Mythologies</option>\n                            ${this.mythologies.map(e=>`\n                                <option value="${e}">${this.capitalize(e)}</option>\n                            `).join("")}\n                        </select>\n\n                        <select id="type-filter">\n                            <option value="">All Types</option>\n                            ${Object.entries(this.collections).map(([e,t])=>`\n                                <option value="${e}">${t}</option>\n                            `).join("")}\n                        </select>\n                    </div>\n\n                    <div id="search-results" class="search-results">\n                        ${this.selectedEntities.length>=this.maxEntities?'<p class="max-entities-msg">Maximum entities reached. Remove one to add more.</p>':'<p class="search-hint">Use the search and filters above to find entities</p>'}\n                    </div>\n                </div>\n\n                <div id="comparison-section" class="comparison-section">\n                    ${this.renderComparisonContent()}\n                </div>\n            </div>\n        `}renderComparisonContent(){return 0===this.selectedEntities.length?this.renderEmptyState():1===this.selectedEntities.length?this.renderSingleEntity():this.renderComparisonTable()}renderEmptyState(){return`\n            <div class="empty-state">\n                <div class="empty-state-icon">‚öñÔ∏è</div>\n                <h2>No Entities Selected</h2>\n                <p>Select at least ${this.minEntities} entities to compare their attributes side-by-side.</p>\n                <p class="hint">Try searching for "Zeus" and "Odin" to compare Greek and Norse gods!</p>\n            </div>\n        `}renderSingleEntity(){return'\n            <div class="single-entity-state">\n                <div class="single-entity-icon">üìå</div>\n                <h2>One Entity Selected</h2>\n                <p>Add at least one more entity to enable comparison.</p>\n            </div>\n        '}renderComparisonTable(){const e=this.getCommonAttributes();return`\n            <div class="comparison-table-wrapper">\n                <table class="comparison-table">\n                    <thead>\n                        <tr>\n                            <th class="attribute-column">Attribute</th>\n                            ${this.selectedEntities.map((e,t)=>`\n                                <th class="entity-column entity-${t}" data-mythology="${e.mythology}">\n                                    <div class="entity-header">\n                                        ${e.icon?`<div class="entity-icon">${e.icon}</div>`:""}\n                                        <div class="entity-info">\n                                            <div class="entity-name">${e.name||"Unknown"}</div>\n                                            <div class="entity-meta">\n                                                <span class="mythology-badge">${this.capitalize(e.mythology||"Unknown")}</span>\n                                                <span class="type-badge">${this.capitalize(e.type||"Entity")}</span>\n                                            </div>\n                                        </div>\n                                        <button class="remove-entity-btn" data-index="${t}" title="Remove">‚úï</button>\n                                    </div>\n                                </th>\n                            `).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${e.map(e=>this.renderAttributeRow(e)).join("")}\n                    </tbody>\n                </table>\n            </div>\n        `}renderAttributeRow(e){const t=this.selectedEntities.map(t=>{let i=t[e.key];return null==i?{raw:null,display:"‚Äî",isEmpty:!0}:Array.isArray(i)?{raw:i,display:i.length>0?i.join(", "):"‚Äî",isEmpty:0===i.length}:"object"==typeof i?{raw:i,display:JSON.stringify(i),isEmpty:0===Object.keys(i).length}:{raw:i,display:String(i),isEmpty:!1}});return`\n            <tr class="attribute-row ${this.getHighlightClass(t)}">\n                <td class="attribute-name">${e.label}</td>\n                ${t.map((e,t)=>`\n                    <td class="entity-value entity-${t}" data-mythology="${this.selectedEntities[t].mythology}">\n                        ${e.isEmpty?'<span class="empty-value">‚Äî</span>':e.display}\n                    </td>\n                `).join("")}\n            </tr>\n        `}getHighlightClass(e){const t=e.filter(e=>!e.isEmpty);if(0===t.length)return"all-empty";const i=JSON.stringify(t[0].raw),n=t.every(e=>JSON.stringify(e.raw)===i);return n&&t.length===e.length?"all-match":n?"some-match":"all-differ"}getCommonAttributes(){return[{key:"name",label:"Name"},{key:"mythology",label:"Mythology"},{key:"type",label:"Type"},{key:"title",label:"Title"},{key:"description",label:"Description"},{key:"domain",label:"Domain"},{key:"domains",label:"Domains"},{key:"symbols",label:"Symbols"},{key:"attributes",label:"Attributes"},{key:"powers",label:"Powers"},{key:"epithets",label:"Epithets"},{key:"family",label:"Family"},{key:"parents",label:"Parents"},{key:"children",label:"Children"},{key:"consort",label:"Consort"},{key:"siblings",label:"Siblings"},{key:"sacred_animals",label:"Sacred Animals"},{key:"sacred_plants",label:"Sacred Plants"},{key:"festivals",label:"Festivals"},{key:"temples",label:"Temples"},{key:"weapons",label:"Weapons"},{key:"myths",label:"Associated Myths"},{key:"cultural_significance",label:"Cultural Significance"},{key:"modern_influence",label:"Modern Influence"}].filter(e=>this.selectedEntities.some(t=>{const i=t[e.key];return null!=i&&(!Array.isArray(i)||i.length>0)&&("object"!=typeof i||Object.keys(i).length>0)}))}async init(){const e=document.getElementById("entity-search");if(e){let t;e.addEventListener("input",e=>{clearTimeout(t),t=setTimeout(()=>{this.performSearch(e.target.value)},300)})}const t=document.getElementById("mythology-filter"),i=document.getElementById("type-filter");t&&t.addEventListener("change",()=>{const t=e?e.value:"";this.performSearch(t)}),i&&i.addEventListener("change",()=>{const t=e?e.value:"";this.performSearch(t)});const n=document.getElementById("clear-compare");n&&n.addEventListener("click",()=>this.clearAll());const s=document.getElementById("share-compare");s&&s.addEventListener("click",()=>this.shareComparison());const a=document.getElementById("export-compare");a&&a.addEventListener("click",()=>this.exportComparison()),document.addEventListener("click",e=>{if(e.target.classList.contains("remove-entity-btn")){const t=parseInt(e.target.dataset.index);this.removeEntity(t)}})}async performSearch(e){const t=document.getElementById("mythology-filter")?.value||"",i=document.getElementById("type-filter")?.value||"",n=document.getElementById("search-results");if(n){n.innerHTML='<div class="search-loading">Searching...</div>';try{const s=await this.searchEntities(e,t,i);this.searchResults=s,0===s.length?n.innerHTML='<p class="no-results">No entities found matching your criteria.</p>':(n.innerHTML=`\n                    <div class="search-results-grid">\n                        ${s.map(e=>this.renderSearchResult(e)).join("")}\n                    </div>\n                `,n.querySelectorAll(".search-result-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.collection,i=(e.dataset.id,JSON.parse(e.dataset.entity));this.addEntity(i,t)})}))}catch(e){n.innerHTML='<p class="search-error">Error performing search. Please try again.</p>'}}}async searchEntities(e,t,i){if(!this.db)throw new Error("Firestore not initialized");const n=[],s=i?[i]:Object.keys(this.collections),a=e.toLowerCase();for(const i of s)try{let s=this.db.collection(i);t&&(s=s.where("mythology","==",t)),s=s.limit(20),(await s.get()).docs.forEach(t=>{const s=t.data(),l=(s.name||"").toLowerCase();e&&!l.includes(a)||this.selectedEntities.some(e=>e.id===t.id&&e._collection===i)||n.push({id:t.id,collection:i,...s})})}catch(e){}return n.slice(0,50)}renderSearchResult(e){return`\n            <div class="search-result-card"\n                 data-collection="${e.collection}"\n                 data-id="${e.id}"\n                 data-entity='${JSON.stringify(e)}'>\n                <div class="result-header">\n                    ${e.icon?`<span class="result-icon">${e.icon}</span>`:""}\n                    <div class="result-info">\n                        <div class="result-name">${e.name||"Unknown"}</div>\n                        <div class="result-meta">\n                            <span class="mythology-badge">${this.capitalize(e.mythology||"Unknown")}</span>\n                            <span class="type-badge">${this.capitalize(e.type||e.collection)}</span>\n                        </div>\n                    </div>\n                </div>\n                ${e.title?`<div class="result-title">${e.title}</div>`:""}\n                ${e.description?`<div class="result-description">${this.truncate(e.description,100)}</div>`:""}\n            </div>\n        `}async addEntityById(e,t){if(this.db)try{const i=await this.db.collection(e).doc(t).get();if(i.exists){const t={id:i.id,...i.data()};this.addEntity(t,e)}}catch(e){}}addEntity(e,t){if(this.selectedEntities.length>=this.maxEntities)this.showToast("Maximum entities reached. Remove one to add more.");else{if(e._collection=t,this.selectedEntities.push(e),this.selectedEntities.length>=this.minEntities&&window.AnalyticsManager){const e=this.selectedEntities.map(e=>e.id),t=this.selectedEntities.map(e=>e.type||e._collection);window.AnalyticsManager.trackEntityComparison(e,t)}this.refresh()}}removeEntity(e){e>=0&&e<this.selectedEntities.length&&(this.selectedEntities.splice(e,1)[0],this.refresh())}clearAll(){confirm("Clear all selected entities?")&&(this.selectedEntities=[],this.refresh())}shareComparison(){if(this.selectedEntities.length<this.minEntities)return void this.showToast("Select at least 2 entities to share.");const e=this.selectedEntities.map(e=>`${e._collection}:${e.id}`).join(","),t=`${window.location.origin}${window.location.pathname}#/compare?entities=${e}`;navigator.clipboard?navigator.clipboard.writeText(t).then(()=>{this.showToast("Share link copied to clipboard!")}).catch(e=>{this.showToast("Failed to copy link.")}):prompt("Copy this URL:",t)}async exportComparison(){this.selectedEntities.length<this.minEntities?this.showToast("Select at least 2 entities to export."):(this.showToast("Export feature requires html2canvas library. This is a placeholder."),window.print())}refresh(){const e=document.querySelector(".compare-view");if(!e)return;const t=e.parentElement;this.render(t)}showToast(e){window.showToast?window.showToast(e):alert(e)}capitalize(e){return e?e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()):""}truncate(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":""}}export{CompareView};"undefined"!=typeof window&&(window.CompareView=CompareView);
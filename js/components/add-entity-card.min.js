!function(){"use strict";class t{constructor(t){this.containerId=t.containerId,this.entityType=t.entityType||this.detectEntityType(),this.mythology=t.mythology||this.detectMythology(),this.category=t.category||this.detectCategory(),this.parentEntity=t.parentEntity||this.detectParentEntity(),this.relationshipType=t.relationshipType||null,this.suggestedEntities=t.suggestedEntities||[],this.label=t.label||this.generateLabel(),this.guestLabel=t.guestLabel||`Sign in to add ${this.capitalizeFirst(this.entityType)}`,this.icon=t.icon||"+",this.redirectUrl=t.redirectUrl||"/theories/user-submissions/edit.html",this.showForGuests=void 0===t.showForGuests||t.showForGuests,this.position=t.position||"end",this.prePopulateFields=void 0===t.prePopulateFields||t.prePopulateFields,this.currentUser=null,this.cardElement=null}async init(){try{await this.waitForAuth(),window.firebaseAuth&&window.firebaseAuth.onAuthStateChanged(t=>{this.currentUser=t,this.updateVisibility()}),this.render()}catch(t){}}async waitForAuth(){return new Promise(t=>{if(window.firebaseAuth&&window.firebaseAuth.auth)t();else{const e=setInterval(()=>{window.firebaseAuth&&window.firebaseAuth.auth&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)}})}detectMythology(){const t=document.querySelector("main[data-mythology]");if(t)return t.getAttribute("data-mythology");const e=window.location.pathname.split("/").filter(Boolean),i=e.indexOf("mythos");if(i>=0&&e[i+1])return e[i+1];const n=document.querySelector('meta[name="mythology"]');return n?n.getAttribute("content"):null}detectEntityType(){const t=window.location.pathname.split("/").filter(Boolean),e=["deities","heroes","creatures","items","places","herbs","rituals","texts","symbols","figures","beings"];for(const i of e)if(t.includes(i))return i.endsWith("ies")?i.slice(0,-3)+"y":i.slice(0,-1);const i=document.querySelector('meta[name="entity-type"]');if(i)return i.getAttribute("content");const n=document.querySelector('[class*="-grid"][data-entity-type]');return n?n.getAttribute("data-entity-type"):"entity"}detectCategory(){const t=new URLSearchParams(window.location.search);if(t.has("category"))return t.get("category");const e=document.querySelector("main[data-category]");if(e)return e.getAttribute("data-category");const i=document.querySelector('meta[name="category"]');return i?i.getAttribute("content"):null}detectParentEntity(){const t=new URLSearchParams(window.location.search);if(t.has("parent"))return t.get("parent");const e=document.querySelector('meta[name="entity-id"]');if(e)return e.getAttribute("content");const i=document.querySelector("main[data-entity-id]");return i?i.getAttribute("data-entity-id"):null}generateLabel(){const t=this.capitalizeFirst(this.entityType);return this.parentEntity?`Add Related ${t}`:this.mythology?`Add ${this.capitalizeFirst(this.mythology)} ${t}`:`Add New ${t}`}render(){const t=document.getElementById(this.containerId);t&&(this.cardElement=document.createElement("div"),this.cardElement.className="add-entity-card",this.cardElement.setAttribute("role","button"),this.cardElement.setAttribute("tabindex","0"),this.cardElement.setAttribute("data-entity-type",this.entityType),this.mythology&&this.cardElement.setAttribute("data-mythology",this.mythology),this.parentEntity&&this.cardElement.setAttribute("data-parent-entity",this.parentEntity),this.renderCardContent(),this.cardElement.addEventListener("click",()=>this.handleClick()),this.cardElement.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.handleClick())}),"start"===this.position?t.insertBefore(this.cardElement,t.firstChild):t.appendChild(this.cardElement),this.updateVisibility())}renderCardContent(){const t=null!==this.currentUser,e=t?this.label:this.guestLabel,i=t?this.icon:"ðŸ”’";this.cardElement.setAttribute("aria-label",e),!t&&this.showForGuests?this.cardElement.classList.add("add-entity-card--guest"):this.cardElement.classList.remove("add-entity-card--guest"),this.cardElement.innerHTML=`\n                <div class="add-entity-card__icon">${i}</div>\n                <div class="add-entity-card__label">${e}</div>\n                ${this.parentEntity?'<div class="add-entity-card__context">Related to current entity</div>':""}\n            `}handleClick(){if(!this.currentUser)return void(window.firebaseAuth&&window.firebaseAuth.showLoginModal());this.storeContextForSubmission();const t=this.buildRedirectUrl();window.location.href=t}buildRedirectUrl(){const t=new URLSearchParams;return t.set("action","create"),t.set("type",this.entityType),this.mythology&&t.set("mythology",this.mythology),this.category&&t.set("category",this.category),this.parentEntity&&t.set("parent",this.parentEntity),this.relationshipType&&t.set("relationshipType",this.relationshipType),this.suggestedEntities.length>0&&t.set("suggestedEntities",JSON.stringify(this.suggestedEntities)),this.prePopulateFields&&t.set("prepopulate","true"),`${this.redirectUrl}?${t.toString()}`}updateVisibility(){this.cardElement&&(this.showForGuests||null!==this.currentUser?(this.cardElement.style.display="",this.cardElement.classList.add("add-entity-card--visible"),this.renderCardContent()):(this.cardElement.style.display="none",this.cardElement.classList.remove("add-entity-card--visible")))}getContextMetadata(){return{entityType:this.entityType,mythology:this.mythology,category:this.category,parentEntity:this.parentEntity,relationshipType:this.relationshipType,suggestedEntities:this.suggestedEntities,timestamp:(new Date).toISOString(),pageUrl:window.location.href,pagePath:window.location.pathname}}storeContextForSubmission(){const t=this.getContextMetadata();try{sessionStorage.setItem("submission_context",JSON.stringify(t))}catch(t){}}capitalizeFirst(t){return t.charAt(0).toUpperCase()+t.slice(1)}destroy(){this.cardElement&&this.cardElement.parentNode&&this.cardElement.parentNode.removeChild(this.cardElement),this.cardElement=null}}window.renderAddEntityCard=function(e){const i=new t(e);return i.init(),i},document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-add-entity-auto]").forEach(t=>{const e={containerId:t.id||`add-entity-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,entityType:t.getAttribute("data-entity-type")||"entity",mythology:t.getAttribute("data-mythology")||null,category:t.getAttribute("data-category")||null,label:t.getAttribute("data-label")||void 0,icon:t.getAttribute("data-icon")||void 0,redirectUrl:t.getAttribute("data-redirect-url")||void 0,showForGuests:"true"===t.getAttribute("data-show-guests")};t.id||(t.id=e.containerId),window.renderAddEntityCard(e)})}),"undefined"!=typeof module&&module.exports&&(module.exports=t),window.AddEntityCard=t}();
class GridPanelEditor{constructor(t,e=null){this.container=t,this.data=e||{panels:[]},this.selectedPanelIndex=null,this.iconPicker=null,this.svgEditor=null,this.currentIconTarget=null,this.init()}init(){this.render(),this.attachEventListeners(),this.initializeComponentIntegrations()}initializeComponentIntegrations(){window.IconPicker&&(this.iconPicker=window.IconPicker),window.SVGEditorModal&&(this.svgEditor=window.SVGEditorModal)}render(){this.container.innerHTML=`\n            <div class="grid-panel-editor">\n                <div class="editor-controls">\n                    <button type="button" class="btn-add-panel" data-action="add-simple-panel">\n                        ‚ûï Add Simple Panel\n                    </button>\n                    <button type="button" class="btn-add-grid" data-action="add-grid-panel">\n                        ‚äû Add Grid Panel\n                    </button>\n                    <button type="button" class="btn-add-svg" data-action="add-svg-panel" ${this.svgEditor?"":'disabled title="SVG Editor not loaded"'}>\n                        üé® Add SVG Panel\n                    </button>\n                </div>\n\n                <div class="panels-root-container">\n                    ${this.renderRootPanels()}\n                </div>\n            </div>\n        `}renderPanelOptionsBar(t){const{index:e,type:n,isFirst:a,isLast:i,addButtons:d=[],extraControls:l=null}=t;return`\n            <div class="panel-options-bar">\n                ${d.length>0?`\n            <div class="panel-options-left">\n                ${d.map(t=>`\n                    <button type="button"\n                            class="btn-option-add"\n                            data-action="${t.action}"\n                            data-parent="${e}"\n                            title="${t.title}"\n                            ${t.disabled?"disabled":""}>\n                        <span class="btn-icon-text">${t.icon}</span> ${t.label}\n                    </button>\n                `).join("")}\n            </div>\n        `:""}\n                \n            <div class="panel-options-right">\n                ${l||""}\n                <button type="button"\n                        class="btn-option"\n                        data-action="move-up"\n                        data-index="${e}"\n                        ${a?"disabled":""}\n                        title="Move Up">‚Üë</button>\n                <button type="button"\n                        class="btn-option"\n                        data-action="move-down"\n                        data-index="${e}"\n                        ${i?"disabled":""}\n                        title="Move Down">‚Üì</button>\n                <button type="button"\n                        class="btn-option btn-delete"\n                        data-action="delete-panel"\n                        data-index="${e}"\n                        title="Delete">üóëÔ∏è</button>\n            </div>\n        \n            </div>\n        `}renderRootPanels(){return 0===this.data.panels.length?'<p class="editor-empty">No panels yet. Add a simple panel, grid panel, or SVG panel to start.</p>':[...this.data.panels].sort((t,e)=>t.order-e.order).map((t,e)=>"grid"===t.type?this.renderGridPanel(t,e):"svg"===t.type?this.renderSVGPanel(t,e):this.renderSimplePanel(t,e)).join("")}renderSimplePanel(t,e){const n=0===e,a=e===this.data.panels.length-1,i=t.titleIcon||"";return`\n            <div class="panel-item simple-panel" data-index="${e}" data-type="panel">\n                ${this.renderPanelOptionsBar({index:e,type:"panel",isFirst:n,isLast:a})}\n\n                \x3c!-- Main panel content with title INSIDE --\x3e\n                <div class="panel-content-box">\n                    <div class="panel-title-section">\n                        ${i?`<span class="panel-title-icon">${i}</span>`:""}\n                        <input type="text"\n                               class="panel-title-input"\n                               placeholder="Panel Title"\n                               value="${this.escapeHtml(t.title||"")}"\n                               data-field="title"\n                               data-index="${e}">\n                        <button type="button"\n                                class="btn-icon-picker"\n                                data-action="pick-icon"\n                                data-index="${e}"\n                                ${this.iconPicker?"":"disabled"}\n                                title="${i?"Change/Clear Icon":"Add Icon"}">üìå</button>\n                    </div>\n\n                    <textarea class="panel-content-input"\n                              placeholder="Panel content..."\n                              rows="6"\n                              data-field="content"\n                              data-index="${e}">${this.escapeHtml(t.content||"")}</textarea>\n                </div>\n            </div>\n        `}renderGridPanel(t,e){const n=0===e,a=e===this.data.panels.length-1,i=t.children||[],d=t.gridWidth||4,l=t.titleIcon||"",s=[{action:"add-child-panel",icon:"üìÑ",label:"Panel",title:"Add Sub-Panel"},{action:"add-child-link",icon:"üîó",label:"Link",title:"Add Link"},{action:"add-child-search",icon:"üîç",label:"Search",title:"Add Search"},{action:"add-child-image",icon:"üñºÔ∏è",label:"Image",title:"Add Image"},{action:"add-child-svg",icon:"üé®",label:"SVG",title:"Add SVG",disabled:!this.svgEditor}],r=`\n            <label class="grid-columns-label">\n                Columns:\n                <input type="number"\n                       class="grid-columns-input"\n                       min="1"\n                       max="12"\n                       value="${d}"\n                       data-field="gridWidth"\n                       data-index="${e}">\n            </label>\n        `;return`\n            <div class="panel-item grid-panel" data-index="${e}" data-type="grid">\n                ${this.renderPanelOptionsBar({index:e,type:"grid",isFirst:n,isLast:a,addButtons:s,extraControls:r})}\n\n                \x3c!-- Main panel content with title INSIDE --\x3e\n                <div class="panel-content-box">\n                    <div class="panel-title-section">\n                        ${l?`<span class="panel-title-icon">${l}</span>`:""}\n                        <input type="text"\n                               class="panel-title-input"\n                               placeholder="Grid Panel Title"\n                               value="${this.escapeHtml(t.title||"")}"\n                               data-field="title"\n                               data-index="${e}">\n                        <button type="button"\n                                class="btn-icon-picker"\n                                data-action="pick-icon"\n                                data-index="${e}"\n                                ${this.iconPicker?"":"disabled"}\n                                title="${l?"Change/Clear Icon":"Add Icon"}">üìå</button>\n                    </div>\n\n                    \x3c!-- Grid content --\x3e\n                    <div class="grid-children-container" data-grid-width="${d}">\n                        ${0===i.length?'<p class="editor-empty">No items in grid. Use buttons above to add content.</p>':this.renderGridChildren(i,e,d)}\n                    </div>\n                </div>\n            </div>\n        `}renderSVGPanel(t,e){const n=0===e,a=e===this.data.panels.length-1,i=t.titleIcon||"",d=t.svgCode||"",l=t.svgPrompt||"",s=t.svgGeneratedBy||"",r=`\n            <button type="button"\n                    class="btn-option-add"\n                    data-action="edit-svg"\n                    data-index="${e}"\n                    ${this.svgEditor?"":"disabled"}\n                    title="Edit SVG">\n                <span class="btn-icon-text">üé®</span> Edit SVG\n            </button>\n        `;return`\n            <div class="panel-item svg-panel" data-index="${e}" data-type="svg">\n                ${this.renderPanelOptionsBar({index:e,type:"svg",isFirst:n,isLast:a,extraControls:r})}\n\n                \x3c!-- Main panel content with title INSIDE --\x3e\n                <div class="panel-content-box">\n                    <div class="panel-title-section">\n                        ${i?`<span class="panel-title-icon">${i}</span>`:""}\n                        <input type="text"\n                               class="panel-title-input"\n                               placeholder="SVG Panel Title"\n                               value="${this.escapeHtml(t.title||"")}"\n                               data-field="title"\n                               data-index="${e}">\n                        <button type="button"\n                                class="btn-icon-picker"\n                                data-action="pick-icon"\n                                data-index="${e}"\n                                ${this.iconPicker?"":"disabled"}\n                                title="${i?"Change/Clear Icon":"Add Icon"}">üìå</button>\n                    </div>\n\n                    <div class="svg-preview-container">\n                        ${d||'<p class="svg-empty-state">No SVG generated yet. Click "Edit SVG" to create one.</p>'}\n                    </div>\n\n                    ${l?`<p class="svg-prompt"><strong>Prompt:</strong> ${this.escapeHtml(l)}</p>`:""}\n                    ${s?`<p class="svg-metadata"><small>Generated by: ${this.escapeHtml(s)}</small></p>`:""}\n                </div>\n            </div>\n        `}renderGridChildren(t,e,n){return`\n            <div class="grid-layout" style="grid-template-columns: repeat(${n}, 1fr);">\n                ${[...t].sort((t,e)=>t.order-e.order).map((t,n)=>this.renderGridChild(t,e,n)).join("")}\n            </div>\n        `}renderGridChild(t,e,n){const a=0===n,i=n===(this.data.panels[e].children||[]).length-1;switch(t.type){case"panel":return this.renderGridChildPanel(t,e,n,a,i);case"link":return this.renderGridChildLink(t,e,n,a,i);case"search":return this.renderGridChildSearch(t,e,n,a,i);case"image":return this.renderGridChildImage(t,e,n,a,i);case"svg":return this.renderGridChildSVG(t,e,n,a,i);default:return""}}renderGridChildPanel(t,e,n,a,i){return`\n            <div class="grid-item grid-item-panel" data-parent="${e}" data-child="${n}">\n                \x3c!-- Options bar ABOVE child panel --\x3e\n                <div class="child-options-bar">\n                    <span class="child-label">Panel</span>\n                    <div class="child-options-right">\n                        <button type="button" class="btn-child-option" data-action="move-left" data-parent="${e}" data-child="${n}" ${a?"disabled":""} title="Move Left">‚Üê</button>\n                        <button type="button" class="btn-child-option" data-action="move-right" data-parent="${e}" data-child="${n}" ${i?"disabled":""} title="Move Right">‚Üí</button>\n                        <button type="button" class="btn-child-option btn-delete" data-action="delete-child" data-parent="${e}" data-child="${n}" title="Delete">√ó</button>\n                    </div>\n                </div>\n                \x3c!-- Content box with title INSIDE --\x3e\n                <div class="child-content-box">\n                    <input type="text"\n                           class="child-title-input"\n                           placeholder="Sub-Panel Title"\n                           value="${this.escapeHtml(t.title||"")}"\n                           data-field="title"\n                           data-parent="${e}"\n                           data-child="${n}">\n                    <textarea class="child-content-textarea"\n                              placeholder="Content..."\n                              rows="4"\n                              data-field="content"\n                              data-parent="${e}"\n                              data-child="${n}">${this.escapeHtml(t.content||"")}</textarea>\n                </div>\n            </div>\n        `}renderGridChildLink(t,e,n,a,i){const d=t.linkType||"external",l="internal"===d;return`\n            <div class="grid-item grid-item-link" data-parent="${e}" data-child="${n}">\n                \x3c!-- Options bar ABOVE link --\x3e\n                <div class="child-options-bar">\n                    <span class="child-label">üîó Link</span>\n                    <div class="child-options-right">\n                        <button type="button" class="btn-child-option" data-action="move-left" data-parent="${e}" data-child="${n}" ${a?"disabled":""}>‚Üê</button>\n                        <button type="button" class="btn-child-option" data-action="move-right" data-parent="${e}" data-child="${n}" ${i?"disabled":""}>‚Üí</button>\n                        <button type="button" class="btn-child-option btn-delete" data-action="delete-child" data-parent="${e}" data-child="${n}">√ó</button>\n                    </div>\n                </div>\n                \x3c!-- Content box --\x3e\n                <div class="child-content-box">\n                    <select class="child-select"\n                            data-field="linkType"\n                            data-parent="${e}"\n                            data-child="${n}"\n                            data-action="change-link-type">\n                        <option value="external" ${"external"===d?"selected":""}>External URL</option>\n                        <option value="internal" ${"internal"===d?"selected":""}>Internal Page</option>\n                    </select>\n\n                    <input type="text"\n                           class="child-input"\n                           placeholder="Link Text"\n                           value="${this.escapeHtml(t.text||"")}"\n                           data-field="text"\n                           data-parent="${e}"\n                           data-child="${n}">\n\n                    ${l?this.renderPageSelector(t,e,n):`\n                        <input type="text"\n                               class="child-input"\n                               placeholder="URL (e.g., https://example.com)"\n                               value="${this.escapeHtml(t.url||"")}"\n                               data-field="url"\n                               data-parent="${e}"\n                               data-child="${n}">\n                    `}\n                </div>\n            </div>\n        `}renderPageSelector(t,e,n){const a=window.pageTaxonomy||{},i=[];return Object.keys(a).forEach(t=>{const e=a[t];e.path&&i.push({label:`üìö ${e.name}`,value:e.path+"index.html",category:e.name}),e.sections&&Object.keys(e.sections).forEach(t=>{const n=e.sections[t];n.path&&i.push({label:`  üìñ ${e.name} ‚Üí ${n.name}`,value:n.path+"index.html",category:e.name})}),e.topics&&Object.keys(e.topics).forEach(t=>{const n=e.topics[t];n.path&&i.push({label:`    üìÑ ${e.name} ‚Üí ${n.name}`,value:n.path,category:e.name})})}),i.sort((t,e)=>t.category!==e.category?t.category.localeCompare(e.category):t.label.localeCompare(e.label)),`\n            <select class="child-select"\n                    data-field="url"\n                    data-parent="${e}"\n                    data-child="${n}">\n                <option value="">-- Select a page --</option>\n                ${i.map(e=>`\n                    <option value="${this.escapeHtml(e.value)}" ${t.url===e.value?"selected":""}>\n                        ${this.escapeHtml(e.label)}\n                    </option>\n                `).join("")}\n            </select>\n            <small class="form-hint">Selected: ${this.escapeHtml(t.url||"none")}</small>\n        `}renderGridChildSearch(t,e,n,a,i){return`\n            <div class="grid-item grid-item-search" data-parent="${e}" data-child="${n}">\n                \x3c!-- Options bar ABOVE search --\x3e\n                <div class="child-options-bar">\n                    <span class="child-label">üîç Search</span>\n                    <div class="child-options-right">\n                        <button type="button" class="btn-child-option" data-action="move-left" data-parent="${e}" data-child="${n}" ${a?"disabled":""}>‚Üê</button>\n                        <button type="button" class="btn-child-option" data-action="move-right" data-parent="${e}" data-child="${n}" ${i?"disabled":""}>‚Üí</button>\n                        <button type="button" class="btn-child-option btn-delete" data-action="delete-child" data-parent="${e}" data-child="${n}">√ó</button>\n                    </div>\n                </div>\n                \x3c!-- Content box --\x3e\n                <div class="child-content-box">\n                    <input type="text"\n                           class="child-input"\n                           placeholder="Search Term"\n                           value="${this.escapeHtml(t.term||"")}"\n                           data-field="term"\n                           data-parent="${e}"\n                           data-child="${n}">\n                    <select class="child-select"\n                            data-field="searchType"\n                            data-parent="${e}"\n                            data-child="${n}">\n                        <option value="corpus" ${"corpus"===t.searchType?"selected":""}>Corpus Search</option>\n                        <option value="page" ${"page"===t.searchType?"selected":""}>Page Search</option>\n                    </select>\n                </div>\n            </div>\n        `}renderGridChildImage(t,e,n,a,i){return`\n            <div class="grid-item grid-item-image" data-parent="${e}" data-child="${n}">\n                \x3c!-- Options bar ABOVE image --\x3e\n                <div class="child-options-bar">\n                    <span class="child-label">üñºÔ∏è Image</span>\n                    <div class="child-options-right">\n                        <button type="button" class="btn-child-option" data-action="move-left" data-parent="${e}" data-child="${n}" ${a?"disabled":""}>‚Üê</button>\n                        <button type="button" class="btn-child-option" data-action="move-right" data-parent="${e}" data-child="${n}" ${i?"disabled":""}>‚Üí</button>\n                        <button type="button" class="btn-child-option btn-delete" data-action="delete-child" data-parent="${e}" data-child="${n}">√ó</button>\n                    </div>\n                </div>\n                \x3c!-- Content box --\x3e\n                <div class="child-content-box">\n                    ${t.url?`<img src="${this.escapeHtml(t.url)}" alt="${this.escapeHtml(t.alt||"")}" class="child-image-preview">`:""}\n                    <input type="text"\n                           class="child-input"\n                           placeholder="Image URL"\n                           value="${this.escapeHtml(t.url||"")}"\n                           data-field="url"\n                           data-parent="${e}"\n                           data-child="${n}">\n                    <input type="text"\n                           class="child-input"\n                           placeholder="Caption"\n                           value="${this.escapeHtml(t.caption||"")}"\n                           data-field="caption"\n                           data-parent="${e}"\n                           data-child="${n}">\n                    <input type="text"\n                           class="child-input"\n                           placeholder="Alt Text"\n                           value="${this.escapeHtml(t.alt||"")}"\n                           data-field="alt"\n                           data-parent="${e}"\n                           data-child="${n}">\n                </div>\n            </div>\n        `}renderGridChildSVG(t,e,n,a,i){const d=t.svgCode||"",l=t.svgPrompt||"";return`\n            <div class="grid-item grid-item-svg" data-parent="${e}" data-child="${n}">\n                \x3c!-- Options bar ABOVE SVG --\x3e\n                <div class="child-options-bar">\n                    <span class="child-label">üé® SVG</span>\n                    <div class="child-options-right">\n                        <button type="button" class="btn-child-option" data-action="edit-child-svg" data-parent="${e}" data-child="${n}" ${this.svgEditor?"":"disabled"} title="Edit SVG">‚úèÔ∏è</button>\n                        <button type="button" class="btn-child-option" data-action="move-left" data-parent="${e}" data-child="${n}" ${a?"disabled":""}>‚Üê</button>\n                        <button type="button" class="btn-child-option" data-action="move-right" data-parent="${e}" data-child="${n}" ${i?"disabled":""}>‚Üí</button>\n                        <button type="button" class="btn-child-option btn-delete" data-action="delete-child" data-parent="${e}" data-child="${n}">√ó</button>\n                    </div>\n                </div>\n                \x3c!-- Content box --\x3e\n                <div class="child-content-box">\n                    <div class="child-svg-preview">\n                        ${d||'<p class="svg-empty-state">No SVG</p>'}\n                    </div>\n                    ${l?`<p class="child-svg-prompt">${this.escapeHtml(l)}</p>`:""}\n                </div>\n            </div>\n        `}attachEventListeners(){this.container.addEventListener("click",t=>{const e=t.target.dataset.action;if(!e)return;const n=parseInt(t.target.dataset.index),a=parseInt(t.target.dataset.parent),i=parseInt(t.target.dataset.child);switch(e){case"add-simple-panel":this.addSimplePanel();break;case"add-grid-panel":this.addGridPanel();break;case"add-svg-panel":this.addSVGPanel();break;case"move-up":this.movePanelUp(n);break;case"move-down":this.movePanelDown(n);break;case"delete-panel":this.deletePanel(n);break;case"pick-icon":this.pickIcon(n);break;case"edit-svg":this.editSVG(n);break;case"add-child-panel":this.addChildPanel(a);break;case"add-child-link":this.addChildLink(a);break;case"add-child-search":this.addChildSearch(a);break;case"add-child-image":this.addChildImage(a);break;case"add-child-svg":this.addChildSVG(a);break;case"edit-child-svg":this.editChildSVG(a,i);break;case"move-left":this.moveChildLeft(a,i);break;case"move-right":this.moveChildRight(a,i);break;case"delete-child":this.deleteChild(a,i);break;case"change-link-type":this.render()}}),this.container.addEventListener("input",t=>{const e=t.target.dataset.field;if(!e)return;const n=parseInt(t.target.dataset.index),a=parseInt(t.target.dataset.parent),i=parseInt(t.target.dataset.child);isNaN(a)||isNaN(i)?isNaN(n)||this.updatePanelField(n,e,t.target.value):this.updateChildField(a,i,e,t.target.value)})}addSimplePanel(){const t={type:"panel",title:"",content:"",order:this.data.panels.length,children:[]};this.data.panels.push(t),this.refresh()}addGridPanel(){const t=prompt("Grid width (number of columns):","4");if(!t||isNaN(t))return;const e=parseInt(t);if(e<1||e>12)return void alert("Grid width must be between 1 and 12");const n={type:"grid",title:"",gridWidth:e,order:this.data.panels.length,children:[]};this.data.panels.push(n),this.refresh()}addSVGPanel(){if(!this.svgEditor)return void alert("SVG Editor component is not loaded. Please ensure SVGEditorModal is included.");const t={type:"svg",title:"",svgCode:"",svgPrompt:"",svgGeneratedBy:"",order:this.data.panels.length};this.data.panels.push(t);const e=this.data.panels.length-1;this.refresh(),setTimeout(()=>this.editSVG(e),100)}pickIcon(t){if(!this.iconPicker)return void alert("Icon Picker component is not loaded. Please ensure IconPicker is included.");const e=this.data.panels[t];new window.IconPicker({currentIcon:e.titleIcon||"",allowCustomClass:!0,onSelect:t=>{e.titleIcon=t,this.refresh()}}).show()}editSVG(t){if(!this.svgEditor)return void alert("SVG Editor component is not loaded. Please ensure SVGEditorModal is included.");const e=this.data.panels[t];window.SVGEditorModal&&window.SVGEditorModal.open?window.SVGEditorModal.open({initialPrompt:e.svgPrompt||"",initialSvg:e.svgCode||"",onSave:t=>{e.svgCode=t.svgCode||"",e.svgPrompt=t.prompt||"",e.svgGeneratedBy=t.generatedBy||"",this.refresh()}}):alert("SVG Editor not properly initialized.")}movePanelUp(t){if(0===t)return;const e=this.data.panels[t];this.data.panels[t]=this.data.panels[t-1],this.data.panels[t-1]=e,this.reorderPanels(),this.refresh()}movePanelDown(t){if(t===this.data.panels.length-1)return;const e=this.data.panels[t];this.data.panels[t]=this.data.panels[t+1],this.data.panels[t+1]=e,this.reorderPanels(),this.refresh()}deletePanel(t){confirm("Delete this panel?")&&(this.data.panels.splice(t,1),this.reorderPanels(),this.refresh())}addChildPanel(t){const e=this.data.panels[t];e.children||(e.children=[]),e.children.push({type:"panel",title:"",content:"",order:e.children.length}),this.refresh()}addChildLink(t){const e=this.data.panels[t];e.children||(e.children=[]),e.children.push({type:"link",text:"",url:"",order:e.children.length}),this.refresh()}addChildSearch(t){const e=this.data.panels[t];e.children||(e.children=[]),e.children.push({type:"search",term:"",searchType:"corpus",order:e.children.length}),this.refresh()}addChildImage(t){const e=this.data.panels[t];e.children||(e.children=[]),e.children.push({type:"image",url:"",caption:"",alt:"",order:e.children.length}),this.refresh()}addChildSVG(t){if(!this.svgEditor)return void alert("SVG Editor component is not loaded. Please ensure SVGEditorModal is included.");const e=this.data.panels[t];e.children||(e.children=[]);const n={type:"svg",svgCode:"",svgPrompt:"",svgGeneratedBy:"",order:e.children.length};e.children.push(n);const a=e.children.length-1;this.refresh(),setTimeout(()=>this.editChildSVG(t,a),100)}editChildSVG(t,e){if(!this.svgEditor)return void alert("SVG Editor component is not loaded. Please ensure SVGEditorModal is included.");const n=this.data.panels[t].children[e];window.SVGEditorModal&&window.SVGEditorModal.open?window.SVGEditorModal.open({initialPrompt:n.svgPrompt||"",initialSvg:n.svgCode||"",onSave:t=>{n.svgCode=t.svgCode||"",n.svgPrompt=t.prompt||"",n.svgGeneratedBy=t.generatedBy||"",this.refresh()}}):alert("SVG Editor not properly initialized.")}moveChildLeft(t,e){const n=this.data.panels[t];if(0===e)return;const a=n.children[e];n.children[e]=n.children[e-1],n.children[e-1]=a,this.reorderChildren(t),this.refresh()}moveChildRight(t,e){const n=this.data.panels[t];if(e===n.children.length-1)return;const a=n.children[e];n.children[e]=n.children[e+1],n.children[e+1]=a,this.reorderChildren(t),this.refresh()}deleteChild(t,e){confirm("Delete this item?")&&(this.data.panels[t].children.splice(e,1),this.reorderChildren(t),this.refresh())}updatePanelField(t,e,n){this.data.panels[t][e]="gridWidth"===e?parseInt(n)||4:n}updateChildField(t,e,n,a){this.data.panels[t].children[e][n]=a}reorderPanels(){this.data.panels.forEach((t,e)=>{t.order=e})}reorderChildren(t){const e=this.data.panels[t];e.children&&e.children.forEach((t,e)=>{t.order=e})}refresh(){this.render()}getData(){return this.data}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}window.GridPanelEditor=GridPanelEditor;
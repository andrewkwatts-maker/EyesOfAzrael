class EditEntityModal{constructor(t){this.crudManager=t,this.currentEntity=null,this.currentCollection=null,this.currentEntityId=null,this.modalElement=null,this.entityForm=null}async open(t,e){try{if(this.currentEntityId=t,this.currentCollection=e,this.showLoadingModal(),this.currentEntity=await this.loadEntity(t,e),!this.currentEntity)return void this.showError("Entity not found");this.createModal(),await this.renderForm(),this.show()}catch(t){this.showError(t.message)}}async loadEntity(t,e){const n=await this.crudManager.read(e,t);if(!n.success)throw new Error(n.error||"Failed to load entity");return n.data}showLoadingModal(){const t=document.getElementById("edit-entity-modal");t&&t.remove();const e=document.createElement("div");e.id="edit-entity-modal",e.className="modal-overlay",e.innerHTML='\n            <div class="modal-content">\n                <div class="loading-spinner-container">\n                    <div class="loading-spinner">Loading entity...</div>\n                </div>\n            </div>\n        ',document.body.appendChild(e),this.modalElement=e,setTimeout(()=>e.classList.add("show"),10)}createModal(){const t=document.getElementById("edit-entity-modal");t&&t.remove();const e=document.createElement("div");e.id="edit-entity-modal",e.className="modal-overlay",e.innerHTML=`\n            <div class="modal-content modal-large">\n                <div class="modal-header">\n                    <h2>Edit ${this.capitalizeFirst(this.currentCollection.slice(0,-1))}</h2>\n                    <button class="modal-close" aria-label="Close" title="Close (ESC)">×</button>\n                </div>\n                <div id="modal-form-container" class="modal-body">\n                    \x3c!-- EntityForm renders here --\x3e\n                </div>\n            </div>\n        `,document.body.appendChild(e),this.modalElement=e,e.querySelector(".modal-close").addEventListener("click",()=>this.close()),e.addEventListener("click",t=>{t.target===e&&this.close()}),this.escapeHandler=t=>{"Escape"===t.key&&this.isOpen()&&this.close()},document.addEventListener("keydown",this.escapeHandler)}async renderForm(){if("undefined"==typeof EntityForm)return void this.showError("EntityForm component not loaded");const t=this.modalElement.querySelector("#modal-form-container");this.entityForm=new EntityForm({crudManager:this.crudManager,collection:this.currentCollection,entityId:this.currentEntityId,onSuccess:t=>{try{this.handleSuccess(t)}catch(t){this.showError("An error occurred after saving. Please refresh the page.")}},onCancel:()=>{try{this.close()}catch(t){const e=document.getElementById("edit-entity-modal");e&&e.remove()}}});const e=await this.entityForm.render();t.innerHTML=e,this.entityForm.initialize(t)}show(){this.modalElement&&setTimeout(()=>this.modalElement.classList.add("show"),10)}close(){this.modalElement&&(this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler),this.modalElement.classList.remove("show"),setTimeout(()=>{this.modalElement&&this.modalElement.parentNode&&this.modalElement.remove(),this.modalElement=null,this.entityForm=null},300))}isOpen(){return!!this.modalElement&&this.modalElement.classList.contains("show")}handleSuccess(t){this.showToast("Entity updated successfully!","success"),setTimeout(()=>{this.close(),window.location.reload()},1e3)}showError(t){const e=this.modalElement?.querySelector("#modal-form-container");e&&(e.innerHTML=`\n                <div class="error-container" style="text-align: center; padding: 3rem;">\n                    <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n                    <h3>Error</h3>\n                    <p style="color: #ef4444; margin: 1rem 0;">${this.escapeHtml(t)}</p>\n                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>\n                </div>\n            `),this.showToast(t,"error")}showToast(t,e="info"){if(window.showToast)return void window.showToast(t,e);const n=document.createElement("div");n.className=`toast toast-${e}`,n.textContent=t,n.style.cssText=`\n            position: fixed;\n            bottom: 2rem;\n            right: 2rem;\n            background: ${"success"===e?"#10b981":"error"===e?"#ef4444":"#3b82f6"};\n            color: white;\n            padding: 1rem 1.5rem;\n            border-radius: 8px;\n            box-shadow: 0 10px 25px rgba(0,0,0,0.3);\n            z-index: 99999;\n            animation: slideIn 0.3s ease;\n            max-width: 400px;\n        `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)}capitalizeFirst(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}window.EditEntityModal=EditEntityModal,"undefined"!=typeof module&&module.exports&&(module.exports=EditEntityModal);
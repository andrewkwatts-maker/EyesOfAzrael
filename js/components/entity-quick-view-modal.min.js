class EntityQuickViewModal{constructor(e){this.db=e,this.currentEntity=null,this.overlay=null}async open(e,t,n){this.createModal();try{this.currentEntity=await this.loadEntity(e,t,n),this.renderContent()}catch(e){this.showError(e.message)}}async loadEntity(e,t,n){if(!this.db)throw new Error("Firestore not initialized");const i=await this.db.collection(t).doc(e).get();if(!i.exists)throw new Error("Entity not found");return{id:i.id,collection:t,mythology:n,...i.data()}}createModal(){const e=document.getElementById("quick-view-modal");e&&e.remove();const t=document.createElement("div");t.id="quick-view-modal",t.className="quick-view-overlay",t.innerHTML='\n            <div class="quick-view-content">\n                <button class="quick-view-close" aria-label="Close quick view">√ó</button>\n                <div id="quick-view-body" class="quick-view-body">\n                    <div class="loading-content">\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                        <p>Loading entity...</p>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t),this.overlay=t,this.attachCloseHandlers(t),requestAnimationFrame(()=>{t.classList.add("show")})}renderContent(){const e=document.getElementById("quick-view-body");if(!e||!this.currentEntity)return;const t=this.currentEntity;e.innerHTML=`\n            ${this.renderHeader(t)}\n            ${this.renderContentSection(t)}\n            ${this.renderActions(t)}\n        `,this.loadRelatedEntitiesAsync(t)}renderHeader(e){const t=e.importance||0,n=t>0?"‚≠ê".repeat(Math.min(5,t)):"";return`\n            <div class="quick-view-header">\n                <div class="entity-icon-large">${this.escapeHtml(e.icon||"üìñ")}</div>\n                <div class="entity-title-section">\n                    <h2 class="entity-title">${this.escapeHtml(e.name||e.title||"Untitled")}</h2>\n                    <div class="entity-meta">\n                        <span class="meta-badge mythology">${this.escapeHtml(this.capitalize(e.mythology))}</span>\n                        <span class="meta-badge type">${this.escapeHtml(this.getTypeLabel(e.collection))}</span>\n                        ${n?`<span class="meta-badge importance">${n}</span>`:""}\n                    </div>\n                    ${e.linguistic?.originalName?`\n                        <div class="entity-subtitle">${this.escapeHtml(e.linguistic.originalName)}</div>\n                    `:""}\n                </div>\n            </div>\n        `}renderContentSection(e){let t='<div class="quick-view-content-section">';e.alternateNames&&e.alternateNames.length>0&&(t+=`\n                <div class="info-section">\n                    <h3>Also Known As</h3>\n                    <p class="alternate-names">${e.alternateNames.map(e=>this.escapeHtml(e)).join(", ")}</p>\n                </div>\n            `);const n=e.fullDescription||e.shortDescription||e.description||"";if(n){const e=n.length>500?n.substring(0,500)+"...":n;t+=`\n                <div class="info-section">\n                    <h3>Description</h3>\n                    <p class="description">${this.escapeHtml(e)}</p>\n                </div>\n            `}return e.domains&&e.domains.length>0&&(t+=`\n                <div class="info-section">\n                    <h3>Domains</h3>\n                    <div class="tag-list">\n                        ${e.domains.map(e=>`<span class="tag">${this.escapeHtml(e)}</span>`).join("")}\n                    </div>\n                </div>\n            `),e.symbols&&e.symbols.length>0&&(t+=`\n                <div class="info-section">\n                    <h3>Symbols</h3>\n                    <div class="tag-list">\n                        ${e.symbols.map(e=>`<span class="tag">${this.escapeHtml(e)}</span>`).join("")}\n                    </div>\n                </div>\n            `),e.element&&(t+=`\n                <div class="info-section">\n                    <h3>Element</h3>\n                    <p class="element">${this.escapeHtml(e.element)}</p>\n                </div>\n            `),e.gender&&(t+=`\n                <div class="info-section">\n                    <h3>Gender</h3>\n                    <p class="gender">${this.escapeHtml(e.gender)}</p>\n                </div>\n            `),this.getRelatedIds(e).length>0&&(t+='\n                <div class="info-section">\n                    <h3>Related Entities</h3>\n                    <div id="related-entities" class="related-grid">\n                        <div class="loading-small">\n                            <div class="spinner-ring"></div>\n                            <p>Loading related entities...</p>\n                        </div>\n                    </div>\n                </div>\n            '),t+="</div>",t}renderActions(e){return`\n            <div class="quick-view-actions">\n                <a href="${this.getFullPageUrl(e)}" class="btn-primary">\n                    View Full Page ‚Üí\n                </a>\n                <button class="btn-secondary" data-action="close">\n                    Close\n                </button>\n            </div>\n        `}async loadRelatedEntitiesAsync(e){const t=document.getElementById("related-entities");if(!t)return;const n=this.getRelatedIds(e);if(0!==n.length)try{const e=await this.loadMultipleEntities(n.slice(0,6));if(0===e.length)return void(t.innerHTML='<p class="no-data">No related entities found</p>');t.innerHTML=e.map(e=>`\n                <div class="related-card"\n                     data-entity-id="${e.id}"\n                     data-collection="${e.collection}"\n                     data-mythology="${e.mythology}"\n                     role="button"\n                     tabindex="0"\n                     aria-label="View ${this.escapeHtml(e.name||e.title)}">\n                    <div class="related-icon">${this.escapeHtml(e.icon||"üìñ")}</div>\n                    <div class="related-name">${this.escapeHtml(e.name||e.title||"Untitled")}</div>\n                </div>\n            `).join(""),this.attachRelatedCardHandlers(t)}catch(e){t.innerHTML='<p class="error-text">Error loading related entities</p>'}}async loadMultipleEntities(e){const t=[],n=["deities","heroes","creatures","cosmology","rituals","herbs","texts","symbols"];for(const i of e)for(const e of n)try{const n=await this.db.collection(e).doc(i).get();if(n.exists){const i=n.data();t.push({id:n.id,collection:e,mythology:i.mythology||"unknown",...i});break}}catch(e){}return t}attachRelatedCardHandlers(e){e.querySelectorAll(".related-card").forEach(e=>{e.addEventListener("click",()=>{this.openRelatedEntity(e)}),e.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.openRelatedEntity(e))})})}openRelatedEntity(e){const t=e.dataset.entityId,n=e.dataset.collection,i=e.dataset.mythology;t&&n&&i&&(this.close(),setTimeout(()=>{this.open(t,n,i)},100))}attachCloseHandlers(e){e.querySelector(".quick-view-close").addEventListener("click",()=>this.close());const t=e.querySelector('[data-action="close"]');t&&t.addEventListener("click",()=>this.close()),e.addEventListener("click",t=>{t.target===e&&this.close()});const n=e=>{"Escape"===e.key&&this.close()};document.addEventListener("keydown",n),e._escHandler=n}close(){const e=document.getElementById("quick-view-modal");e&&(e._escHandler&&document.removeEventListener("keydown",e._escHandler),e.classList.remove("show"),setTimeout(()=>{e.remove(),this.overlay=null},300))}showError(e){const t=document.getElementById("quick-view-modal");if(!t)return this.createModal(),void setTimeout(()=>this.showError(e),50);const n=t.querySelector(".quick-view-body");n&&(n.innerHTML=`\n            <div class="error-state">\n                <div class="error-icon">‚ö†Ô∏è</div>\n                <h2>Error</h2>\n                <p class="error-message">${this.escapeHtml(e)}</p>\n                <button class="btn-primary" onclick="this.closest('.quick-view-overlay').remove()">\n                    Close\n                </button>\n            </div>\n        `)}getRelatedIds(e){const t=[];return e.displayOptions?.relatedEntities&&e.displayOptions.relatedEntities.forEach(e=>{e.ids&&Array.isArray(e.ids)&&t.push(...e.ids)}),e.relationships?.relatedIds&&t.push(...e.relationships.relatedIds),[...new Set(t)]}getFullPageUrl(e){return`#/mythology/${e.mythology||"unknown"}/${e.collection||"entities"}/${e.id}`}getTypeLabel(e){return{deities:"Deity",heroes:"Hero",creatures:"Creature",cosmology:"Cosmology",rituals:"Ritual",herbs:"Herb",texts:"Text",symbols:"Symbol"}[e]||this.capitalize(e)}capitalize(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.EntityQuickViewModal=EntityQuickViewModal;
class CorpusSearch{constructor(e){this.db=e,this.searchCache=new Map,this.cacheTimeout=3e5,this.collections=["deities","heroes","creatures","cosmology","texts","rituals","herbs","symbols","magic","path","places","items","concepts","events","figures","beings","angels","teachings"]}async search(e,t={}){const{mode:s="generic",mythology:a=null,entityType:o=null,language:r=null,limit:c=50,offset:n=0,sortBy:i="relevance"}=t,l=this.getCacheKey(e,t);if(this.searchCache.has(l)){const e=this.searchCache.get(l);if(Date.now()-e.timestamp<this.cacheTimeout)return e.results}let h;switch(s){case"language":h=await this.searchByLanguage(e,t);break;case"source":h=await this.searchBySources(e,t);break;case"term":h=await this.searchByCorpusTerm(e,t);break;case"advanced":h=await this.advancedSearch(e,t);break;default:h=await this.genericSearch(e,t)}h=this.sortResults(h,i);const u=h.slice(n,n+c);return this.searchCache.set(l,{results:{items:u,total:h.length},timestamp:Date.now()}),{items:u,total:h.length}}async genericSearch(e,t={}){const{mythology:s,entityType:a}=t,o=this.tokenize(e.toLowerCase()),r=[];for(const e of this.collections){if(a&&e!==a)continue;let t=this.db.collection(e);s&&(t=t.where("mythology","==",s)),(await t.get()).forEach(e=>{const t=e.data(),s=this.calculateGenericScore(t,o);s>0&&r.push({...t,_searchScore:s,_matchedFields:this.getMatchedFields(t,o)})})}return r}async searchByLanguage(e,t={}){const{mythology:s,language:a}=t,o=[];for(const t of this.collections)(await this.db.collection(t).get()).forEach(t=>{const r=t.data();if(s&&r.mythology!==s)return;const c=r.languages||{},n=this.calculateLanguageScore(c,e,a);n>0&&o.push({...r,_searchScore:n,_matchedLanguage:this.getMatchedLanguage(c,e,a)})});return o}async searchBySources(e,t={}){const{mythology:s}=t,a=[],o=this.tokenize(e.toLowerCase());for(const e of this.collections)(await this.db.collection(e).get()).forEach(e=>{const t=e.data();if(s&&t.mythology!==s)return;const r=t.sources||{},c=this.calculateSourceScore(r,o);c>0&&a.push({...t,_searchScore:c,_matchedSources:this.getMatchedSources(r,o)})});return a}async searchByCorpusTerm(e,t={}){const{mythology:s}=t,a=[],o=e.toLowerCase().trim();for(const e of this.collections)(await this.db.collection(e).get()).forEach(e=>{const t=e.data();if(s&&t.mythology!==s)return;const r=t.corpusSearch||{},c=this.calculateCorpusScore(r,o);c>0&&a.push({...t,_searchScore:c,_matchedTerms:this.getMatchedCorpusTerms(r,o)})});return a}async advancedSearch(e,t={}){const{text:s,domains:a=[],symbols:o=[],dateRange:r=null,hasImage:c=null,importance:n=null}=e;let i=[];if(s)i=await this.genericSearch(s,t);else for(const e of this.collections)(await this.db.collection(e).get()).forEach(e=>{i.push({...e.data(),_searchScore:50})});return i=i.filter(e=>{if(a.length>0){const t=e.deity?.domains||e.corpusSearch?.domains||[];if(!a.some(e=>t.includes(e)))return!1}if(o.length>0){const t=e.deity?.symbols||e.corpusSearch?.symbols||[];if(!o.some(e=>t.includes(e)))return!1}if(r){const t=e.timeline?.dateRange;if(!t)return!1;if(t.start>r.end||t.end<r.start)return!1}if(null!==c&&!(!e.image&&!e.gridDisplay?.image)!==c)return!1;if(n){const t=e.importance||50;if(t<n.min||t>n.max)return!1}return!0}),i}calculateGenericScore(e,t){let s=0;const a=JSON.stringify(e).toLowerCase();return t.forEach(t=>{e.name?.toLowerCase().includes(t)&&(s+=50),e.description?.toLowerCase().includes(t)&&(s+=30),e.subtitle?.toLowerCase().includes(t)&&(s+=20),(e.searchTerms||[]).some(e=>e.toLowerCase().includes(t))&&(s+=40),(e.tags||[]).some(e=>e.toLowerCase().includes(t))&&(s+=35);const o=(a.match(new RegExp(t,"gi"))||[]).length;s+=5*o}),s}calculateLanguageScore(e,t,s=null){let a=0;const o=t.toLowerCase();e.originalName?.toLowerCase().includes(o)&&(a+=100),e.transliteration?.toLowerCase().includes(o)&&(a+=80);const r=e.alternateNames||{};return Object.entries(r).forEach(([e,t])=>{s&&e!==s||t.toLowerCase().includes(o)&&(a+=s?90:60)}),(e.variants||[]).forEach(e=>{e.toLowerCase()===o?a+=70:e.toLowerCase().includes(o)&&(a+=50)}),a}calculateSourceScore(e,t){let s=0;const a=JSON.stringify(e).toLowerCase();return t.forEach(t=>{(e.primaryTexts||[]).forEach(e=>{e.title?.toLowerCase().includes(t)&&(s+=40),e.author?.toLowerCase().includes(t)&&(s+=35),e.citations?.some(e=>e.toLowerCase().includes(t))&&(s+=25)}),(e.secondarySources||[]).forEach(e=>{e.title?.toLowerCase().includes(t)&&(s+=30),e.author?.toLowerCase().includes(t)&&(s+=25)}),(e.archeologicalEvidence||[]).forEach(e=>{e.name?.toLowerCase().includes(t)&&(s+=20),e.location?.toLowerCase().includes(t)&&(s+=15)});const o=(a.match(new RegExp(t,"gi"))||[]).length;s+=5*o}),s}calculateCorpusScore(e,t){let s=0;return e.canonical===t?s+=100:e.canonical?.includes(t)&&(s+=80),(e.variants||[]).forEach(e=>{e===t?s+=90:e.includes(t)&&(s+=70)}),(e.epithets||[]).forEach(e=>{e.includes(t)&&(s+=60)}),(e.domains||[]).forEach(e=>{e.includes(t)&&(s+=50)}),(e.symbols||[]).forEach(e=>{e.includes(t)&&(s+=45)}),(e.places||[]).forEach(e=>{e.includes(t)&&(s+=40)}),(e.concepts||[]).forEach(e=>{e.includes(t)&&(s+=35)}),s}getMatchedFields(e,t){const s=[];return JSON.stringify(e).toLowerCase(),t.some(t=>e.name?.toLowerCase().includes(t))&&s.push("name"),t.some(t=>e.description?.toLowerCase().includes(t))&&s.push("description"),t.some(t=>e.subtitle?.toLowerCase().includes(t))&&s.push("subtitle"),s}getMatchedLanguage(e,t,s){const a=t.toLowerCase(),o={};e.originalName?.toLowerCase().includes(a)&&(o.originalName=e.originalName),e.transliteration?.toLowerCase().includes(a)&&(o.transliteration=e.transliteration);const r=e.alternateNames||{};return Object.entries(r).forEach(([e,t])=>{t.toLowerCase().includes(a)&&(o[e]=t)}),o}getMatchedSources(e,t){const s={primaryTexts:[],secondarySources:[],archeologicalEvidence:[]},a=e=>t.some(t=>e?.toLowerCase().includes(t));return(e.primaryTexts||[]).forEach(e=>{(a(e.title)||a(e.author))&&s.primaryTexts.push(e)}),(e.secondarySources||[]).forEach(e=>{(a(e.title)||a(e.author))&&s.secondarySources.push(e)}),(e.archeologicalEvidence||[]).forEach(e=>{(a(e.name)||a(e.location))&&s.archeologicalEvidence.push(e)}),s}getMatchedCorpusTerms(e,t){const s={type:null,terms:[]};return e.canonical===t&&(s.type="canonical",s.terms.push(e.canonical)),(e.variants||[]).forEach(e=>{e.includes(t)&&(s.type=s.type||"variants",s.terms.push(e))}),["epithets","domains","symbols","places","concepts"].forEach(a=>{(e[a]||[]).forEach(e=>{e.includes(t)&&(s.type=s.type||a,s.terms.push(e))})}),s}sortResults(e,t){switch(t){case"relevance":return e.sort((e,t)=>(t._searchScore||0)-(e._searchScore||0));case"importance":return e.sort((e,t)=>(t.importance||50)-(e.importance||50));case"popularity":return e.sort((e,t)=>(t.popularity||50)-(e.popularity||50));case"name":return e.sort((e,t)=>(e.sortName||e.name||"").localeCompare(t.sortName||t.name||""));default:return e}}tokenize(e){return e.toLowerCase().split(/[\s,;]+/).filter(e=>e.length>2).map(e=>e.replace(/[^\w]/g,""))}getCacheKey(e,t){return JSON.stringify({query:e,...t})}clearCache(){this.searchCache.clear()}async findParallels(e){const t=await this.getEntity(e);if(!t)return[];const s=t.relationships?.parallels||{},a=[];for(const[e,t]of Object.entries(s)){const s=await this.getEntity(t);s&&a.push({mythology:e,entity:s,relationship:"parallel"})}return a}async getEntity(e){const[t,s]=e.split("_");for(const t of this.collections){const s=await this.db.collection(t).doc(e).get();if(s.exists)return s.data()}return null}async getSuggestions(e,t=10){const s=new Set,a=e.toLowerCase();for(const e of this.collections){if(s.size>=t)break;(await this.db.collection(e).limit(100).get()).forEach(e=>{const t=e.data();t.name?.toLowerCase().startsWith(a)&&s.add(t.name),(t.searchTerms||[]).forEach(e=>{e.toLowerCase().startsWith(a)&&s.add(e)});const o=t.corpusSearch||{};["epithets","domains","symbols"].forEach(e=>{(o[e]||[]).forEach(e=>{e.toLowerCase().startsWith(a)&&s.add(e)})})})}return Array.from(s).slice(0,t)}}"undefined"!=typeof module&&module.exports&&(module.exports=CorpusSearch);
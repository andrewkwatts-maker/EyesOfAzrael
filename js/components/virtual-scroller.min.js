export class VirtualScroller{constructor(t,e={}){if(!t)throw new Error("Container element is required");this.container=t,this.items=[],this.itemHeight=e.itemHeight||80,this.bufferSize=e.bufferSize||5,this.renderItem=e.renderItem||(t=>`<div>${JSON.stringify(t)}</div>`),this.onLoadMore=e.onLoadMore||null,this.scrollTop=0,this.visibleStart=0,this.visibleEnd=0,this.isDestroyed=!1,this.renderCount=0,this.totalRenderTime=0,this.slowRenderWarnings=0,this.boundScrollHandler=this.onScroll.bind(this),this.boundResizeHandler=this.onResize.bind(this),this.init()}init(){this.container.style.position="relative",this.container.style.overflow="auto",this.container.classList.add("virtual-scroller-container"),this.scrollContent=document.createElement("div"),this.scrollContent.className="virtual-scroll-content",this.scrollContent.style.position="relative",this.scrollContent.style.width="100%",this.container.appendChild(this.scrollContent),this.viewport=document.createElement("div"),this.viewport.className="virtual-viewport",this.viewport.style.position="absolute",this.viewport.style.top="0",this.viewport.style.left="0",this.viewport.style.right="0",this.viewport.style.willChange="transform",this.scrollContent.appendChild(this.viewport),this.loadingIndicator=document.createElement("div"),this.loadingIndicator.className="virtual-loading",this.loadingIndicator.innerHTML='<div class="spinner"></div><p>Loading more...</p>',this.loadingIndicator.style.display="none",this.container.appendChild(this.loadingIndicator),this.container.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),window.addEventListener("resize",this.boundResizeHandler,{passive:!0}),console.log("[VirtualScroller] Initialized with itemHeight:",this.itemHeight,"bufferSize:",this.bufferSize)}setItems(t){Array.isArray(t)||(console.warn("[VirtualScroller] setItems expects an array, got:",typeof t),t=[]),this.items=t;const e=t.length*this.itemHeight;this.scrollContent.style.height=`${e}px`,console.log(`[VirtualScroller] Set ${t.length} items (total height: ${e}px)`),this.scrollTop>e&&(this.container.scrollTop=0,this.scrollTop=0),this.render()}onScroll(){if(!this.isDestroyed){if(this.scrollTop=this.container.scrollTop,this.onLoadMore){const t=this.container.scrollHeight,e=this.container.clientHeight;t-(this.scrollTop+e)<200&&!this.isLoading&&this.triggerLoadMore()}this.render()}}onResize(){this.isDestroyed||this.render()}async triggerLoadMore(){if(this.onLoadMore&&!this.isLoading){this.isLoading=!0,this.loadingIndicator.style.display="block";try{await this.onLoadMore()}catch(t){console.error("[VirtualScroller] Load more failed:",t)}finally{this.isLoading=!1,this.loadingIndicator.style.display="none"}}}render(){if(this.isDestroyed||0===this.items.length)return void(this.viewport.innerHTML="");const t=performance.now(),e=this.container.clientHeight,i=Math.max(0,this.scrollTop),s=this.scrollTop+e;this.visibleStart=Math.max(0,Math.floor(i/this.itemHeight)-this.bufferSize),this.visibleEnd=Math.min(this.items.length,Math.ceil(s/this.itemHeight)+this.bufferSize);const r=this.visibleStart*this.itemHeight;this.viewport.style.transform=`translateY(${r}px)`;const n=document.createDocumentFragment();for(let t=this.visibleStart;t<this.visibleEnd;t++){const e=this.items[t],i=document.createElement("div");i.className="virtual-item",i.style.height=`${this.itemHeight}px`,i.style.overflow="hidden",i.dataset.index=t;try{const s=this.renderItem(e,t);i.innerHTML=s}catch(e){console.error(`[VirtualScroller] Failed to render item ${t}:`,e),i.innerHTML='<div style="color: red;">Error rendering item</div>'}n.appendChild(i)}this.viewport.innerHTML="",this.viewport.appendChild(n);const o=performance.now()-t;this.renderCount++,this.totalRenderTime+=o;const l=this.visibleEnd-this.visibleStart;if(o>16&&(this.slowRenderWarnings++,console.warn(`[VirtualScroller] Slow render: ${o.toFixed(2)}ms (${l} items)`)),window.AnalyticsManager&&window.AnalyticsManager.trackPerformance("virtual_scroll_render",{itemCount:this.items.length,visibleCount:l,duration:o,fps:o>0?Math.round(1e3/o):60}),this.renderCount%10==0){const t=this.totalRenderTime/this.renderCount;console.log(`[VirtualScroller] Stats: ${this.renderCount} renders, avg ${t.toFixed(2)}ms, ${this.slowRenderWarnings} slow renders`)}}scrollToIndex(t,e="smooth"){if(t<0||t>=this.items.length)return void console.warn(`[VirtualScroller] Invalid index: ${t}`);const i=t*this.itemHeight;this.container.scrollTo({top:i,behavior:e}),console.log(`[VirtualScroller] Scrolled to index ${t} (${i}px)`)}getCurrentIndex(){return Math.floor(this.scrollTop/this.itemHeight)}updateItem(t,e){if(t<0||t>=this.items.length)console.warn(`[VirtualScroller] Invalid update index: ${t}`);else if(this.items[t]=e,t>=this.visibleStart&&t<this.visibleEnd){const i=this.viewport.querySelector(`[data-index="${t}"]`);if(i)try{i.innerHTML=this.renderItem(e,t)}catch(e){console.error(`[VirtualScroller] Failed to update item ${t}:`,e)}}}appendItems(t){if(!Array.isArray(t)||0===t.length)return;const e=this.items.length;this.items=this.items.concat(t);const i=this.items.length*this.itemHeight;this.scrollContent.style.height=`${i}px`,console.log(`[VirtualScroller] Appended ${t.length} items (total: ${this.items.length})`),this.visibleEnd>=e&&this.render()}clear(){this.items=[],this.scrollContent.style.height="0px",this.viewport.innerHTML="",this.container.scrollTop=0,this.scrollTop=0,this.visibleStart=0,this.visibleEnd=0,console.log("[VirtualScroller] Cleared all items")}getStats(){return{itemCount:this.items.length,renderCount:this.renderCount,averageRenderTime:this.renderCount>0?this.totalRenderTime/this.renderCount:0,slowRenderWarnings:this.slowRenderWarnings,visibleRange:{start:this.visibleStart,end:this.visibleEnd,count:this.visibleEnd-this.visibleStart},scrollPosition:{top:this.scrollTop,index:this.getCurrentIndex()}}}destroy(){console.log("[VirtualScroller] Destroying instance"),this.container.removeEventListener("scroll",this.boundScrollHandler),window.removeEventListener("resize",this.boundResizeHandler),this.container.classList.remove("virtual-scroller-container"),this.container.innerHTML="",this.items=[],this.scrollContent=null,this.viewport=null,this.loadingIndicator=null,this.isDestroyed=!0;const t=this.getStats();console.log("[VirtualScroller] Final stats:",t)}}export default VirtualScroller;"undefined"!=typeof window&&(window.VirtualScroller=VirtualScroller);
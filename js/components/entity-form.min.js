class EntityForm{constructor(e){this.crudManager=e.crudManager,this.collection=e.collection,this.entityId=e.entityId,this.onSuccess="function"==typeof e.onSuccess?e.onSuccess:()=>{},this.onCancel="function"==typeof e.onCancel?e.onCancel:()=>{},this.formData={},this.errors={},this.isEditing=!!this.entityId,this.autoSaveTimer=null,this.schema=this.getSchema(this.collection)}getSchema(e){return{fields:[{name:"name",label:"Name",type:"text",required:!0,placeholder:"Enter entity name...",helpText:"The primary name of this entity"},{name:"mythology",label:"Mythology",type:"select",required:!0,options:["greek","norse","egyptian","hindu","buddhist","christian","celtic","roman","aztec","mayan","chinese","japanese","sumerian","babylonian","persian","yoruba","aboriginal","polynesian"],helpText:"The mythological tradition this entity belongs to"},{name:"type",label:"Type",type:"text",required:!0,placeholder:"e.g., deity, hero, creature...",helpText:"The category or classification"},{name:"description",label:"Description",type:"textarea",required:!1,placeholder:"Enter a detailed description...",rows:6,helpText:"Detailed information about this entity"},{name:"icon",label:"Icon (Emoji)",type:"text",required:!1,placeholder:"⚡",maxLength:2,helpText:"An emoji to represent this entity"},...{deities:[{name:"domains",label:"Domains",type:"tags",placeholder:"Add domain (e.g., Thunder, Sky)...",helpText:"Areas of influence or power"},{name:"symbols",label:"Symbols",type:"tags",placeholder:"Add symbol...",helpText:"Sacred symbols and objects"},{name:"family",label:"Family Relationships",type:"textarea",rows:3,placeholder:"Parents, siblings, children...",helpText:"Family connections and relationships"}],creatures:[{name:"habitat",label:"Habitat",type:"text",placeholder:"Where this creature lives...",helpText:"Natural habitat or dwelling place"},{name:"abilities",label:"Abilities",type:"tags",placeholder:"Add ability...",helpText:"Special powers and capabilities"}],heroes:[{name:"quests",label:"Quests",type:"tags",placeholder:"Add quest...",helpText:"Famous quests and adventures"},{name:"weapons",label:"Weapons",type:"tags",placeholder:"Add weapon...",helpText:"Legendary weapons and tools"}],items:[{name:"powers",label:"Powers",type:"tags",placeholder:"Add power...",helpText:"Magical powers and properties"},{name:"owner",label:"Owner",type:"text",placeholder:"Who owns or wields this item...",helpText:"The deity, hero, or being associated with this item"}],herbs:[{name:"uses",label:"Uses",type:"tags",placeholder:"Add use...",helpText:"Medicinal, magical, or ritual uses"},{name:"preparation",label:"Preparation",type:"textarea",rows:3,placeholder:"How to prepare this herb...",helpText:"Methods of preparation and application"}],rituals:[{name:"purpose",label:"Purpose",type:"text",placeholder:"Purpose of this ritual...",helpText:"What this ritual achieves or celebrates"},{name:"steps",label:"Steps",type:"textarea",rows:5,placeholder:"Ritual steps...",helpText:"Step-by-step procedure"},{name:"offerings",label:"Offerings",type:"tags",placeholder:"Add offering...",helpText:"Required offerings or materials"}]}[e]||[]]}}async render(){if(this.isEditing){const e=await this.crudManager.read(this.collection,this.entityId);e.success&&(this.formData=e.data)}return`\n            <div class="entity-form-container">\n                <div class="entity-form-header">\n                    <h2>${this.isEditing?"Edit":"Create"} ${this.capitalizeFirst(this.collection.slice(0,-1))}</h2>\n                    <button class="form-close-btn" data-action="cancel">×</button>\n                </div>\n\n                <form class="entity-form" id="entityForm">\n                    ${this.schema.fields.map(e=>this.renderField(e)).join("\n")}\n\n                    <div class="form-actions">\n                        <button type="button" class="btn-secondary" data-action="cancel">\n                            Cancel\n                        </button>\n                        <button type="submit" class="btn-primary">\n                            ${this.isEditing?"Update":"Create"} ${this.capitalizeFirst(this.collection.slice(0,-1))}\n                        </button>\n                    </div>\n\n                    <div class="form-status" id="formStatus"></div>\n                </form>\n            </div>\n        `}renderField(e){const t=this.formData[e.name]||"",a=this.errors[e.name];let n="";switch(e.type){case"text":n=`\n                    <input\n                        type="text"\n                        id="${e.name}"\n                        name="${e.name}"\n                        value="${this.escapeHtml(t)}"\n                        placeholder="${e.placeholder||""}"\n                        ${e.required?"required":""}\n                        ${e.maxLength?`maxlength="${e.maxLength}"`:""}\n                        class="form-input"\n                    />\n                `;break;case"textarea":n=`\n                    <textarea\n                        id="${e.name}"\n                        name="${e.name}"\n                        placeholder="${e.placeholder||""}"\n                        ${e.required?"required":""}\n                        rows="${e.rows||4}"\n                        class="form-textarea"\n                    >${this.escapeHtml(t)}</textarea>\n                `;break;case"select":const a=e.options.map(e=>`<option value="${e}" ${t===e?"selected":""}>${this.capitalizeFirst(e)}</option>`).join("\n");n=`\n                    <select\n                        id="${e.name}"\n                        name="${e.name}"\n                        ${e.required?"required":""}\n                        class="form-select"\n                    >\n                        <option value="">Select ${e.label}...</option>\n                        ${a}\n                    </select>\n                `;break;case"tags":const s=Array.isArray(t)?t:[];n=`\n                    <div class="form-tags-input" id="${e.name}_container">\n                        <div class="tags-list">\n                            ${s.map(e=>`\n                                <span class="tag">\n                                    ${this.escapeHtml(e)}\n                                    <button type="button" class="tag-remove" data-tag="${this.escapeHtml(e)}">×</button>\n                                </span>\n                            `).join("")}\n                        </div>\n                        <input\n                            type="text"\n                            id="${e.name}_input"\n                            placeholder="${e.placeholder||"Add tag..."}"\n                            class="form-input"\n                            data-field="${e.name}"\n                        />\n                    </div>\n                `}return`\n            <div class="form-field ${a?"has-error":""}">\n                <label for="${e.name}" class="form-label">\n                    ${e.label}\n                    ${e.required?'<span class="required">*</span>':""}\n                </label>\n                ${n}\n                ${e.helpText?`<p class="form-help-text">${e.helpText}</p>`:""}\n                ${a?`<p class="form-error">${a}</p>`:""}\n            </div>\n        `}initialize(e){this.container=e,this.form=e.querySelector("#entityForm"),this.form.addEventListener("submit",e=>this.handleSubmit(e)),e.querySelectorAll('[data-action="cancel"]').forEach(e=>{e.addEventListener("click",()=>this.handleCancel())}),this.initializeTagsInputs(),this.form.addEventListener("input",()=>this.scheduleAutoSave())}initializeTagsInputs(){this.schema.fields.filter(e=>"tags"===e.type).forEach(e=>{const t=this.form.querySelector(`#${e.name}_input`);t&&(t.addEventListener("keydown",a=>{"Enter"===a.key&&(a.preventDefault(),this.addTag(e.name,t.value.trim()),t.value="")}),this.form.querySelector(`#${e.name}_container`).addEventListener("click",t=>{t.target.classList.contains("tag-remove")&&this.removeTag(e.name,t.target.dataset.tag)}))})}addTag(e,t){if(!t)return;const a=this.form.querySelector(`#${e}_container .tags-list`),n=`\n            <span class="tag">\n                ${this.escapeHtml(t)}\n                <button type="button" class="tag-remove" data-tag="${this.escapeHtml(t)}">×</button>\n            </span>\n        `;a.insertAdjacentHTML("beforeend",n)}removeTag(e,t){this.form.querySelector(`#${e}_container .tags-list`).querySelectorAll(".tag").forEach(e=>{e.querySelector(".tag-remove").dataset.tag===t&&e.remove()})}getTags(e){const t=this.form.querySelector(`#${e}_container .tags-list`);if(!t)return[];const a=t.querySelectorAll(".tag");return Array.from(a).map(e=>e.querySelector(".tag-remove").dataset.tag)}async handleSubmit(e){e.preventDefault();const t=new FormData(this.form),a={};let n;this.schema.fields.forEach(e=>{"tags"===e.type?a[e.name]=this.getTags(e.name):a[e.name]=t.get(e.name)||""}),this.showStatus("Saving...","loading"),n=this.isEditing?await this.crudManager.update(this.collection,this.entityId,a):await this.crudManager.create(this.collection,a),n.success?(this.showStatus("Success!","success"),setTimeout(()=>{if("function"==typeof this.onSuccess)try{this.onSuccess(n)}catch(e){}},1e3)):this.showStatus(`Error: ${n.error}`,"error")}handleCancel(){if(confirm("Are you sure you want to cancel? Any unsaved changes will be lost.")&&"function"==typeof this.onCancel)try{this.onCancel()}catch(e){document.querySelectorAll(".modal-overlay").forEach(e=>e.remove())}}scheduleAutoSave(){clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout(()=>{this.saveDraft()},2e3)}saveDraft(){const e=new FormData(this.form),t={};this.schema.fields.forEach(a=>{"tags"===a.type?t[a.name]=this.getTags(a.name):t[a.name]=e.get(a.name)});const a=`draft_${this.collection}_${this.entityId||"new"}`;localStorage.setItem(a,JSON.stringify(t))}showStatus(e,t){const a=this.container.querySelector("#formStatus");a.textContent=e,a.className=`form-status ${t}`}capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}"undefined"!=typeof module&&module.exports&&(module.exports=EntityForm);
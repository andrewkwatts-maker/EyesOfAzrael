class AttributeGridRenderer{constructor(){this.db=firebase.firestore(),this.auth=firebase.auth()}init(){document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-attribute-grid]").forEach(t=>this.renderGrid(t))})}async renderGrid(t){const e=t.getAttribute("data-mythology"),r=t.getAttribute("data-entity"),i="true"===t.getAttribute("data-allow-edit");if(e&&r)try{t.innerHTML=this.getLoadingHTML();const n=await this.fetchAttributes(e,r);t.innerHTML=this.renderGridHTML(n,i,e,r),i&&this.attachEditListeners(t,e,r)}catch(e){t.innerHTML=this.getErrorHTML(e.message)}}async fetchAttributes(t,e){const r=this.db.collection("deities").doc(t).collection("entities").doc(e),i=await r.get();if(!i.exists)throw new Error(`Entity not found: ${t}/${e}`);return i.data().attributes||{}}renderGridHTML(t,e,r,i){const n=Object.entries(t).map(([t,n])=>this.renderCardHTML(t,n,e,r,i)).join("");return`\n            <div class="attribute-grid" data-mythology="${r}" data-entity="${i}">\n                ${n}\n                ${e?this.getAddButtonHTML():""}\n            </div>\n        `}renderCardHTML(t,e,r,i,n){const a=Array.isArray(e)?e.join(", "):e;return`\n            <div class="subsection-card" data-label="${t}" style="position: relative;">\n                ${r?`\n            <button class="edit-attribute-btn"\n                    data-label="${t}"\n                    data-value="${a}"\n                    title="Edit ${t}"\n                    style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(var(--color-primary-rgb), 0.2); border: none; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">\n                ✏️\n            </button>\n        `:""}\n                <div class="attribute-label">${t}</div>\n                <div class="attribute-value">${a}</div>\n            </div>\n        `}getAddButtonHTML(){return'\n            <div class="subsection-card add-attribute-card" style="cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; opacity: 0.7; border: 2px dashed rgba(var(--color-primary-rgb), 0.5);">\n                <button class="add-attribute-btn" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--color-primary);">\n                    ➕ Add Attribute\n                </button>\n            </div>\n        '}getLoadingHTML(){return'\n            <div class="spinner-container" style="text-align: center; padding: 2rem;">\n                <div class="spinner-ring"></div>\n                <div class="spinner-ring"></div>\n                <div class="spinner-ring"></div>\n                <p style="margin-top: 1rem; color: var(--color-text-secondary);">Loading attributes...</p>\n            </div>\n        '}getErrorHTML(t){return`\n            <div style="padding: 2rem; text-align: center; color: var(--color-error);">\n                <p><strong>Error loading attributes:</strong></p>\n                <p>${t}</p>\n                <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--color-primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer;">\n                    Retry\n                </button>\n            </div>\n        `}attachEditListeners(t,e,r){t.querySelectorAll(".edit-attribute-btn").forEach(t=>{t.addEventListener("click",i=>{const n=t.getAttribute("data-label"),a=t.getAttribute("data-value");this.showEditModal(e,r,n,a)})});const i=t.querySelector(".add-attribute-btn");i&&i.addEventListener("click",()=>{this.showAddModal(e,r)})}async showEditModal(t,e,r,i){if(!this.auth.currentUser)return void alert("Please sign in to edit content");const n=prompt(`Edit ${r}:`,i);n&&n!==i&&await this.submitEdit(t,e,r,n)}async showAddModal(t,e){if(!this.auth.currentUser)return void alert("Please sign in to add content");const r=prompt('Attribute name (e.g., "Sacred Numbers"):');if(!r)return;const i=prompt(`Value for ${r}:`);i&&await this.submitEdit(t,e,r,i)}async submitEdit(t,e,r,i){const n=this.auth.currentUser;if(!n)throw new Error("User must be authenticated");try{await this.db.collection("submissions").add({type:"attribute_edit",mythology:t,entityId:e,section:"attributes",label:r,value:i,userId:n.uid,userName:n.displayName||n.email,status:"pending_review",timestamp:firebase.firestore.FieldValue.serverTimestamp()}),alert("Your edit has been submitted for review. Thank you!")}catch(t){alert("Error submitting edit. Please try again.")}}}"undefined"!=typeof firebase&&(new AttributeGridRenderer).init();
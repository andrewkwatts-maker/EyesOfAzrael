class TheoryWidget{constructor(e){this.element=e,this.pageId=e.dataset.page||window.location.pathname,this.pageTitle=e.dataset.title||document.title,this.mode=e.dataset.mode||"button",this.init()}init(){this.render(),this.attachEventListeners(),window.addEventListener("theoriesUpdated",()=>this.refreshTheories()),window.addEventListener("userLogin",()=>this.render()),window.addEventListener("userLogout",()=>this.render())}render(){"button"===this.mode?this.renderButton():"inline"===this.mode&&this.renderInline()}renderButton(){const e=this.getPageTheories().length;this.element.innerHTML=`\n            <button class="theory-widget-button" data-theory-toggle>\n                <span class="theory-icon">üí≠</span>\n                <span class="theory-text">User Theories</span>\n                ${e>0?`<span class="theory-count">${e}</span>`:""}\n            </button>\n        `}renderInline(){const e=this.getPageTheories(),t=window.authGuard&&window.authGuard.isAuthenticated();this.element.innerHTML=`\n            <div class="theory-widget-inline">\n                <div class="theory-widget-header">\n                    <h3>\n                        <span class="theory-icon">üí≠</span>\n                        User Theories\n                        ${e.length>0?`<span class="theory-count">${e.length}</span>`:""}\n                    </h3>\n                    ${t?'\n                        <button class="theory-add-btn" data-theory-add>\n                            <span>+</span> Add Theory\n                        </button>\n                    ':'\n                        <button class="theory-login-btn auth-required" data-theory-login\n                                title="Sign in to add theories">\n                            <span>üîí</span> Sign in to Add\n                        </button>\n                    '}\n                </div>\n\n                <div class="theory-widget-content">\n                    ${e.length>0?this.renderTheoryList(e):this.renderEmpty()}\n                </div>\n            </div>\n        `}renderTheoryList(e){return`\n            <div class="theory-list">\n                ${e.map(e=>this.renderTheoryCard(e)).join("")}\n            </div>\n        `}renderTheoryCard(e){const t=window.authGuard&&window.authGuard.isAuthenticated(),n=t?window.authGuard.getCurrentUser():null,o=n&&n.username===e.author,s=e.voters.find(e=>n&&e.username===n.username);return`\n            <div class="theory-card" data-theory-id="${e.id}">\n                <div class="theory-card-header">\n                    <div class="theory-author">\n                        <img src="${e.authorAvatar}" alt="${e.author}" class="theory-avatar">\n                        <div>\n                            <div class="theory-author-name">${e.author}</div>\n                            <div class="theory-date">${window.userTheories.formatDate(e.createdAt)}</div>\n                        </div>\n                    </div>\n                    <div class="theory-category">\n                        <span class="category-icon">${window.userTheories.getCategoryIcon(e.category)}</span>\n                        <span class="category-name">${window.userTheories.getCategoryName(e.category)}</span>\n                    </div>\n                </div>\n\n                <h4 class="theory-title">${this.escapeHtml(e.title)}</h4>\n\n                ${e.summary?`\n                    <p class="theory-summary">${this.escapeHtml(e.summary)}</p>\n                `:""}\n\n                <div class="theory-content-preview">\n                    ${this.truncateText(this.escapeHtml(e.content),200)}\n                </div>\n\n                <div class="theory-card-footer">\n                    <div class="theory-stats">\n                        <span class="stat">\n                            <span>üëÅÔ∏è</span> ${e.views||0}\n                        </span>\n                        <span class="stat">\n                            <span>üí¨</span> ${e.comments.length}\n                        </span>\n                    </div>\n\n                    <div class="theory-actions">\n                        ${t?`\n                            <button class="vote-btn ${1===s?.direction?"voted":""}"\n                                    data-theory-vote="${e.id}" data-direction="1">\n                                <span>üëç</span> ${e.votes>0?e.votes:""}\n                            </button>\n                            <button class="vote-btn ${-1===s?.direction?"voted":""}"\n                                    data-theory-vote="${e.id}" data-direction="-1">\n                                <span>üëé</span>\n                            </button>\n                        `:`\n                            <span class="vote-display auth-required"\n                                  onclick="window.authGuard?.showLoginPrompt('Sign in to vote on theories', 'vote')"\n                                  title="Sign in to vote">\n                                <span>üëç</span> ${e.votes}\n                            </span>\n                        `}\n\n                        <button class="theory-view-btn" data-theory-view="${e.id}">\n                            View Full Theory ‚Üí\n                        </button>\n\n                        ${o?`\n                            <button class="theory-edit-btn" data-theory-edit="${e.id}">\n                                ‚úèÔ∏è Edit\n                            </button>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `}renderEmpty(){return`\n            <div class="theory-empty">\n                <div class="theory-empty-icon">üí°</div>\n                <p class="theory-empty-text">No theories yet for this topic</p>\n                ${window.authGuard&&window.authGuard.isAuthenticated()?'\n                    <button class="theory-add-btn-large" data-theory-add>\n                        <span>+</span> Be the First to Share\n                    </button>\n                ':'\n                    <p class="theory-empty-subtext">\n                        <button class="theory-login-link auth-required" data-theory-login\n                                title="Sign in to contribute">Sign in</button>\n                        to share your insights\n                    </p>\n                '}\n            </div>\n        `}attachEventListeners(){this.element.addEventListener("click",e=>{e.target.closest("[data-theory-toggle]")&&this.toggleModal(),e.target.closest("[data-theory-add]")&&this.showTheoryForm(),e.target.closest("[data-theory-login]")&&window.authGuard?.showLoginPrompt("Sign in to share your theories and insights","submit");const t=e.target.closest("[data-theory-vote]");if(t){const e=t.dataset.theoryVote,n=parseInt(t.dataset.direction);this.handleVote(e,n)}const n=e.target.closest("[data-theory-view]");if(n){const e=n.dataset.theoryView;this.showTheoryDetail(e)}const o=e.target.closest("[data-theory-edit]");if(o){const e=o.dataset.theoryEdit;this.showTheoryForm(e)}})}getPageTheories(){return window.userTheories?window.userTheories.getAllTheories({relatedPage:this.pageId}):[]}toggleModal(){const e=this.getOrCreateModal();e.style.display="flex"===e.style.display?"none":"flex","flex"===e.style.display&&this.renderModalContent()}getOrCreateModal(){let e=document.getElementById("theory-modal");return e||(e=document.createElement("div"),e.id="theory-modal",e.className="theory-modal",e.innerHTML='\n                <div class="theory-modal-content">\n                    <button class="theory-modal-close" data-theory-modal-close>√ó</button>\n                    <div class="theory-modal-body"></div>\n                </div>\n            ',document.body.appendChild(e),e.addEventListener("click",t=>{(t.target===e||t.target.closest("[data-theory-modal-close]"))&&(e.style.display="none")})),e}renderModalContent(){const e=document.getElementById("theory-modal").querySelector(".theory-modal-body"),t=this.getPageTheories(),n=window.authGuard&&window.authGuard.isAuthenticated();e.innerHTML=`\n            <div class="theory-modal-header">\n                <h2>\n                    <span class="theory-icon">üí≠</span>\n                    Theories about ${this.escapeHtml(this.pageTitle)}\n                </h2>\n                ${n?'\n                    <button class="theory-add-btn" data-theory-add>\n                        <span>+</span> Add Theory\n                    </button>\n                ':'\n                    <button class="theory-login-btn auth-required" data-theory-login\n                            title="Sign in to add theories">\n                        <span>üîí</span> Sign in to Add\n                    </button>\n                '}\n            </div>\n\n            <div class="theory-modal-content-area">\n                ${t.length>0?this.renderTheoryList(t):this.renderEmpty()}\n            </div>\n        `}showTheoryForm(e=null){const t=this.getOrCreateModal(),n=t.querySelector(".theory-modal-body"),o=!!e,s=o?window.userTheories.getTheory(e):null;if(o&&!s)return void alert("Theory not found");n.innerHTML=`\n            <div class="theory-form-container">\n                <h2>${o?"Edit":"Add"} Theory</h2>\n                <p class="theory-form-subtitle">Sharing about: ${this.escapeHtml(this.pageTitle)}</p>\n\n                <form id="theory-submit-form" class="theory-form">\n                    <div class="form-group">\n                        <label for="theory-title">Theory Title *</label>\n                        <input type="text" id="theory-title" name="title"\n                               value="${o?this.escapeHtml(s.title):""}"\n                               placeholder="Enter a descriptive title" required>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="theory-category">Category *</label>\n                        <select id="theory-category" name="category" required>\n                            <option value="">Select a category...</option>\n                            <option value="pattern" ${"pattern"===s?.category?"selected":""}>üîó Pattern Connections</option>\n                            <option value="archaeological" ${"archaeological"===s?.category?"selected":""}>üèõÔ∏è Archaeological Correlations</option>\n                            <option value="textual" ${"textual"===s?.category?"selected":""}>üìñ Textual Analysis</option>\n                            <option value="alternative" ${"alternative"===s?.category?"selected":""}>üß¨ Alternative Interpretations</option>\n                            <option value="geographic" ${"geographic"===s?.category?"selected":""}>üó∫Ô∏è Geographic Correlations</option>\n                            <option value="timeline" ${"timeline"===s?.category?"selected":""}>‚è≥ Timeline Analysis</option>\n                            <option value="physics" ${"physics"===s?.category?"selected":""}>‚öõÔ∏è Physics Integration</option>\n                            <option value="general" ${"general"===s?.category?"selected":""}>üí° General Theory</option>\n                        </select>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="theory-summary">Summary</label>\n                        <textarea id="theory-summary" name="summary" rows="2"\n                                  placeholder="Brief summary (optional)">${o?this.escapeHtml(s.summary||""):""}</textarea>\n                        <small>2-3 sentences summarizing your theory</small>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="theory-content">Full Theory *</label>\n                        <textarea id="theory-content" name="content" rows="10" required\n                                  placeholder="Present your theory in detail...">${o?this.escapeHtml(s.content):""}</textarea>\n                        <small>Minimum 50 characters</small>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="theory-sources">Sources & References</label>\n                        <textarea id="theory-sources" name="sources" rows="4"\n                                  placeholder="List your sources, citations, or links">${o?this.escapeHtml(s.sources||""):""}</textarea>\n                    </div>\n\n                    <div class="form-group">\n                        <label for="theory-mythologies">Related Mythologies</label>\n                        <input type="text" id="theory-mythologies" name="mythologies"\n                               value="${o?(s.relatedMythologies||[]).join(", "):""}"\n                               placeholder="e.g., Greek, Egyptian, Norse (comma-separated)">\n                    </div>\n\n                    <div class="form-message" id="theory-form-message"></div>\n\n                    <div class="form-actions">\n                        <button type="button" class="btn-secondary" data-theory-modal-close>\n                            Cancel\n                        </button>\n                        <button type="submit" class="btn-primary">\n                            ${o?"Update":"Submit"} Theory\n                        </button>\n                    </div>\n                </form>\n            </div>\n        `,t.style.display="flex";const a=n.querySelector("#theory-submit-form");a.addEventListener("submit",t=>{t.preventDefault(),this.handleTheorySubmit(a,o?e:null)})}handleTheorySubmit(e,t=null){const n=new FormData(e),o={title:n.get("title"),summary:n.get("summary"),content:n.get("content"),category:n.get("category"),sources:n.get("sources"),relatedMythologies:n.get("mythologies").split(",").map(e=>e.trim()).filter(e=>e),relatedPage:this.pageId};let s;s=t?window.userTheories.updateTheory(t,o):window.userTheories.submitTheory(o);const a=e.querySelector("#theory-form-message");s.success?(a.textContent=s.message,a.className="form-message form-message-success",a.style.display="block",setTimeout(()=>{this.refreshTheories(),this.getOrCreateModal().style.display="none"},1500)):(a.textContent=s.error,a.className="form-message form-message-error",a.style.display="block")}handleVote(e,t){const n=window.userTheories.voteTheory(e,t);n.success?this.refreshTheories():alert(n.error)}showTheoryDetail(e){const t=window.userTheories.getTheory(e);if(!t)return void alert("Theory not found");window.userTheories.incrementViews(e);const n=this.getOrCreateModal(),o=n.querySelector(".theory-modal-body"),s=window.authGuard&&window.authGuard.isAuthenticated(),a=s?window.authGuard.getCurrentUser():null,r=a&&a.username===t.author,i=t.voters.find(e=>a&&e.username===a.username);o.innerHTML=`\n            <div class="theory-detail">\n                <div class="theory-detail-header">\n                    <div class="theory-meta">\n                        <span class="theory-category">\n                            <span class="category-icon">${window.userTheories.getCategoryIcon(t.category)}</span>\n                            ${window.userTheories.getCategoryName(t.category)}\n                        </span>\n                        <span class="theory-date">${window.userTheories.formatDate(t.createdAt)}</span>\n                    </div>\n                    <h1 class="theory-detail-title">${this.escapeHtml(t.title)}</h1>\n\n                    <div class="theory-author-detail">\n                        <img src="${t.authorAvatar}" alt="${t.author}" class="theory-avatar-large">\n                        <div>\n                            <div class="theory-author-name">${t.author}</div>\n                            <div class="theory-stats-inline">\n                                <span>üëÅÔ∏è ${t.views} views</span>\n                                <span>üí¨ ${t.comments.length} comments</span>\n                                <span>üëç ${t.votes} votes</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="theory-detail-content">\n                    ${this.formatContent(t.content)}\n                </div>\n\n                ${t.sources?`\n                    <div class="theory-sources">\n                        <h3>Sources & References</h3>\n                        ${this.formatContent(t.sources)}\n                    </div>\n                `:""}\n\n                ${t.relatedMythologies.length>0?`\n                    <div class="theory-mythologies">\n                        <strong>Related Mythologies:</strong>\n                        ${t.relatedMythologies.map(e=>`<span class="mythology-tag">${e}</span>`).join("")}\n                    </div>\n                `:""}\n\n                <div class="theory-actions-detail">\n                    ${s?`\n                        <button class="vote-btn-large ${1===i?.direction?"voted":""}"\n                                data-theory-vote="${t.id}" data-direction="1">\n                            <span>üëç</span> Upvote ${t.votes>0?`(${t.votes})`:""}\n                        </button>\n                        <button class="vote-btn-large ${-1===i?.direction?"voted":""}"\n                                data-theory-vote="${t.id}" data-direction="-1">\n                            <span>üëé</span> Downvote\n                        </button>\n                    `:`\n                        <div class="vote-btn-disabled auth-required"\n                             onclick="window.authGuard?.showLoginPrompt('Sign in to vote on theories', 'vote')"\n                             title="Sign in to vote">\n                            <span>üëç</span> Upvote (${t.votes>0?t.votes:0})\n                            <span class="signin-required-badge" style="margin-left: 0.5rem;">üîí Sign in</span>\n                        </div>\n                    `}\n\n                    ${r?`\n                        <button class="btn-edit" data-theory-edit="${t.id}">\n                            ‚úèÔ∏è Edit Theory\n                        </button>\n                        <button class="btn-delete" data-theory-delete="${t.id}">\n                            üóëÔ∏è Delete\n                        </button>\n                    `:""}\n                </div>\n\n                <div class="theory-comments">\n                    <h3>Comments (${t.comments.length})</h3>\n\n                    ${s?`\n                        <form class="comment-form" data-comment-form="${t.id}">\n                            <textarea placeholder="Add your thoughts..." rows="3" required></textarea>\n                            <button type="submit" class="btn-primary">Post Comment</button>\n                        </form>\n                    `:'\n                        <p class="comments-login-prompt">\n                            <button class="theory-login-link auth-required" data-theory-login\n                                    title="Sign in to comment">Sign in</button> to comment\n                        </p>\n                    '}\n\n                    <div class="comments-list">\n                        ${t.comments.map(e=>`\n                            <div class="comment">\n                                <img src="${e.authorAvatar}" alt="${e.author}" class="comment-avatar">\n                                <div class="comment-content">\n                                    <div class="comment-header">\n                                        <span class="comment-author">${e.author}</span>\n                                        <span class="comment-date">${window.userTheories.formatDate(e.createdAt)}</span>\n                                    </div>\n                                    <p>${this.escapeHtml(e.content)}</p>\n                                </div>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n\n                <button class="btn-back" data-theory-modal-close>‚Üê Back to List</button>\n            </div>\n        `,n.style.display="flex";const d=o.querySelector(`[data-comment-form="${e}"]`);d&&d.addEventListener("submit",t=>{t.preventDefault();const n=d.querySelector("textarea"),o=window.userTheories.addComment(e,n.value);o.success?(n.value="",this.showTheoryDetail(e)):alert(o.error)});const l=o.querySelector(`[data-theory-delete="${e}"]`);l&&l.addEventListener("click",()=>{if(confirm("Are you sure you want to delete this theory?")){const t=window.userTheories.deleteTheory(e);t.success?(this.refreshTheories(),n.style.display="none"):alert(t.error)}})}refreshTheories(){this.render();const e=document.getElementById("theory-modal");e&&"flex"===e.style.display&&this.renderModalContent()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}truncateText(e,t){return e.length<=t?e:e.substr(0,t)+"..."}formatContent(e){return e.split("\n\n").map(e=>`<p>${this.escapeHtml(e).replace(/\n/g,"<br>")}</p>`).join("")}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-theory-widget]").forEach(e=>{new TheoryWidget(e)})}),"undefined"!=typeof module&&module.exports&&(module.exports=TheoryWidget);
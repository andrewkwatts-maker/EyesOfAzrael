class EntityDetailViewer{constructor(t={}){this.db=t.db||window.firebase&&window.firebase.firestore(),this.router=t.router}async render(t){try{const{mythology:e,entityType:i,entityId:n}=t,s=await this.loadEntity(e,i,n);if(!s)return this.renderNotFound(n);const a=await this.loadRelatedEntities(s);return this.generateHTML(s,a,e,i)}catch(t){throw t}}async loadEntity(t,e,i){if(!this.db)throw new Error("Firebase Firestore not initialized");const n=this.getCollectionName(e),s=await this.db.collection(n).doc(i).get();return s.exists?{id:s.id,...s.data()}:null}async loadRelatedEntities(t){const e={};if(t.displayOptions?.relatedEntities)for(const i of t.displayOptions.relatedEntities)try{const t=await this.loadEntitiesByIds(i.collection,i.ids||[]);e[i.type]={label:i.label||i.type,entities:t}}catch(t){}return e}async loadEntitiesByIds(t,e){if(!e||0===e.length)return[];const i=[];for(const n of e.slice(0,10))try{const e=await this.db.collection(t).doc(n).get();e.exists&&i.push({id:e.id,...e.data()})}catch(t){}return i}generateHTML(t,e,i,n){const s=t.colors||{},a=s.primary||"#667eea",r=s.secondary||"#764ba2";return`\n            <div class="entity-detail-viewer" data-entity-id="${t.id}">\n                \x3c!-- Hero Section --\x3e\n                <div class="entity-hero" style="--primary-color: ${a}; --secondary-color: ${r};">\n                    <div class="entity-hero-background"></div>\n                    <div class="entity-hero-content">\n                        ${t.icon?`<div class="entity-icon-large">${t.icon}</div>`:""}\n                        <h1 class="entity-title">${this.escapeHtml(t.name||t.title)}</h1>\n                        ${t.linguistic?.originalName?`\n                            <div class="entity-subtitle">${this.escapeHtml(t.linguistic.originalName)}</div>\n                        `:""}\n\n                        <div class="entity-badges">\n                            <span class="entity-type-badge">${this.getEntityTypeLabel(n)}</span>\n                            <span class="mythology-badge">${this.capitalize(i)}</span>\n                        </div>\n\n                        ${t.shortDescription?`\n                            <p class="entity-hero-description">${this.escapeHtml(t.shortDescription)}</p>\n                        `:""}\n\n                        \x3c!-- Actions --\x3e\n                        <div class="entity-actions">\n                            <button class="btn-secondary" onclick="window.history.back()">\n                                ‚Üê Back\n                            </button>\n                            <button class="btn-secondary" onclick="navigator.share ? navigator.share({title: '${this.escapeHtml(t.name)}', url: window.location.href}) : alert('Sharing not supported')">\n                                Share\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Main Content --\x3e\n                <div class="entity-content">\n                    \x3c!-- Primary Information --\x3e\n                    ${this.renderPrimaryInfo(t,n)}\n\n                    \x3c!-- Full Description --\x3e\n                    ${t.fullDescription?`\n                        <div class="entity-section">\n                            <h2 class="section-title">Overview</h2>\n                            <div class="entity-description">\n                                ${this.escapeHtml(t.fullDescription)}\n                            </div>\n                        </div>\n                    `:""}\n\n                    \x3c!-- Type-Specific Sections --\x3e\n                    ${this.renderTypeSpecificSections(t,n)}\n\n                    \x3c!-- Linguistic Information --\x3e\n                    ${t.linguistic?this.renderLinguisticInfo(t.linguistic):""}\n\n                    \x3c!-- Cultural Context --\x3e\n                    ${t.culturalContext?this.renderCulturalContext(t.culturalContext):""}\n\n                    \x3c!-- Related Entities --\x3e\n                    ${Object.keys(e).length>0?this.renderRelatedEntities(e,i):""}\n\n                    \x3c!-- Sources --\x3e\n                    ${t.sources?this.renderSources(t.sources):""}\n                </div>\n            </div>\n        `}renderPrimaryInfo(t,e){const i=this.getPrimaryFields(e);return i.some(e=>this.getNestedValue(t,e.path))?`\n            <div class="entity-section">\n                <h2 class="section-title">Key Attributes</h2>\n                <div class="entity-attributes-grid">\n                    ${i.map(e=>this.renderAttribute(t,e)).filter(Boolean).join("")}\n                </div>\n            </div>\n        `:""}renderAttribute(t,e){const i=this.getNestedValue(t,e.path);if(!i)return null;const n=Array.isArray(i)?i.map(t=>`<span class="attribute-tag">${this.escapeHtml(t)}</span>`).join(""):this.escapeHtml(i);return`\n            <div class="entity-attribute">\n                <div class="attribute-label">${e.label}:</div>\n                <div class="attribute-value">${n}</div>\n            </div>\n        `}renderTypeSpecificSections(t,e){let i="";return"deity"===e&&(t.mythology_specific&&(i+=this.renderSection("Mythology-Specific Information",t.mythology_specific)),t.worship&&(i+=this.renderSection("Worship & Rituals",t.worship))),"hero"===e&&(t.feats&&(i+=this.renderListSection("Legendary Feats",t.feats)),t.weapons&&(i+=this.renderListSection("Weapons & Equipment",t.weapons))),"creature"===e&&(t.abilities&&(i+=this.renderListSection("Abilities & Powers",t.abilities)),t.weaknesses&&(i+=this.renderListSection("Weaknesses",t.weaknesses))),i}renderLinguisticInfo(t){return t&&0!==Object.keys(t).length?`\n            <div class="entity-section">\n                <h2 class="section-title">Linguistic Information</h2>\n                <div class="entity-attributes-grid">\n                    ${t.originalName?`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">Original Name:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.originalName)}</div>\n                        </div>\n                    `:""}\n                    ${t.etymology?`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">Etymology:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.etymology)}</div>\n                        </div>\n                    `:""}\n                    ${t.pronunciation?`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">Pronunciation:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.pronunciation)}</div>\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `:""}renderCulturalContext(t){return t&&0!==Object.keys(t).length?`\n            <div class="entity-section">\n                <h2 class="section-title">Cultural Context</h2>\n                <div class="entity-attributes-grid">\n                    ${t.region?`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">Region:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.region)}</div>\n                        </div>\n                    `:""}\n                    ${t.period?`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">Time Period:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.period)}</div>\n                        </div>\n                    `:""}\n                    ${t.significance?`\n                        <div class="entity-attribute full-width">\n                            <div class="attribute-label">Cultural Significance:</div>\n                            <div class="attribute-value">${this.escapeHtml(t.significance)}</div>\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `:""}renderRelatedEntities(t,e){return`\n            <div class="entity-section">\n                <h2 class="section-title">Related Entities</h2>\n                ${Object.entries(t).map(([t,i])=>`\n                    <div class="related-entities-group">\n                        <h3 class="related-group-title">${i.label}</h3>\n                        <div class="related-entities-list">\n                            ${i.entities.map(i=>`\n                                <a href="#/mythology/${e}/${t}/${i.id}" class="related-entity-card">\n                                    ${i.icon?`<span class="related-entity-icon">${i.icon}</span>`:""}\n                                    <span class="related-entity-name">${this.escapeHtml(i.name||i.title)}</span>\n                                </a>\n                            `).join("")}\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n        `}renderSources(t){return t&&0!==t.length?`\n            <div class="entity-section">\n                <h2 class="section-title">Sources</h2>\n                <ul class="sources-list">\n                    ${t.map(t=>`\n                        <li class="source-item">${this.escapeHtml(t)}</li>\n                    `).join("")}\n                </ul>\n            </div>\n        `:""}renderSection(t,e){return e&&0!==Object.keys(e).length?`\n            <div class="entity-section">\n                <h2 class="section-title">${t}</h2>\n                <div class="entity-attributes-grid">\n                    ${Object.entries(e).map(([t,e])=>`\n                        <div class="entity-attribute">\n                            <div class="attribute-label">${this.capitalize(t)}:</div>\n                            <div class="attribute-value">${this.escapeHtml(e)}</div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `:""}renderListSection(t,e){return e&&0!==e.length?`\n            <div class="entity-section">\n                <h2 class="section-title">${t}</h2>\n                <ul class="entity-list">\n                    ${e.map(t=>`\n                        <li class="entity-list-item">${this.escapeHtml(t)}</li>\n                    `).join("")}\n                </ul>\n            </div>\n        `:""}renderNotFound(t){return`\n            <div class="error-container">\n                <div class="error-icon">üîç</div>\n                <h2>Entity Not Found</h2>\n                <p class="error-message">\n                    The entity "${this.escapeHtml(t)}" could not be found.\n                </p>\n                <div class="error-actions">\n                    <button class="btn-primary" onclick="window.history.back()">Go Back</button>\n                    <a href="#/" class="btn-secondary">Browse Mythologies</a>\n                </div>\n            </div>\n        `}getPrimaryFields(t){return{deity:[{label:"Domains",path:"domains"},{label:"Symbols",path:"symbols"},{label:"Element",path:"element"},{label:"Gender",path:"gender"}],hero:[{label:"Parentage",path:"parentage"},{label:"Legacy",path:"legacy"},{label:"Era",path:"era"}],creature:[{label:"Type",path:"type"},{label:"Habitat",path:"habitat"},{label:"Abilities",path:"abilities"}]}[t]||[]}getEntityTypeLabel(t){return{deity:"Deity",hero:"Hero",creature:"Creature",cosmology:"Cosmology",ritual:"Ritual",herb:"Herb",text:"Text",symbol:"Symbol"}[t]||this.capitalize(t)}getCollectionName(t){return{deity:"deities",hero:"heroes",creature:"creatures",cosmology:"cosmology",ritual:"rituals",herb:"herbs",text:"texts",symbol:"symbols"}[t]||t+"s"}getNestedValue(t,e){return e.split(".").reduce((t,e)=>t?.[e],t)}capitalize(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}escapeHtml(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}}window.EntityDetailViewer=EntityDetailViewer;
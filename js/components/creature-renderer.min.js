class CreatureRenderer{constructor(){this.db=firebase.firestore(),this.auth=firebase.auth(),this.cache=new Map}init(){document.querySelectorAll("[data-creature-content]").forEach(e=>{const t=e.dataset.mythology,r=e.dataset.entity,n="true"===e.dataset.allowEdit;this.renderCreature(e,t,r,n)})}async fetchCreature(e,t){const r=`${e}/${t}`;if(this.cache.has(r))return this.cache.get(r);try{const n=this.db.collection("entities").doc(e).collection("creature").doc(t),i=await n.get();if(!i.exists)return null;const s=i.data();return this.cache.set(r,s),s}catch(e){return null}}async renderCreature(e,t,r,n=!1){e.innerHTML='<div class="loading-spinner">Loading creature data...</div>';const i=await this.fetchCreature(t,r);if(!i)return void(e.innerHTML='<div class="error-message">Creature data not found. Content will load from HTML.</div>');e.style.position="relative";let s="";n&&this.canUserEdit(i)&&(s+=this.renderEditIcon(r,"creatures")),s+=this.renderHeader(i),i.physicalDescription&&(s+=this.renderPhysicalDescription(i.physicalDescription)),i.abilities&&i.abilities.length>0&&(s+=this.renderAbilities(i.abilities)),i.habitat&&(s+=this.renderHabitat(i.habitat)),i.origin&&(s+=this.renderOrigin(i.origin)),i.encounters&&i.encounters.length>0&&(s+=this.renderEncounters(i.encounters)),i.symbolism&&(s+=this.renderSymbolism(i.symbolism)),i.sections&&i.sections.length>0&&(s+=this.renderSections(i.sections)),i.sources&&i.sources.length>0&&(s+=this.renderSources(i.sources)),n&&(s+=this.renderEditButton(t,r)),e.innerHTML=s}renderHeader(e){return`\n            <div class="creature-header">\n                <h1>${e.icon||"ğŸ‰"} ${e.name}</h1>\n                ${e.subtitle?`<p class="subtitle">${e.subtitle}</p>`:""}\n                ${e.shortDescription?`<p class="short-description">${e.shortDescription}</p>`:""}\n                ${e.creatureType?`<span class="creature-type-badge">${e.creatureType}</span>`:""}\n            </div>\n        `}renderPhysicalDescription(e){let t='<section class="creature-physical"><h2>ğŸ‘ï¸ Physical Description</h2>';return"string"==typeof e?t+=`<p>${e}</p>`:"object"==typeof e&&(e.appearance&&(t+=`<div class="description-card"><h3>Appearance</h3><p>${e.appearance}</p></div>`),e.size&&(t+=`<div class="description-card"><h3>Size</h3><p>${e.size}</p></div>`),e.features&&e.features.length>0&&(t+='<div class="description-card"><h3>Notable Features</h3><ul>',e.features.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul></div>")),t+="</section>",t}renderAbilities(e){let t='<section class="creature-abilities"><h2>âš¡ Abilities & Powers</h2>';return t+='<div class="abilities-grid">',e.forEach(e=>{"string"==typeof e?t+=`<div class="ability-card"><p>${e}</p></div>`:e.name&&(t+=`\n                    <div class="ability-card">\n                        <h3>${e.name}</h3>\n                        ${e.description?`<p>${e.description}</p>`:""}\n                    </div>\n                `)}),t+="</div></section>",t}renderHabitat(e){let t='<section class="creature-habitat"><h2>ğŸï¸ Habitat</h2>';return"string"==typeof e?t+=`<p>${e}</p>`:"object"==typeof e&&(e.location&&(t+=`<p><strong>Location:</strong> ${e.location}</p>`),e.environment&&(t+=`<p><strong>Environment:</strong> ${e.environment}</p>`),e.territory&&(t+=`<p><strong>Territory:</strong> ${e.territory}</p>`)),t+="</section>",t}renderOrigin(e){let t='<section class="creature-origin"><h2>ğŸ“– Origin</h2>';return t+=this.renderContent(e),t+="</section>",t}renderEncounters(e){let t='<section class="creature-encounters"><h2>âš”ï¸ Famous Encounters</h2>';return t+='<div class="encounters-list">',e.forEach((e,r)=>{"string"==typeof e?t+=`<div class="encounter-card"><p>${e}</p></div>`:e.hero&&(t+=`\n                    <div class="encounter-card">\n                        <h3>${e.hero}${e.title?` - ${e.title}`:""}</h3>\n                        ${e.description?`<p>${e.description}</p>`:""}\n                        ${e.outcome?`<p class="outcome"><strong>Outcome:</strong> ${e.outcome}</p>`:""}\n                    </div>\n                `)}),t+="</div></section>",t}renderSymbolism(e){let t='<section class="creature-symbolism"><h2>ğŸ”® Symbolism</h2>';return"string"==typeof e?t+=`<p>${e}</p>`:"object"==typeof e&&(e.represents&&e.represents.length>0&&(t+='<div class="symbolism-card"><h3>Represents</h3><ul>',e.represents.forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul></div>"),e.culturalSignificance&&(t+=`<div class="symbolism-card"><h3>Cultural Significance</h3><p>${e.culturalSignificance}</p></div>`)),t+="</section>",t}renderSections(e){let t="";return e.forEach(e=>{t+='<section class="content-section">',t+=`<h2>${e.title}</h2>`,t+=this.renderContent(e.content),t+="</section>"}),t}renderContent(e){return Array.isArray(e)?e.map(e=>`<p>${e}</p>`).join(""):"string"==typeof e?`<p>${e}</p>`:""}renderSources(e){let t='<section class="sources-section"><h2>ğŸ“š Sources</h2><ul class="sources-list">';return e.forEach(e=>{"string"==typeof e?t+=`<li>${e}</li>`:e.title&&(t+=`<li><strong>${e.title}</strong>`,e.author&&(t+=` by ${e.author}`),e.date&&(t+=` (${e.date})`),t+="</li>")}),t+="</ul></section>",t}renderEditIcon(e,t){return`\n            <button class="edit-icon-btn"\n                    data-entity-id="${e}"\n                    data-collection="${t}"\n                    aria-label="Edit creature"\n                    title="Edit this creature">\n                âœï¸\n            </button>\n        `}canUserEdit(e){const t=this.auth.currentUser;return!!t&&e.createdBy===t.uid}renderEditButton(e,t){return`\n            <div class="edit-controls">\n                <button class="btn-edit" onclick="window.location.href='/admin/edit-creature.html?mythology=${e}&id=${t}'">\n                    âœï¸ Edit Creature\n                </button>\n            </div>\n        `}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new CreatureRenderer).init()}):(new CreatureRenderer).init(),window.CreatureRenderer=CreatureRenderer;
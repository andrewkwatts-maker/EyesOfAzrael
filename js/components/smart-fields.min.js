class SmartFields{constructor(){this.db="undefined"!=typeof firebase&&firebase.firestore?firebase.firestore():null,this.auth="undefined"!=typeof firebase&&firebase.auth?firebase.auth():null,this.userHistoryCache={}}renderHierarchicalSelect(e,t,a="",n=[]){const s=e.options||[],i=!1!==e.allowCustom,l=s.filter(e=>!e.parent),c={};s.forEach(e=>{e.parent&&(c[e.parent]||(c[e.parent]=[]),c[e.parent].push(e))});const r=(e,t=0)=>{const n="  ".repeat(t),s="separator"===e.type?"disabled":"",i=e.value===a?"selected":"",l="separator"===e.type?e.label:`${n}${e.label}`;let o=`<option value="${this.escapeHtml(e.value)}" ${s} ${i}>${this.escapeHtml(l)}</option>`;return c[e.value]&&c[e.value].forEach(e=>{o+=r(e,t+1)}),o};let o=`\n            <select class="smart-field hierarchical-select"\n                    name="${t}"\n                    id="${t}"\n                    data-field-type="hierarchical">\n                <option value="">-- Select ${e.label||t} --</option>\n        `;if(l.forEach(e=>{o+=r(e)}),n.length>0&&(o+='<option value="" disabled>--- My Previous Choices ---</option>',n.forEach(e=>{const t=e===a?"selected":"";o+=`<option value="${this.escapeHtml(e)}" ${t}>${this.escapeHtml(e)} ‚≠ê</option>`})),i){const e=s.find(e=>"custom"===e.type);e&&(o+=`<option value="__custom__">${this.escapeHtml(e.label)}</option>`)}return o+="</select>",i&&(o+=`\n                <input type="text"\n                       class="smart-field custom-input"\n                       id="${t}-custom"\n                       name="${t}-custom"\n                       placeholder="Enter custom ${e.label||t}"\n                       style="display: none; margin-top: var(--spacing-sm);">\n            `),o}renderMultiSelect(e,t,a=[],n=[]){const s=e.options||[],i={};s.forEach(e=>{const t=e.category||"other";i[t]||(i[t]=[]),i[t].push(e)});let l='\n            <div class="smart-field multi-select-container" data-field-type="multi-select">\n                <div class="multi-select-options">\n        ';return Object.keys(i).forEach(e=>{l+=`\n                <div class="multi-select-category">\n                    <div class="category-label">${this.escapeHtml(e)}</div>\n                    <div class="category-options">\n            `,i[e].forEach(e=>{if("custom"===e.type)return;const n=a.includes(e.value)?"checked":"",s=`${t}-${e.value}`;l+=`\n                    <label class="multi-select-option">\n                        <input type="checkbox"\n                               name="${t}[]"\n                               value="${this.escapeHtml(e.value)}"\n                               id="${s}"\n                               ${n}>\n                        <span class="option-label">${this.escapeHtml(e.label)}</span>\n                    </label>\n                `}),l+="\n                    </div>\n                </div>\n            "}),n.length>0&&(l+='\n                <div class="multi-select-category">\n                    <div class="category-label">‚≠ê My Previous Choices</div>\n                    <div class="category-options">\n            ',n.forEach(e=>{if(s.find(t=>t.value===e))return;const n=a.includes(e)?"checked":"",i=`${t}-history-${e.replace(/\s+/g,"-")}`;l+=`\n                    <label class="multi-select-option">\n                        <input type="checkbox"\n                               name="${t}[]"\n                               value="${this.escapeHtml(e)}"\n                               id="${i}"\n                               ${n}>\n                        <span class="option-label">${this.escapeHtml(e)}</span>\n                    </label>\n                `}),l+="\n                    </div>\n                </div>\n            "),e.allowCustom&&(l+=`\n                <div class="multi-select-custom">\n                    <input type="text"\n                           class="smart-field custom-input"\n                           id="${t}-custom"\n                           placeholder="${e.placeholder||"Add custom value"}">\n                    <button type="button"\n                            class="btn-add-custom"\n                            data-field="${t}">+ Add</button>\n                </div>\n            `),l+="\n                </div>\n            </div>\n        ",l}renderCoordinateInput(e,t={}){const a=t.lat||"",n=t.lng||"";return`\n            <div class="smart-field coordinate-input" data-field-type="coordinates">\n                <div class="coordinate-fields">\n                    <div class="coordinate-field">\n                        <label for="${e}-lat">Latitude</label>\n                        <input type="number"\n                               id="${e}-lat"\n                               name="${e}[lat]"\n                               value="${a}"\n                               min="-90"\n                               max="90"\n                               step="any"\n                               placeholder="e.g., 40.7128"\n                               class="coordinate-lat">\n                        <small class="field-hint">-90¬∞ to 90¬∞</small>\n                    </div>\n                    <div class="coordinate-field">\n                        <label for="${e}-lng">Longitude</label>\n                        <input type="number"\n                               id="${e}-lng"\n                               name="${e}[lng]"\n                               value="${n}"\n                               min="-180"\n                               max="180"\n                               step="any"\n                               placeholder="e.g., -74.0060"\n                               class="coordinate-lng">\n                        <small class="field-hint">-180¬∞ to 180¬∞</small>\n                    </div>\n                </div>\n                <div class="coordinate-preview" id="${e}-preview">\n                    ${a&&n?`<small>üìç ${a}, ${n}</small>`:""}\n                </div>\n            </div>\n        `}async renderSmartField(e,t,a,n=[]){const s=e.type||"text";switch(0===n.length&&this.auth&&this.auth.currentUser&&(n=await this.getUserFieldHistory(t)),s){case"hierarchical":return this.renderHierarchicalSelect(e,t,a,n);case"multi-select":return this.renderMultiSelect(e,t,a,n);case"coordinates":return this.renderCoordinateInput(t,a);default:return`<input type="text" name="${t}" id="${t}" value="${this.escapeHtml(a||"")}" class="smart-field">`}}async getUserFieldHistory(e){if(!this.db||!this.auth||!this.auth.currentUser)return[];const t=`${this.auth.currentUser.uid}-${e}`;if(this.userHistoryCache[t])return this.userHistoryCache[t];try{const a=this.auth.currentUser.uid,n=await this.db.collection("theories").where("userId","==",a).orderBy("createdAt","desc").limit(50).get(),s=new Set;n.docs.forEach(t=>{const a=t.data();if(a.assetMetadata&&a.assetMetadata[e]){const t=a.assetMetadata[e];Array.isArray(t)?t.forEach(e=>s.add(e)):s.add(t)}if(a.metadata&&a.metadata[e]){const t=a.metadata[e];Array.isArray(t)?t.forEach(e=>s.add(e)):s.add(t)}if(a[e]){const t=a[e];Array.isArray(t)?t.forEach(e=>s.add(e)):s.add(t)}});const i=Array.from(s).filter(e=>e&&""!==e);return this.userHistoryCache[t]=i,i}catch(e){return[]}}initializeEventListeners(){document.addEventListener("change",e=>{if(e.target.classList.contains("hierarchical-select")){const t=document.getElementById(`${e.target.id}-custom`);t&&("__custom__"===e.target.value?(t.style.display="block",t.required=!0,t.focus()):(t.style.display="none",t.required=!1,t.value=""))}}),document.addEventListener("click",e=>{if(e.target.classList.contains("btn-add-custom")){const t=e.target.dataset.field,a=document.getElementById(`${t}-custom`);if(a&&a.value.trim()){const n=a.value.trim(),s=e.target.closest(".multi-select-container"),i=(s.querySelector(".category-options"),`${t}-custom-${n.replace(/\s+/g,"-")}`),l=`\n                        <label class="multi-select-option">\n                            <input type="checkbox"\n                                   name="${t}[]"\n                                   value="${this.escapeHtml(n)}"\n                                   id="${i}"\n                                   checked>\n                            <span class="option-label">${this.escapeHtml(n)}</span>\n                        </label>\n                    `;let c=s.querySelector(".custom-values-category");c||(c=document.createElement("div"),c.className="multi-select-category custom-values-category",c.innerHTML='\n                            <div class="category-label">Custom Values</div>\n                            <div class="category-options"></div>\n                        ',s.querySelector(".multi-select-options").appendChild(c)),c.querySelector(".category-options").insertAdjacentHTML("beforeend",l),a.value=""}}}),document.addEventListener("input",e=>{if(e.target.classList.contains("coordinate-lat")||e.target.classList.contains("coordinate-lng")){const t=e.target.closest(".coordinate-input"),a=t.querySelector(".coordinate-lat"),n=t.querySelector(".coordinate-lng"),s=t.querySelector(".coordinate-preview");a.value&&n.value?s.innerHTML=`<small>üìç ${a.value}, ${n.value}</small>`:s.innerHTML=""}})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.smartFields=new SmartFields,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.smartFields.initializeEventListeners()}):window.smartFields.initializeEventListeners();
class SearchViewComplete{constructor(t){if(!t)throw new Error("Firestore instance is required");if(this.db=t,"undefined"!=typeof EnhancedCorpusSearch)this.searchEngine=new EnhancedCorpusSearch(t);else{if("undefined"==typeof CorpusSearch)throw new Error("CorpusSearch component not loaded");this.searchEngine=new CorpusSearch(t)}this.state={query:"",results:[],totalResults:0,currentPage:1,resultsPerPage:24,displayMode:"grid",sortBy:"relevance",filters:{mythology:"",entityTypes:[],importance:[1,5],hasImage:null},isLoading:!1,error:null},this.autocompleteTimer=null,this.autocompleteDelay=300,this.searchHistory=this.loadSearchHistory(),this.maxHistorySize=10,this.mythologies=[],this.boundHandlers={},this.activeTimers=[],this.elements={},this.isDestroyed=!1}async render(t){try{await this.loadMythologies(),t.innerHTML=this.getHTML(),await this.init()}catch(e){t.innerHTML=`\n                <div class="search-error">\n                    <div class="error-icon">‚ö†Ô∏è</div>\n                    <h2>Failed to load search</h2>\n                    <p>${e.message}</p>\n                </div>\n            `}}async loadMythologies(){try{const t=await this.db.collection("mythologies").get();this.mythologies=[],t.forEach(t=>{this.mythologies.push({id:t.id,name:t.data().name||this.formatMythologyName(t.id)})}),this.mythologies.sort((t,e)=>t.name.localeCompare(e.name))}catch(t){this.mythologies=[{id:"greek",name:"Greek"},{id:"norse",name:"Norse"},{id:"egyptian",name:"Egyptian"},{id:"hindu",name:"Hindu"},{id:"buddhist",name:"Buddhist"},{id:"christian",name:"Christian"},{id:"babylonian",name:"Babylonian"},{id:"sumerian",name:"Sumerian"}]}}formatMythologyName(t){return t.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}getHTML(){return`\n            <div class="search-view">\n                <div class="search-header">\n                    <h1>Search Mythological Entities</h1>\n                    <p class="search-description">Explore deities, heroes, creatures, and more across world mythologies</p>\n\n                    <div class="search-input-wrapper">\n                        <span class="search-icon">üîç</span>\n                        <input\n                            type="text"\n                            id="search-input"\n                            class="search-input"\n                            placeholder="Search deities, heroes, creatures, and more..."\n                            autocomplete="off"\n                            value="${this.state.query}"\n                        >\n                        <button id="clear-search" class="clear-btn" style="display: none;">‚úï</button>\n                        <button id="search-btn" class="search-submit-btn">Search</button>\n                    </div>\n\n                    <div id="autocomplete-results" class="search-suggestions" style="display: none;"></div>\n                </div>\n\n                <div class="search-content">\n                    <aside class="search-filters">\n                        <button id="filter-toggle-btn" class="filter-toggle-btn">\n                            <span>üéõÔ∏è Filters</span>\n                            <span id="filter-count" class="filter-count" style="display: none;">0</span>\n                        </button>\n\n                        <div id="filter-panel" class="filter-panel" style="display: none;">\n                            ${this.getFiltersHTML()}\n                        </div>\n\n                        ${this.getSearchHistoryHTML()}\n                    </aside>\n\n                    <main class="search-results-main">\n                        <div class="results-controls" style="display: none;">\n                            <div class="results-info">\n                                <span id="results-count">0 results</span>\n                            </div>\n\n                            <div class="display-mode-switcher">\n                                <button class="display-mode-btn active" data-mode="grid" title="Grid view">\n                                    ‚ñ¶\n                                </button>\n                                <button class="display-mode-btn" data-mode="list" title="List view">\n                                    ‚ò∞\n                                </button>\n                                <button class="display-mode-btn" data-mode="table" title="Table view">\n                                    ‚ñ§\n                                </button>\n                            </div>\n\n                            <div class="sort-controls">\n                                <label for="sort-select">Sort:</label>\n                                <select id="sort-select" class="sort-select">\n                                    <option value="relevance">Relevance</option>\n                                    <option value="name">Name (A-Z)</option>\n                                    <option value="importance">Importance</option>\n                                    <option value="popularity">Popularity</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div id="results-container" class="search-results">\n                            ${this.getEmptyStateHTML()}\n                        </div>\n\n                        <div id="pagination" class="pagination" style="display: none;"></div>\n                    </main>\n                </div>\n            </div>\n        `}getFiltersHTML(){return`\n            <div class="filter-group">\n                <label for="mythology-filter">Mythology</label>\n                <select id="mythology-filter">\n                    <option value="">All Mythologies</option>\n                    ${this.mythologies.map(t=>`<option value="${t.id}">${t.name}</option>`).join("")}\n                </select>\n            </div>\n\n            <div class="filter-group">\n                <label>Entity Type</label>\n                <div class="checkbox-group">\n                    <label><input type="checkbox" value="deities" checked> Deities</label>\n                    <label><input type="checkbox" value="heroes" checked> Heroes</label>\n                    <label><input type="checkbox" value="creatures" checked> Creatures</label>\n                    <label><input type="checkbox" value="cosmology" checked> Cosmology</label>\n                    <label><input type="checkbox" value="rituals" checked> Rituals</label>\n                    <label><input type="checkbox" value="texts" checked> Texts</label>\n                </div>\n            </div>\n\n            <div class="filter-group">\n                <label for="importance-filter">\n                    Minimum Importance: <span id="importance-value">1</span>\n                </label>\n                <input\n                    type="range"\n                    id="importance-filter"\n                    min="1"\n                    max="5"\n                    value="1"\n                    step="1"\n                >\n            </div>\n\n            <div class="filter-group">\n                <label>Has Image</label>\n                <select id="image-filter">\n                    <option value="">Any</option>\n                    <option value="true">Yes</option>\n                    <option value="false">No</option>\n                </select>\n            </div>\n\n            <div class="filter-actions">\n                <button id="apply-filters" class="btn-primary">Apply Filters</button>\n                <button id="clear-filters" class="btn-secondary">Clear All</button>\n            </div>\n        `}getSearchHistoryHTML(){return 0===this.searchHistory.length?"":`\n            <div class="search-history">\n                <div class="history-header">\n                    <h4>Recent Searches</h4>\n                    <button id="clear-history" class="btn-text">Clear</button>\n                </div>\n                <ul class="history-list">\n                    ${this.searchHistory.slice(0,5).map(t=>`\n                        <li class="history-item" data-query="${this.escapeHtml(t.query)}">\n                            <span class="history-query">${this.escapeHtml(t.query)}</span>\n                            <span class="history-count">${t.resultCount||0}</span>\n                        </li>\n                    `).join("")}\n                </ul>\n            </div>\n        `}getEmptyStateHTML(){return'\n            <div class="search-placeholder">\n                <div class="placeholder-icon">üîç</div>\n                <p>Enter a search term to find entities across world mythologies</p>\n                <div class="search-examples">\n                    <p><strong>Try searching for:</strong></p>\n                    <button class="example-query" data-query="zeus">Zeus</button>\n                    <button class="example-query" data-query="odin">Odin</button>\n                    <button class="example-query" data-query="ra">Ra</button>\n                    <button class="example-query" data-query="shiva">Shiva</button>\n                    <button class="example-query" data-query="thunder">Thunder deities</button>\n                    <button class="example-query" data-query="underworld">Underworld</button>\n                </div>\n            </div>\n        '}getNoResultsHTML(){return`\n            <div class="no-results">\n                <div class="no-results-icon">üòï</div>\n                <p>No entities found for "${this.escapeHtml(this.state.query)}"</p>\n                <p class="no-results-hint">Try different keywords or check your filters</p>\n            </div>\n        `}getLoadingHTML(){return'\n            <div class="search-loading">\n                <div class="spinner"></div>\n                <p>Searching...</p>\n            </div>\n        '}async init(){const t=document.getElementById("search-input"),e=document.getElementById("search-btn"),s=document.getElementById("clear-search"),n=document.getElementById("filter-toggle-btn"),i=document.getElementById("apply-filters"),a=document.getElementById("clear-filters"),r=document.getElementById("sort-select");t.addEventListener("input",t=>{const e=t.target.value.trim();s.style.display=e?"inline-block":"none",clearTimeout(this.autocompleteTimer),e.length>=2?this.autocompleteTimer=setTimeout(()=>{this.showAutocomplete(e)},this.autocompleteDelay):this.hideAutocomplete()}),t.addEventListener("keypress",e=>{"Enter"===e.key&&this.performSearch(t.value)}),e.addEventListener("click",()=>{this.performSearch(t.value)}),s.addEventListener("click",()=>{t.value="",t.focus(),s.style.display="none",this.hideAutocomplete(),this.showEmptyState()}),n.addEventListener("click",()=>{const t=document.getElementById("filter-panel");t.style.display="none"===t.style.display?"block":"none"}),i.addEventListener("click",()=>{this.updateFilters(),this.state.query&&this.performSearch(this.state.query)}),a.addEventListener("click",()=>{this.clearFilters()}),r.addEventListener("change",t=>{this.state.sortBy=t.target.value,this.renderResults()}),document.querySelectorAll(".display-mode-btn").forEach(t=>{t.addEventListener("click",e=>{document.querySelectorAll(".display-mode-btn").forEach(t=>t.classList.remove("active")),t.classList.add("active"),this.state.displayMode=t.dataset.mode,this.renderResults()})});const o=document.getElementById("importance-filter"),l=document.getElementById("importance-value");o.addEventListener("input",t=>{l.textContent=t.target.value}),document.querySelectorAll(".example-query").forEach(e=>{e.addEventListener("click",e=>{const s=e.target.dataset.query;t.value=s,this.performSearch(s)})}),document.querySelectorAll(".history-item").forEach(e=>{e.addEventListener("click",e=>{const s=e.currentTarget.dataset.query;t.value=s,this.performSearch(s)})});const c=document.getElementById("clear-history");c&&c.addEventListener("click",()=>{this.clearSearchHistory()}),document.addEventListener("click",e=>{const s=document.getElementById("autocomplete-results");t.contains(e.target)||s.contains(e.target)||this.hideAutocomplete()}),window.searchViewInstance=this}async showAutocomplete(t){try{const e=await this.searchEngine.getSuggestions(t,8),s=document.getElementById("autocomplete-results");if(!s)return;if(!e||0===e.length)return void this.hideAutocomplete();s.innerHTML=e.map(e=>`\n                <div class="suggestion-item" data-query="${this.escapeHtml(e)}">\n                    <strong>${this.highlightMatch(e,t)}</strong>\n                </div>\n            `).join(""),s.querySelectorAll(".suggestion-item").forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget.dataset.query,s=document.getElementById("search-input");s&&(s.value=e,this.performSearch(e),this.hideAutocomplete())})}),s.style.display="block"}catch(t){}}hideAutocomplete(){const t=document.getElementById("autocomplete-results");t&&(t.style.display="none")}async performSearch(t){if(!(t=t.trim())||t.length<2)return void this.showEmptyState();this.hideAutocomplete(),this.state.query=t,this.state.currentPage=1,this.state.isLoading=!0,this.state.error=null;const e=document.getElementById("results-container");e&&(e.innerHTML=this.getLoadingHTML());const s=document.querySelector(".results-controls");s&&(s.style.display="none");try{const e={mode:"generic",mythology:this.state.filters.mythology||null,limit:1e3},s=await this.searchEngine.search(t,e);this.state.results=this.applyClientFilters(s.items||[]),this.state.totalResults=this.state.results.length,window.AnalyticsManager&&window.AnalyticsManager.trackSearch(t,{mythology:this.state.filters.mythology,entityTypes:this.state.filters.entityTypes.join(","),hasImage:this.state.filters.hasImage},this.state.totalResults),this.addToSearchHistory(t,this.state.totalResults),this.renderResults()}catch(t){this.state.error=t.message,this.renderError()}finally{this.state.isLoading=!1}}applyClientFilters(t){return t.filter(t=>{if(this.state.filters.entityTypes.length>0){const e=t.type||t.collection;if(!this.state.filters.entityTypes.includes(e))return!1}return!((t.importance||50)<20*this.state.filters.importance[0])&&(null===this.state.filters.hasImage||!(!t.image&&!t.gridDisplay?.image)===this.state.filters.hasImage)})}updateFilters(){const t=document.getElementById("mythology-filter");t&&(this.state.filters.mythology=t.value);const e=Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked')).map(t=>t.value);this.state.filters.entityTypes=e;const s=document.getElementById("importance-filter");if(s){const t=parseInt(s.value);this.state.filters.importance=[t,5]}const n=document.getElementById("image-filter");if(n){const t=n.value;this.state.filters.hasImage=""===t?null:"true"===t}let i=0;this.state.filters.mythology&&i++,this.state.filters.entityTypes.length<6&&i++,this.state.filters.importance[0]>1&&i++,null!==this.state.filters.hasImage&&i++;const a=document.getElementById("filter-count");a&&(i>0?(a.textContent=i,a.style.display="inline-block"):a.style.display="none")}clearFilters(){const t=document.getElementById("mythology-filter");t&&(t.value=""),document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(t=>{t.checked=!0});const e=document.getElementById("importance-filter");e&&(e.value=1);const s=document.getElementById("importance-value");s&&(s.textContent="1");const n=document.getElementById("image-filter");n&&(n.value=""),this.state.filters={mythology:"",entityTypes:[],importance:[1,5],hasImage:null};const i=document.getElementById("filter-count");i&&(i.style.display="none"),this.state.query&&this.performSearch(this.state.query)}renderResults(){const t=document.getElementById("results-container");if(!t)return;const e=document.querySelector(".results-controls");if(!e)return;const s=document.getElementById("pagination");if(!s)return;if(0===this.state.totalResults)return t.innerHTML=this.getNoResultsHTML(),e.style.display="none",void(s.style.display="none");e.style.display="flex";const n=document.getElementById("results-count");n&&(n.textContent=`${this.state.totalResults} result${1!==this.state.totalResults?"s":""}`);const i=this.sortResults([...this.state.results]),a=(this.state.currentPage-1)*this.state.resultsPerPage,r=a+this.state.resultsPerPage,o=i.slice(a,r);switch(this.state.displayMode){case"grid":t.innerHTML=this.renderGridView(o);break;case"list":t.innerHTML=this.renderListView(o);break;case"table":t.innerHTML=this.renderTableView(o)}this.renderPagination()}renderGridView(t){return`\n            <div class="entity-grid universal-grid">\n                ${t.map(t=>this.renderEntityCard(t)).join("")}\n            </div>\n        `}renderEntityCard(t){const e=t.mythology||"unknown",s=t.type||t.collection||"entity",n=t.id||t.name?.toLowerCase().replace(/\s+/g,"-"),i=t.icon||t.gridDisplay?.icon||"üìñ",a=t.name||"Unknown",r=t.subtitle||t.description?.substring(0,60)||"",o=t.importance||50,l=Math.round(o/20);return`\n            <a href="#/mythology/${e}/${s}/${n}" class="entity-card grid-card">\n                <div class="card-badge">${this.formatMythologyName(e)}</div>\n                <div class="card-icon">${i}</div>\n                <div class="card-title">${this.escapeHtml(a)}</div>\n                <div class="card-subtitle">${this.escapeHtml(r)}</div>\n                <div class="card-stats">\n                    <div class="stat-item">\n                        <span class="stat-label">Type:</span>\n                        <span class="stat-value">${this.formatEntityType(s)}</span>\n                    </div>\n                    <div class="stat-item">\n                        <span class="stat-label">Importance:</span>\n                        <span class="stat-value">${"‚≠ê".repeat(l)}</span>\n                    </div>\n                </div>\n            </a>\n        `}renderListView(t){return`\n            <ul class="entity-list universal-list">\n                ${t.map(t=>this.renderListItem(t)).join("")}\n            </ul>\n        `}renderListItem(t){const e=t.mythology||"unknown",s=t.type||t.collection||"entity",n=t.id||t.name?.toLowerCase().replace(/\s+/g,"-"),i=t.icon||t.gridDisplay?.icon||"üìñ",a=t.name||"Unknown",r=t.description||"";return`\n            <li class="entity-list-item">\n                <a href="#/mythology/${e}/${s}/${n}" class="list-item-main">\n                    <div class="list-icon">${i}</div>\n                    <div class="list-content">\n                        <div class="list-primary">${this.escapeHtml(a)}</div>\n                        <div class="list-secondary">${this.escapeHtml(r.substring(0,120))}${r.length>120?"...":""}</div>\n                        <div class="list-meta">${this.formatMythologyName(e)} ‚Ä¢ ${this.formatEntityType(s)}</div>\n                    </div>\n                </a>\n            </li>\n        `}renderTableView(t){return`\n            <div class="entity-table-container">\n                <table class="entity-table">\n                    <thead>\n                        <tr>\n                            <th>Icon</th>\n                            <th>Name</th>\n                            <th>Type</th>\n                            <th>Mythology</th>\n                            <th>Importance</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${t.map(t=>this.renderTableRow(t)).join("")}\n                    </tbody>\n                </table>\n            </div>\n        `}renderTableRow(t){const e=t.mythology||"unknown",s=t.type||t.collection||"entity",n=t.id||t.name?.toLowerCase().replace(/\s+/g,"-"),i=t.icon||t.gridDisplay?.icon||"üìñ",a=t.name||"Unknown",r=t.importance||50,o=Math.round(r/20);return`\n            <tr onclick="window.location.hash='#/mythology/${e}/${s}/${n}'" style="cursor: pointer;">\n                <td style="font-size: 24px;">${i}</td>\n                <td><strong>${this.escapeHtml(a)}</strong></td>\n                <td>${this.formatEntityType(s)}</td>\n                <td>${this.formatMythologyName(e)}</td>\n                <td>${"‚≠ê".repeat(o)}</td>\n            </tr>\n        `}renderPagination(){const t=document.getElementById("pagination");if(!t)return;const e=Math.ceil(this.state.totalResults/this.state.resultsPerPage);if(e<=1)return void(t.style.display="none");t.style.display="flex",t.style.justifyContent="center",t.style.gap="8px",t.style.padding="20px";let s="";s+=`\n            <button class="btn-secondary" ${1===this.state.currentPage?"disabled":""}\n                    onclick="searchViewInstance.goToPage(${this.state.currentPage-1})">\n                ‚Üê Previous\n            </button>\n        `;let n=Math.max(1,this.state.currentPage-Math.floor(3.5)),i=Math.min(e,n+7-1);i-n<6&&(n=Math.max(1,i-7+1)),n>1&&(s+='<button class="btn-secondary" onclick="searchViewInstance.goToPage(1)">1</button>',n>2&&(s+="<span>...</span>"));for(let t=n;t<=i;t++)s+=`\n                <button class="btn-${t===this.state.currentPage?"primary":"secondary"}"\n                        onclick="searchViewInstance.goToPage(${t})">\n                    ${t}\n                </button>\n            `;i<e&&(i<e-1&&(s+="<span>...</span>"),s+=`<button class="btn-secondary" onclick="searchViewInstance.goToPage(${e})">${e}</button>`),s+=`\n            <button class="btn-secondary" ${this.state.currentPage===e?"disabled":""}\n                    onclick="searchViewInstance.goToPage(${this.state.currentPage+1})">\n                Next ‚Üí\n            </button>\n        `,t.innerHTML=s}goToPage(t){const e=Math.ceil(this.state.totalResults/this.state.resultsPerPage);if(t<1||t>e)return;this.state.currentPage=t,this.renderResults();const s=document.querySelector(".search-results-main");s&&s.scrollIntoView({behavior:"smooth"})}sortResults(t){switch(this.state.sortBy){case"relevance":return t.sort((t,e)=>(e._searchScore||0)-(t._searchScore||0));case"name":return t.sort((t,e)=>(t.name||"").localeCompare(e.name||""));case"importance":return t.sort((t,e)=>(e.importance||50)-(t.importance||50));case"popularity":return t.sort((t,e)=>(e.popularity||50)-(t.popularity||50));default:return t}}showEmptyState(){const t=document.getElementById("results-container");if(!t)return;t.innerHTML=this.getEmptyStateHTML();const e=document.querySelector(".results-controls");e&&(e.style.display="none");const s=document.getElementById("pagination");s&&(s.style.display="none"),document.querySelectorAll(".example-query").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.dataset.query,s=document.getElementById("search-input");s&&(s.value=e,this.performSearch(e))})})}renderError(){const t=document.getElementById("results-container");t&&(t.innerHTML=`\n            <div class="search-error">\n                <div class="error-icon">‚ö†Ô∏è</div>\n                <h3>Search Error</h3>\n                <p>${this.escapeHtml(this.state.error)}</p>\n                <button class="btn-primary" onclick="searchViewInstance.performSearch('${this.escapeHtml(this.state.query)}')">\n                    Try Again\n                </button>\n            </div>\n        `)}loadSearchHistory(){try{const t=localStorage.getItem("searchHistory");return t?JSON.parse(t):[]}catch(t){return[]}}saveSearchHistory(){try{localStorage.setItem("searchHistory",JSON.stringify(this.searchHistory))}catch(t){}}addToSearchHistory(t,e){this.searchHistory=this.searchHistory.filter(e=>e.query!==t),this.searchHistory.unshift({query:t,resultCount:e,timestamp:Date.now()}),this.searchHistory.length>this.maxHistorySize&&(this.searchHistory=this.searchHistory.slice(0,this.maxHistorySize)),this.saveSearchHistory()}clearSearchHistory(){this.searchHistory=[],this.saveSearchHistory();const t=document.querySelector(".search-history");t&&t.remove()}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}highlightMatch(t,e){const s=t.toLowerCase().indexOf(e.toLowerCase());if(-1===s)return this.escapeHtml(t);const n=t.substring(0,s),i=t.substring(s,s+e.length),a=t.substring(s+e.length);return`${this.escapeHtml(n)}<strong>${this.escapeHtml(i)}</strong>${this.escapeHtml(a)}`}formatEntityType(t){return t.charAt(0).toUpperCase()+t.slice(1)}destroy(){window.searchViewInstance===this&&(window.searchViewInstance=null),this.autocompleteTimer&&(clearTimeout(this.autocompleteTimer),this.autocompleteTimer=null),this.isDestroyed=!0}}export{SearchViewComplete};"undefined"!=typeof window&&(window.SearchViewComplete=SearchViewComplete);let searchViewInstance=null;
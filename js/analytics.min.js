!function(){"use strict";window.AnalyticsManager=new class{constructor(){this.initialized=!1,this.analyticsEnabled=!0,this.debugMode=!1,this.sessionStartTime=Date.now(),this.pageLoadTime=null,this.performanceMetrics={},this.eventQueue=[],this.consentGiven=this.checkConsent(),this.debugMode="localhost"===window.location.hostname||window.location.search.includes("debug=true")}async initialize(){if(!this.initialized)try{if(!this.consentGiven)return void(this.analyticsEnabled=!1);await this.initializeGA4(),await this.initializeFirebaseAnalytics(),this.setupPerformanceMonitoring(),this.setupErrorTracking(),this.setupInteractionTracking(),this.trackPageLoad(),this.initialized=!0,this.processEventQueue()}catch(e){}}async initializeGA4(){"undefined"!=typeof gtag&&(gtag("config","G-ECC98XJ9W9",{send_page_view:!1,anonymize_ip:!0,cookie_flags:"SameSite=None;Secure"}),gtag("set","user_properties",{theme_preference:this.getThemePreference(),user_type:this.getUserType()}))}async initializeFirebaseAnalytics(){"undefined"!=typeof firebase&&firebase.analytics&&(this.firebaseAnalytics=firebase.analytics(),this.firebaseAnalytics.setUserProperties({theme_preference:this.getThemePreference(),user_type:this.getUserType()}))}setupPerformanceMonitoring(){window.performance&&window.performance.timing&&window.addEventListener("load",()=>{setTimeout(()=>{const e=window.performance.timing,t=e.loadEventEnd-e.navigationStart,i=e.domContentLoadedEventEnd-e.navigationStart,n=e.domainLookupEnd-e.domainLookupStart,a=e.connectEnd-e.connectStart;this.performanceMetrics={pageLoadTime:t,domReadyTime:i,dnsTime:n,tcpTime:a},this.trackPerformance("page_load",{page_load_time:t,dom_ready_time:i,dns_time:n,tcp_time:a})},0)}),this.setupFirebasePerformanceMonitoring()}setupFirebasePerformanceMonitoring(){if(window.db){const e=window.db.collection.prototype.get;window.db.collection.prototype.get=async function(...t){const i=performance.now();try{const n=await e.apply(this,t),a=performance.now()-i;return window.AnalyticsManager?.trackPerformance("firestore_read",{collection:this.path,duration:Math.round(a),success:!0}),n}catch(e){const t=performance.now()-i;throw window.AnalyticsManager?.trackPerformance("firestore_read",{collection:this.path,duration:Math.round(t),success:!1,error:e.message}),e}}}}setupErrorTracking(){window.addEventListener("error",e=>{this.trackError({type:"javascript_error",message:e.message,filename:e.filename,line:e.lineno,column:e.colno,stack:e.error?.stack})}),window.addEventListener("unhandledrejection",e=>{this.trackError({type:"unhandled_promise_rejection",message:e.reason?.message||e.reason,stack:e.reason?.stack})}),window.FirebaseService&&window.addEventListener("firebaseAuthStateChanged",e=>{e.detail.error&&this.trackError({type:"firebase_auth_error",message:e.detail.error.message,code:e.detail.error.code})})}setupInteractionTracking(){document.addEventListener("click",e=>{const t=e.target.closest("button, a.btn, .card, .deity-card");if(t){const e=t.textContent.trim()||t.getAttribute("aria-label")||t.id||t.className;this.trackInteraction("button_click",{label:e.substring(0,100),element_type:t.tagName.toLowerCase(),location:window.location.hash})}}),document.addEventListener("submit",e=>{const t=e.target,i=t.id||t.className;this.trackInteraction("form_submit",{form_id:i,location:window.location.hash})});const e=document.querySelector('#searchInput, [name="search"]');if(e){let t;e.addEventListener("input",e=>{clearTimeout(t),t=setTimeout(()=>{e.target.value.length>=3&&this.trackSearch(e.target.value)},1e3)})}this.setupScrollTracking(),this.setupTimeTracking()}setupScrollTracking(){let e=0;const t=[25,50,75,90,100],i=new Set;window.addEventListener("scroll",()=>{const n=document.documentElement.scrollHeight-window.innerHeight,a=window.scrollY/n*100;a>e&&(e=a,t.forEach(e=>{a>=e&&!i.has(e)&&(i.add(e),this.trackInteraction("scroll_depth",{depth:e,page:window.location.hash}))}))})}setupTimeTracking(){let e=0,t=!0,i=Date.now();const n=()=>{t||(t=!0,i=Date.now())};document.addEventListener("mousemove",n),document.addEventListener("keydown",n),document.addEventListener("scroll",n),document.addEventListener("click",n),setInterval(()=>{if(t){const t=Date.now();e+=t-i,i=t}},1e3),window.addEventListener("beforeunload",()=>{this.trackInteraction("time_on_page",{duration:Math.round(e/1e3),page:window.location.hash})}),setInterval(()=>{t&&Date.now()-i>3e4&&(t=!1)},5e3)}trackPageView(e,t){if(!this.analyticsEnabled)return;const i=e||window.location.hash||"/",n=t||document.title;"undefined"!=typeof gtag&&gtag("event","page_view",{page_path:i,page_title:n,page_location:window.location.href}),this.firebaseAnalytics&&this.firebaseAnalytics.logEvent("page_view",{page_path:i,page_title:n}),this.log("Page View",{path:i,title:n})}trackPageLoad(){this.trackPageView(),this.trackEvent("app_initialized",{load_time:Date.now()-this.sessionStartTime,user_agent:navigator.userAgent,screen_resolution:`${window.screen.width}x${window.screen.height}`,viewport_size:`${window.innerWidth}x${window.innerHeight}`})}trackEvent(e,t={}){if(!this.analyticsEnabled)return void this.eventQueue.push({eventName:e,eventParams:t});const i={...t,timestamp:(new Date).toISOString(),page:window.location.hash};"undefined"!=typeof gtag&&gtag("event",e,i),this.firebaseAnalytics&&this.firebaseAnalytics.logEvent(e,i),this.log("Event",e,i)}trackMythologyView(e,t,i){this.trackEvent("mythology_viewed",{mythology:e,entity_type:t,entity_id:i})}trackDeityView(e,t){this.trackEvent("deity_viewed",{mythology:e,deity_name:t})}trackEntityDetail(e,t,i){this.trackEvent("entity_detail_opened",{entity_type:e,entity_id:t,mythology:i})}trackSearch(e,t={},i=null){this.trackEvent("search",{search_term:e,filters:JSON.stringify(t),results_count:i})}trackSearchResult(e,t,i,n){this.trackEvent("search_result_clicked",{search_term:e,result_id:t,result_type:i,position:n})}trackComparison(e,t){this.trackEvent("mythology_comparison",{mythologies:e.join(","),entity_types:t.join(","),comparison_count:e.length})}trackComparisonView(e,t,i){this.trackEvent("comparison_viewed",{mythology_1:e,mythology_2:t,comparison_type:i})}trackTheorySubmission(e,t=null){this.trackEvent("theory_submitted",{theory_type:e,mythology:t})}trackEntitySubmission(e,t){this.trackEvent("entity_submitted",{entity_type:e,mythology:t})}trackContribution(e,t={}){this.trackEvent("user_contribution",{contribution_type:e,...t})}trackInteraction(e,t={}){this.trackEvent("user_interaction",{interaction_type:e,...t})}trackPerformance(e,t){this.trackEvent("performance_metric",{metric_name:e,...t})}trackError(e){this.trackEvent("error",{...e,user_agent:navigator.userAgent,url:window.location.href}),this.debugMode}trackConversion(e,t=null){const i={conversion_type:e};null!==t&&(i.value=t),this.trackEvent("conversion",i)}trackEngagement(e,t=null){const i={engagement_type:e};null!==t&&(i.engagement_time=t),this.trackEvent("user_engagement",i)}trackEntityView(e){this.analyticsEnabled&&(this.trackEvent("view_item",{item_id:e.id,item_name:e.name||e.title,item_category:e.collection||e.type,item_category2:e.mythology,content_type:"entity",entity_type:e.type,mythology:e.mythology}),this.log("Entity View",e.name||e.title))}trackNavigation(e,t){this.analyticsEnabled&&(this.trackEvent("navigation",{from_route:e||"initial",to_route:t,navigation_type:e?"route_change":"initial_load"}),this.log("Navigation",e,"â†’",t))}trackEntityComparison(e,t=[]){this.analyticsEnabled&&(this.trackEvent("compare_entities",{entity_count:e.length,entity_ids:e.join(","),entity_types:t.join(",")}),this.log("Comparison",e.length,"entities"))}trackContributionAction(e,t,i=null){this.analyticsEnabled&&(this.trackEvent("contribution_action",{action:e,collection:t,entity_id:i}),this.log("Contribution Action",e,t,i))}trackTiming(e,t,i,n=""){this.analyticsEnabled&&(gtag("event","timing_complete",{name:t,value:Math.round(i),event_category:e,event_label:n}),this.log("Timing",e,t,Math.round(i)+"ms"))}trackCustomError(e,t={}){this.analyticsEnabled&&(this.trackEvent("exception",{description:e.message||e,fatal:t.fatal||!1,context:JSON.stringify(t),stack:e.stack}),this.log("Error Tracked",e.message||e))}setUserProperty(e,t){this.analyticsEnabled&&("undefined"!=typeof gtag&&gtag("set","user_properties",{[e]:t}),this.firebaseAnalytics&&this.firebaseAnalytics.setUserProperties({[e]:t}),this.log("User Property Set",e,t))}setUserId(e){this.analyticsEnabled&&("undefined"!=typeof gtag&&gtag("config","G-ECC98XJ9W9",{user_id:e}),this.firebaseAnalytics&&this.firebaseAnalytics.setUserId(e),this.log("User ID Set",e))}checkConsent(){const e=localStorage.getItem("analytics_consent");return null===e||"true"===e}setConsent(e){localStorage.setItem("analytics_consent",e.toString()),this.consentGiven=e,this.analyticsEnabled=e,e&&!this.initialized&&this.initialize(),this.log("Consent updated",e)}optOut(){this.setConsent(!1),window["ga-disable-G-ECC98XJ9W9"]=!0}processEventQueue(){this.eventQueue.length>0&&(this.eventQueue.forEach(({eventName:e,eventParams:t})=>{this.trackEvent(e,t)}),this.eventQueue=[])}getThemePreference(){return localStorage.getItem("theme")||"dark"}getUserType(){return window.FirebaseService?.isAuthenticated()?"authenticated":"anonymous"}log(...e){this.debugMode}getSummary(){return{initialized:this.initialized,analyticsEnabled:this.analyticsEnabled,consentGiven:this.consentGiven,debugMode:this.debugMode,sessionDuration:Date.now()-this.sessionStartTime,performanceMetrics:this.performanceMetrics,queuedEvents:this.eventQueue.length}}},window.FirebaseService?window.AnalyticsManager.initialize():window.addEventListener("load",()=>{setTimeout(()=>{window.AnalyticsManager.initialize()},1e3)}),window.trackEvent=(e,t)=>window.AnalyticsManager.trackEvent(e,t),window.trackPageView=(e,t)=>window.AnalyticsManager.trackPageView(e,t),window.trackSearch=(e,t,i)=>window.AnalyticsManager.trackSearch(e,t,i),window.trackMythologyView=(e,t,i)=>window.AnalyticsManager.trackMythologyView(e,t,i)}();
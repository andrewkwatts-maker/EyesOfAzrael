class FirebaseAuth{constructor(){this.currentUser=null,this.auth=null,this.db=null,this.unsubscribeAuth=null,this.authStateChangeCallbacks=[]}async init(){if("undefined"!=typeof firebase)try{this.auth=firebase.auth(),this.db=firebase.firestore(),await this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL),this.unsubscribeAuth=this.auth.onAuthStateChanged(async e=>{e?await this.handleUserSignedIn(e):this.handleUserSignedOut()})}catch(e){}}async handleUserSignedIn(e){try{this.currentUser={uid:e.uid,email:e.email,displayName:e.displayName,photoURL:e.photoURL,emailVerified:e.emailVerified},await this.createOrUpdateUserProfile(e),this.updateUIForLoggedInUser(),this.notifyAuthStateChange(this.currentUser),window.dispatchEvent(new CustomEvent("userLogin",{detail:this.currentUser}))}catch(e){}}handleUserSignedOut(){this.currentUser=null,this.updateUIForLoggedOutUser(),this.notifyAuthStateChange(null),window.dispatchEvent(new CustomEvent("userLogout"))}async createOrUpdateUserProfile(e){try{const t=this.db.collection("users").doc(e.uid),s=await t.get(),a={email:e.email,displayName:e.displayName,photoURL:e.photoURL,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};s.exists?await t.update(a):(a.createdAt=firebase.firestore.FieldValue.serverTimestamp(),a.bio="",a.theories=[],a.votes={},await t.set(a))}catch(e){throw e}}async signInWithGoogle(){try{const e=new firebase.auth.GoogleAuthProvider;return e.addScope("profile"),e.addScope("email"),{success:!0,user:(await this.auth.signInWithPopup(e)).user}}catch(e){let t="Failed to sign in with Google";return"auth/popup-closed-by-user"===e.code?t="Sign-in cancelled. Please try again.":"auth/popup-blocked"===e.code?t="Pop-up blocked. Please allow pop-ups for this site.":"auth/network-request-failed"===e.code?t="Network error. Please check your connection.":"auth/cancelled-popup-request"===e.code?t="Sign-in cancelled.":e.message&&(t=e.message),{success:!1,error:t}}}async signOut(){try{return await this.auth.signOut(),{success:!0,message:"Signed out successfully"}}catch(e){return{success:!1,error:"Failed to sign out"}}}isLoggedIn(){return null!==this.currentUser}getCurrentUser(){return this.currentUser}async getUserProfile(e){try{const t=await this.db.collection("users").doc(e).get();return t.exists?t.data():null}catch(e){return null}}async updateProfile(e){if(!this.isLoggedIn())return{success:!1,error:"Not logged in"};try{const t=this.db.collection("users").doc(this.currentUser.uid),s={};return"bio"in e&&(s.bio=e.bio),"displayName"in e&&(s.displayName=e.displayName),s.updatedAt=firebase.firestore.FieldValue.serverTimestamp(),await t.update(s),"displayName"in s&&(this.currentUser.displayName=s.displayName),{success:!0,message:"Profile updated successfully"}}catch(e){return{success:!1,error:"Failed to update profile"}}}onAuthStateChanged(e){return this.authStateChangeCallbacks.push(e),this.currentUser&&e(this.currentUser),()=>{const t=this.authStateChangeCallbacks.indexOf(e);t>-1&&this.authStateChangeCallbacks.splice(t,1)}}notifyAuthStateChange(e){this.authStateChangeCallbacks.forEach(t=>{try{t(e)}catch(e){}})}updateUIForLoggedInUser(){document.querySelectorAll('[data-auth-show="loggedOut"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-auth-show="loggedIn"]').forEach(e=>{e.style.display=""}),document.querySelectorAll("[data-auth-username]").forEach(e=>{e.textContent=this.currentUser.displayName||this.currentUser.email}),document.querySelectorAll("[data-auth-avatar]").forEach(e=>{e.src=this.currentUser.photoURL||this.generateAvatar(this.currentUser.email)}),document.querySelectorAll("[data-auth-email]").forEach(e=>{e.textContent=this.currentUser.email})}updateUIForLoggedOutUser(){document.querySelectorAll('[data-auth-show="loggedIn"]').forEach(e=>{e.style.display="none"}),document.querySelectorAll('[data-auth-show="loggedOut"]').forEach(e=>{e.style.display=""})}generateAvatar(e){return`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(e)}`}showLoginModal(){const e=document.getElementById("auth-modal");e&&(e.style.display="flex")}hideAuthModal(){const e=document.getElementById("auth-modal");e&&(e.style.display="none",this.clearAuthMessages())}showAuthMessage(e,t="error"){const s=document.getElementById("auth-message");s&&(s.textContent=e,s.className=`auth-message auth-message-${t}`,s.style.display="block")}clearAuthMessages(){const e=document.getElementById("auth-message");e&&(e.style.display="none")}destroy(){this.unsubscribeAuth&&this.unsubscribeAuth(),this.authStateChangeCallbacks=[]}}window.firebaseAuth=new FirebaseAuth,window.userAuth={isLoggedIn:()=>window.firebaseAuth.isLoggedIn(),getCurrentUser:()=>window.firebaseAuth.getCurrentUser(),login:()=>window.firebaseAuth.signInWithGoogle(),logout:()=>window.firebaseAuth.signOut(),showLoginModal:()=>window.firebaseAuth.showLoginModal(),showSignupModal:()=>window.firebaseAuth.showLoginModal(),hideAuthModal:()=>window.firebaseAuth.hideAuthModal(),showAuthMessage:(e,t)=>window.firebaseAuth.showAuthMessage(e,t),clearAuthMessages:()=>window.firebaseAuth.clearAuthMessages(),updateProfile:(e,t)=>window.firebaseAuth.updateProfile({bio:e}),switchAuthMode:()=>{},onAuthStateChanged:e=>window.firebaseAuth.onAuthStateChanged(e)},"undefined"!=typeof firebase&&firebase.apps.length>0?window.firebaseAuth.init():document.addEventListener("DOMContentLoaded",()=>{"undefined"!=typeof firebase&&firebase.apps.length>0&&window.firebaseAuth.init()}),"undefined"!=typeof module&&module.exports&&(module.exports=FirebaseAuth);
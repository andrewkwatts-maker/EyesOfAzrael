!function(t){"use strict";class e{constructor(){this.context=null,this.pageTaxonomy=null,this.initialized=!1}async initialize(){return this.initialized||(await this.loadPageTaxonomy(),this.context=this.detectContext(),this.initialized=!0),this.context}async loadPageTaxonomy(){try{if(t.pageTaxonomy)return void(this.pageTaxonomy=t.pageTaxonomy);const e=await fetch("/data/page-taxonomy.json");e.ok?(this.pageTaxonomy=await e.json(),t.pageTaxonomy=this.pageTaxonomy):this.pageTaxonomy={}}catch(t){this.pageTaxonomy={}}}detectContext(){const t=this.detectFromURL(),e=this.detectFromBreadcrumbs(),o={...this.detectFromPageMetadata(),...e,...t};return o.suggestedType=this.inferContributionType(o),o.locks=this.determineLocks(o),o}detectFromURL(){const e={mythology:null,section:null,topic:null,isDetailPage:!1,isIndexPage:!1,isMythologyHome:!1},o=t.location.pathname.replace(/^\/|\/$/g,"").split("/"),i=o.indexOf("mythos");if(-1===i)return e;if(o.length>i+1){const t=o[i+1];e.mythology=this.normalizeMythologyName(t),e.mythologySlug=t}if(o.length>i+2){const t=o[i+2];"index.html"===t?e.isMythologyHome=!0:(e.section=this.normalizeSectionName(t),e.sectionSlug=t)}if(o.length>i+3){const t=o[i+3];if(t&&"index.html"!==t){const o=t.replace(".html","");e.topic=this.normalizeTopicName(o),e.topicSlug=o,e.isDetailPage=!0}else"index.html"===t&&(e.isIndexPage=!0)}if(this.pageTaxonomy&&e.mythologySlug){const t=this.pageTaxonomy[e.mythologySlug];if(t&&(e.mythologyFull=t.name,e.mythologyPath=t.path,e.sectionSlug&&t.sections)){const o=t.sections[e.sectionSlug];if(o&&(e.sectionFull=o.name,e.sectionPath=o.path,e.topicSlug&&o.topics)){const t=o.topics[e.topicSlug];t&&(e.topicFull=t.name,e.topicPath=t.path)}}}return e}detectFromBreadcrumbs(){const t={mythology:null,section:null,topic:null},e=document.querySelector('.breadcrumb, nav[aria-label="Breadcrumb"]');if(!e)return t;const o=e.querySelectorAll("a"),i=e.querySelectorAll("span");if(o.length>=1){if(o[1]){const e=o[1].textContent.trim();t.mythology||(t.mythology=e)}if(o[2]){const e=o[2].textContent.trim();t.section||(t.section=e)}}if(i.length>0&&!t.topic){const e=i[i.length-1].textContent.trim();e&&"Home"!==e&&e!==t.section&&e!==t.mythology&&(t.topic=e)}return t}detectFromPageMetadata(){const t={mythology:null,section:null,topic:null,pageTitle:null},e=document.body;e&&(e.dataset.mythology&&(t.mythology=e.dataset.mythology),e.dataset.section&&(t.section=e.dataset.section),e.dataset.topic&&(t.topic=e.dataset.topic));const o=document.querySelector('meta[name="mythology"]');o&&!t.mythology&&(t.mythology=o.content);const i=document.querySelector('meta[name="section"]');i&&!t.section&&(t.section=i.content);const n=document.title;if(n){t.pageTitle=n;const e=n.split("-").map(t=>t.trim());if(e.length>=2&&!t.mythology){const o=e[e.length-1];this.isMythologyName(o)&&(t.mythology=o)}}return t}inferContributionType(t){if(!t.section)return null;const e=t.section.toLowerCase(),o={deities:"deity",gods:"deity",goddesses:"deity",pantheon:"deity",heroes:"hero",figures:"hero",prophets:"hero",saints:"hero",disciples:"hero",creatures:"creature",beings:"creature",angels:"creature",demons:"creature",spirits:"creature",monsters:"creature",places:"place",locations:"place",realms:"place",geography:"place",temples:"place",mountains:"place",items:"item",artifacts:"item",relics:"item",tools:"item",weapons:"item",herbs:"herb",plants:"herb","sacred plants":"herb",botanicals:"herb",texts:"text",scriptures:"text",books:"text",writings:"text",concepts:"concept",teachings:"concept",theology:"concept",philosophy:"concept",cosmology:"concept",eschatology:"concept"};for(const[t,i]of Object.entries(o))if(e.includes(t))return i;return"theory"}determineLocks(t){const e={};return t.mythology&&"Home"!==t.mythology&&(e.mythology={locked:!0,value:t.mythologySlug||t.mythology,reason:`Auto-filled from current page (${t.mythology})`}),t.section&&!t.isDetailPage&&(e.section={locked:!0,value:t.sectionSlug||t.section,reason:`Auto-filled from current section (${t.section})`}),t.isDetailPage&&t.topic&&(e.topic={locked:!1,value:t.topicSlug||t.topic,reason:`Suggested from current page (${t.topic})`},t.section&&(e.section={locked:!0,value:t.sectionSlug||t.section,reason:"Auto-filled from current page context"})),e}async getCurrentContext(){return this.initialized||await this.initialize(),this.context}async getSubmissionUrl(t="/theories/user-submissions/submit.html"){this.initialized||await this.initialize();const e=new URLSearchParams;this.context.mythologySlug?e.append("context",this.context.mythologySlug):this.context.mythology&&e.append("context",this.slugify(this.context.mythology)),this.context.sectionSlug?e.append("section",this.context.sectionSlug):this.context.section&&e.append("section",this.slugify(this.context.section)),this.context.topicSlug?e.append("topic",this.context.topicSlug):this.context.topic&&e.append("topic",this.slugify(this.context.topic)),this.context.suggestedType&&e.append("type",this.context.suggestedType);const o=e.toString();return o?`${t}?${o}`:t}async isContextLocked(t){this.initialized||await this.initialize();const e=this.normalizeFieldName(t);return this.context.locks[e]||null}async getLockedFields(){return this.initialized||await this.initialize(),this.context.locks||{}}async applyContextToForm(t){if(this.initialized||await this.initialize(),this.context.locks.mythology){const e=t.querySelector('#taxonomy-page, [name="page"]');e&&(e.value=this.context.locks.mythology.value,this.context.locks.mythology.locked&&(e.disabled=!0,e.setAttribute("data-context-locked","true"),e.setAttribute("title",this.context.locks.mythology.reason)),e.dispatchEvent(new Event("change",{bubbles:!0})))}if(this.context.locks.section){const e=t.querySelector('#taxonomy-section, [name="section"]');e&&setTimeout(()=>{e.value=this.context.locks.section.value,this.context.locks.section.locked&&(e.disabled=!0,e.setAttribute("data-context-locked","true"),e.setAttribute("title",this.context.locks.section.reason)),e.dispatchEvent(new Event("change",{bubbles:!0}))},100)}if(this.context.locks.topic){const e=t.querySelector('#taxonomy-topic, [name="topic"]');e&&setTimeout(()=>{e.value=this.context.locks.topic.value,e.setAttribute("title",this.context.locks.topic.reason),e.style.borderColor="var(--color-accent)"},200)}if(this.context.suggestedType){const e=t.querySelector('#contribution-type, [name="contributionType"]');e&&(e.value=this.context.suggestedType,e.setAttribute("title",`Suggested based on current section (${this.context.section})`),e.dispatchEvent(new Event("change",{bubbles:!0})))}this.addContextIndicator(t)}addContextIndicator(t){if(t.querySelector(".context-indicator"))return;if(!(this.context.mythology||this.context.section||this.context.topic))return;const e=document.createElement("div");e.className="context-indicator",e.style.cssText="\n                background: rgba(var(--color-accent-rgb, 139, 127, 255), 0.1);\n                border-left: 4px solid var(--color-accent);\n                padding: var(--spacing-md);\n                margin-bottom: var(--spacing-lg);\n                border-radius: var(--radius-md);\n                font-size: var(--font-size-sm);\n            ";let o=[];this.context.mythology&&o.push(`<strong>Mythology:</strong> ${this.context.mythology}`),this.context.section&&o.push(`<strong>Section:</strong> ${this.context.section}`),this.context.topic&&o.push(`<strong>Topic:</strong> ${this.context.topic}`),e.innerHTML=`\n                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">\n                    <span style="font-size: 1.2rem;">üìç</span>\n                    <div>\n                        <div style="font-weight: var(--font-semibold); margin-bottom: var(--spacing-xs);">\n                            Context Detected\n                        </div>\n                        <div style="opacity: 0.9;">\n                            ${o.join(" ‚Ä¢ ")}\n                        </div>\n                    </div>\n                </div>\n            `,t.insertBefore(e,t.firstChild)}normalizeFieldName(t){return{page:"mythology","taxonomy-page":"mythology","taxonomy-section":"section","taxonomy-topic":"topic"}[t]||t}normalizeMythologyName(t){return{greek:"Greek",norse:"Norse",egyptian:"Egyptian",roman:"Roman",celtic:"Celtic",hindu:"Hindu",buddhist:"Buddhist",chinese:"Chinese",japanese:"Japanese",jewish:"Jewish",christian:"Christian",islamic:"Islamic",aztec:"Aztec",mayan:"Mayan",babylonian:"Babylonian",mesopotamian:"Mesopotamian",apocryphal:"Apocryphal",gnostic:"Gnostic"}[t.toLowerCase()]||this.capitalize(t)}normalizeSectionName(t){return this.capitalize(t.replace(/-/g," "))}normalizeTopicName(t){return this.capitalize(t.replace(/-/g," "))}isMythologyName(t){const e=t.toLowerCase();return["greek","norse","egyptian","roman","celtic","hindu","buddhist","chinese","japanese","jewish","christian","islamic","aztec","mayan","babylonian","mesopotamian","apocryphal","gnostic","mythology","mythos"].some(t=>e.includes(t))}slugify(t){return t.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}capitalize(t){return t.split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}}t.SubmissionContext=e,t.submissionContext=new e,t.SubmissionContext.detect=function(){return t.submissionContext.initialized?t.submissionContext.context:null},t.SubmissionContext.getLink=async function(){return await t.submissionContext.getSubmissionUrl()},t.SubmissionContext.getTitle=function(){const e=t.submissionContext.context;if(!e)return"Share Your Theory";const o=[];return e.topic&&o.push(e.topic),e.section&&o.push(e.section),e.mythology&&o.push(e.mythology),o.length>0?o.join(" - "):"Share Your Theory"},t.SubmissionContext.buildURL=function(t){const e=new URLSearchParams;t.tradition&&e.set("context",t.tradition),t.category&&e.set("section",t.category),t.entity&&e.set("topic",t.entity);const o="/theories/user-submissions/submit.html",i=e.toString();return i?`${o}?${i}`:o}}(window);
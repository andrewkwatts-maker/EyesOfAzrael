let isAuthenticated=!1,currentUser=null;const perfMarks={scriptStart:performance.now(),overlayVisible:null,firebaseReady:null,authResolved:null},STORAGE_KEYS={LAST_USER_EMAIL:"eoa_last_user_email",LAST_USER_NAME:"eoa_last_user_name",LAST_USER_PHOTO:"eoa_last_user_photo",AUTH_CACHED:"eoa_auth_cached",AUTH_TIMESTAMP:"eoa_auth_timestamp"},AUTH_CACHE_DURATION=3e5;function instantDisplay(){const e=getCachedAuthState();e.isValid&&e.wasAuthenticated?(document.body.classList.add("auth-loading"),showLoadingScreen()):(document.body.classList.add("not-authenticated"),showAuthOverlay(),prefillLastUserEmail()),perfMarks.overlayVisible=performance.now()}export function setupAuthGuard(){if("undefined"==typeof firebase)return void handleNotAuthenticated();0===firebase.apps.length&&"undefined"!=typeof firebaseConfig&&firebase.initializeApp(firebaseConfig);const e=firebase.auth();e.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(()=>{perfMarks.firebaseReady=performance.now()}).catch(e=>{}),e.onAuthStateChanged(e=>{perfMarks.authResolved=performance.now(),document.body.classList.remove("auth-loading"),e?(handleAuthenticated(e),cacheAuthState(!0,e)):(handleNotAuthenticated(),cacheAuthState(!1,null))}),setupLoginHandlers(),setupLogoutHandler()}function getCachedAuthState(){try{const e=localStorage.getItem(STORAGE_KEYS.AUTH_CACHED),t=localStorage.getItem(STORAGE_KEYS.AUTH_TIMESTAMP);if(!e||!t)return{isValid:!1,wasAuthenticated:!1};const n=Date.now()-parseInt(t,10);return{isValid:n<3e5,wasAuthenticated:"true"===e,age:n}}catch(e){return{isValid:!1,wasAuthenticated:!1}}}function cacheAuthState(e,t){try{localStorage.setItem(STORAGE_KEYS.AUTH_CACHED,e.toString()),localStorage.setItem(STORAGE_KEYS.AUTH_TIMESTAMP,Date.now().toString()),t&&(t.email&&localStorage.setItem(STORAGE_KEYS.LAST_USER_EMAIL,t.email),t.displayName&&localStorage.setItem(STORAGE_KEYS.LAST_USER_NAME,t.displayName),t.photoURL&&localStorage.setItem(STORAGE_KEYS.LAST_USER_PHOTO,t.photoURL))}catch(e){}}function prefillLastUserEmail(){try{const e=localStorage.getItem(STORAGE_KEYS.LAST_USER_EMAIL),t=localStorage.getItem(STORAGE_KEYS.LAST_USER_NAME);if(e||t){const n=document.querySelector(".auth-card");if(n&&(e||t)){const a=document.createElement("div");a.className="welcome-back-msg",a.innerHTML=`\n                    <p class="welcome-text">Welcome back${t?", "+t:""}!</p>\n                    ${e?`<p class="last-email">${e}</p>`:""}\n                `;const o=n.querySelector(".google-login-btn");o&&n.insertBefore(a,o)}}}catch(e){}}function showLoadingScreen(){document.getElementById("auth-loading-screen")||injectLoadingScreen();const e=document.getElementById("auth-loading-screen");e&&(e.style.display="flex")}function showAuthOverlay(){document.getElementById("auth-overlay")||injectAuthOverlay();const e=document.getElementById("auth-overlay");e&&(e.style.display="flex")}function setupLoginHandlers(){const e=document.getElementById("google-login-btn-overlay");e&&e.addEventListener("click",handleLogin)}function setupLogoutHandler(){const e=document.getElementById("signOutBtn");e&&e.addEventListener("click",handleLogout)}function handleAuthenticated(e){isAuthenticated=!0,currentUser=e,document.body.classList.remove("not-authenticated","auth-loading"),document.body.classList.add("authenticated");const t=document.getElementById("auth-overlay");t&&(t.style.opacity="0",t.style.transition="opacity 0.3s ease",setTimeout(()=>{t.style.display="none"},300));const n=document.getElementById("auth-loading-screen");n&&(n.style.opacity="0",n.style.transition="opacity 0.3s ease",setTimeout(()=>{n.style.display="none"},300));const a=document.getElementById("main-content");if(a){a.style.display="block",a.style.opacity="0",a.style.transition="opacity 0.3s ease",setTimeout(()=>{a.style.opacity="1"},50);const e=a.querySelector(".loading-container");e&&(e.style.display="none")}updateUserDisplay(e),document.dispatchEvent(new CustomEvent("auth-ready",{detail:{user:e,authenticated:!0}}))}function handleNotAuthenticated(){isAuthenticated=!1,currentUser=null,document.body.classList.add("not-authenticated"),document.body.classList.remove("authenticated","auth-loading");const e=document.getElementById("auth-overlay");e&&(e.style.display="flex",e.style.opacity="1",prefillLastUserEmail());const t=document.getElementById("auth-loading-screen");t&&(t.style.display="none");const n=document.getElementById("main-content");n&&(n.style.display="none"),updateUserDisplay(null),document.dispatchEvent(new CustomEvent("auth-ready",{detail:{user:null,authenticated:!1}}))}async function handleLogin(){const e=document.getElementById("google-login-btn-overlay");e&&(e.disabled=!0,e.textContent="Signing in...");try{const e=firebase.auth(),t=new firebase.auth.GoogleAuthProvider;t.addScope("profile"),t.addScope("email");const n=await e.signInWithPopup(t);n.user&&cacheAuthState(!0,n.user)}catch(t){alert("Login failed: "+t.message),e&&(e.disabled=!1,e.innerHTML='\n                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" style="width: 20px; height: 20px; margin-right: 12px;">\n                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>\n                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>\n                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>\n                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.30-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>\n                </svg>\n                Sign in with Google\n            ')}}async function handleLogout(){try{const e=firebase.auth();await e.signOut(),cacheAuthState(!1,null)}catch(e){}}function updateUserDisplay(e){const t=document.getElementById("userInfo"),n=document.getElementById("userName"),a=document.getElementById("userAvatar");e&&t?(t.style.display="flex",n&&(n.textContent=e.displayName||e.email),a&&e.photoURL&&(a.src=e.photoURL,a.alt=e.displayName||"User")):t&&(t.style.display="none")}function injectLoadingScreen(){const e=document.createElement("div");e.id="auth-loading-screen",e.className="auth-loading-screen",e.innerHTML='\n        <div class="auth-spinner"></div>\n        <p class="loading-text">Loading Eyes of Azrael...</p>\n    ',document.body.insertBefore(e,document.body.firstChild)}function injectAuthOverlay(){const e=document.createElement("div");e.id="auth-overlay",e.className="auth-overlay",e.innerHTML='\n        <div class="auth-card">\n            <div class="auth-logo">üëÅÔ∏è</div>\n\n            <h1 class="auth-title">Eyes of Azrael</h1>\n            <p class="auth-subtitle">Explore World Mythologies</p>\n\n            <p class="auth-description">\n                Discover deities, heroes, creatures, and sacred texts from cultures across the globe\n            </p>\n\n            <button id="google-login-btn-overlay" class="google-login-btn">\n                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" style="width: 20px; height: 20px; margin-right: 12px;">\n                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>\n                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>\n                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>\n                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.30-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>\n                </svg>\n                Sign in with Google\n            </button>\n\n            <div class="auth-tos">\n                <p class="tos-notice">By logging in, you agree to the <a href="/terms.html" target="_blank">Terms of Service</a></p>\n                <p class="tos-summary">All content is protected. Redistribution prohibited.</p>\n            </div>\n\n            <footer class="auth-footer">\n                <p>Copyright ¬© Eyes of Azrael 2025</p>\n            </footer>\n        </div>\n    ',document.body.insertBefore(e,document.body.firstChild)}export function isUserAuthenticated(){return isAuthenticated}export function getCurrentUser(){return currentUser}export function getPerformanceMetrics(){return{displayTime:perfMarks.overlayVisible-perfMarks.scriptStart,firebaseReadyTime:perfMarks.firebaseReady-perfMarks.scriptStart,totalAuthTime:perfMarks.authResolved-perfMarks.scriptStart,marks:perfMarks}}instantDisplay(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",setupAuthGuard):setupAuthGuard();
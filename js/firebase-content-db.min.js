class FirebaseContentDB{constructor(){this.db=null,this.initialized=!1,this.cache=new Map,this.contentTypes={deity:"deity",hero:"hero",creature:"creature",place:"place",concept:"concept",ritual:"ritual",magic:"magic",herb:"herb",symbol:"symbol",text:"text",archetype:"archetype",cosmology:"cosmology",lineage:"lineage",event:"event"}}async init(){if(!this.initialized)try{if(!firebase||!firebase.firestore)throw new Error("Firebase not initialized. Make sure firebase-init.js is loaded first.");this.db=firebase.firestore();try{await this.db.enablePersistence({synchronizeTabs:!0})}catch(t){"failed-precondition"===t.code||t.code}this.initialized=!0}catch(t){throw t}}generateContentId(t,e=!1){const a=this.slugify(t.title);if(e)return`default_${t.mythology}_${t.contentType}_${a}`;{const e=firebase.auth().currentUser?.uid||"anonymous",s=Date.now();return`user_${e}_${t.contentType}_${s}_${a.substring(0,20)}`}}slugify(t){return t.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}validateContentType(t){if(!this.contentTypes[t])throw new Error(`Invalid content type: ${t}. Must be one of: ${Object.keys(this.contentTypes).join(", ")}`);return!0}validateBaseContent(t){const e=[];(!t.title||t.title.trim().length<1)&&e.push("Title is required and must not be empty"),t.title&&t.title.length>200&&e.push("Title must be 200 characters or less"),t.contentType||e.push("Content type is required"),t.mythology||e.push("Mythology is required"),t.section||e.push("Section is required"),(!t.summary||t.summary.trim().length<10)&&e.push("Summary is required and must be at least 10 characters");try{this.validateContentType(t.contentType)}catch(t){e.push(t.message)}return e}validateDeityAttributes(t){const e=[];return t?(["titles","domains","symbols","sacredAnimals","sacredPlants"].forEach(a=>{t[a]&&!Array.isArray(t[a])&&e.push(`${a} must be an array`)}),e):(e.push("Deity attributes are required"),e)}validateHeroAttributes(t){const e=[];return t?(["parentage","notableDeeds","weapons","companions"].forEach(a=>{t[a]&&!Array.isArray(t[a])&&e.push(`${a} must be an array`)}),e):(e.push("Hero attributes are required"),e)}validateCreatureAttributes(t){const e=[];return t?(["abilities","weaknesses"].forEach(a=>{t[a]&&!Array.isArray(t[a])&&e.push(`${a} must be an array`)}),e):(e.push("Creature attributes are required"),e)}async createContent(t,e={}){await this.init();const a=e.isDefault||!1,s=firebase.auth().currentUser;if(!a&&!s)throw new Error("User must be authenticated to create user-submitted content");const i=this.validateBaseContent(t);if(i.length>0)throw new Error(`Validation failed: ${i.join(", ")}`);if(t.attributes){let e=[];switch(t.contentType){case"deity":e=this.validateDeityAttributes(t.attributes);break;case"hero":e=this.validateHeroAttributes(t.attributes);break;case"creature":e=this.validateCreatureAttributes(t.attributes)}if(e.length>0)throw new Error(`Attribute validation failed: ${e.join(", ")}`)}const r=e.contentId||this.generateContentId(t,a),o=firebase.firestore.FieldValue.serverTimestamp(),n={id:r,contentType:t.contentType,title:t.title.trim(),subtitle:t.subtitle?.trim()||"",summary:t.summary.trim(),richContent:t.richContent||{panels:[]},mythology:t.mythology,mythologyName:t.mythologyName||this.getMythologyDisplayName(t.mythology),section:t.section,sectionName:t.sectionName||this.getSectionDisplayName(t.section),tags:t.tags||[],relatedContent:t.relatedContent||[],relatedMythologies:t.relatedMythologies||[],icon:t.icon||"",imageUrl:t.imageUrl||null,imageUrls:t.imageUrls||[],attributes:t.attributes||{},...t.pantheon&&{pantheon:t.pantheon},...t.role&&{role:t.role},...t.alignment&&{alignment:t.alignment},...t.heroType&&{heroType:t.heroType},...t.creatureType&&{creatureType:t.creatureType},isDefault:a,sources:t.sources||"",createdAt:o,updatedAt:o};!a&&s?(n.authorId=s.uid,n.authorName=s.displayName||s.email,n.authorAvatar=s.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.displayName||s.email)}&background=9333ea&color=fff`):(n.authorId=null,n.authorName=null,n.authorAvatar=null),n.status=t.status||(a?"published":"draft"),n.visibility=t.visibility||"public",n.views=0,n.votes=0,n.commentsCount=0;try{await this.db.collection("content").doc(r).set(n);const t={...n,createdAt:new Date,updatedAt:new Date};return this.cache.set(r,t),{success:!0,contentId:r,content:t}}catch(t){throw t}}async batchCreateContent(t,e={}){await this.init();const a={successful:[],failed:[],total:t.length},s=[];for(let i=0;i<t.length;i+=500){const r=this.db.batch(),o=t.slice(i,i+500);for(const t of o)try{const s=this.validateBaseContent(t);if(s.length>0){a.failed.push({content:t,error:`Validation failed: ${s.join(", ")}`});continue}const i=this.generateContentId(t,e.isDefault||!1),o=firebase.firestore.Timestamp.now(),n={id:i,contentType:t.contentType,title:t.title.trim(),subtitle:t.subtitle?.trim()||"",summary:t.summary.trim(),richContent:t.richContent||{panels:[]},mythology:t.mythology,mythologyName:t.mythologyName||this.getMythologyDisplayName(t.mythology),section:t.section,sectionName:t.sectionName||this.getSectionDisplayName(t.section),tags:t.tags||[],relatedContent:t.relatedContent||[],relatedMythologies:t.relatedMythologies||[],icon:t.icon||"",imageUrl:t.imageUrl||null,imageUrls:t.imageUrls||[],attributes:t.attributes||{},isDefault:e.isDefault||!1,sources:t.sources||"",authorId:null,authorName:null,authorAvatar:null,status:t.status||"published",visibility:t.visibility||"public",views:0,votes:0,commentsCount:0,createdAt:o,updatedAt:o};t.pantheon&&(n.pantheon=t.pantheon),t.role&&(n.role=t.role),t.alignment&&(n.alignment=t.alignment);const c=this.db.collection("content").doc(i);r.set(c,n),a.successful.push({contentId:i,title:n.title})}catch(e){a.failed.push({content:t,error:e.message})}s.push(r)}for(let t=0;t<s.length;t++)try{await s[t].commit()}catch(t){throw t}return a}async getContent(t,e=!0){if(await this.init(),e&&this.cache.has(t))return this.cache.get(t);try{const e=await this.db.collection("content").doc(t).get();if(!e.exists)return null;const a=this.convertTimestamps(e.data());return this.cache.set(t,a),a}catch(t){throw t}}async queryContent(t={}){await this.init();try{let e=this.db.collection("content");switch(void 0!==t.isDefault&&(e=e.where("isDefault","==",t.isDefault)),t.contentType&&(e=e.where("contentType","==",t.contentType)),t.mythology&&(e=e.where("mythology","==",t.mythology)),t.section&&(e=e.where("section","==",t.section)),e=t.status?e.where("status","==",t.status):e.where("status","==","published"),t.sortBy||"newest"){case"newest":e=e.orderBy("createdAt","desc");break;case"oldest":e=e.orderBy("createdAt","asc");break;case"popular":e=e.orderBy("votes","desc");break;case"views":e=e.orderBy("views","desc");break;case"alphabetical":e=e.orderBy("title","asc")}const a=t.limit||50;e=e.limit(a),t.startAfter&&(e=e.startAfter(t.startAfter));const s=await e.get();return{content:s.docs.map(t=>this.convertTimestamps(t.data())),lastDoc:s.docs[s.docs.length-1],hasMore:s.docs.length===a}}catch(t){throw t}}getMythologyDisplayName(t){return{greek:"Greek Mythology",roman:"Roman Mythology",norse:"Norse Mythology",egyptian:"Egyptian Mythology",hindu:"Hindu Mythology",chinese:"Chinese Mythology",japanese:"Japanese Mythology",celtic:"Celtic Mythology",slavic:"Slavic Mythology",aztec:"Aztec Mythology",mayan:"Mayan Mythology",sumerian:"Sumerian Mythology",christian:"Christian Tradition",jewish:"Jewish Tradition",islamic:"Islamic Tradition",buddhist:"Buddhist Tradition"}[t]||t.charAt(0).toUpperCase()+t.slice(1)}getSectionDisplayName(t){return{deities:"Deities",heroes:"Heroes",creatures:"Creatures",places:"Places",cosmology:"Cosmology",concepts:"Concepts",rituals:"Rituals",magic:"Magic",herbs:"Sacred Herbs",symbols:"Symbols",texts:"Sacred Texts",archetypes:"Archetypes",lineage:"Lineage",events:"Events"}[t]||t.charAt(0).toUpperCase()+t.slice(1)}convertTimestamps(t){const e={...t};return t.createdAt&&t.createdAt.toDate&&(e.createdAt=t.createdAt.toDate()),t.updatedAt&&t.updatedAt.toDate&&(e.updatedAt=t.updatedAt.toDate()),t.publishedAt&&t.publishedAt.toDate&&(e.publishedAt=t.publishedAt.toDate()),e}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,contentIds:Array.from(this.cache.keys())}}}window.firebaseContentDB=new FirebaseContentDB,"undefined"!=typeof module&&module.exports&&(module.exports=FirebaseContentDB);
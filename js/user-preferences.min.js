class UserPreferences{constructor(){this.userId=null,this.preferences=this.getDefaultPreferences(),this.cache=null,this.cacheTimestamp=null,this.cacheDuration=3e5,this.unsavedChanges=!1,this.db=firebase.firestore()}getDefaultPreferences(){return{userId:null,blockedUsers:[],blockedTopics:[],blockedCategories:[],blockedMythologies:[],hiddenSubmissions:[],hiddenTheories:[],displayPreferences:{theme:"auto",layout:"grid",gridSize:"medium",itemsPerPage:24,showImages:!0,showIcons:!0,compactMode:!1,animationsEnabled:!0},contentFilters:{showUserContent:!0,showTheories:!0,showSubmissions:!0,showApprovedOnly:!1,hideControversial:!1,minVoteScore:-10},notificationPreferences:{emailNotifications:!0,notifyOnTheoryComment:!0,notifyOnSubmissionUpdate:!0,notifyOnVote:!1,notifyOnMention:!0,notifyOnReply:!0,digestFrequency:"weekly"},privacySettings:{profileVisibility:"public",showEmail:!1,showTheories:!0,showVotes:!1,allowMessages:!0,analyticsOptOut:!1},searchPreferences:{defaultSearchScope:["deities","heroes","creatures","places","items","concepts","magic","theories"],searchHistory:!0,autoComplete:!0},bookmarks:[],recentlyViewed:[],version:1}}async loadPreferences(e){if(!e)return this.preferences;if(this.userId=e,this.cache&&this.cacheTimestamp&&Date.now()-this.cacheTimestamp<this.cacheDuration&&this.cache.userId===e)return this.preferences=this.cache,this.preferences;try{const s=await this.db.collection("user_preferences").doc(e).get();return s.exists?(this.preferences=this.mergeWithDefaults(s.data()),this.preferences.userId=e):(this.preferences=this.getDefaultPreferences(),this.preferences.userId=e,this.preferences.createdAt=(new Date).toISOString(),this.preferences.updatedAt=(new Date).toISOString(),await this.savePreferences()),this.cache={...this.preferences},this.cacheTimestamp=Date.now(),this.unsavedChanges=!1,this.preferences}catch(e){return this.getDefaultPreferences()}}async savePreferences(){if(!this.userId)return!1;try{return this.preferences.updatedAt=(new Date).toISOString(),await this.db.collection("user_preferences").doc(this.userId).set(this.preferences,{merge:!0}),this.cache={...this.preferences},this.cacheTimestamp=Date.now(),this.unsavedChanges=!1,!0}catch(e){return!1}}mergeWithDefaults(e){const s=this.getDefaultPreferences();return{...s,...e,displayPreferences:{...s.displayPreferences,...e.displayPreferences||{}},contentFilters:{...s.contentFilters,...e.contentFilters||{}},notificationPreferences:{...s.notificationPreferences,...e.notificationPreferences||{}},privacySettings:{...s.privacySettings,...e.privacySettings||{}},searchPreferences:{...s.searchPreferences,...e.searchPreferences||{}}}}blockUser(e){this.preferences.blockedUsers.includes(e)||(this.preferences.blockedUsers.push(e),this.unsavedChanges=!0)}unblockUser(e){const s=this.preferences.blockedUsers.indexOf(e);s>-1&&(this.preferences.blockedUsers.splice(s,1),this.unsavedChanges=!0)}isUserBlocked(e){return this.preferences.blockedUsers.includes(e)}blockTopic(e){const s=e.toLowerCase().trim();this.preferences.blockedTopics.includes(s)||(this.preferences.blockedTopics.push(s),this.unsavedChanges=!0)}unblockTopic(e){const s=e.toLowerCase().trim(),t=this.preferences.blockedTopics.indexOf(s);t>-1&&(this.preferences.blockedTopics.splice(t,1),this.unsavedChanges=!0)}isTopicBlocked(e){const s=e.toLowerCase().trim();return this.preferences.blockedTopics.includes(s)}blockCategory(e){this.preferences.blockedCategories.includes(e)||(this.preferences.blockedCategories.push(e),this.unsavedChanges=!0)}unblockCategory(e){const s=this.preferences.blockedCategories.indexOf(e);s>-1&&(this.preferences.blockedCategories.splice(s,1),this.unsavedChanges=!0)}isCategoryBlocked(e){return this.preferences.blockedCategories.includes(e)}blockMythology(e){this.preferences.blockedMythologies.includes(e)||(this.preferences.blockedMythologies.push(e),this.unsavedChanges=!0)}unblockMythology(e){const s=this.preferences.blockedMythologies.indexOf(e);s>-1&&(this.preferences.blockedMythologies.splice(s,1),this.unsavedChanges=!0)}isMythologyBlocked(e){return this.preferences.blockedMythologies.includes(e)}hideSubmission(e){this.preferences.hiddenSubmissions.includes(e)||(this.preferences.hiddenSubmissions.push(e),this.unsavedChanges=!0)}unhideSubmission(e){const s=this.preferences.hiddenSubmissions.indexOf(e);s>-1&&(this.preferences.hiddenSubmissions.splice(s,1),this.unsavedChanges=!0)}hideTheory(e){this.preferences.hiddenTheories.includes(e)||(this.preferences.hiddenTheories.push(e),this.unsavedChanges=!0)}unhideTheory(e){const s=this.preferences.hiddenTheories.indexOf(e);s>-1&&(this.preferences.hiddenTheories.splice(s,1),this.unsavedChanges=!0)}isContentBlocked(e){if(!e)return!1;if(e.authorId&&this.isUserBlocked(e.authorId))return!0;if(e.submittedBy&&this.isUserBlocked(e.submittedBy))return!0;if(e.contributedBy&&this.isUserBlocked(e.contributedBy))return!0;if(e.type&&this.isCategoryBlocked(e.type))return!0;if(e.mythology&&this.isMythologyBlocked(e.mythology))return!0;if(e.primaryMythology&&this.isMythologyBlocked(e.primaryMythology))return!0;if(e.mythologies&&Array.isArray(e.mythologies)&&e.mythologies.some(e=>this.isMythologyBlocked(e)))return!0;if(e.tags&&Array.isArray(e.tags)&&e.tags.some(e=>this.isTopicBlocked(e)))return!0;if(e.topics&&Array.isArray(e.topics)&&e.topics.some(e=>this.isTopicBlocked(e)))return!0;if(e.id&&this.preferences.hiddenSubmissions.includes(e.id))return!0;if(e.id&&this.preferences.hiddenTheories.includes(e.id))return!0;const{contentFilters:s}=this.preferences;return!(!s.showApprovedOnly||"approved"===e.status||"published"===e.status)||!(s.showUserContent||!(e.authorId||e.submittedBy||e.contributedBy))||!s.showTheories&&"user_theory"===e.type||!s.showSubmissions&&"submission"===e.type||!(!s.hideControversial||!e.controversial)||void 0!==e.voteScore&&e.voteScore<s.minVoteScore}applyFilters(e){return Array.isArray(e)?e.filter(e=>!this.isContentBlocked(e)):e}setDisplayPreference(e,s){this.preferences.displayPreferences.hasOwnProperty(e)&&(this.preferences.displayPreferences[e]=s,this.unsavedChanges=!0)}getDisplayPreference(e){return this.preferences.displayPreferences[e]}setContentFilter(e,s){this.preferences.contentFilters.hasOwnProperty(e)&&(this.preferences.contentFilters[e]=s,this.unsavedChanges=!0)}getContentFilter(e){return this.preferences.contentFilters[e]}setNotificationPreference(e,s){this.preferences.notificationPreferences.hasOwnProperty(e)&&(this.preferences.notificationPreferences[e]=s,this.unsavedChanges=!0)}getNotificationPreference(e){return this.preferences.notificationPreferences[e]}setPrivacySetting(e,s){this.preferences.privacySettings.hasOwnProperty(e)&&(this.preferences.privacySettings[e]=s,this.unsavedChanges=!0)}getPrivacySetting(e){return this.preferences.privacySettings[e]}addBookmark(e,s){this.preferences.bookmarks.find(t=>t.id===e&&t.type===s)||(this.preferences.bookmarks.push({id:e,type:s,addedAt:(new Date).toISOString()}),this.unsavedChanges=!0)}removeBookmark(e,s){const t=this.preferences.bookmarks.findIndex(t=>t.id===e&&t.type===s);t>-1&&(this.preferences.bookmarks.splice(t,1),this.unsavedChanges=!0)}isBookmarked(e,s){return this.preferences.bookmarks.some(t=>t.id===e&&t.type===s)}addRecentlyViewed(e,s){const t=this.preferences.recentlyViewed.findIndex(t=>t.id===e&&t.type===s);t>-1&&this.preferences.recentlyViewed.splice(t,1),this.preferences.recentlyViewed.unshift({id:e,type:s,viewedAt:(new Date).toISOString()}),this.preferences.recentlyViewed.length>50&&(this.preferences.recentlyViewed=this.preferences.recentlyViewed.slice(0,50)),this.unsavedChanges=!0}getRecentlyViewed(e=10){return this.preferences.recentlyViewed.slice(0,e)}clearRecentlyViewed(){this.preferences.recentlyViewed=[],this.unsavedChanges=!0}hasUnsavedChanges(){return this.unsavedChanges}resetToDefaults(){this.preferences=this.getDefaultPreferences(),this.preferences.userId=this.userId,this.unsavedChanges=!0}exportPreferences(){return JSON.stringify(this.preferences,null,2)}importPreferences(e){try{const s=JSON.parse(e);return this.preferences=this.mergeWithDefaults(s),this.preferences.userId=this.userId,this.unsavedChanges=!0,!0}catch(e){return!1}}getBlockingStats(){return{blockedUsers:this.preferences.blockedUsers.length,blockedTopics:this.preferences.blockedTopics.length,blockedCategories:this.preferences.blockedCategories.length,blockedMythologies:this.preferences.blockedMythologies.length,hiddenSubmissions:this.preferences.hiddenSubmissions.length,hiddenTheories:this.preferences.hiddenTheories.length,bookmarks:this.preferences.bookmarks.length,recentlyViewed:this.preferences.recentlyViewed.length}}applyTheme(){const e=this.preferences.displayPreferences.theme;if("auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",e?"dark":"light")}else document.documentElement.setAttribute("data-theme",e)}applyDisplayPreferences(){this.applyTheme(),this.preferences.displayPreferences.animationsEnabled?document.documentElement.style.removeProperty("--animation-duration"):document.documentElement.style.setProperty("--animation-duration","0ms"),window.dispatchEvent(new CustomEvent("preferencesApplied",{detail:this.preferences}))}}window.userPreferences=new UserPreferences,"undefined"!=typeof module&&module.exports&&(module.exports=UserPreferences);
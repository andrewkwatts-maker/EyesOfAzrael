class FirebaseCacheManager{constructor(t={}){this.db=t.db||"undefined"!=typeof firebase&&firebase.firestore(),this.memoryCache=new Map,this.defaultTTL={mythologies:864e5,metadata:36e5,entities:3e5,lists:6e5,search:6048e5,temporary:6e4},this.metrics={hits:0,misses:0,sets:0,invalidations:0,queries:0,avgResponseTime:0,totalResponseTime:0},this.loadMetrics()}async get(t,e,s={}){const r=performance.now(),i=this.generateKey(t,e),a=s.ttl||this.getDefaultTTL(t),o=s.forceRefresh||!1;try{if(!o){const t=this.getFromMemory(i);if(t&&!this.isExpired(t,a))return this.recordHit(r),t.data;const e=this.getFromSessionStorage(i);if(e&&!this.isExpired(e,a))return this.memoryCache.set(i,e),this.recordHit(r),e.data;const s=this.getFromLocalStorage(i);if(s&&!this.isExpired(s,a))return this.memoryCache.set(i,s),this.setToSessionStorage(i,s),this.recordHit(r),s.data}this.recordMiss();const s=await this.fetchFromFirebase(t,e);if(s){await this.set(t,e,s,{ttl:a});const i=performance.now()-r;this.recordQuery(i)}return s}catch(t){throw t}}async set(t,e,s,r={}){const i=this.generateKey(t,e),a=r.ttl||this.getDefaultTTL(t),o={data:s,timestamp:Date.now(),ttl:a,collection:t,id:e};try{this.memoryCache.set(i,o),this.setToSessionStorage(i,o),this.setToLocalStorage(i,o),this.metrics.sets++}catch(t){}}invalidate(t,e=null){if(e){const s=this.generateKey(t,e);this.memoryCache.delete(s),sessionStorage.removeItem(s),localStorage.removeItem(s)}else{const e=`cache_${t}_`;for(const t of this.memoryCache.keys())t.startsWith(e)&&this.memoryCache.delete(t);this.clearStorageByPrefix(sessionStorage,e),this.clearStorageByPrefix(localStorage,e)}this.metrics.invalidations++}clearAll(){this.memoryCache.clear(),this.clearStorageByPrefix(sessionStorage,"cache_"),this.clearStorageByPrefix(localStorage,"cache_")}async fetchFromFirebase(t,e){if(!this.db)throw new Error("Firebase Firestore not initialized");try{const s=await this.db.collection(t).doc(e).get();return s.exists?{id:s.id,...s.data()}:null}catch(t){throw t}}async getList(t,e={},s={}){const r=this.generateListKey(t,e),i=s.ttl||this.defaultTTL.lists,a=s.forceRefresh||!1;try{if(!a){const t=this.getFromMemory(r)||this.getFromSessionStorage(r)||this.getFromLocalStorage(r);if(t&&!this.isExpired(t,i))return this.recordHit(performance.now()),t.data}this.recordMiss();const o=performance.now();let c=this.db.collection(t);if(e.mythology&&(c=c.where("mythology","==",e.mythology)),e.type&&(c=c.where("type","==",e.type)),s.orderBy){const[t,e="asc"]=s.orderBy.split(" ");c=c.orderBy(t,e)}const h=s.limit||20;c=c.limit(h),s.startAfter&&(c=c.startAfter(s.startAfter));const n=(await c.get()).docs.map(t=>({id:t.id,...t.data()})),m={data:n,timestamp:Date.now(),ttl:i,collection:t,filters:e};this.memoryCache.set(r,m),this.setToSessionStorage(r,m);const l=performance.now()-o;return this.recordQuery(l),n}catch(t){throw t}}async getMetadata(t,e=null){const s=e?`cache_metadata_${t}_${e}`:`cache_metadata_${t}`,r=this.defaultTTL.metadata;try{const i=this.getFromMemory(s)||this.getFromLocalStorage(s);if(i&&!this.isExpired(i,r))return this.recordHit(performance.now()),i.data;let a;if(this.recordMiss(),e){const s=await this.db.collection("metadata").doc(`${t}_${e}`).get();a=s.exists?s.data():null}else a=(await this.db.collection("metadata").where("type","==",t).get()).docs.map(t=>t.data());if(a){const t={data:a,timestamp:Date.now(),ttl:r};this.memoryCache.set(s,t),this.setToLocalStorage(s,t)}return a}catch(t){return null}}async warmCache(){try{await this.getList("mythologies",{},{ttl:this.defaultTTL.mythologies}),await this.getMetadata("mythology_counts")}catch(t){}}getStats(){const t=this.metrics.hits+this.metrics.misses>0?(this.metrics.hits/(this.metrics.hits+this.metrics.misses)*100).toFixed(2):0;return{...this.metrics,hitRate:t+"%",memoryCacheSize:this.memoryCache.size,avgResponseTime:this.metrics.queries>0?(this.metrics.totalResponseTime/this.metrics.queries).toFixed(2)+"ms":"0ms"}}printStats(){this.getStats()}generateKey(t,e){return`cache_${t}_${e}`}generateListKey(t,e){return`cache_list_${t}_${Object.entries(e).sort().map(([t,e])=>`${t}:${e}`).join("_")}`}getDefaultTTL(t){return this.defaultTTL[t]||this.defaultTTL.temporary}isExpired(t,e){return!t||!t.timestamp||Date.now()-t.timestamp>e}getFromMemory(t){return this.memoryCache.get(t)}getFromSessionStorage(t){try{const e=sessionStorage.getItem(t);return e?JSON.parse(e):null}catch(t){return null}}getFromLocalStorage(t){try{const e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(t){return null}}setToSessionStorage(t,e){try{sessionStorage.setItem(t,JSON.stringify(e))}catch(s){if("QuotaExceededError"===s.name){this.clearOldestEntries(sessionStorage);try{sessionStorage.setItem(t,JSON.stringify(e))}catch(t){}}}}setToLocalStorage(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(s){if("QuotaExceededError"===s.name){this.clearOldestEntries(localStorage);try{localStorage.setItem(t,JSON.stringify(e))}catch(t){}}}}clearStorageByPrefix(t,e){const s=[];for(let r=0;r<t.length;r++){const i=t.key(r);i&&i.startsWith(e)&&s.push(i)}s.forEach(e=>t.removeItem(e))}clearOldestEntries(t){const e=[];for(let s=0;s<t.length;s++){const r=t.key(s);if(r&&r.startsWith("cache_"))try{const s=JSON.parse(t.getItem(r));e.push({key:r,timestamp:s.timestamp||0})}catch(t){e.push({key:r,timestamp:0})}}e.sort((t,e)=>t.timestamp-e.timestamp);const s=Math.ceil(.25*e.length);for(let r=0;r<s;r++)t.removeItem(e[r].key)}recordHit(t){this.metrics.hits++;const e=performance.now()-t;this.recordQuery(e)}recordMiss(){this.metrics.misses++}recordQuery(t){this.metrics.queries++,this.metrics.totalResponseTime+=t,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.queries,this.metrics.queries%10==0&&this.saveMetrics()}saveMetrics(){try{localStorage.setItem("cache_metrics",JSON.stringify(this.metrics))}catch(t){}}loadMetrics(){try{const t=localStorage.getItem("cache_metrics");t&&(this.metrics={...this.metrics,...JSON.parse(t)})}catch(t){}}}"undefined"!=typeof window&&(window.FirebaseCacheManager=FirebaseCacheManager,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.cacheManager=new FirebaseCacheManager}):window.cacheManager=new FirebaseCacheManager),"undefined"!=typeof module&&module.exports&&(module.exports=FirebaseCacheManager);
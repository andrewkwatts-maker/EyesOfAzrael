class PreferencesUI{constructor(){this.prefs=window.userPreferences,this.currentUser=null,this.currentTab="content-filters",this.mythologies=["jewish","greek","norse","egyptian","hindu","buddhist","japanese","chinese","celtic","mesopotamian","roman","slavic"],this.entityTypes=["deity","hero","creature","place","item","concept","magic","realm","theory"]}async init(){this.currentUser=firebase.auth().currentUser,this.currentUser?(await this.prefs.loadPreferences(this.currentUser.uid),this.setupTabNavigation(),this.setupContentFilters(),this.setupBlockedContent(),this.setupDisplaySettings(),this.setupNotifications(),this.setupPrivacy(),this.setupHeaderActions(),this.setupSaveIndicator(),this.populateMythologyFilters(),this.populateEntityTypeFilters(),this.populateBlockedUsers(),this.populateBlockedTopics(),this.populateHiddenSubmissions(),this.updateStatistics(),this.updateBlockedCountBadge(),this.loadPreferencesIntoUI()):window.location.href="index.html"}setupTabNavigation(){document.querySelectorAll(".pref-tab").forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.tab;this.switchTab(s)})})}switchTab(e){document.querySelectorAll(".pref-tab").forEach(t=>{t.dataset.tab===e?t.classList.add("active"):t.classList.remove("active")}),document.querySelectorAll(".tab-panel").forEach(t=>{t.id===`tab-${e}`?t.classList.add("active"):t.classList.remove("active")}),this.currentTab=e}setupContentFilters(){const e=document.getElementById("show-user-content");e&&e.addEventListener("change",e=>{this.prefs.setContentFilter("showUserContent",e.target.checked),this.prefs.savePreferences()}),document.querySelectorAll('input[name="content-source"]').forEach(e=>{e.addEventListener("change",e=>{if(e.target.checked){const t=e.target.value;"official"===t?this.prefs.set("contentFilters.showUserContent",!1):("official-self"===t||"everyone"===t)&&(this.prefs.set("contentFilters.showUserContent",!0),this.prefs.set("contentFilters.showApprovedOnly",!1)),this.prefs.savePreferences()}})});const t=document.getElementById("btn-add-tag"),s=document.getElementById("tag-filter-input");t&&s&&(t.addEventListener("click",()=>{const e=s.value.trim();e&&(this.prefs.blockTopic(e),this.prefs.savePreferences(),this.populateBlockedTopics(),s.value="")}),s.addEventListener("keypress",e=>{"Enter"===e.key&&t.click()}))}setupBlockedContent(){const e=document.getElementById("btn-clear-blocked-users");e&&e.addEventListener("click",async()=>{confirm("Are you sure you want to unblock all users?")&&(this.prefs.preferences.blockedUsers=[],await this.prefs.savePreferences(),this.populateBlockedUsers(),this.updateBlockedCountBadge())});const t=document.getElementById("btn-clear-blocked-topics");t&&t.addEventListener("click",async()=>{confirm("Are you sure you want to unblock all topics?")&&(this.prefs.preferences.blockedTopics=[],await this.prefs.savePreferences(),this.populateBlockedTopics(),this.updateBlockedCountBadge())});const s=document.getElementById("btn-clear-hidden-submissions");s&&s.addEventListener("click",async()=>{confirm("Are you sure you want to restore all hidden submissions?")&&(this.prefs.preferences.hiddenSubmissions=[],await this.prefs.savePreferences(),this.populateHiddenSubmissions(),this.updateBlockedCountBadge())});const n=document.getElementById("btn-block-topic"),i=document.getElementById("block-topic-input");n&&i&&(n.addEventListener("click",()=>{const e=i.value.trim();e&&(this.prefs.blockTopic(e),this.prefs.savePreferences(),this.populateBlockedTopics(),this.updateBlockedCountBadge(),i.value="")}),i.addEventListener("keypress",e=>{"Enter"===e.key&&n.click()}))}setupDisplaySettings(){document.querySelectorAll('input[name="theme"]').forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&(this.prefs.setDisplayPreference("theme",e.target.value),this.prefs.savePreferences(),this.prefs.applyTheme())})}),document.querySelectorAll('input[name="layout"]').forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&(this.prefs.setDisplayPreference("layout",e.target.value),this.prefs.savePreferences())})});const e=document.getElementById("grid-columns"),t=document.getElementById("grid-columns-value");e&&t&&(e.addEventListener("input",e=>{const s=e.target.value;t.textContent=`${s} columns`}),e.addEventListener("change",e=>{this.prefs.setDisplayPreference("gridSize",parseInt(e.target.value)),this.prefs.savePreferences()})),document.querySelectorAll('input[name="card-size"]').forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&(this.prefs.setDisplayPreference("cardSize",e.target.value),this.prefs.savePreferences())})}),document.querySelectorAll('input[name="font-size"]').forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&(this.prefs.setDisplayPreference("fontSize",e.target.value),this.prefs.savePreferences())})}),document.querySelectorAll('input[name="animations"]').forEach(e=>{e.addEventListener("change",e=>{if(e.target.checked){const t="none"!==e.target.value;this.prefs.setDisplayPreference("animationsEnabled",t),this.prefs.savePreferences(),this.prefs.applyDisplayPreferences()}})})}setupNotifications(){["email-notifications","notify-submission-status","notify-community","notify-site-updates","weekly-digest"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",t=>{const s=this.notificationIdToKey(e);this.prefs.setNotificationPreference(s,t.target.checked),this.prefs.savePreferences()})})}setupPrivacy(){const e=document.getElementById("public-profile");e&&e.addEventListener("change",e=>{this.prefs.setPrivacySetting("profileVisibility",e.target.checked?"public":"private"),this.prefs.savePreferences()});const t=document.getElementById("show-email");t&&t.addEventListener("change",e=>{this.prefs.setPrivacySetting("showEmail",e.target.checked),this.prefs.savePreferences()});const s=document.getElementById("activity-tracking");s&&s.addEventListener("change",e=>{this.prefs.setPrivacySetting("analyticsOptOut",!e.target.checked),this.prefs.savePreferences()});const n=document.getElementById("btn-download-data");n&&n.addEventListener("click",()=>{this.downloadUserData()});const i=document.getElementById("btn-clear-history");i&&i.addEventListener("click",async()=>{confirm("Are you sure you want to clear your browsing history?")&&(this.prefs.clearRecentlyViewed(),await this.prefs.savePreferences(),alert("Browsing history cleared"))});const c=document.getElementById("btn-delete-account");c&&c.addEventListener("click",()=>{this.handleDeleteAccount()})}setupHeaderActions(){const e=document.getElementById("btn-export");e&&e.addEventListener("click",()=>{const e=this.prefs.exportPreferences(),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=`preferences-${Date.now()}.json`,n.click(),URL.revokeObjectURL(s)});const t=document.getElementById("btn-import"),s=document.getElementById("import-file-input");t&&s&&(t.addEventListener("click",()=>{s.click()}),s.addEventListener("change",async e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=async e=>{try{this.prefs.importPreferences(e.target.result)?(await this.prefs.savePreferences(),this.loadPreferencesIntoUI(),alert("Preferences imported successfully!")):alert("Failed to import preferences. Invalid file format.")}catch(e){alert("Error importing preferences: "+e.message)}},e.readAsText(t),s.value=""}}));const n=document.getElementById("btn-reset");n&&n.addEventListener("click",async()=>{confirm("Are you sure you want to reset all preferences to defaults? This cannot be undone.")&&(this.prefs.resetToDefaults(),await this.prefs.savePreferences(),this.loadPreferencesIntoUI(),this.populateBlockedUsers(),this.populateBlockedTopics(),this.populateHiddenSubmissions(),alert("Preferences reset to defaults"))});const i=document.getElementById("btn-manual-save");i&&i.addEventListener("click",async()=>{await this.prefs.savePreferences(),this.showSaveSuccess()})}setupSaveIndicator(){window.addEventListener("preferencesApplied",()=>{this.showSaveSuccess()})}loadPreferencesIntoUI(){const e=this.prefs.preferences;document.getElementById("show-user-content").checked=e.contentFilters.showUserContent,document.getElementById(`theme-${e.displayPreferences.theme}`).checked=!0,document.getElementById(`layout-${e.displayPreferences.layout}`).checked=!0;const t=e.displayPreferences.gridSize||3;document.getElementById("grid-columns").value=t,document.getElementById("grid-columns-value").textContent=`${t} columns`,document.getElementById("email-notifications").checked=e.notificationPreferences.emailNotifications,document.getElementById("notify-submission-status").checked=e.notificationPreferences.notifyOnSubmissionUpdate,document.getElementById("notify-community").checked=e.notificationPreferences.notifyOnTheoryComment,document.getElementById("notify-site-updates").checked=!0,document.getElementById("weekly-digest").checked="weekly"===e.notificationPreferences.digestFrequency,document.getElementById("public-profile").checked="public"===e.privacySettings.profileVisibility,document.getElementById("show-email").checked=e.privacySettings.showEmail,document.getElementById("activity-tracking").checked=!e.privacySettings.analyticsOptOut}populateMythologyFilters(){const e=document.getElementById("mythology-filters");e&&(e.innerHTML=this.mythologies.map(e=>`\n            <label class="checkbox-item">\n                <input type="checkbox" value="${e}" ${this.prefs.isMythologyBlocked(e)?"":"checked"}>\n                <span class="checkbox-label">${this.capitalize(e)}</span>\n            </label>\n        `).join(""),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{const t=e.target.value;e.target.checked?this.prefs.unblockMythology(t):this.prefs.blockMythology(t),this.prefs.savePreferences()})}))}populateEntityTypeFilters(){const e=document.getElementById("entity-type-filters");e&&(e.innerHTML=this.entityTypes.map(e=>`\n            <label class="checkbox-item">\n                <input type="checkbox" value="${e}" ${this.prefs.isCategoryBlocked(e)?"":"checked"}>\n                <span class="checkbox-label">${this.capitalize(e)}</span>\n            </label>\n        `).join(""),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{const t=e.target.value;e.target.checked?this.prefs.unblockCategory(t):this.prefs.blockCategory(t),this.prefs.savePreferences()})}))}async populateBlockedUsers(){const e=document.getElementById("blocked-users-list");if(!e)return;const t=this.prefs.preferences.blockedUsers;if(0===t.length)return void(e.innerHTML='\n                <div class="empty-state">\n                    <div class="empty-icon">ðŸ‘¥</div>\n                    <p>No blocked users</p>\n                </div>\n            ');const s=await Promise.all(t.map(e=>this.getUserInfo(e)));e.innerHTML=s.map((e,s)=>`\n            <div class="blocked-item" data-user-id="${t[s]}">\n                <img src="${e.avatar}" alt="${e.name}" class="blocked-user-avatar">\n                <div class="blocked-item-info">\n                    <div class="blocked-item-name">${e.name}</div>\n                    <div class="blocked-item-reason">Blocked by you</div>\n                </div>\n                <button class="btn-unblock" onclick="window.preferencesUI.unblockUser('${t[s]}')">\n                    Unblock\n                </button>\n            </div>\n        `).join("")}populateBlockedTopics(){const e=document.getElementById("blocked-topics");if(!e)return;const t=this.prefs.preferences.blockedTopics;0!==t.length?e.innerHTML=t.map(e=>`\n            <div class="tag-chip">\n                <span>${this.escapeHtml(e)}</span>\n                <button class="tag-chip-remove" onclick="window.preferencesUI.unblockTopic('${this.escapeHtml(e)}')">&times;</button>\n            </div>\n        `).join(""):e.innerHTML='<div class="empty-state-inline">No blocked topics</div>'}populateHiddenSubmissions(){const e=document.getElementById("hidden-submissions-list");if(!e)return;const t=this.prefs.preferences.hiddenSubmissions;0!==t.length?e.innerHTML=t.map(e=>`\n            <div class="blocked-item" data-submission-id="${e}">\n                <div class="blocked-item-info">\n                    <div class="blocked-item-name">Submission ${e}</div>\n                    <div class="blocked-item-reason">Hidden by you</div>\n                </div>\n                <button class="btn-unblock" onclick="window.preferencesUI.restoreSubmission('${e}')">\n                    Restore\n                </button>\n            </div>\n        `).join(""):e.innerHTML='\n                <div class="empty-state">\n                    <div class="empty-icon">ðŸ“‹</div>\n                    <p>No hidden submissions</p>\n                </div>\n            '}updateStatistics(){const e=this.prefs.getBlockingStats(),t=document.getElementById("stat-blocked-users"),s=document.getElementById("stat-blocked-topics"),n=document.getElementById("stat-hidden-content"),i=document.getElementById("stat-storage-used");t&&(t.textContent=e.blockedUsers),s&&(s.textContent=e.blockedTopics),n&&(n.textContent=e.hiddenSubmissions+e.hiddenTheories);const c=JSON.stringify(this.prefs.preferences),o=(new Blob([c]).size/1024).toFixed(2);i&&(i.textContent=`${o} KB`)}updateBlockedCountBadge(){const e=document.getElementById("blocked-count-badge");if(e){const t=this.prefs.getBlockingStats(),s=t.blockedUsers+t.blockedTopics+t.hiddenSubmissions;e.textContent=s,e.style.display=s>0?"block":"none"}}async unblockUser(e){this.prefs.unblockUser(e),await this.prefs.savePreferences(),this.populateBlockedUsers(),this.updateBlockedCountBadge(),this.updateStatistics()}async unblockTopic(e){this.prefs.unblockTopic(e),await this.prefs.savePreferences(),this.populateBlockedTopics(),this.updateBlockedCountBadge(),this.updateStatistics()}async restoreSubmission(e){this.prefs.unhideSubmission(e),await this.prefs.savePreferences(),this.populateHiddenSubmissions(),this.updateBlockedCountBadge(),this.updateStatistics()}showSaveSuccess(){const e=document.getElementById("save-indicator"),t=document.getElementById("save-timestamp");e&&t&&(e.classList.remove("saving","error"),t.textContent="Last saved: "+(new Date).toLocaleTimeString())}downloadUserData(){const e={preferences:this.prefs.preferences,user:{uid:this.currentUser.uid,email:this.currentUser.email,displayName:this.currentUser.displayName},exportedAt:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=`eyes-of-azrael-user-data-${Date.now()}.json`,n.click(),URL.revokeObjectURL(s)}async handleDeleteAccount(){if("DELETE"===prompt('This will permanently delete your account and all associated data. Type "DELETE" to confirm:'))try{await firebase.firestore().collection("user_preferences").doc(this.currentUser.uid).delete(),await this.currentUser.delete(),alert("Account deleted successfully"),window.location.href="index.html"}catch(e){alert("Error deleting account: "+e.message)}}async getUserInfo(e){try{const t=await firebase.firestore().collection("users").doc(e).get();if(t.exists){const e=t.data();return{name:e.displayName||e.email||"Unknown User",avatar:e.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.displayName||"User")}`}}}catch(e){}return{name:"Unknown User",avatar:"https://ui-avatars.com/api/?name=Unknown"}}notificationIdToKey(e){return{"email-notifications":"emailNotifications","notify-submission-status":"notifyOnSubmissionUpdate","notify-community":"notifyOnTheoryComment","notify-site-updates":"notifyOnMention","weekly-digest":"digestFrequency"}[e]||e}capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}window.preferencesUI=new PreferencesUI;
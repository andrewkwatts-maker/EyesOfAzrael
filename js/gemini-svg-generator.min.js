class GeminiSVGGenerator{constructor(){this.model="gemini-1.5-flash",this.apiEndpoint=`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent`,this.maxRetries=3,this.retryDelay=1e3,this.auth=null,this.systemInstructions="You are an expert SVG artist specializing in mythology and sacred symbolism.\nGenerate clean, semantic SVG code with these requirements:\n- ViewBox: 0 0 400 400\n- Use vibrant colors: #f59e0b (orange), #8b7fff (purple), #fbbf24 (gold), #ef4444 (red), #10b981 (green)\n- No external dependencies or scripts\n- Inline styles only (no CSS classes or external stylesheets)\n- Include aria-label for accessibility\n- Mythologically accurate symbolism\n- Professional illustration quality\n- No text unless specifically requested\n- Simple, clean geometric shapes preferred\n- Use gradients for depth and visual interest\n- Ensure all paths are closed and valid\n- Return ONLY the SVG code, no markdown formatting or explanations",this.initializeAuth()}initializeAuth(){"undefined"!=typeof firebase&&firebase.auth&&(this.auth=firebase.auth())}async getCurrentUserToken(){if(!this.auth&&"undefined"!=typeof firebase&&firebase.auth&&(this.auth=firebase.auth()),!this.auth)return null;await new Promise(e=>{if(this.auth.currentUser)e();else{const t=this.auth.onAuthStateChanged(s=>{t(),e()})}});const e=this.auth.currentUser;if(!e)return null;try{return await e.getIdToken(!0)}catch(e){return null}}isAuthenticated(){return!this.auth&&"undefined"!=typeof firebase&&firebase.auth&&(this.auth=firebase.auth()),!(!this.auth||!this.auth.currentUser)}isConfigured(){return this.isAuthenticated()}getConfigInstructions(){return{title:"Sign In Required",message:"To use AI SVG generation, you need to sign in with your Google account. Your Google account OAuth token will be used to access the Gemini API.",steps:['1. Click the "Sign In with Google" button in the top right',"2. Sign in with your Google account","3. Once signed in, the AI Generator will be enabled","4. No API key needed - your Google OAuth token is used automatically"],note:"The Gemini 1.5 Flash model is free for moderate usage and very cost-effective for SVG generation."}}async generateSVG(e,t={}){if(!this.isAuthenticated())return{success:!1,error:"Not authenticated",needsAuth:!0,configInstructions:this.getConfigInstructions()};const s=this.buildEnhancedPrompt(e,t);for(let r=1;r<=this.maxRetries;r++)try{const i=await this.callGeminiAPI(s);if(i.success){const s=this.validateSVG(i.svgCode);if(s.valid)return{success:!0,svgCode:i.svgCode,prompt:e,options:t};if(r<this.maxRetries){await this.sleep(this.retryDelay);continue}return{success:!1,error:`Generated SVG was invalid: ${s.errors.join(", ")}`}}if(r<this.maxRetries&&i.retryable){await this.sleep(this.retryDelay*r);continue}return i}catch(e){if(r<this.maxRetries){await this.sleep(this.retryDelay*r);continue}return{success:!1,error:`Generation failed: ${e.message}`}}return{success:!1,error:"Maximum retries exceeded"}}buildEnhancedPrompt(e,t){let s=e;return t.style&&(s+=` Style: ${{symbolic:"Use simple, iconic symbols with clean lines and minimal detail. Focus on archetypal representation.",detailed:"Include intricate details, patterns, and textures. Make it visually rich and complex.",minimalist:"Use minimal shapes and elements. Clean, modern aesthetic with lots of negative space.",geometric:"Use geometric shapes, sacred geometry patterns, and mathematical precision. Emphasize symmetry."}[t.style]||""}`),t.colorScheme&&(s+=` Colors: ${{fire:"Use warm colors: oranges (#f59e0b, #fb923c), reds (#ef4444), and gold (#fbbf24). Fiery, energetic palette.",divine:"Use purple (#8b7fff, #a78bfa), gold (#fbbf24), and white. Divine, mystical palette.",nature:"Use greens (#10b981, #22c55e), browns (#92400e, #78350f), and earth tones. Natural, grounded palette.",water:"Use blues (#3b82f6, #0ea5e9), teals (#14b8a6), and aqua tones. Calm, flowing palette.",monochrome:"Use shades of purple (#8b7fff) with white and dark accents. Elegant, unified palette."}[t.colorScheme]||""}`),s+="\n\nIMPORTANT: Return ONLY the complete SVG code starting with <svg and ending with </svg>. No explanations, no markdown code blocks, just the raw SVG code.",s}async callGeminiAPI(e){try{const t=await this.getCurrentUserToken();if(!t)return{success:!1,error:"Failed to get authentication token. Please try signing in again.",retryable:!1,needsAuth:!0};const s={contents:[{parts:[{text:`${this.systemInstructions}\n\nUser Request: ${e}`}]}],generationConfig:{temperature:.9,topK:40,topP:.95,maxOutputTokens:8192}},r=await fetch(this.apiEndpoint,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const s=await r.json().catch(()=>({}));if(401===r.status||403===r.status){const s=await this.getCurrentUserToken();return s&&s!==t?this.callGeminiAPI(e):{success:!1,error:"Authentication failed. Your session may have expired. Please sign in again.",retryable:!1,needsAuth:!0}}return 429===r.status?{success:!1,error:"Rate limit exceeded. Please wait a moment and try again.",retryable:!0}:r.status>=500?{success:!1,error:"Google API server error. Please try again.",retryable:!0}:400===r.status?{success:!1,error:`API request error: ${s.error?.message||"Invalid request"}`,retryable:!1}:{success:!1,error:`API error: ${s.error?.message||r.statusText}`,retryable:!1}}const i=await r.json();if(!i.candidates||!i.candidates[0]||!i.candidates[0].content)return{success:!1,error:"No content generated by API",retryable:!0};const n=i.candidates[0].content.parts[0].text,a=this.extractSVGFromResponse(n);return a?{success:!0,svgCode:a}:{success:!1,error:"Failed to extract valid SVG from API response",retryable:!0}}catch(e){return{success:!1,error:`Network error: ${e.message}`,retryable:!0}}}extractSVGFromResponse(e){const t=e.replace(/```svg\n?/g,"").replace(/```\n?/g,"").match(/<svg[\s\S]*?<\/svg>/i);return t?t[0].trim():null}validateSVG(e){const t=[];if(!e)return t.push("SVG code is empty"),{valid:!1,errors:t};e.trim().toLowerCase().startsWith("<svg")||t.push("SVG must start with <svg tag"),e.trim().toLowerCase().endsWith("</svg>")||t.push("SVG must end with </svg> tag"),e.includes("viewBox")||t.push("SVG should have a viewBox attribute");try{(new DOMParser).parseFromString(e,"image/svg+xml").querySelector("parsererror")&&t.push("SVG contains XML parse errors")}catch(e){t.push(`XML parsing failed: ${e.message}`)}return{valid:0===t.length,errors:t}}sleep(e){return new Promise(t=>setTimeout(t,e))}static getExamplePrompts(){return[{text:"Zeus hurling a lightning bolt",style:"detailed",colorScheme:"fire"},{text:"Tree of Life with 10 spheres representing the Sefirot",style:"geometric",colorScheme:"divine"},{text:"Ouroboros serpent eating its tail in circular form",style:"symbolic",colorScheme:"monochrome"},{text:"Phoenix rising from flames",style:"detailed",colorScheme:"fire"},{text:"Yggdrasil world tree connecting nine realms",style:"detailed",colorScheme:"nature"},{text:"Sacred Lotus flower with mystical light",style:"minimalist",colorScheme:"divine"},{text:"Eye of Horus with sacred geometry",style:"geometric",colorScheme:"divine"},{text:"Metatron's Cube sacred geometry pattern",style:"geometric",colorScheme:"divine"}]}}window.GeminiSVGGenerator=GeminiSVGGenerator;
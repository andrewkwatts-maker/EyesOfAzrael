class FirestoreQueries{constructor(e){this.db=e}async queryTheories(e={}){const{filters:t={},sort:s="newest",limit:r=20,startAfter:i=null,includeDeleted:o=!1}=e,a={...t,sortBy:s,limit:r,startAfter:i};return o||t.status||(a.status="published"),await this.db.getTheories(a)}async filterByTopic(e,t={}){return await this.queryTheories({filters:{topic:e},...t})}async filterBySubtopic(e,t={}){return await this.queryTheories({filters:{subtopic:e},...t})}async filterByAuthor(e,t={}){return await this.queryTheories({filters:{author:e},...t})}async filterByAuthorId(e,t={}){return await this.queryTheories({filters:{authorId:e},...t})}async getUserTheories(e,t={}){return await this.queryTheories({filters:{authorId:e,status:null},...t})}async sortByNewest(e={},t={}){return await this.queryTheories({filters:e,sort:"newest",...t})}async sortByOldest(e={},t={}){return await this.queryTheories({filters:e,sort:"oldest",...t})}async sortByPopular(e={},t={}){return await this.queryTheories({filters:e,sort:"popular",...t})}async sortByViews(e={},t={}){return await this.queryTheories({filters:e,sort:"views",...t})}async search(e,t={},s={}){return e&&""!==e.trim()?await this.db.searchTheories(e,{...t,...s}):await this.queryTheories({filters:t,...s})}async groupByTopic(e=null,t={}){e||(e=(await this.queryTheories({limit:100,...t})).theories);const s={};return e.forEach(e=>{const t=e.topic||"uncategorized";s[t]||(s[t]={topic:t,topicName:e.topicName||"Uncategorized",topicIcon:e.topicIcon||"ðŸ“Œ",theories:[]}),s[t].theories.push(e)}),s}async groupBySubtopic(e=null,t={}){e||(e=(await this.queryTheories({limit:100,...t})).theories);const s={};return e.forEach(e=>{const t=e.subtopic||"unspecified";s[t]||(s[t]={subtopic:t,subtopicName:e.subtopicName||"Unspecified",topicIcon:e.topicIcon||"ðŸ“‹",theories:[]}),s[t].theories.push(e)}),s}async groupByAuthor(e=null,t={}){e||(e=(await this.queryTheories({limit:100,...t})).theories);const s={};return e.forEach(e=>{const t=e.authorName||e.authorId;s[t]||(s[t]={author:t,authorName:e.authorName,authorAvatar:e.authorAvatar,theories:[]}),s[t].theories.push(e)}),s}async getTrendingTheories(e=7,t=10){const s=new Date;return s.setDate(s.getDate()-e),{theories:(await this.queryTheories({sort:"popular",limit:50})).theories.filter(e=>{const t=e.createdAt;return t&&t>=s}).slice(0,t),hasMore:!1}}async getRelatedTheories(e,t=5){const s={};return e.subtopic?s.subtopic=e.subtopic:e.topic&&(s.topic=e.topic),{theories:(await this.queryTheories({filters:s,sort:"popular",limit:t+1})).theories.filter(t=>t.id!==e.id).slice(0,t),hasMore:!1}}async getStatistics(){try{const e=(await this.queryTheories({limit:1e3,filters:{status:"published"}})).theories,t={totalTheories:e.length,totalVotes:e.reduce((e,t)=>e+(t.votes||0),0),totalViews:e.reduce((e,t)=>e+(t.views||0),0),totalComments:0,topics:new Set(e.filter(e=>e.topic).map(e=>e.topic)).size,subtopics:new Set(e.filter(e=>e.subtopic).map(e=>e.subtopic)).size,authors:new Set(e.map(e=>e.authorId)).size,avgVotes:0,avgViews:0,mostPopular:null,mostViewed:null,newest:null};return e.length>0&&(t.avgVotes=t.totalVotes/e.length,t.avgViews=t.totalViews/e.length,t.mostPopular=e.reduce((e,t)=>(t.votes||0)>(e.votes||0)?t:e,e[0]),t.mostViewed=e.reduce((e,t)=>(t.views||0)>(e.views||0)?t:e,e[0]),t.newest=e.reduce((e,t)=>t.createdAt>e.createdAt?t:e,e[0])),t}catch(e){throw e}}async loadMore(e,t={},s="newest",r=20){return await this.queryTheories({filters:t,sort:s,limit:r,startAfter:e})}async advancedSearch(e){const{searchTerm:t="",topic:s=null,subtopic:r=null,author:i=null,minVotes:o=null,minViews:a=null,dateFrom:u=null,dateTo:n=null,sort:c="newest",limit:l=20}=e,h={};let p;s&&(h.topic=s),r&&(h.subtopic=r),i&&(h.author=i),p=t?await this.search(t,h,{sort:c,limit:100}):await this.queryTheories({filters:h,sort:c,limit:100});let y=p.theories;return null!==o&&(y=y.filter(e=>(e.votes||0)>=o)),null!==a&&(y=y.filter(e=>(e.views||0)>=a)),u&&(y=y.filter(e=>e.createdAt>=new Date(u))),n&&(y=y.filter(e=>e.createdAt<=new Date(n))),y=y.slice(0,l),{theories:y,hasMore:!1,totalMatches:y.length}}async getTheoriesByTopics(e,t={}){const s=await Promise.all(e.map(e=>this.filterByTopic(e,t))),r=new Map;return s.forEach(e=>{e.theories.forEach(e=>{r.set(e.id,e)})}),{theories:Array.from(r.values()),hasMore:!1}}async batchUpdate(e,t){const s=await Promise.all(e.map(e=>this.db.updateTheory(e,t)));return{success:s.every(e=>e.success),updated:s.filter(e=>e.success).length,failed:s.filter(e=>!e.success).length}}async exportTheories(e={},t="json"){const s=await this.queryTheories({filters:e,limit:1e3});return"json"===t?JSON.stringify(s.theories,null,2):"csv"===t?this.convertToCSV(s.theories):s.theories}convertToCSV(e){if(0===e.length)return"";const t=e.map(e=>[e.id,`"${(e.title||"").replace(/"/g,'""')}"`,e.authorName,e.topicName||"",e.subtopicName||"",e.votes||0,e.views||0,e.createdAt?e.createdAt.toISOString():""]);return[["ID","Title","Author","Topic","Subtopic","Votes","Views","Created"].join(","),...t.map(e=>e.join(","))].join("\n")}}window.firebaseDB&&(window.firestoreQueries=new FirestoreQueries(window.firebaseDB)),"undefined"!=typeof module&&module.exports&&(module.exports=FirestoreQueries);
class EditablePanelSystem{constructor(e){this.app=e,this.db=firebase.firestore(),this.auth=firebase.auth(),this.currentUser=null,this.editMode=!1,this.auth.onAuthStateChanged(e=>{this.currentUser=e,this.updateEditIcons()})}initEditablePanel(e,t={}){const{contentType:s,documentId:n,canEdit:i=!1,canSubmitAppendment:o=!0,collection:a="deities"}=t;e.classList.add("editable-panel"),e.dataset.contentType=s,e.dataset.documentId=n,e.dataset.collection=a,i&&this.currentUser&&this.addEditIcon(e,t),o&&this.addSubmissionButton(e,t),this.loadSubmissions(e,t)}addEditIcon(e,t){if(e.querySelector(".panel-edit-icon"))return;const s=document.createElement("button");s.className="panel-edit-icon",s.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n      </svg>\n    ',s.title="Edit your submission",s.addEventListener("click",s=>{s.stopPropagation(),this.enterEditMode(e,t)}),e.style.position="relative",e.appendChild(s)}addSubmissionButton(e,t){if(e.querySelector(".panel-submission-btn"))return;const s=document.createElement("button");s.className="panel-submission-btn",s.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <line x1="12" y1="5" x2="12" y2="19"></line>\n        <line x1="5" y1="12" x2="19" y2="12"></line>\n      </svg>\n    ',s.title="Submit additional information",s.addEventListener("click",s=>{s.stopPropagation(),this.currentUser?this.openSubmissionModal(e,t):this.showLoginPrompt()}),e.appendChild(s)}async enterEditMode(e,t){if(!this.currentUser)return void this.showLoginPrompt();const s=await this.db.collection(t.collection).doc(t.documentId).get();if(!s.exists)return void this.showError("Content not found");const n=s.data();this.showEditModal(e,n,t)}showEditModal(e,t,s){const n=this.createModal("Edit Content"),i=document.createElement("form");i.className="edit-panel-form",i.innerHTML=this.generateFormHTML(t,s),i.addEventListener("submit",async e=>{e.preventDefault(),await this.saveEdit(i,s,n)}),n.querySelector(".modal-body").appendChild(i),document.body.appendChild(n)}openSubmissionModal(e,t){const s=this.createModal("Submit Additional Information"),n=document.createElement("form");n.className="submission-panel-form",n.innerHTML=this.generateSubmissionFormHTML(t),n.addEventListener("submit",async e=>{e.preventDefault(),await this.saveSubmission(n,t,s)}),s.querySelector(".modal-body").appendChild(n),document.body.appendChild(s)}generateFormHTML(e,t){const s=this.getFieldsForContentType(t.contentType);let n="";return s.forEach(t=>{const s=e[t.key]||"";"textarea"===t.type?n+=`\n          <div class="form-group">\n            <label for="${t.key}">${t.label}</label>\n            <textarea id="${t.key}" name="${t.key}" rows="4" required>${s}</textarea>\n          </div>\n        `:"array"===t.type?n+=`\n          <div class="form-group">\n            <label for="${t.key}">${t.label}</label>\n            <input type="text" id="${t.key}" name="${t.key}"\n                   value="${Array.isArray(s)?s.join(", "):s}"\n                   placeholder="Comma-separated values">\n          </div>\n        `:n+=`\n          <div class="form-group">\n            <label for="${t.key}">${t.label}</label>\n            <input type="${t.type||"text"}" id="${t.key}" name="${t.key}"\n                   value="${s}" ${t.required?"required":""}>\n          </div>\n        `}),n+='\n      <div class="form-actions">\n        <button type="button" class="btn-cancel">Cancel</button>\n        <button type="submit" class="btn-submit">Save Changes</button>\n      </div>\n    ',n}generateSubmissionFormHTML(e){return'\n      <div class="form-group">\n        <label for="submission-title">Title</label>\n        <input type="text" id="submission-title" name="title" required placeholder="Brief title for your submission">\n      </div>\n      <div class="form-group">\n        <label for="submission-content">Content</label>\n        <textarea id="submission-content" name="content" rows="6" required placeholder="Your additional information, insights, or corrections..."></textarea>\n      </div>\n      <div class="form-group">\n        <label for="submission-sources">Sources (optional)</label>\n        <input type="text" id="submission-sources" name="sources" placeholder="Citations or references">\n      </div>\n      <div class="form-actions">\n        <button type="button" class="btn-cancel">Cancel</button>\n        <button type="submit" class="btn-submit">Submit</button>\n      </div>\n    '}async saveEdit(e,t,s){if(!this.currentUser)return void this.showError("You must be logged in to edit");const n=new FormData(e),i={};for(const[e,t]of n.entries())t.includes(",")?i[e]=t.split(",").map(e=>e.trim()):i[e]=t;i.updatedAt=firebase.firestore.FieldValue.serverTimestamp(),i.updatedBy=this.currentUser.uid;try{await this.db.collection(t.collection).doc(t.documentId).update(i),this.showSuccess("Content updated successfully!"),this.closeModal(s),setTimeout(()=>window.location.reload(),1e3)}catch(e){this.showError("Failed to update content: "+e.message)}}async saveSubmission(e,t,s){if(!this.currentUser)return void this.showError("You must be logged in to submit");const n=new FormData(e),i={title:n.get("title"),content:n.get("content"),sources:n.get("sources"),parentCollection:t.collection,parentDocumentId:t.documentId,contentType:t.contentType,submittedBy:this.currentUser.uid,submittedByEmail:this.currentUser.email,submittedAt:firebase.firestore.FieldValue.serverTimestamp(),status:"pending",upvotes:0,downvotes:0};try{await this.db.collection("submissions").add(i),this.showSuccess("Submission received! It will be reviewed by moderators."),this.closeModal(s),setTimeout(()=>window.location.reload(),1e3)}catch(e){this.showError("Failed to submit: "+e.message)}}async loadSubmissions(e,t){try{const s=await this.db.collection("submissions").where("parentCollection","==",t.collection).where("parentDocumentId","==",t.documentId).where("status","==","approved").orderBy("submittedAt","desc").get();if(s.empty)return;const n=this.createSubmissionsPanel(s.docs);e.appendChild(n)}catch(e){}}createSubmissionsPanel(e){const t=document.createElement("div");t.className="submissions-panel expandable";const s=document.createElement("div");s.className="submissions-header",s.innerHTML=`\n      <h4>Community Submissions (${e.length})</h4>\n      <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <polyline points="6 9 12 15 18 9"></polyline>\n      </svg>\n    `;const n=document.createElement("div");return n.className="submissions-content",e.forEach(e=>{const t=e.data(),s=this.createSubmissionCard(e.id,t);n.appendChild(s)}),s.addEventListener("click",()=>{t.classList.toggle("expanded")}),t.appendChild(s),t.appendChild(n),t}createSubmissionCard(e,t){const s=document.createElement("div");s.className="submission-card frosted-glass";const n=this.currentUser&&t.submittedBy===this.currentUser.uid;return s.innerHTML=`\n      <div class="submission-header">\n        <h5>${t.title}</h5>\n        ${n?`<button class="edit-submission-btn" data-id="${e}">âœŽ</button>`:""}\n      </div>\n      <div class="submission-body">\n        <p>${t.content}</p>\n        ${t.sources?`<p class="submission-sources"><strong>Sources:</strong> ${t.sources}</p>`:""}\n      </div>\n      <div class="submission-meta">\n        <span class="submitted-by">By ${t.submittedByEmail||"Anonymous"}</span>\n        <span class="submitted-date">${this.formatDate(t.submittedAt)}</span>\n      </div>\n    `,n&&s.querySelector(".edit-submission-btn").addEventListener("click",()=>{this.editSubmission(e,t)}),s}async editSubmission(e,t){const s=this.createModal("Edit Submission"),n=document.createElement("form");n.innerHTML=`\n      <div class="form-group">\n        <label for="edit-title">Title</label>\n        <input type="text" id="edit-title" name="title" value="${t.title}" required>\n      </div>\n      <div class="form-group">\n        <label for="edit-content">Content</label>\n        <textarea id="edit-content" name="content" rows="6" required>${t.content}</textarea>\n      </div>\n      <div class="form-group">\n        <label for="edit-sources">Sources</label>\n        <input type="text" id="edit-sources" name="sources" value="${t.sources||""}">\n      </div>\n      <div class="form-actions">\n        <button type="button" class="btn-cancel">Cancel</button>\n        <button type="submit" class="btn-submit">Save Changes</button>\n      </div>\n    `,n.addEventListener("submit",async t=>{t.preventDefault();const i=new FormData(n);try{await this.db.collection("submissions").doc(e).update({title:i.get("title"),content:i.get("content"),sources:i.get("sources"),updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),this.showSuccess("Submission updated!"),this.closeModal(s),setTimeout(()=>window.location.reload(),1e3)}catch(e){this.showError("Failed to update: "+e.message)}}),s.querySelector(".modal-body").appendChild(n),document.body.appendChild(s)}createModal(e){const t=document.createElement("div");return t.className="editable-panel-modal frosted-glass",t.innerHTML=`\n      <div class="modal-content">\n        <div class="modal-header">\n          <h3>${e}</h3>\n          <button class="modal-close">&times;</button>\n        </div>\n        <div class="modal-body"></div>\n      </div>\n    `,t.querySelector(".modal-close").addEventListener("click",()=>{this.closeModal(t)}),t.addEventListener("click",e=>{e.target===t&&this.closeModal(t)}),setTimeout(()=>{const e=t.querySelector(".btn-cancel");e&&e.addEventListener("click",()=>this.closeModal(t))},100),t}closeModal(e){e.classList.add("closing"),setTimeout(()=>e.remove(),300)}updateEditIcons(){document.querySelectorAll(".editable-panel").forEach(e=>{const t={contentType:e.dataset.contentType,documentId:e.dataset.documentId,collection:e.dataset.collection};this.checkOwnership(e,t)})}async checkOwnership(e,t){if(this.currentUser)try{const s=await this.db.collection(t.collection).doc(t.documentId).get();s.exists&&s.data().createdBy===this.currentUser.uid&&this.addEditIcon(e,t)}catch(e){}}getFieldsForContentType(e){return{deity:[{key:"displayName",label:"Name",type:"text",required:!0},{key:"description",label:"Description",type:"textarea",required:!0},{key:"domains",label:"Domains",type:"array"},{key:"symbols",label:"Symbols",type:"array"},{key:"mythology",label:"Mythology",type:"text",required:!0}],myth:[{key:"displayName",label:"Title",type:"text",required:!0},{key:"description",label:"Story",type:"textarea",required:!0},{key:"characters",label:"Characters",type:"array"},{key:"themes",label:"Themes",type:"array"}],ritual:[{key:"displayName",label:"Name",type:"text",required:!0},{key:"description",label:"Description",type:"textarea",required:!0},{key:"purpose",label:"Purpose",type:"text"},{key:"steps",label:"Steps",type:"textarea"}]}[e]||[{key:"displayName",label:"Name",type:"text",required:!0},{key:"description",label:"Description",type:"textarea",required:!0}]}showLoginPrompt(){const e=this.createModal("Login Required");e.querySelector(".modal-body").innerHTML='\n      <p>You must be logged in to edit or submit content.</p>\n      <div class="form-actions">\n        <button class="btn-cancel">Cancel</button>\n        <button class="btn-submit" onclick="window.location.href=\'/login.html\'">Login</button>\n      </div>\n    ',document.body.appendChild(e)}showSuccess(e){this.showToast(e,"success")}showError(e){this.showToast(e,"error")}showToast(e,t="info"){const s=document.createElement("div");s.className=`toast toast-${t} frosted-glass`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>s.classList.add("show"),100),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}formatDate(e){return e?(e.toDate?e.toDate():new Date(e)).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):""}}window.EditablePanelSystem=EditablePanelSystem;
class FirebaseEntityRenderer{constructor(){this.db=null,this.currentEntity=null,this.mythology=null}async init(){if(!this.db){if(!firebase||!firebase.firestore)throw new Error("Firebase not initialized. Include Firebase SDK before this script.");this.db=firebase.firestore()}}async loadAndRender(e,t,n,s){await this.init();try{const i=await this.fetchEntity(e,t);if(!i)return void this.renderError(s,`Entity not found: ${e}/${t}`);switch(this.currentEntity=i,this.mythology=n||i.mythology||i.mythologies?.[0],this.applyMythologyStyles(s,this.mythology),i.type){case"deity":this.renderDeity(i,s);break;case"hero":this.renderHero(i,s);break;case"creature":this.renderCreature(i,s);break;case"item":this.renderItem(i,s);break;case"place":this.renderPlace(i,s);break;case"concept":this.renderConcept(i,s);break;case"magic":this.renderMagicSystem(i,s);break;case"theory":this.renderTheory(i,s);break;default:this.renderGenericEntity(i,s)}this.updatePageMetadata(i)}catch(e){this.renderError(s,`Failed to load entity: ${e.message}`)}}async fetchEntity(e,t){const n=this.getCollectionName(e),s=await this.db.collection(n).doc(t).get();return s.exists?{id:s.id,...s.data()}:null}getCollectionName(e){return{deity:"deities",hero:"heroes",creature:"creatures",item:"items",place:"places",concept:"concepts",magic:"magic",theory:"user_theories",mythology:"mythologies"}[e]||e}applyMythologyStyles(e,t){if(e.removeAttribute("data-mythology"),t&&e.setAttribute("data-mythology",t.toLowerCase()),!document.querySelector('link[href*="mythology-colors.css"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="/themes/mythology-colors.css",document.head.appendChild(e)}}renderDeity(e,t){t.style.position="relative";const n=`\n            ${this.renderEditIcon(e)}\n\n            \x3c!-- Deity Header --\x3e\n            <section class="deity-header">\n                <div class="deity-icon">${e.visual?.icon||e.icon||this.getDefaultIcon("deity")}</div>\n                <h2>${this.escapeHtml(e.name||e.title)}</h2>\n                ${e.subtitle?`<p class="subtitle" style="font-size: 1.5rem; margin: 0.5rem 0;">${this.escapeHtml(e.subtitle)}</p>`:""}\n                ${e.description?`<p style="font-size: 1.1rem; margin-top: 1rem;">${this.escapeHtml(e.description)}</p>`:""}\n            </section>\n\n            \x3c!-- Attributes & Domains --\x3e\n            <section>\n                <h2 style="color: var(--mythos-primary);">Attributes & Domains</h2>\n                <div class="attribute-grid">\n                    ${this.renderDeityAttributes(e)}\n                </div>\n            </section>\n\n            \x3c!-- Mythology & Stories --\x3e\n            ${e.mythsAndLegends?.length?`\n            <section>\n                <h2 style="color: var(--mythos-primary);">Mythology & Stories</h2>\n                <div class="glass-card">\n                    ${e.mythsAndLegends.map(e=>`\n                        <div class="subsection-card accent-border-left" style="margin-bottom: 1rem;">\n                            <h4 style="color: var(--mythos-secondary);">${this.escapeHtml(e.title||e.name)}</h4>\n                            <p>${this.escapeHtml(e.description||e.summary)}</p>\n                        </div>\n                    `).join("")}\n                </div>\n            </section>\n            `:""}\n\n            \x3c!-- Family Relationships --\x3e\n            ${e.family?`\n            <section>\n                <h2 style="color: var(--mythos-primary);">Family & Relationships</h2>\n                <div class="glass-card">\n                    ${this.renderFamilyRelationships(e.family)}\n                </div>\n            </section>\n            `:""}\n\n            \x3c!-- Worship & Sacred Sites --\x3e\n            ${e.worship||e.cultCenters?`\n            <section>\n                <h2 style="color: var(--mythos-primary);">Worship & Sacred Sites</h2>\n                <div class="glass-card">\n                    ${e.worship?`<p>${this.escapeHtml(e.worship)}</p>`:""}\n                    ${e.cultCenters?.length?`\n                        <h4 style="color: var(--mythos-secondary); margin-top: 1rem;">Sacred Sites</h4>\n                        <ul>\n                            ${e.cultCenters.map(e=>`<li>${this.escapeHtml(e)}</li>`).join("")}\n                        </ul>\n                    `:""}\n                </div>\n            </section>\n            `:""}\n\n            \x3c!-- Content (Markdown) --\x3e\n            ${e.content?`\n            <section>\n                <div class="glass-card">\n                    ${this.renderMarkdown(e.content)}\n                </div>\n            </section>\n            `:""}\n\n            \x3c!-- Related Entities --\x3e\n            ${e.relatedEntities?.length?`\n            <section>\n                <h2 style="color: var(--mythos-primary);">Related Entities</h2>\n                ${this.renderRelatedEntities(e.relatedEntities,"relatedEntities",e.displayOptions)}\n            </section>\n            `:""}\n\n            \x3c!-- Sources --\x3e\n            ${e.sources?.length?`\n            <section>\n                <h3 style="color: var(--mythos-secondary);">Sources & References</h3>\n                <div class="glass-card">\n                    <ul>\n                        ${e.sources.map(e=>`<li>${this.escapeHtml(e)}</li>`).join("")}\n                    </ul>\n                </div>\n            </section>\n            `:""}\n        `;t.innerHTML=n}renderDeityAttributes(e){const t=[];return(e.titles?.length||e.epithets?.length)&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Titles</div>\n                    <div class="attribute-value">${(e.titles||e.epithets||[]).join(", ")}</div>\n                </div>\n            `),e.domains?.length&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Domains</div>\n                    <div class="attribute-value">${e.domains.join(", ")}</div>\n                </div>\n            `),e.symbols?.length&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Symbols</div>\n                    <div class="attribute-value">${e.symbols.join(", ")}</div>\n                </div>\n            `),e.sacredAnimals?.length&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Sacred Animals</div>\n                    <div class="attribute-value">${e.sacredAnimals.join(", ")}</div>\n                </div>\n            `),e.sacredPlants?.length&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Sacred Plants</div>\n                    <div class="attribute-value">${e.sacredPlants.join(", ")}</div>\n                </div>\n            `),e.sacredPlaces?.length&&t.push(`\n                <div class="attribute-card">\n                    <div class="attribute-label">Sacred Places</div>\n                    <div class="attribute-value">${e.sacredPlaces.join(", ")}</div>\n                </div>\n            `),t.join("")}renderFamilyRelationships(e){const t=[];if(e.parents?.length&&t.push(`\n                <div class="subsection-card">\n                    <div class="subsection-title">Parents</div>\n                    <p>${e.parents.join(", ")}</p>\n                </div>\n            `),e.consorts?.length||e.spouses?.length){const n=e.consorts||e.spouses||[];t.push(`\n                <div class="subsection-card">\n                    <div class="subsection-title">Consorts</div>\n                    <p>${n.join(", ")}</p>\n                </div>\n            `)}if(e.children?.length||e.offspring?.length){const n=e.children||e.offspring||[];t.push(`\n                <div class="subsection-card">\n                    <div class="subsection-title">Children</div>\n                    <p>${n.join(", ")}</p>\n                </div>\n            `)}return e.siblings?.length&&t.push(`\n                <div class="subsection-card">\n                    <div class="subsection-title">Siblings</div>\n                    <p>${e.siblings.join(", ")}</p>\n                </div>\n            `),t.join("")}renderRelatedEntities(e,t="relatedEntities",n=null){const s=n?.[t]||this.getDefaultDisplayConfig();switch(s.mode){case"grid":default:return this.renderRelatedEntitiesGrid(e,s);case"list":return this.renderRelatedEntitiesList(e,s);case"table":return this.renderRelatedEntitiesTable(e,s);case"panel":return this.renderRelatedEntitiesPanel(e,s)}}renderRelatedEntitiesGrid(e,t){const n=t.columns||4,s=!1!==t.showIcons,i=t.cardStyle||"compact";return`\n            <div class="entity-grid" style="display: grid; grid-template-columns: repeat(${n}, 1fr); gap: 1rem;">\n                ${this.sortEntities(e,t.sort).map(e=>`\n                    <div class="glass-card entity-card entity-card-${i}" style="padding: 1rem;">\n                        ${s&&e.icon?`<div class="entity-icon" style="font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">${e.icon}</div>`:""}\n                        <h4 style="color: var(--mythos-primary); margin: 0 0 0.5rem 0; font-size: ${"minimal"===i?"0.9rem":"1rem"};">\n                            ${this.escapeHtml(e.name)}\n                        </h4>\n                        ${"minimal"!==i?`\n                            <p style="font-size: 0.85rem; margin: 0; color: var(--mythos-text-secondary);">\n                                ${this.escapeHtml(e.relationship||e.description||e.type||"")}\n                            </p>\n                        `:""}\n                        ${"detailed"===i&&e.mythology?`\n                            <small style="display: block; margin-top: 0.5rem; opacity: 0.7;">\n                                ${this.escapeHtml(e.mythology)}\n                            </small>\n                        `:""}\n                    </div>\n                `).join("")}\n            </div>\n        `}renderRelatedEntitiesList(e,t){const n=!1!==t.showIcons,s=t.compact||!1,i=t.categorize||"none";let r=this.sortEntities(e,t.sort);return"none"!==i?this.renderCategorizedList(r,t,i):`\n            <div class="entity-list" style="display: flex; flex-direction: column; gap: ${s?"0.5rem":"1rem"};">\n                ${r.map(e=>`\n                    <div class="glass-card entity-list-item" style="padding: ${s?"0.75rem":"1rem"}; display: flex; align-items: center; gap: 1rem;">\n                        ${n&&e.icon?`<span class="entity-icon" style="font-size: 1.25rem;">${e.icon}</span>`:""}\n                        <div style="flex: 1;">\n                            <strong style="color: var(--mythos-primary);">${this.escapeHtml(e.name)}</strong>\n                            ${!s&&e.relationship?`\n                                <span style="margin-left: 0.5rem; opacity: 0.8;">- ${this.escapeHtml(e.relationship)}</span>\n                            `:""}\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n        `}renderCategorizedList(e,t,n){const s={};e.forEach(e=>{let t="Other";switch(n){case"by_domain":t=e.domain||e.type||"Other";break;case"by_mythology":t=e.mythology||"Other";break;case"by_importance":t=e.importance||"Standard";break;case"alphabetical":t=e.name?e.name.charAt(0).toUpperCase():"Other"}s[t]||(s[t]=[]),s[t].push(e)});const i=!1!==t.showIcons,r=t.compact||!1;return Object.keys(s).sort().map(e=>`\n            <div class="entity-category" style="margin-bottom: 1.5rem;">\n                <h4 style="color: var(--mythos-secondary); margin-bottom: 0.75rem; font-size: 1rem;">\n                    ${this.escapeHtml(e)}\n                </h4>\n                <div class="entity-list" style="display: flex; flex-direction: column; gap: ${r?"0.5rem":"0.75rem"};">\n                    ${s[e].map(e=>`\n                        <div class="glass-card entity-list-item" style="padding: ${r?"0.5rem 0.75rem":"0.75rem 1rem"}; display: flex; align-items: center; gap: 0.75rem;">\n                            ${i&&e.icon?`<span style="font-size: 1rem;">${e.icon}</span>`:""}\n                            <strong style="color: var(--mythos-primary); font-size: ${r?"0.9rem":"1rem"};">\n                                ${this.escapeHtml(e.name)}\n                            </strong>\n                            ${!r&&e.relationship?`\n                                <span style="margin-left: 0.5rem; opacity: 0.8; font-size: 0.85rem;">\n                                    ${this.escapeHtml(e.relationship)}\n                                </span>\n                            `:""}\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `).join("")}renderRelatedEntitiesTable(e,t){const n=t.columns||["name","description","mythology"],s=!1!==t.sortable,i=this.sortEntities(e,t.sort||"name");return`\n            <div class="glass-card" style="padding: 1rem; overflow-x: auto;">\n                <table class="entity-table" style="width: 100%; border-collapse: collapse;">\n                    <thead>\n                        <tr>\n                            ${n.map(e=>`\n                                <th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid var(--mythos-border); color: var(--mythos-primary); font-weight: 600;">\n                                    ${this.capitalize(e.replace("_"," "))}\n                                    ${s?'<span style="opacity: 0.5; margin-left: 0.25rem;">‚áÖ</span>':""}\n                                </th>\n                            `).join("")}\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${i.map(e=>`\n                            <tr style="border-bottom: 1px solid var(--mythos-border);">\n                                ${n.map(t=>{let n=e[t]||"-";return"name"===t?n=`<strong style="color: var(--mythos-primary);">${this.escapeHtml(e.name)}</strong>`:Array.isArray(n)&&(n=n.join(", ")),`<td style="padding: 0.75rem;">${"string"!=typeof n||t.includes("name")?n:this.escapeHtml(n)}</td>`}).join("")}\n                            </tr>\n                        `).join("")}\n                    </tbody>\n                </table>\n            </div>\n        `}renderRelatedEntitiesPanel(e,t){const n=!1!==t.showAllDetails,s=t.expandable||!1,i=t.layout||"stacked",r=this.sortEntities(e,t.sort||"name");return"accordion"===i?this.renderAccordionPanels(r,n):`\n            <div class="entity-panels" style="display: flex; flex-direction: column; gap: 1rem;">\n                ${r.map((e,t)=>`\n                    <div class="glass-card entity-panel ${s?"expandable":""}"\n                         style="padding: 1.5rem; ${s?"cursor: pointer;":""}"\n                         ${s?`data-panel-id="${t}"`:""}>\n                        <div class="panel-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: ${n?"1rem":"0"};">\n                            ${e.icon?`<span style="font-size: 1.5rem;">${e.icon}</span>`:""}\n                            <h4 style="color: var(--mythos-primary); margin: 0; flex: 1;">\n                                ${this.escapeHtml(e.name)}\n                            </h4>\n                            ${s?'<span class="expand-indicator">‚ñº</span>':""}\n                        </div>\n                        ${n?`\n                            <div class="panel-content" style="opacity: 0.9;">\n                                ${e.relationship?`<p style="margin: 0 0 0.5rem 0;"><strong>Relationship:</strong> ${this.escapeHtml(e.relationship)}</p>`:""}\n                                ${e.description?`<p style="margin: 0 0 0.5rem 0;">${this.escapeHtml(e.description)}</p>`:""}\n                                ${e.mythology?`<p style="margin: 0; font-size: 0.9rem; opacity: 0.7;"><strong>Mythology:</strong> ${this.escapeHtml(e.mythology)}</p>`:""}\n                                ${e.domain?`<p style="margin: 0; font-size: 0.9rem; opacity: 0.7;"><strong>Domain:</strong> ${this.escapeHtml(e.domain)}</p>`:""}\n                            </div>\n                        `:""}\n                    </div>\n                `).join("")}\n            </div>\n        `}renderAccordionPanels(e,t){return`\n            <div class="entity-accordion" style="display: flex; flex-direction: column; gap: 0.5rem;">\n                ${e.map((e,t)=>`\n                    <div class="glass-card accordion-item" style="overflow: hidden;">\n                        <div class="accordion-header"\n                             style="padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 1rem;"\n                             onclick="this.parentElement.classList.toggle('expanded')">\n                            ${e.icon?`<span style="font-size: 1.25rem;">${e.icon}</span>`:""}\n                            <strong style="color: var(--mythos-primary); flex: 1;">${this.escapeHtml(e.name)}</strong>\n                            <span class="accordion-indicator" style="transition: transform 0.3s;">‚ñº</span>\n                        </div>\n                        <div class="accordion-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s;">\n                            <div style="padding: 0 1rem 1rem 1rem; opacity: 0.9;">\n                                ${e.relationship?`<p style="margin: 0 0 0.5rem 0;"><strong>Relationship:</strong> ${this.escapeHtml(e.relationship)}</p>`:""}\n                                ${e.description?`<p style="margin: 0 0 0.5rem 0;">${this.escapeHtml(e.description)}</p>`:""}\n                                ${e.mythology?`<p style="margin: 0; font-size: 0.9rem; opacity: 0.7;">${this.escapeHtml(e.mythology)}</p>`:""}\n                            </div>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            <style>\n                .accordion-item.expanded .accordion-content {\n                    max-height: 500px;\n                }\n                .accordion-item.expanded .accordion-indicator {\n                    transform: rotate(180deg);\n                }\n            </style>\n        `}sortEntities(e,t){const n=[...e];switch(t){case"name":default:n.sort((e,t)=>(e.name||"").localeCompare(t.name||""));break;case"name-desc":n.sort((e,t)=>(t.name||"").localeCompare(e.name||""));break;case"importance":n.sort((e,t)=>(t.importance||0)-(e.importance||0));break;case"date":n.sort((e,t)=>(e.date||0)-(t.date||0));case"custom":}return n}getDefaultDisplayConfig(){return{mode:"grid",columns:4,sort:"name",showIcons:!0}}renderHero(e,t){this.renderGenericEntity(e,t)}renderCreature(e,t){this.renderGenericEntity(e,t)}renderGenericEntity(e,t){t.style.position="relative";const n=`\n            ${this.renderEditIcon(e)}\n\n            <section class="entity-header">\n                <div class="entity-icon">${e.visual?.icon||e.icon||this.getDefaultIcon(e.type)}</div>\n                <h2>${this.escapeHtml(e.name||e.title)}</h2>\n                ${e.subtitle?`<p class="subtitle">${this.escapeHtml(e.subtitle)}</p>`:""}\n                ${e.description?`<p>${this.escapeHtml(e.description)}</p>`:""}\n            </section>\n\n            ${e.content?`\n            <section class="glass-card">\n                ${this.renderMarkdown(e.content)}\n            </section>\n            `:""}\n        `;t.innerHTML=n}renderEditIcon(e){if(!this.canUserEdit(e))return"";const t=this.getCollectionName(e.type);return`\n            <button class="edit-icon-btn"\n                    data-entity-id="${e.id}"\n                    data-collection="${t}"\n                    aria-label="Edit ${e.name}"\n                    title="Edit this ${e.type}">\n                ‚úèÔ∏è\n            </button>\n        `}canUserEdit(e){if(!firebase||!firebase.auth)return!1;const t=firebase.auth().currentUser;return!!t&&e.createdBy===t.uid}renderMarkdown(e){return e.replace(/^### (.*$)/gim,'<h3 style="color: var(--mythos-secondary);">$1</h3>').replace(/^## (.*$)/gim,'<h2 style="color: var(--mythos-primary);">$1</h2>').replace(/^# (.*$)/gim,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}getDefaultIcon(e){return{deity:"‚ö°",hero:"üó°Ô∏è",creature:"üêâ",item:"‚öîÔ∏è",place:"üèõÔ∏è",concept:"üí≠",magic:"üîÆ",theory:"üî¨",mythology:"üìú"}[e]||"‚ú®"}updatePageMetadata(e){document.title=`${e.name} - ${this.capitalize(this.mythology)} Mythology - Eyes of Azrael`;let t=document.querySelector('meta[name="description"]');t||(t=document.createElement("meta"),t.name="description",document.head.appendChild(t)),t.content=e.description||`Learn about ${e.name}, ${e.subtitle||e.type} in ${this.capitalize(this.mythology)} mythology.`}renderError(e,t){e.innerHTML=`\n            <div class="glass-card" style="border-color: #DC143C; background: rgba(220, 20, 60, 0.1);">\n                <h2 style="color: #DC143C;">Error</h2>\n                <p>${this.escapeHtml(t)}</p>\n                <p><a href="/mythos/index.html">Return to Home</a></p>\n            </div>\n        `}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}capitalize(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}}window.FirebaseEntityRenderer=FirebaseEntityRenderer,document.addEventListener("DOMContentLoaded",async()=>{const e=new URLSearchParams(window.location.search),t=e.get("type"),n=e.get("id"),s=e.get("mythology");if("true"===e.get("firebase")&&t&&n){const e=document.querySelector("main")||document.body,i=new FirebaseEntityRenderer;await i.loadAndRender(t,n,s,e)}});
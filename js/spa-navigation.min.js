class SPANavigation{constructor(e,t,n){performance.now(),this.db=e,this.auth=t,this.renderer=n,this.currentRoute=null,this.routeHistory=[],this.maxHistory=50,this.authReady=!1,this.routes={home:/^#?\/?$/,mythology:/^#?\/mythology\/([^\/]+)\/?$/,entity:/^#?\/mythology\/([^\/]+)\/([^\/]+)\/([^\/]+)\/?$/,category:/^#?\/mythology\/([^\/]+)\/([^\/]+)\/?$/,search:/^#?\/search\/?$/,compare:/^#?\/compare\/?$/,dashboard:/^#?\/dashboard\/?$/,about:/^#?\/about\/?$/,privacy:/^#?\/privacy\/?$/,terms:/^#?\/terms\/?$/},performance.now();const r=firebase.auth().currentUser;performance.now(),r?(performance.now(),this.authReady=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initRouter()}):this.initRouter()):this.waitForAuth().then(e=>{performance.now(),this.authReady=!0,this.initRouter()}).catch(e=>{})}async waitForAuth(){return new Promise((e,t)=>{const n=firebase.auth();if(!n)return void t(new Error("Firebase auth not available"));const r=n.onAuthStateChanged(t=>{(new Date).toISOString(),r(),e(t)})})}initRouter(){window.addEventListener("hashchange",()=>{this.handleRoute()}),window.addEventListener("popstate",()=>{this.handleRoute()}),document.addEventListener("click",e=>{if(e.target.matches('a[href^="#"]')||e.target.closest('a[href^="#"]')){const t=e.target.matches("a")?e.target:e.target.closest("a");t.hash&&(e.preventDefault(),this.navigate(t.hash))}}),this.handleRoute()}navigate(e){e.startsWith("#")||(e="#"+e),window.location.hash=e}async handleRoute(){(new Date).toISOString();const e=(window.location.hash||"#/").replace("#","");window.AnalyticsManager&&window.AnalyticsManager.trackPageView(e),this.currentRoute&&window.AnalyticsManager&&window.AnalyticsManager.trackNavigation(this.currentRoute,e);const t=document.getElementById("main-content");if(this.authReady)if(firebase.auth().currentUser){this.addToHistory(e),this.showLoading();try{if(this.routes.home.test(e))await this.renderHome();else if(this.routes.entity.test(e)){const t=e.match(this.routes.entity);await this.renderEntity(t[1],t[2],t[3])}else if(this.routes.category.test(e)){const t=e.match(this.routes.category);await this.renderCategory(t[1],t[2])}else if(this.routes.mythology.test(e)){const t=e.match(this.routes.mythology);await this.renderMythology(t[1])}else this.routes.search.test(e)?await this.renderSearch():this.routes.compare.test(e)?await this.renderCompare():this.routes.dashboard.test(e)?await this.renderDashboard():this.routes.about.test(e)?await this.renderAbout():this.routes.privacy.test(e)?await this.renderPrivacy():this.routes.terms.test(e)?await this.renderTerms():await this.render404();this.updateBreadcrumb(e),this.currentRoute=e}catch(e){this.renderError(e)}}else this.showAuthWaitingState(t);else this.showAuthWaitingState(t)}async renderHome(){const e=document.getElementById("main-content");if(!e)return void document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"home",error:"main-content element not found",timestamp:Date.now()}}));if("undefined"!=typeof PageAssetRenderer)try{const t=new PageAssetRenderer(this.db);if(await t.loadPage("home"))return await t.renderPage("home",e),void document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"home",renderer:"PageAssetRenderer",timestamp:Date.now()}}))}catch(e){}if("undefined"!=typeof HomeView){const t=new HomeView(this.db);return await t.render(e),void document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"home",renderer:"HomeView",timestamp:Date.now()}}))}const t=[{id:"greek",name:"Greek",icon:"üèõÔ∏è",color:"#4A90E2"},{id:"norse",name:"Norse",icon:"‚öîÔ∏è",color:"#7C4DFF"},{id:"egyptian",name:"Egyptian",icon:"üî∫",color:"#FFB300"},{id:"hindu",name:"Hindu",icon:"üïâÔ∏è",color:"#E91E63"},{id:"chinese",name:"Chinese",icon:"üêâ",color:"#F44336"},{id:"japanese",name:"Japanese",icon:"‚õ©Ô∏è",color:"#FF5722"},{id:"celtic",name:"Celtic",icon:"üçÄ",color:"#4CAF50"},{id:"babylonian",name:"Babylonian",icon:"üè∫",color:"#795548"},{id:"sumerian",name:"Sumerian",icon:"üìú",color:"#9E9E9E"},{id:"persian",name:"Persian",icon:"ü¶Å",color:"#00BCD4"},{id:"roman",name:"Roman",icon:"üèõÔ∏è",color:"#673AB7"},{id:"aztec",name:"Aztec",icon:"‚òÄÔ∏è",color:"#FF9800"},{id:"mayan",name:"Mayan",icon:"üóø",color:"#8BC34A"},{id:"buddhist",name:"Buddhist",icon:"‚ò∏Ô∏è",color:"#FFEB3B"},{id:"christian",name:"Christian",icon:"‚úùÔ∏è",color:"#2196F3"},{id:"yoruba",name:"Yoruba",icon:"üëë",color:"#9C27B0"}];e.innerHTML=`\n            <div class="home-container">\n                <div class="hero-section">\n                    <h1 class="hero-title">Explore World Mythologies</h1>\n                    <p class="hero-subtitle">Discover deities, heroes, creatures, and sacred texts from cultures across the globe</p>\n\n                    <div class="hero-search">\n                        <input type="text" id="quick-search" placeholder="Search across all mythologies..." class="search-input-large">\n                        <button id="search-btn" class="btn-primary btn-large">\n                            üîç Search\n                        </button>\n                    </div>\n                </div>\n\n                <div class="mythologies-grid">\n                    ${t.map(e=>`\n                        <a href="#/mythology/${e.id}" class="mythology-card" data-mythology="${e.id}">\n                            <div class="myth-icon" style="color: ${e.color}">${e.icon}</div>\n                            <h3 class="myth-name">${e.name}</h3>\n                            <div class="myth-count" id="count-${e.id}">Loading...</div>\n                        </a>\n                    `).join("")}\n                </div>\n\n                <div class="featured-section">\n                    <h2>Featured Entities</h2>\n                    <div id="featured-entities" class="entity-grid">\n                        Loading...\n                    </div>\n                </div>\n            </div>\n        `,this.loadMythologyCounts(t),this.loadFeaturedEntities();const n=document.getElementById("search-btn"),r=document.getElementById("quick-search");n&&r&&(n.addEventListener("click",()=>{const e=r.value;e&&this.navigate(`/search?q=${encodeURIComponent(e)}`)}),r.addEventListener("keypress",e=>{"Enter"===e.key&&n.click()})),document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"home",renderer:"inline-fallback",timestamp:Date.now()}}))}async loadMythologyCounts(e){const t=["deities","heroes","creatures","texts","places","items"];for(const n of e){let e=0;for(const r of t)try{e+=(await this.db.collection(r).where("mythology","==",n.id).get()).size}catch(e){}const r=document.getElementById(`count-${n.id}`);r&&(r.textContent=`${e} entities`)}}async loadFeaturedEntities(){const e=document.getElementById("featured-entities");if(e)try{const t=(await this.db.collection("deities").where("importance",">=",90).orderBy("importance","desc").limit(12).get()).docs.map(e=>({id:e.id,...e.data()}));t.length>0?e.innerHTML=this.renderer.render(t,"grid"):e.innerHTML="<p>No featured entities found</p>"}catch(t){e.innerHTML='<p class="error">Error loading featured entities</p>'}}async renderMythology(e){try{document.getElementById("main-content").innerHTML=`<div class="mythology-page"><h1>${e} Mythology</h1><p>Coming soon...</p></div>`,document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"mythology",mythologyId:e,timestamp:Date.now()}}))}catch(t){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"mythology",mythologyId:e,error:t.message,timestamp:Date.now()}})),t}}async renderCategory(e,t){try{document.getElementById("main-content").innerHTML=`<div class="category-page"><h1>${t} - ${e}</h1><p>Coming soon...</p></div>`,document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"category",mythology:e,category:t,timestamp:Date.now()}}))}catch(n){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"category",mythology:e,category:t,error:n.message,timestamp:Date.now()}})),n}}async renderEntity(e,t,n){try{document.getElementById("main-content").innerHTML=`<div class="entity-page"><h1>${n}</h1><p>Coming soon...</p></div>`,document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"entity",mythology:e,categoryType:t,entityId:n,timestamp:Date.now()}}))}catch(r){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"entity",mythology:e,categoryType:t,entityId:n,error:r.message,timestamp:Date.now()}})),r}}async renderSearch(){try{const e=document.getElementById("main-content");if("undefined"!=typeof SearchViewComplete){const t=new SearchViewComplete(this.db);return window.searchViewInstance=t,await t.render(e),void document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"search",renderer:"SearchViewComplete",timestamp:Date.now()}}))}if("undefined"!=typeof EnhancedCorpusSearch){const t=document.createElement("div");return t.id="search-container",e.innerHTML="",e.appendChild(t),new EnhancedCorpusSearch(this.db),void document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"search",renderer:"EnhancedCorpusSearch",timestamp:Date.now()}}))}e.innerHTML='\n                <div class="error-page">\n                    <h1>Search Not Available</h1>\n                    <p>The search component failed to load. Please refresh the page.</p>\n                    <a href="#/" class="btn-primary">Return Home</a>\n                </div>\n            '}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"search",error:e.message,timestamp:Date.now()}})),e}}async renderCompare(){try{const e=document.getElementById("main-content");if("undefined"==typeof CompareView)return void(e.innerHTML='\n                    <div class="error-page">\n                        <h1>Error</h1>\n                        <p>Compare component not loaded. Please refresh the page.</p>\n                    </div>\n                ');const t=new CompareView(this.db);await t.render(e),document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"compare",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"compare",error:e.message,timestamp:Date.now()}})),e}}async renderDashboard(){try{const e=document.getElementById("main-content");if("undefined"==typeof UserDashboard)return void(e.innerHTML='\n                    <div class="error-page">\n                        <h1>Error</h1>\n                        <p>Dashboard component not loaded. Please refresh the page.</p>\n                    </div>\n                ');if("undefined"==typeof FirebaseCRUDManager)return void(e.innerHTML='\n                    <div class="error-page">\n                        <h1>Error</h1>\n                        <p>CRUD manager not loaded. Please refresh the page.</p>\n                    </div>\n                ');const t=new FirebaseCRUDManager(this.db,firebase.auth()),n=new UserDashboard({crudManager:t,auth:firebase.auth()}),r=await n.render();e.innerHTML=r,n.initialize(e),document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"dashboard",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"dashboard",error:e.message,timestamp:Date.now()}})),e}}async renderAbout(){try{const e=document.getElementById("main-content");"undefined"!=typeof AboutPage?(new AboutPage).render(e):e.innerHTML='<div class="error">AboutPage component not loaded</div>',document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"about",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"about",error:e.message,timestamp:Date.now()}})),e}}async renderPrivacy(){try{const e=document.getElementById("main-content");"undefined"!=typeof PrivacyPage?(new PrivacyPage).render(e):e.innerHTML='<div class="error">PrivacyPage component not loaded</div>',document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"privacy",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"privacy",error:e.message,timestamp:Date.now()}})),e}}async renderTerms(){try{const e=document.getElementById("main-content");"undefined"!=typeof TermsPage?(new TermsPage).render(e):e.innerHTML='<div class="error">TermsPage component not loaded</div>',document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"terms",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"terms",error:e.message,timestamp:Date.now()}})),e}}async render404(){try{document.getElementById("main-content").innerHTML='\n                <div class="error-page">\n                    <h1>404</h1>\n                    <p>Page not found</p>\n                    <a href="#/" class="btn-primary">Return Home</a>\n                </div>\n            ',document.dispatchEvent(new CustomEvent("first-render-complete",{detail:{route:"404",timestamp:Date.now()}}))}catch(e){throw document.dispatchEvent(new CustomEvent("render-error",{detail:{route:"404",error:e.message,timestamp:Date.now()}})),e}}renderError(e){document.getElementById("main-content").innerHTML=`\n            <div class="error-page">\n                <h1>Error</h1>\n                <p>${e.message}</p>\n                <a href="#/" class="btn-primary">Return Home</a>\n            </div>\n        `}showLoading(){const e=document.getElementById("main-content");e&&(e.innerHTML='\n                <div class="loading-container">\n                    <div class="spinner-container">\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                    </div>\n                    <p class="loading-message">Loading...</p>\n                </div>\n            ')}showAuthWaitingState(e){e||(e=document.getElementById("main-content")),e&&(e.innerHTML='\n                <div class="loading-container" role="status">\n                    <div class="spinner-container">\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                        <div class="spinner-ring"></div>\n                    </div>\n                    <p class="loading-message">Preparing content...</p>\n                    <p class="loading-submessage">Verifying authentication...</p>\n                </div>\n            ')}updateBreadcrumb(e){}addToHistory(e){this.routeHistory.push({path:e,timestamp:Date.now()}),this.routeHistory.length>this.maxHistory&&(this.routeHistory=this.routeHistory.slice(-this.maxHistory))}getHistory(){return this.routeHistory}goBack(){window.history.back()}}"undefined"!=typeof module&&module.exports&&(module.exports=SPANavigation);
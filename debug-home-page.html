<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page Debug - Eyes of Azrael</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0e27;
            color: #f8f9fa;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .debug-section {
            background: #1a1f3a;
            border: 1px solid #2a2f4a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .debug-section h2 {
            color: #8b7fff;
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
        }
        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .status.pass { background: #1e4620; color: #51cf66; }
        .status.fail { background: #5c1a1a; color: #ff6b6b; }
        .status.pending { background: #3a3a1a; color: #ffd93d; }
        .log-entry {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #0f1424;
            border-left: 3px solid #8b7fff;
            font-size: 0.9rem;
        }
        .log-entry.error { border-left-color: #ff6b6b; color: #ff6b6b; }
        .log-entry.warn { border-left-color: #ffd93d; color: #ffd93d; }
        .log-entry.success { border-left-color: #51cf66; color: #51cf66; }
        button {
            background: #8b7fff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 1rem;
        }
        button:hover { background: #9d8fff; }
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .data-display {
            background: #0f1424;
            padding: 1rem;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.85rem;
        }
        #main-content {
            min-height: 300px;
            background: #0f1424;
            border: 2px solid #2a2f4a;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <h1>üîç Home Page Debug Tool</h1>

    <!-- Test 1: Check if scripts are loaded -->
    <div class="debug-section">
        <h2>1. Script Loading Check</h2>
        <div id="script-status"></div>
        <button onclick="checkScripts()">Check Scripts</button>
    </div>

    <!-- Test 2: Firebase Connection -->
    <div class="debug-section">
        <h2>2. Firebase Connection</h2>
        <div id="firebase-status"></div>
        <button onclick="testFirebase()">Test Firebase</button>
    </div>

    <!-- Test 3: Authentication Status -->
    <div class="debug-section">
        <h2>3. Authentication Status</h2>
        <div id="auth-status"></div>
        <button onclick="checkAuth()">Check Auth</button>
        <button onclick="signInAnonymously()">Sign In Anonymously</button>
    </div>

    <!-- Test 4: Home Page Rendering -->
    <div class="debug-section">
        <h2>4. Home Page Rendering Test</h2>
        <div id="render-status"></div>
        <button onclick="testHomeView()">Test HomeView</button>
        <button onclick="testSPANavigation()">Test SPA Navigation</button>
    </div>

    <!-- Test 5: Live Home Page Container -->
    <div class="debug-section">
        <h2>5. Live Home Page Preview</h2>
        <div id="main-content">
            <p style="color: #adb5bd;">Home page will render here...</p>
        </div>
    </div>

    <!-- Console Logs -->
    <div class="debug-section">
        <h2>Console Logs</h2>
        <div id="console-logs" class="data-display"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-cache-manager.js"></script>
    <script src="js/views/home-view.js"></script>
    <script src="js/page-asset-renderer.js"></script>
    <script src="js/components/universal-display-renderer.js"></script>
    <script src="js/spa-navigation.js"></script>

    <script>
        let db, auth;
        const logs = [];

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'log') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });

            const logsDiv = document.getElementById('console-logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = logEntry;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = (...args) => {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addLog(args.join(' '), 'warn');
        };

        // Test 1: Check if scripts loaded
        function checkScripts() {
            const statusDiv = document.getElementById('script-status');
            statusDiv.innerHTML = '';

            const scripts = [
                { name: 'Firebase App', check: () => typeof firebase !== 'undefined' },
                { name: 'Firebase Firestore', check: () => firebase && firebase.firestore },
                { name: 'Firebase Auth', check: () => firebase && firebase.auth },
                { name: 'FirebaseConfig', check: () => typeof firebaseConfig !== 'undefined' },
                { name: 'FirebaseCacheManager', check: () => typeof FirebaseCacheManager !== 'undefined' },
                { name: 'HomeView', check: () => typeof HomeView !== 'undefined' },
                { name: 'PageAssetRenderer', check: () => typeof PageAssetRenderer !== 'undefined' },
                { name: 'UniversalDisplayRenderer', check: () => typeof UniversalDisplayRenderer !== 'undefined' },
                { name: 'SPANavigation', check: () => typeof SPANavigation !== 'undefined' }
            ];

            scripts.forEach(script => {
                const loaded = script.check();
                const status = document.createElement('div');
                status.className = `status ${loaded ? 'pass' : 'fail'}`;
                status.textContent = `${loaded ? '‚úÖ' : '‚ùå'} ${script.name}`;
                statusDiv.appendChild(status);
                console.log(`Script check: ${script.name} = ${loaded ? 'LOADED' : 'MISSING'}`);
            });
        }

        // Test 2: Firebase Connection
        async function testFirebase() {
            const statusDiv = document.getElementById('firebase-status');
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Testing Firebase connection...</div>';

            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }

                // Initialize Firebase if needed
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase initialized');
                }

                db = firebase.firestore();
                auth = firebase.auth();

                // Test Firestore connection
                const testQuery = await db.collection('mythologies').limit(1).get();

                statusDiv.innerHTML = `
                    <div class="status pass">‚úÖ Firebase connected successfully</div>
                    <div class="status pass">‚úÖ Firestore accessible (${testQuery.size} docs found)</div>
                `;
                console.log('Firebase test: SUCCESS');
                return true;

            } catch (error) {
                statusDiv.innerHTML = `<div class="status fail">‚ùå Firebase test failed: ${error.message}</div>`;
                console.error('Firebase test failed:', error);
                return false;
            }
        }

        // Test 3: Check Authentication
        async function checkAuth() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Checking authentication...</div>';

            try {
                if (!auth) {
                    auth = firebase.auth();
                }

                const user = auth.currentUser;

                if (user) {
                    statusDiv.innerHTML = `
                        <div class="status pass">‚úÖ User authenticated</div>
                        <div class="log-entry">UID: ${user.uid}</div>
                        <div class="log-entry">Email: ${user.email || 'Anonymous'}</div>
                        <div class="log-entry">Provider: ${user.isAnonymous ? 'Anonymous' : user.providerData[0]?.providerId}</div>
                    `;
                    console.log('Auth check: User logged in -', user.email || 'Anonymous');
                } else {
                    statusDiv.innerHTML = `
                        <div class="status fail">‚ùå No user authenticated</div>
                        <div class="log-entry">Use "Sign In Anonymously" button to authenticate</div>
                    `;
                    console.warn('Auth check: No user logged in');
                }

                return !!user;

            } catch (error) {
                statusDiv.innerHTML = `<div class="status fail">‚ùå Auth check failed: ${error.message}</div>`;
                console.error('Auth check failed:', error);
                return false;
            }
        }

        // Sign in anonymously for testing
        async function signInAnonymously() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Signing in anonymously...</div>';

            try {
                if (!auth) {
                    auth = firebase.auth();
                }

                const result = await auth.signInAnonymously();

                statusDiv.innerHTML = `
                    <div class="status pass">‚úÖ Signed in anonymously</div>
                    <div class="log-entry">UID: ${result.user.uid}</div>
                `;
                console.log('Anonymous sign-in: SUCCESS');

                // Now test rendering
                setTimeout(() => testHomeView(), 500);

            } catch (error) {
                statusDiv.innerHTML = `<div class="status fail">‚ùå Sign-in failed: ${error.message}</div>`;
                console.error('Anonymous sign-in failed:', error);
            }
        }

        // Test 4a: Test HomeView directly
        async function testHomeView() {
            const statusDiv = document.getElementById('render-status');
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Testing HomeView rendering...</div>';

            try {
                if (!db) {
                    await testFirebase();
                }

                if (!auth.currentUser) {
                    throw new Error('Must be authenticated first - click "Sign In Anonymously"');
                }

                if (typeof HomeView === 'undefined') {
                    throw new Error('HomeView class not loaded');
                }

                const mainContent = document.getElementById('main-content');
                const homeView = new HomeView(db);

                console.log('Rendering HomeView...');
                await homeView.render(mainContent);

                statusDiv.innerHTML = `<div class="status pass">‚úÖ HomeView rendered successfully</div>`;
                console.log('HomeView test: SUCCESS');

            } catch (error) {
                statusDiv.innerHTML = `<div class="status fail">‚ùå HomeView test failed: ${error.message}</div>`;
                console.error('HomeView test failed:', error);
            }
        }

        // Test 4b: Test SPA Navigation
        async function testSPANavigation() {
            const statusDiv = document.getElementById('render-status');
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Testing SPA Navigation...</div>';

            try {
                if (!db) {
                    await testFirebase();
                }

                if (!auth.currentUser) {
                    throw new Error('Must be authenticated first - click "Sign In Anonymously"');
                }

                if (typeof SPANavigation === 'undefined') {
                    throw new Error('SPANavigation class not loaded');
                }

                if (typeof UniversalDisplayRenderer === 'undefined') {
                    throw new Error('UniversalDisplayRenderer class not loaded');
                }

                const renderer = new UniversalDisplayRenderer({
                    enableHover: true,
                    enableExpand: true,
                    enableCorpusLinks: true
                });

                const navigation = new SPANavigation(db, null, renderer);

                // Wait for auth ready
                await new Promise(resolve => setTimeout(resolve, 1000));

                console.log('Testing SPA Navigation home route...');
                const mainContent = document.getElementById('main-content');

                // Manually trigger renderHome
                await navigation.renderHome();

                statusDiv.innerHTML = `<div class="status pass">‚úÖ SPA Navigation test completed</div>`;
                console.log('SPA Navigation test: SUCCESS');

            } catch (error) {
                statusDiv.innerHTML = `<div class="status fail">‚ùå SPA Navigation test failed: ${error.message}</div>`;
                console.error('SPA Navigation test failed:', error);
            }
        }

        // Auto-run script check on load
        window.addEventListener('load', () => {
            console.log('Page loaded, running initial checks...');
            checkScripts();
        });
    </script>
</body>
</html>

#!/usr/bin/env node

/**
 * AGENT 3: Apply Fixes to Firebase
 *
 * This script applies the fixes generated by generate-fixes-offline.js to Firebase.
 */

const admin = require('firebase-admin');
const fs = require('fs');

const args = process.argv.slice(2);
const isDryRun = args.includes('--dry-run');

console.log('='.repeat(80));
console.log('AGENT 3: APPLY FIXES TO FIREBASE');
console.log('='.repeat(80));
console.log(`Mode: ${isDryRun ? 'DRY RUN' : 'LIVE UPDATE'}`);
console.log('');

// Load fixes
if (!fs.existsSync('AGENT_3_FIXES.json')) {
  console.error('❌ Error: AGENT_3_FIXES.json not found. Run generate-fixes-offline.js first.');
  process.exit(1);
}

const fixes = JSON.parse(fs.readFileSync('AGENT_3_FIXES.json', 'utf8'));

console.log('Loaded fixes:');
console.log(`  Rituals: ${fixes.rituals.length} items`);
console.log(`  Herbs: ${fixes.herbs.length} items`);
console.log(`  Texts: ${fixes.texts.length} items`);
console.log('');

// Initialize Firebase Admin
const serviceAccount = JSON.parse(
  fs.readFileSync('firebase-service-account.json', 'utf8')
);

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: 'https://eyesofazrael-default-rtdb.firebaseio.com'
  });
}

const db = admin.database();

/**
 * Apply fixes for a collection
 */
async function applyCollectionFixes(collection, collectionFixes) {
  console.log(`\n--- APPLYING ${collection.toUpperCase()} FIXES ---\n`);

  const updates = {};
  let count = 0;

  for (const fix of collectionFixes) {
    const { id, updates: itemUpdates } = fix;

    for (const [field, value] of Object.entries(itemUpdates)) {
      updates[`${id}/${field}`] = value;
    }

    console.log(`✓ ${id}: ${Object.entries(itemUpdates).map(([k,v]) => `${k}=${v}`).join(', ')}`);
    count++;
  }

  if (!isDryRun && Object.keys(updates).length > 0) {
    console.log(`\nApplying ${Object.keys(updates).length} updates...`);
    await db.ref(`assets/${collection}`).update(updates);
    console.log(`✓ Applied updates to ${count} ${collection}`);
  } else if (isDryRun) {
    console.log(`\n[DRY RUN] Would apply ${Object.keys(updates).length} updates to ${count} ${collection}`);
  }

  return count;
}

/**
 * Main execution
 */
async function main() {
  const startTime = Date.now();

  try {
    const ritualsFixed = await applyCollectionFixes('rituals', fixes.rituals);
    const herbsFixed = await applyCollectionFixes('herbs', fixes.herbs);
    const textsFixed = await applyCollectionFixes('texts', fixes.texts);

    const total = ritualsFixed + herbsFixed + textsFixed;

    console.log('\n' + '='.repeat(80));
    console.log('SUMMARY');
    console.log('='.repeat(80));
    console.log(`Rituals: ${ritualsFixed} items ${isDryRun ? 'would be ' : ''}fixed`);
    console.log(`Herbs: ${herbsFixed} items ${isDryRun ? 'would be ' : ''}fixed`);
    console.log(`Texts: ${textsFixed} items ${isDryRun ? 'would be ' : ''}fixed`);
    console.log(`\nTotal: ${total} items ${isDryRun ? 'would be ' : ''}updated`);
    console.log(`Time: ${((Date.now() - startTime) / 1000).toFixed(2)}s`);
    console.log('='.repeat(80));

    if (!isDryRun) {
      console.log('\n✓ Fixes applied successfully!\n');
    } else {
      console.log('\n[DRY RUN] No changes made. Run without --dry-run to apply fixes.\n');
    }

  } catch (error) {
    console.error('\n❌ Error:', error.message);
    console.error(error.stack);
    process.exit(1);
  } finally {
    process.exit(0);
  }
}

// Run with timeout
const timeout = setTimeout(() => {
  console.error('\n❌ Script timed out after 5 minutes');
  process.exit(1);
}, 300000); // 5 minutes

main().then(() => {
  clearTimeout(timeout);
});
